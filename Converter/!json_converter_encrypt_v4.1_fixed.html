<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MystiGo Konverter (V4.1 - Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #f8fafc; color: #1e293b; }
        .container { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #0f172a; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .step { margin-bottom: 2rem; }
        label { font-weight: 600; display: block; margin-bottom: 0.75rem; color: #334155; }
        
        .file-upload { position: relative; display: flex; align-items: center; justify-content: center; padding: 2rem; border: 2px dashed #cbd5e1; border-radius: 12px; transition: all 0.2s; background: #f8fafc; cursor: pointer; }
        .file-upload:hover { border-color: #3b82f6; background: #eff6ff; }
        .file-upload input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-text { pointer-events: none; color: #64748b; font-weight: 500; }
        
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        #convertBtn { background-color: #0f172a; color: white; margin-top: 1rem; }
        #convertBtn:hover { background-color: #1e293b; transform: translateY(-1px); }
        #convertBtn:disabled { background-color: #cbd5e1; cursor: not-allowed; transform: none; }
        
        #downloadBtn { background-color: #10b981; color: white; display: none; margin-top: 1.5rem; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        #downloadBtn:hover { background-color: #059669; }

        #status { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; display: none; font-size: 0.95rem; line-height: 1.5; }
        .success { background-color: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .error { background-color: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        
        .stats { display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.85rem; color: #64748b; justify-content: center; }
        .stat-item { background: #f1f5f9; padding: 4px 12px; border-radius: 99px; }
    </style>
</head>
<body>

<div class="container">
    <h1>MystiGo Konverter <span style="font-size: 0.6em; vertical-align: middle; background: #e0f2fe; color: #0284c7; padding: 2px 8px; border-radius: 6px;">V4.1 Fixed</span></h1>
    <p class="subtitle">K√ºl√∂n munkalapok ("games" √©s "tasks") √∂sszef√©s√ºl√©se + Jav√≠tott param√©terek</p>

    <div class="step">
        <label>1. Excel f√°jl kiv√°laszt√°sa</label>
        <div class="file-upload">
            <input type="file" id="excelFile" accept=".xlsx, .xls">
            <span class="upload-text" id="fileNameDisplay">Kattints vagy h√∫zd ide a f√°jlt...</span>
        </div>
    </div>

    <button id="convertBtn" disabled>Adatok Feldolgoz√°sa</button>
    
    <div id="status"></div>
    <div id="statsContainer" class="stats" style="display:none;"></div>
    
    <button id="downloadBtn">JSON Let√∂lt√©se (Firebase)</button>
</div>

<script>
    let splitDatabase = {
        public_games_list: {},
        secure_game_contents: {}
    };

    const fileInput = document.getElementById('excelFile');
    const convertBtn = document.getElementById('convertBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusMsg = document.getElementById('status');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const statsContainer = document.getElementById('statsContainer');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileNameDisplay.textContent = fileInput.files[0].name;
            fileNameDisplay.style.color = "#0f172a";
            convertBtn.disabled = false;
            statusMsg.style.display = 'none';
            downloadBtn.style.display = 'none';
            statsContainer.style.display = 'none';
        }
    });

    // --- SEG√âDF√úGGV√âNYEK ---
    
    // Hash gener√°l√°s (√©kezetmentes√≠tve)
    function generateHash(text) {
        if (!text) return "";
        let cleanText = String(text).trim().toLowerCase();
        cleanText = cleanText.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        cleanText = cleanText.replace(/[^a-z0-9]/g, '');
        return CryptoJS.SHA256(cleanText).toString();
    }

    function safeFloat(val) {
        if (!val) return 0;
        const num = parseFloat(String(val).replace(',', '.').trim());
        return isNaN(num) ? 0 : num;
    }

    function safeString(val) {
        return (val === undefined || val === null) ? "" : String(val).trim();
    }

    // √öJ: Rugalmas mez≈ëolvas√≥ (t√∂bbf√©le elnevez√©st is megtal√°l, case-insensitive)
    function getValue(row, keys) {
        if (!row) return null;
        
        // 1. Pontos egyez√©s keres√©se
        for (const key of keys) {
            if (row[key] !== undefined) return row[key];
        }
        
        // 2. Kisbet≈±s egyez√©s keres√©se (ha az Excel fejl√©c nagybet≈±s volt)
        const rowKeys = Object.keys(row);
        for (const key of keys) {
            const foundKey = rowKeys.find(k => k.toLowerCase() === key.toLowerCase());
            if (foundKey) return row[foundKey];
        }
        return null;
    }

    // --- KONVERT√ÅL√ÅS ---
    convertBtn.addEventListener('click', () => {
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const gamesSheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('game')) || workbook.SheetNames[0];
                const tasksSheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('task')) || workbook.SheetNames[1];

                if (!gamesSheetName) throw new Error("Nem tal√°lhat√≥ 'games' munkalap.");
                
                const gamesData = XLSX.utils.sheet_to_json(workbook.Sheets[gamesSheetName]);
                const tasksData = tasksSheetName ? XLSX.utils.sheet_to_json(workbook.Sheets[tasksSheetName]) : [];

                splitDatabase = { public_games_list: {}, secure_game_contents: {} };
                let tasksCount = 0;

                // 1. J√ÅT√âKOK FELDOLGOZ√ÅSA (Jav√≠tott getValue haszn√°lattal)
                gamesData.forEach(row => {
                    const gameIdRaw = getValue(row, ['id', 'gameId', 'ID']);
                    if (!gameIdRaw) return;

                    const gameId = String(gameIdRaw).trim();
                    const version = getValue(row, ['version', 'ver']) ? parseInt(getValue(row, ['version', 'ver'])) : 1;

                    // Adatok kinyer√©se
                    const title = safeString(getValue(row, ['title', 'gameTitle', 'nev']));
                    const category = safeString(getValue(row, ['category', 'kategoria'])) || "family";
                    const type = safeString(getValue(row, ['type', 'tipus'])) || "normal";
                    const age = safeString(getValue(row, ['age', 'kor'])) || "6-99";
                    
                    const priceRaw = getValue(row, ['price', 'ar']);
                    const price = priceRaw ? parseInt(String(priceRaw).replace(/\D/g,'')) : 0;
                    
                    const locName = safeString(getValue(row, ['location', 'locationName', 'helyszin']));
                    const desc = safeString(getValue(row, ['description', 'desc', 'leiras']));
                    const imgUrl = safeString(getValue(row, ['imageUrl', 'image', 'kep', 'cover']));
                    const logo = safeString(getValue(row, ['headerLogo', 'logo'])) || "logo/default.png";
                    
                    const isHiddenRaw = getValue(row, ['isHidden', 'hidden', 'rejtett']);
                    const isHidden = (String(isHiddenRaw).toLowerCase() === 'true' || isHiddenRaw === 1);
                    
                    const reviewUrl = safeString(getValue(row, ['reviewUrl', 'ertekeles']));
                    
                    const maxPlay = getValue(row, ['maxPlayCount', 'maxPlay']) ? parseInt(getValue(row, ['maxPlayCount', 'maxPlay'])) : 0;
                    const globLim = getValue(row, ['globalLimit']) ? parseInt(getValue(row, ['globalLimit'])) : 0;
                    
                    const sLat = safeFloat(getValue(row, ['startLocationLat', 'lat', 'startLat', 'kezdoLat']));
                    const sLng = safeFloat(getValue(row, ['startLocationLng', 'lng', 'startLng', 'kezdoLng']));
                    
                    // JAV√çT√ÅS: geofenceRadius biztons√°gos beolvas√°sa (t√∂bb n√©ven is keresi)
                    const geoRadRaw = getValue(row, ['geofenceRadius', 'radius', 'geoFence', 'sugar']);
                    const geoRad = geoRadRaw ? parseInt(geoRadRaw) : null;

                    const endStory = safeString(getValue(row, ['endStory', 'ending', 'vegeSzoveg']));

                    // Public lista √∂ssze√°ll√≠t√°sa
                    splitDatabase.public_games_list[gameId] = {
                        id: gameId,
                        version: version,
                        title: title,
                        category: category,
                        type: type,
                        age: age,
                        price: price,
                        location: locName,
                        description: desc,
                        imageUrl: imgUrl,
                        headerLogo: logo,
                        isHidden: isHidden,
                        reviewUrl: reviewUrl,
                        maxPlayCount: maxPlay,
                        globalLimit: globLim,
                        startLocationLat: sLat,
                        startLocationLng: sLng
                    };

                    // Secure tartalom √∂ssze√°ll√≠t√°sa
                    splitDatabase.secure_game_contents[gameId] = {
                        version: version,
                        startLocationLat: sLat,
                        startLocationLng: sLng,
                        geofenceRadius: geoRad, // <-- Itt a jav√≠tott √©rt√©k
                        endStory: endStory,
                        tasks: []
                    };
                });

                // TITKOS√çT√ì KULCS
                const SECRET_KEY = "MystiGo_Szuper_Titkos_Kulcs_2025"; 

                // 2. FELADATOK FELDOLGOZ√ÅSA
                if (tasksData.length > 0) {
                    tasksData.forEach(row => {
                        const gId = safeString(getValue(row, ['gameId', 'GameId', 'id']));
                        
                        if (splitDatabase.secure_game_contents[gId]) {
                            
                            // Megold√°s keres√©se
                            const rawSol = safeString(getValue(row, ['solution', 'Solution', 'answer', 'megoldas']));
                            
                            // Hash gener√°l√°s vagy megl√©v≈ë √°tv√©tele
                            let solHash = "";
                            if (rawSol) solHash = generateHash(rawSol);
                            else {
                                const existingHash = getValue(row, ['solutionHash', 'hash']);
                                if (existingHash) solHash = existingHash;
                            }

                            // Titkos√≠t√°s
                            const encryptedSol = rawSol ? CryptoJS.AES.encrypt(rawSol, SECRET_KEY).toString() : "";
                            const rawHint1 = safeString(getValue(row, ['hint1', 'hint', 'segitseg1']));
                            const rawHint2 = safeString(getValue(row, ['hint2', 'segitseg2']));
                            const encryptedHint1 = rawHint1 ? CryptoJS.AES.encrypt(rawHint1, SECRET_KEY).toString() : "";
                            const encryptedHint2 = rawHint2 ? CryptoJS.AES.encrypt(rawHint2, SECRET_KEY).toString() : "";

                            // Adatok beolvas√°sa (Jav√≠tott mez≈ëk)
                            const tIndex = parseInt(getValue(row, ['index', 'taskIndex', 'i', 'sorszam']) || 0);
                            const tStory = safeString(getValue(row, ['story', 'taskStory', 'intro', 'tortenet']));
                            const tPrompt = safeString(getValue(row, ['prompt', 'question', 'taskQuestion', 'kerdes']));
                            
                            const tLat = safeFloat(getValue(row, ['locationLat', 'lat', 'latitude']));
                            const tLng = safeFloat(getValue(row, ['locationLng', 'lng', 'longitude']));
                            
                            // √öJ MEZ≈êK FELISMER√âSE
                            const tImage = safeString(getValue(row, ['taskImage', 'image', 'img', 'media', 'kep']));
                            const tPoints = getValue(row, ['points', 'score', 'pont']) ? parseInt(getValue(row, ['points', 'score', 'pont'])) : 10;
                            const tGeoRad = getValue(row, ['geofenceRadius', 'radius', 'sugar']) ? parseInt(getValue(row, ['geofenceRadius', 'radius', 'sugar'])) : null;

                            const taskObj = {
                                index: tIndex,
                                story: tStory,
                                prompt: tPrompt,
                                locationLat: tLat,
                                locationLng: tLng,
                                location: {
                                    lat: tLat,
                                    lng: tLng
                                },
                                // Extra mez≈ëk
                                taskImage: tImage, 
                                points: tPoints,
                                geofenceRadius: tGeoRad, // Feladat szint≈± sug√°r

                                solution: encryptedSol, 
                                solutionHash: solHash,
                                hints: [encryptedHint1, encryptedHint2], 
                                acceptedHashes: []
                            };
                            
                            if (taskObj.index === 0) taskObj.isStartTask = true;

                            splitDatabase.secure_game_contents[gId].tasks.push(taskObj);
                            tasksCount++;
                        }
                    });
                }

                // Rendez√©s index szerint
                Object.values(splitDatabase.secure_game_contents).forEach(game => {
                    if (game.tasks) {
                        game.tasks.sort((a, b) => a.index - b.index);
                    }
                });

                const gameCount = Object.keys(splitDatabase.public_games_list).length;
                
                if (gameCount === 0) {
                    throw new Error("Nem siker√ºlt egyetlen j√°t√©kot sem beolvasni. Ellen≈ërizd az 'id' oszlopot!");
                }

                statusMsg.style.display = 'block';
                statusMsg.className = 'success';
                statusMsg.innerHTML = `‚úÖ <strong>Sikeres feldolgoz√°s!</strong><br>Beolvasva: ${gamesSheetName} / ${tasksSheetName || '-'}`;
                
                statsContainer.style.display = 'flex';
                statsContainer.innerHTML = `
                    <div class=\"stat-item\">üéÆ ${gameCount} J√°t√©k</div>
                    <div class=\"stat-item\">üß© ${tasksCount} Feladat</div>
                `;

                downloadBtn.style.display = 'block';
                convertBtn.disabled = true;

            } catch (err) {
                console.error(err);
                statusMsg.style.display = 'block';
                statusMsg.className = 'error';
                statusMsg.textContent = "Hiba: " + err.message;
            }
        };
        reader.readAsArrayBuffer(file);
    });

    downloadBtn.addEventListener('click', () => {
        const filename = `mystigo_firebase_full_${new Date().toISOString().slice(0,10)}.json`;
        const blob = new Blob([JSON.stringify(splitDatabase, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
    });
</script>

</body>
</html>