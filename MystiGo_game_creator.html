<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interakt√≠v T√∂rt√©netk√©sz√≠t≈ë</title>
    
    <style>
        /* √öj CSS a k√©t oszlopos elrendez√©shez √©s az oldals√°vhoz */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f4f4f4;
            display: flex; /* F≈ë elrendez√©s */
            justify-content: center;
        }

        #main-layout {
            display: flex;
            width: 100%;
            max-width: 1200px; /* Sz√©lesebb kont√©ner az oldals√°v miatt */
            gap: 20px;
        }

        #game-list-sidebar {
            flex: 0 0 250px; /* Fix sz√©less√©g≈± oldals√°v */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 80vh; /* Megnyit√°s gomb miatt */
            overflow-y: auto;
        }
        
        #game-list-sidebar h2 {
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        #game-list-container {
            list-style: none;
            padding: 0;
        }

        .game-list-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: bold;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .game-list-item:hover {
            background-color: #e0f7fa;
            color: #0056b3;
        }
        
        .game-list-item.selected {
            background-color: #007bff;
            color: white;
        }

        #form-container {
            flex-grow: 1; /* A f≈ë ≈±rlap kit√∂lti a marad√©k helyet */
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* A t√∂bbi st√≠lus v√°ltozatlan, de az utols√≥ gombok st√≠lus√°t friss√≠tj√ºk */

        .general-info, .task-group {
            border: 1px solid #0056b3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .general-info {
            background-color: #e6f7ff;
        }

        .task-group {
            background-color: #f0f8ff;
        }
        
        /* GPS gomb elrendez√©shez (M√ìDOS√çTVA: Oszlopos elrendez√©s) */
        .input-with-gps {
            display: flex;
            flex-direction: column; /* Oszlopos elrendez√©s: mez≈ë alatta gomb */
            gap: 5px;
        }
        
        .input-with-gps input[type="text"] {
            flex-grow: 1; /* A mez≈ë foglalja el a hely nagy r√©sz√©t */
        }

        .gps-button {
            padding: 8px 10px;
            border: none;
            background-color: #ffc107;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            line-height: 1;
            transition: background-color 0.2s;
            height: auto; /* Magass√°g automatikus, nem fix */
            text-transform: lowercase; /* Kisbet≈±s st√≠lus */
            white-space: nowrap; /* Megakad√°lyozza a t√∂r√©st */
        }

        .gps-button:hover {
            background-color: #e0a800;
        }

        .input-row {
            display: flex;
            gap: 20px;
        }

        .input-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        input[readonly] {
            background-color: #eee;
        }

        textarea {
            resize: vertical;
        }

        #plus-button, .action-button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 1.1em;
            width: 100%;
            transition: background-color 0.2s;
            margin-top: 10px; 
        }
        
        #plus-button {
            background-color: #4CAF50;
            color: white;
            margin-bottom: 30px;
        }
        #plus-button:hover {
            background-color: #45a049;
        }
        
        .action-button-row {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .action-button-row > button {
            flex: 1;
            font-weight: bold;
        }

        #open-button {
            background-color: #ff9800;
            color: white;
        }
        #open-button:hover {
            background-color: #e68900;
        }

        #save-button {
            background-color: #007bff;
            color: white;
        }
        #save-button:hover {
            background-color: #0056b3;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script> 
</head>
<body>

<div id="main-layout">
    
    <div id="game-list-sidebar">
        <h2>J√°t√©kok list√°ja</h2>
        <div id="game-list-container">
            <p style="font-size: 0.9em; color: #555;">T√∂lts be egy XLSX adatb√°zis f√°jlt a lentebbi gombbal!</p>
        </div>
        
        <hr style="margin-top: 20px;">
        <button id="open-button" onclick="document.getElementById('file-input').click()" class="action-button">üìÇ Megnyit√°s (XLSX)</button>
    </div>
    
    <div id="form-container">
        <h1>Interakt√≠v T√∂rt√©net & Feladatk√©sz√≠t≈ë</h1>
        
        <p id="autosave-status" style="color: #007bff; font-weight: bold; font-size: 0.9em;">Automatikusan mentve: ...</p>
        <div class="general-info">
            <h2>√Åltal√°nos adatok üìã</h2>
            
            <div class="input-row">
                <div>
                    <label for="title">C√≠m</label>
                    <input type="text" id="title" placeholder="A kaland c√≠me (pl: A F≈ëv√°ros Rejt√©lye)" oninput="generateId(this.value); autoSave()">
                </div>
                <div>
                    <label for="generated-id">Azonos√≠t√≥ (ID)</label>
                    <input type="text" id="generated-id" placeholder="pl: a-fovaros-rejtelye" readonly>
                </div>
            </div>

            <div class="input-row">
                <div>
                    <label for="type">T√≠pus</label>
                    <select id="type" onchange="autoSave()">
                        <option value="normal">Normal</option>
                        <option value="kids">Kids</option>
                        <option value="team">Team</option>
                    </select>
                </div>
                <div>
                    <label for="cover-image">Bor√≠t√≥k√©p f√°jln√©v</label>
                    <input type="text" id="cover-image" placeholder="pl: boritokep.jpg" oninput="autoSave()">
                </div>
            </div>
            
            <div class="input-row">
                <div>
                    <label for="start-coords">Kezd≈ë GPS Koordin√°t√°k</label>
                    <div class="input-with-gps">
                        <input type="text" id="start-coords" placeholder="Pl: 47.4979, 19.0402" oninput="autoSave()">
                        <button type="button" class="gps-button" onclick="getCurrentGps('start-coords')">üìçgps</button>
                    </div>
                </div>
                <div>
                    <label for="start-radius">Kezd≈ë R√°diusz (m√©terben)</label>
                    <input type="text" id="start-radius" placeholder="Pl: 20 (ez a k√∂r sugara)" oninput="autoSave()">
                </div>
            </div>

        </div>

        <label for="initial-story">Kezdeti T√∂rt√©net</label>
        <textarea id="initial-story" rows="4" placeholder="√çrd ide a t√∂rt√©net elej√©t, a k√ºldet√©s ind√≠t√°s√°t..." oninput="autoSave()"></textarea>
        
        <hr>

        <div id="task-groups-container">
            </div>

        <button id="plus-button">‚ûï Plusz Feladatcsoport Hozz√°ad√°sa</button>

        <hr>

        <label for="final-story">Z√°r√≥ T√∂rt√©net</label>
        <textarea id="final-story" rows="4" placeholder="√çrd ide a t√∂rt√©net v√©g√©t, a k√ºldet√©s lez√°r√°s√°t..." oninput="autoSave()"></textarea>

        <div class="action-button-row">
             <button id="save-button" onclick="saveData()">üíæ Ment√©s (XLSX f√°jlk√©nt)</button>
        </div>
    </div>
    
    <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;" onchange="openData(event)">
</div>

<script>
    let taskCounter = 0; // 0-r√≥l indul a jobb kezelhet≈ës√©g√©rt a dinamikus r√©szben
    
    // GLOB√ÅLIS T√ÅROL√ìK A BET√ñLT√ñTT J√ÅT√âKOKNAK √âS FELADATOKNAK
    let allGamesData = [];
    let allTasksData = [];
    let currentLoadedGameId = null;
    
    const AUTOSAVE_KEY = 'mystigo_game_creator_data';
    const taskGroupsContainer = document.getElementById('task-groups-container');
    const plusButton = document.getElementById('plus-button');

    // Seg√©dfunkci√≥k
    function setInputValue(id, value) {
        const element = document.getElementById(id);
        if (element && value !== undefined && value !== null) {
            element.value = (value === null || value === undefined) ? '' : value;
        }
    }

    function clearTaskGroups() {
        taskGroupsContainer.innerHTML = '';
        taskCounter = 0;
    }
    
    function clearForm() {
        setInputValue('title', '');
        setInputValue('generated-id', '');
        setInputValue('type', 'normal');
        setInputValue('cover-image', '');
        setInputValue('initial-story', '');
        setInputValue('final-story', '');
        setInputValue('start-coords', '');
        setInputValue('start-radius', '');
        clearTaskGroups();
    }
    
    // ===================================
    // 0. GPS MEZ≈êK DINAMIKUS GENER√ÅL√ÅSA
    // ===================================

    function getTaskGroupHTML(newTaskId, isLoadedData = false) {
        return `
            <div class="task-group" id="task-group-${newTaskId}">
                <h2>Feladat ${newTaskId}. (Helysz√≠n) üìç</h2>

                <div class="input-row">
                    <div>
                        <label for="task-coords-${newTaskId}">GPS Koordin√°t√°k</label>
                        <div class="input-with-gps">
                            <input type="text" id="task-coords-${newTaskId}" placeholder="Pl: 47.4979, 19.0402" oninput="autoSave()">
                            <button type="button" class="gps-button" onclick="getCurrentGps('task-coords-${newTaskId}')">üìçgps</button>
                        </div>
                    </div>
                    <div>
                        <label for="task-radius-${newTaskId}">R√°diusz (m√©terben)</label>
                        <input type="text" id="task-radius-${newTaskId}" placeholder="Pl: 10 (ez a k√∂r sugara)" oninput="autoSave()">
                    </div>
                </div>

                <label for="task-story-${newTaskId}">Feladathoz Tartoz√≥ T√∂rt√©net</label>
                <textarea id="task-story-${newTaskId}" rows="3" placeholder="A helysz√≠nre √©rkez√©skor megjelen≈ë t√∂rt√©neti r√©sz..." oninput="autoSave()"></textarea>

                <label for="task-description-${newTaskId}">Konkr√©t Feladat</label>
                <textarea id="task-description-${newTaskId}" rows="3" placeholder="Mit kell a felhaszn√°l√≥nak csin√°lnia a helysz√≠nen?" oninput="autoSave()"></textarea>

                <hr style="border-style: dashed;">

                <div class="input-row">
                    <div>
                        <label for="task-hint-1-${newTaskId}">Seg√≠ts√©g 1</label>
                        <input type="text" id="task-hint-1-${newTaskId}" placeholder="R√∂vid tipp 1" oninput="autoSave()">
                    </div>
                    <div>
                        <label for="task-hint-2-${newTaskId}">Seg√≠ts√©g 2</label>
                        <input type="text" id="task-hint-2-${newTaskId}" placeholder="R√∂vid tipp 2" oninput="autoSave()">
                    </div>
                    <div>
                        <label for="task-solution-${newTaskId}">Megold√°s</label>
                        <input type="text" id="task-solution-${newTaskId}" placeholder="A helyes v√°lasz" oninput="autoSave()">
                    </div>
                </div>
            </div>
        `;
    }

    plusButton.addEventListener('click', function() {
        taskCounter++;
        const newTaskId = taskCounter;
        const newGroupHTML = getTaskGroupHTML(newTaskId);
        taskGroupsContainer.insertAdjacentHTML('beforeend', newGroupHTML);
        // T√∂rl√©s nem sz√ºks√©ges, az ≈±rlap elemek alapb√≥l √ºresek
        autoSave(); // Menti a megn√∂vekedett mez≈ësz√°mot
    });


    // ===================================
    // 1. AZONOS√çT√ì GENER√ÅL√ÅSA
    // ===================================

    function generateId(title) {
        const id = title.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s-]/g, '')
            .trim()
            .replace(/\s+/g, '-');
        
        setInputValue('generated-id', id);
    }
    
    // ===================================
    // 2. GPS KOORDIN√ÅTA K√âZEL√âS (FRISS√çTVE: 2 mp k√©sleltet√©s)
    // ===================================
    
    function getCurrentGps(targetId) {
        if (navigator.geolocation) {
            const button = document.querySelector(`[onclick="getCurrentGps('${targetId}')"]`);
            // M√≥dos√≠tott sz√∂vegek sz√≥k√∂z n√©lk√ºl
            const originalText = 'üìçgps'; 
            if (button) button.textContent = 'bet√∂lt√©s...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(4);
                    const lng = position.coords.longitude.toFixed(4);
                    const coords = `${lat}, ${lng}`;
                    setInputValue(targetId, coords);
                    
                    if (button) button.textContent = '‚úÖbet√∂ltve';
                    // 2000 ms k√©sleltet√©s a pontoss√°g ellen≈ërz√©s√©re
                    setTimeout(() => { if (button) button.textContent = originalText; }, 2000); 
                    autoSave();
                },
                (error) => {
                    alert(`Hiba t√∂rt√©nt a GPS koordin√°t√°k lek√©r√©sekor: ${error.message}`);
                    if (button) button.textContent = '‚ùåhiba';
                    setTimeout(() => { if (button) button.textContent = originalText; }, 2000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            alert("A b√∂ng√©sz≈ëd nem t√°mogatja a Geolocation-t (GPS koordin√°ta lek√©r√©st).");
        }
    }


    // ===================================
    // 3. AUTOMATIKUS MENT√âS √âS BET√ñLT√âS
    // ===================================
    
    function getFormData() {
        // √Åltal√°nos adatok
        const formData = {
            title: document.getElementById('title').value,
            generatedId: document.getElementById('generated-id').value,
            type: document.getElementById('type').value,
            coverImage: document.getElementById('cover-image').value,
            initialStory: document.getElementById('initial-story').value,
            finalStory: document.getElementById('final-story').value,
            startCoords: document.getElementById('start-coords').value,
            startRadius: document.getElementById('start-radius').value,
            tasks: [],
            taskCounter: taskCounter // Mentj√ºk a feladatok sz√°m√°t
        };

        // Feladat adatok gy≈±jt√©se
        const taskGroups = document.querySelectorAll('.task-group');
        taskGroups.forEach((group) => {
            const groupID = group.id.split('-').pop(); // Kinyerj√ºk az aktu√°lis dinamikus ID-t
            
            // Csak akkor mentj√ºk, ha vannak a mez≈ëkben val√≥s ID-k
            if(document.getElementById(`task-coords-${groupID}`)) {
                formData.tasks.push({
                    id: groupID, // A dinamikus ID ment√©se a vissza√°ll√≠t√°shoz
                    coords: document.getElementById(`task-coords-${groupID}`).value,
                    radius: document.getElementById(`task-radius-${groupID}`).value,
                    story: document.getElementById(`task-story-${groupID}`).value,
                    description: document.getElementById(`task-description-${groupID}`).value,
                    hint1: document.getElementById(`task-hint-1-${groupID}`).value,
                    hint2: document.getElementById(`task-hint-2-${groupID}`).value,
                    solution: document.getElementById(`task-solution-${groupID}`).value
                });
            }
        });
        
        return formData;
    }

    function autoSave() {
        const formData = getFormData();
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(formData));
        
        // Vizu√°lis visszajelz√©s
        const now = new Date();
        const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        document.getElementById('autosave-status').textContent = `Automatikusan mentve: ${timeString}`;
    }

    function loadAutosave() {
        const savedDataJson = localStorage.getItem(AUTOSAVE_KEY);
        if (!savedDataJson) {
            document.getElementById('autosave-status').textContent = 'Automatikusan mentve: M√©g nem volt ment√©s.';
            plusButton.click(); // Ha nincs ment√©s, hozzunk l√©tre egy √ºres feladatot
            return;
        }

        try {
            const data = JSON.parse(savedDataJson);
            
            // --- √Åltal√°nos adatok bet√∂lt√©se ---
            setInputValue('title', data.title);
            setInputValue('generated-id', data.generatedId);
            setInputValue('type', data.type);
            setInputValue('cover-image', data.coverImage);
            setInputValue('initial-story', data.initialStory);
            setInputValue('final-story', data.finalStory);
            setInputValue('start-coords', data.startCoords);
            setInputValue('start-radius', data.startRadius);
            
            // --- Feladatok bet√∂lt√©se (Dinamikus vissza√°ll√≠t√°s) ---
            clearTaskGroups(); // T√∂rli √©s taskCounter = 0
            
            // Vissza√°ll√≠tja a taskCountert a mentett legmagasabb ID-re
            taskCounter = data.taskCounter || 0; 
            
            data.tasks.forEach(task => {
                const newTaskId = parseInt(task.id, 10); // A mentett dinamikus ID
                
                // Mivel a loadAutosave fut√°sa el≈ëtt a taskCounter a mentett √©rt√©kre √°ll,
                // a getTaskGroupHTML-ben a newTaskId-t haszn√°ljuk fel a mez≈ëk ID-j√©nek.
                const newGroupHTML = getTaskGroupHTML(newTaskId);
                taskGroupsContainer.insertAdjacentHTML('beforeend', newGroupHTML);
                
                // √ârt√©kek felt√∂lt√©se
                setInputValue(`task-coords-${newTaskId}`, task.coords);
                setInputValue(`task-radius-${newTaskId}`, task.radius);
                setInputValue(`task-story-${newTaskId}`, task.story);
                setInputValue(`task-description-${newTaskId}`, task.description);
                setInputValue(`task-hint-1-${newTaskId}`, task.hint1);
                setInputValue(`task-hint-2-${newTaskId}`, task.hint2);
                setInputValue(`task-solution-${newTaskId}`, task.solution);
            });
            
            // Ha a mentett feladatok sz√°ma 0, de a sz√°ml√°l√≥ nem, akkor is kell egy √ºres
            if (data.tasks.length === 0) {
                 clearTaskGroups();
                 plusButton.click();
            }

            document.getElementById('autosave-status').textContent = `Automatikusan mentve: Sikeresen vissza√°ll√≠tva az el≈ëz≈ë munkamenet!`;

        } catch (error) {
            console.error("Hiba az autosave adatok bet√∂lt√©sekor:", error);
            document.getElementById('autosave-status').textContent = 'Automatikusan mentve: Hiba a mentett adatok vissza√°ll√≠t√°sakor.';
            clearForm();
            plusButton.click();
        }
    }
    
    // Esem√©nyfigyel≈ë hozz√°ad√°sa minden mez≈ëh√∂z a form-container-ben a v√°ltoz√°sok figyel√©s√©re
    document.getElementById('form-container').addEventListener('input', (event) => {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
            // A glob√°lis oninput/onchange-t a dinamikus mez≈ëk miatt adtam hozz√°, 
            // de a general-info-n bel√ºli mez≈ëkre is √©rv√©nyes, √≠gy a megl√©v≈ë oninput-okat kivessz√ºk, ha itt kezelj√ºk
            // Viszont a generateId-t megh√≠v√≥ oninput miatt jobb ha marad a jelenlegi k√≥d!
            // Ezzel a megold√°ssal a dinamikus mez≈ëket √©s a gombokat kezelj√ºk a megl√©v≈ë k√≥ddal.
        }
    });

    // Oldal bet√∂lt√©sekor azonnal h√≠vjuk
    window.addEventListener('load', loadAutosave);


    // ===================================
    // 4. ADATOK BET√ñLT√âSE AZ XLSX-B≈êL
    // ===================================
    // (A logika nagyj√°b√≥l v√°ltozatlan, de a clearForm √©s taskCounter miatt m√°r j√≥l m≈±k√∂dik)

    function openData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            try {
                // 1. Adatok kinyer√©se
                const gameSheet = workbook.Sheets['games'];
                const taskSheet = workbook.Sheets['tasks'];
                
                allGamesData = XLSX.utils.sheet_to_json(gameSheet) || [];
                allTasksData = XLSX.utils.sheet_to_json(taskSheet) || [];
                
                // 2. Oldals√°v felt√∂lt√©se
                const listContainer = document.getElementById('game-list-container');
                listContainer.innerHTML = '';
                
                if (allGamesData.length === 0) {
                    listContainer.innerHTML = '<p style="font-size: 0.9em; color: #555;">Nincs j√°t√©k a games munkalapon.</p>';
                    return;
                }
                
                allGamesData.forEach(game => {
                    const listItem = document.createElement('div');
                    listItem.className = 'game-list-item';
                    listItem.textContent = game.title || game.id || 'N√©vtelen j√°t√©k';
                    listItem.setAttribute('data-game-id', game.id);
                    listItem.onclick = () => loadGame(game.id, listItem);
                    listContainer.appendChild(listItem);
                });
                
                // 3. Az els≈ë j√°t√©k bet√∂lt√©se
                loadGame(allGamesData[0].id, listContainer.firstChild);
                
                // T√∂r√∂lj√ºk a localStorage-t, ha XLSX-b≈ël t√∂lt√ºnk be
                localStorage.removeItem(AUTOSAVE_KEY); 
                document.getElementById('autosave-status').textContent = 'Automatikusan mentve: Bet√∂lt√©s XLSX-b≈ël. (A helyi ment√©s t√∂r√∂lve lett)';

                alert(`Sikeresen bet√∂ltve ${allGamesData.length} j√°t√©k a(z) ${file.name} f√°jlb√≥l!`);
                
            } catch (error) {
                console.error("Hiba a f√°jl feldolgoz√°sakor:", error);
                alert("Hiba t√∂rt√©nt a f√°jl feldolgoz√°sa k√∂zben. Gy≈ëz≈ëdj meg r√≥la, hogy a f√°jl tartalmazza a 'games' √©s 'tasks' munkalapokat, √©s a form√°tum helyes.");
            }
        };

        reader.readAsArrayBuffer(file);
    }
    
    // ===================================
    // 5. EGY J√ÅT√âK ADATAINAK BET√ñLT√âSE AZ ≈∞RLAPBA
    // ===================================

    function loadGame(gameId, listItemElement) {
        
        const gameInfo = allGamesData.find(g => g.id === gameId);
        const tasks = allTasksData.filter(t => t.gameId === gameId);
        
        if (!gameInfo) {
            alert(`Hiba: Nem tal√°lhat√≥ j√°t√©k a(z) ${gameId} azonos√≠t√≥val.`);
            return;
        }

        // Vizu√°lis kiemel√©s elt√°vol√≠t√°sa √©s hozz√°ad√°sa
        document.querySelectorAll('.game-list-item').forEach(item => {
            item.classList.remove('selected');
        });
        if (listItemElement) {
             listItemElement.classList.add('selected');
        }

        currentLoadedGameId = gameId;
        clearForm(); // Minden mez≈ë t√∂rl√©se √©s taskCounter = 0
        
        // --- √Åltal√°nos adatok bet√∂lt√©se ---
        setInputValue('title', gameInfo.title);
        setInputValue('generated-id', gameInfo.id);
        setInputValue('type', gameInfo.type);
        setInputValue('cover-image', gameInfo.imageUrl);
        setInputValue('initial-story', gameInfo.description);
        setInputValue('final-story', gameInfo.endStory);
        
        // Kezd≈ë koordin√°t√°k √©s r√°diusz
        const startCoords = `${gameInfo.startLocationLat || ''}, ${gameInfo.startLocationLng || ''}`.trim().replace(/^,\s*|,\s*$/g, '');
        setInputValue('start-coords', startCoords);
        setInputValue('start-radius', gameInfo.startGeofenceRadius);
        
        // --- Feladatok bet√∂lt√©se ---
        clearTaskGroups(); // T√∂r√∂lj√ºk a r√©gi feladatmez≈ëket √©s taskCounter = 0

        tasks.sort((a, b) => (a.index || 0) - (b.index || 0)); // Index szerinti rendez√©s

        tasks.forEach(task => {
            // Dinamikus feladatcsoport hozz√°ad√°sa
            taskCounter++; // A sz√°ml√°l√≥ haszn√°lata √∫j ID gener√°l√°s√°hoz
            const newTaskId = taskCounter; 

            const newGroupHTML = getTaskGroupHTML(newTaskId);
            taskGroupsContainer.insertAdjacentHTML('beforeend', newGroupHTML);
            
            // √ârt√©kek felt√∂lt√©se
            const coords = `${task.locationLat || ''}, ${task.locationLng || ''}`.trim().replace(/^,\s*|,\s*$/g, '');
            setInputValue(`task-coords-${newTaskId}`, coords);
            setInputValue(`task-radius-${newTaskId}`, task.geofenceRadius);
            setInputValue(`task-story-${newTaskId}`, task.story);
            setInputValue(`task-description-${newTaskId}`, task.prompt);
            setInputValue(`task-hint-1-${newTaskId}`, task.hint1);
            setInputValue(`task-hint-2-${newTaskId}`, task.hint2);
            setInputValue(`task-solution-${newTaskId}`, task.solution);

        });
        
        // Ha az XLSX √ºres volt, gondoskodunk egy alap feladatcsoportr√≥l
        if (tasks.length === 0) {
            plusButton.click(); // Hozz√°adja az els≈ë √ºres feladatot (taskCounter 1 lesz)
        }
        
        // A bet√∂lt√©s ut√°n azonnal ments√ºk el az √°llapotot a localStorage-ba
        autoSave();
    }
    
    // ===================================
    // 6. ADATOK GY≈∞JT√âSE √âS MENT√âSE (XLSX)
    // ===================================

    function saveData() {
        // 1. √Åltal√°nos adatok gy≈±jt√©se
        const title = document.getElementById('title').value || "N√©vtelen Kaland";
        const gameId = document.getElementById('generated-id').value || title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const type = document.getElementById('type').value;
        const coverImage = document.getElementById('cover-image').value;
        const initialStory = document.getElementById('initial-story').value;
        const finalStory = document.getElementById('final-story').value;
        
        const startCoordsInput = document.getElementById('start-coords').value;
        const startRadiusInput = document.getElementById('start-radius').value;

        let startLat = '';
        let startLng = '';
        if (startCoordsInput) {
            const parts = startCoordsInput.split(',').map(c => c.trim());
            if (parts.length === 2) {
                startLat = parts[0];
                startLng = parts[1];
            }
        }
        
        // 2. Feladat adatok gy≈±jt√©se
        let tasksData = [];
        const taskGroups = document.querySelectorAll('.task-group');
        
        taskGroups.forEach((group, index) => {
            const currentTaskIndex = index + 1; // 1-t≈ël indexel√©s a ment√©shez
            
            const groupID = group.id.split('-').pop(); // Kinyerj√ºk a task-group-X ID-b≈ël az X-et

            const coordsInput = document.getElementById(`task-coords-${groupID}`).value;
            const radiusInput = document.getElementById(`task-radius-${groupID}`).value;

            let lat = '';
            let lng = '';
            if (coordsInput) {
                const parts = coordsInput.split(',').map(c => c.trim());
                if (parts.length === 2) {
                    lat = parts[0];
                    lng = parts[1];
                }
            }

            tasksData.push({
                gameId: gameId, 
                index: currentTaskIndex, // 1-t≈ël indexel√©s
                locationLat: lat,
                locationLng: lng,
                geofenceRadius: radiusInput || '0',
                story: document.getElementById(`task-story-${groupID}`).value,
                prompt: document.getElementById(`task-description-${groupID}`).value,
                hint1: document.getElementById(`task-hint-1-${groupID}`).value,
                hint2: document.getElementById(`task-hint-2-${groupID}`).value,
                solution: document.getElementById(`task-solution-${groupID}`).value
            });
        });

        // 3. √Åltal√°nos adatok (games munkalap)
        const gameInfo = {
            id: gameId,
            type: type,
            title: title,
            age: '', 
            price: '0', 
            description: initialStory,
            startLocationLat: startLat,
            startLocationLng: startLng,
            startGeofenceRadius: startRadiusInput || '0', 
            endStory: finalStory,
            imageUrl: coverImage
        };

        let finalGamesData = [];
        let finalTasksData = [];
        
        // Ha van m√°r bet√∂lt√∂tt adatb√°zis (allGamesData nem √ºres), akkor FRISS√çTJ√úK ahelyett, hogy fel√ºl√≠rn√°nk az eg√©szet
        if (allGamesData.length > 0) {
            // J√°t√©k friss√≠t√©se vagy hozz√°ad√°sa
            const gameIndex = allGamesData.findIndex(g => g.id === gameId);
            if (gameIndex > -1) {
                allGamesData[gameIndex] = gameInfo;
            } else {
                allGamesData.push(gameInfo);
            }
            finalGamesData = allGamesData;

            // Feladatok friss√≠t√©se/cser√©je: az √∂sszes r√©gi feladatot t√∂r√∂lj√ºk, √©s betessz√ºk az √∫jakat
            finalTasksData = allTasksData.filter(t => t.gameId !== gameId); // R√©gi feladatok t√∂rl√©se
            finalTasksData.push(...tasksData); // √öj feladatok hozz√°ad√°sa
            
        } else {
            // Ha nem volt bet√∂ltve adatb√°zis, csak az aktu√°lis j√°t√©kot mentj√ºk
            finalGamesData.push(gameInfo);
            finalTasksData.push(...tasksData);
        }

        // 4. Munkalapok l√©trehoz√°sa √©s f√°jl ment√©se (SheetJS)
        
        const workbook = XLSX.utils.book_new();

        const taskSheet = XLSX.utils.json_to_sheet(finalTasksData);
        XLSX.utils.book_append_sheet(workbook, taskSheet, 'tasks');

        const gameSheet = XLSX.utils.json_to_sheet(finalGamesData);
        XLSX.utils.book_append_sheet(workbook, gameSheet, 'games');

        const filename = `${gameId}_data.xlsx`;
        XLSX.writeFile(workbook, filename);

        alert(`Az adatok sikeresen mentve lettek ${filename} n√©ven, XLSX form√°tumban! (Munkalapok: games, tasks)`);
        
        // Sikeres ment√©s ut√°n t√∂r√∂lj√ºk az autosave-et
        localStorage.removeItem(AUTOSAVE_KEY);
        document.getElementById('autosave-status').textContent = 'Automatikusan mentve: A f√°jl sikeresen elmentve, helyi ment√©s t√∂r√∂lve.';
    }
</script>

</body>
</html>