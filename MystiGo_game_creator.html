<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MystiGo | Game Studio Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script> 
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --secondary: #64748b;
            --success: #059669;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --border: #cbd5e1;
            --text-dark: #0f172a;
            --text-muted: #475569;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-main); 
            display: flex;
        }

        /* Sidebar */
        #game-list-sidebar { 
            width: 320px; background: var(--bg-card); height: 100vh; 
            border-right: 1px solid var(--border); padding: 24px; 
            position: fixed; overflow-y: auto; z-index: 100;
        }

        .game-list-item { 
            padding: 12px; margin-bottom: 8px; background: #f8fafc; 
            border-radius: 8px; cursor: pointer; border: 1px solid var(--border); 
            transition: 0.2s; font-size: 0.9rem; font-weight: 500;
        }
        .game-list-item:hover { border-color: var(--primary); background: var(--primary-light); }
        .game-list-item.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Main Layout */
        #main-layout { 
            margin-left: 320px; width: calc(100% - 320px);
            padding: 40px; box-sizing: border-box; display: flex; justify-content: center;
        }
        #form-container { width: 100%; max-width: 1000px; }

        .card {
            background: var(--bg-card); border-radius: 16px; padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h3 { margin-top: 0; margin-bottom: 25px; color: var(--primary); border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; }

        /* Grid System */
        .input-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .field-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

        input, textarea, select { 
            width: 100%; padding: 10px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 0.95rem; box-sizing: border-box;
            background: #fff;
        }
        textarea { resize: vertical; }

        /* Solution Zone - Vertical Stack */
        .solution-zone {
            background: #f8fafc; border: 2px solid var(--primary-light);
            border-radius: 12px; padding: 24px; margin-top: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }

        .radio-group {
            display: flex; background: #fff; border: 1px solid var(--border);
            padding: 4px; border-radius: 8px; gap: 4px; width: fit-content;
        }
        .radio-option input { display: none; }
        .radio-option label {
            display: block; padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-size: 0.8rem; margin: 0; transition: 0.2s;
        }
        .radio-option input:checked + label { background: var(--primary); color: white; }

        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: #e2e8f0; color: var(--text-dark); }

        .gps-container { display: flex; gap: 6px; }
        .gps-btn { padding: 8px; aspect-ratio: 1; justify-content: center; }

        .sticky-actions {
            position: sticky; bottom: 20px; background: rgba(255,255,255,0.9);
            padding: 20px; border-radius: 16px; border: 1px solid var(--border);
            display: flex; gap: 15px; backdrop-filter: blur(10px); z-index: 50;
        }

        #map-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        #map-content { width: 85%; height: 85%; background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; }
        #map-canvas { flex-grow: 1; border-radius: 12px; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="game-list-sidebar">
    <h2 style="font-size: 1.1rem; color: var(--primary);">üìÇ MystiGo Adatb√°zis</h2>
    <button class="btn btn-ghost" style="width:100%; margin-bottom:20px;" onclick="document.getElementById('file-input').click()">XLSX Bet√∂lt√©se</button>
    <div id="game-list-container"></div>
</div>

<div id="main-layout">
    <div id="form-container">
        <div class="card">
            <h3>üåç J√°t√©k Alapadatok (games)</h3>
            <div class="input-grid">
                <div class="field-group" style="grid-column: span 2;">
                    <label>J√°t√©k c√≠me (title)</label>
                    <input type="text" id="title" oninput="generateId(this.value)">
                </div>
                <div class="field-group">
                    <label>Azonos√≠t√≥ (id)</label>
                    <input type="text" id="generated-id" readonly style="background:#f1f5f9;">
                </div>
                <div class="field-group">
                    <label>T√≠pus (type)</label>
                    <select id="type">
                        <option value="normal">normal</option>
                        <option value="kids">kids</option>
                        <option value="team">team</option>
                        <option value="explore">explore</option>
                    </select>
                </div>
            </div>

            <div class="input-grid">
                <div class="field-group"><label>Helysz√≠n (location)</label><input type="text" id="location"></div>
                <div class="field-group"><label>√âletkor (age)</label><input type="text" id="age"></div>
                <div class="field-group"><label>√År (price)</label><input type="text" id="price"></div>
                <div class="field-group">
                    <label>Rejtett? (isHidden)</label>
                    <select id="isHidden">
                        <option value="">Nem</option>
                        <option value="1">Igen (1)</option>
                    </select>
                </div>
            </div>

            <div class="input-grid">
                <div class="field-group" style="grid-column: span 2;">
                    <label>Kezd≈ë Koordin√°t√°k (startLocationLat, Lng)</label>
                    <div class="gps-container">
                        <input type="text" id="start-coords" placeholder="Lat, Lng">
                        <button class="btn btn-ghost gps-btn" onclick="getCurrentGps('start-coords')">üìç</button>
                        <button class="btn btn-primary gps-btn" onclick="openMapPicker('start-coords')">üó∫Ô∏è</button>
                    </div>
                </div>
                <div class="field-group"><label>Sug√°r (geofenceRadius)</label><input type="number" id="game-radius" value="15"></div>
            </div>

            <div class="input-grid">
                <div class="field-group"><label>Bor√≠t√≥k√©p (imageUrl)</label><input type="text" id="imageUrl"></div>
                <div class="field-group"><label>Header Logo (headerLogo)</label><input type="text" id="headerLogo"></div>
                <div class="field-group"><label>√ârt√©kel√©s URL (reviewUrl)</label><input type="text" id="reviewUrl"></div>
            </div>

            <div class="input-grid">
                <div class="field-group"><label>Max J√°t√©k/F≈ë (maxPlayCount)</label><input type="number" id="maxPlayCount"></div>
                <div class="field-group"><label>Glob√°lis Limit (globalLimit)</label><input type="number" id="globalLimit"></div>
            </div>

            <div class="field-group" style="margin-top:10px;"><label>Kezd≈ë T√∂rt√©net (description)</label><textarea id="description" rows="4"></textarea></div>
            <div class="field-group"><label>Z√°r√≥ T√∂rt√©net (endStory)</label><textarea id="endStory" rows="4"></textarea></div>
        </div>

        <div id="task-groups-container"></div>

        <div class="sticky-actions">
            <button class="btn btn-success" id="plus-button" style="flex:1">‚ûï √öj Feladat Hozz√°ad√°sa</button>
            <button class="btn btn-primary" onclick="saveData()" style="flex:2">üíæ XLSX Adatb√°zis Ment√©se</button>
        </div>
    </div>
</div>

<div id="map-modal"><div id="map-content"><h3>V√°lassz helysz√≠nt</h3><div id="map-canvas"></div><div style="margin-top:20px; text-align:right;"><button class="btn btn-ghost" onclick="closeMap()">M√©gse</button> <button class="btn btn-success" onclick="confirmMapCoords()">Koordin√°t√°k Ment√©se</button></div></div></div>

<input type="file" id="file-input" accept=".xlsx" style="display:none" onchange="openData(event)">

<script>
    let taskCounter = 0;
    let allGamesData = [];
    let allTasksData = [];
    let map, mapMarker, currentMapId;

    function generateId(v) { document.getElementById('generated-id').value = v.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, ''); }

    function getTaskHTML(id) {
        return `
            <div class="card task-group" id="task-group-${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; border:none;">üìç Feladat #${id}</h3>
                    <span style="font-weight:bold; color:var(--secondary); background:var(--bg-main); padding:4px 12px; border-radius:20px; font-size:0.8rem;">INDEX: ${id}</span>
                </div>
                
                <div class="input-grid">
                    <div class="field-group" style="grid-column: span 2;">
                        <label>Poz√≠ci√≥ (locationLat, locationLng)</label>
                        <div class="gps-container">
                            <input type="text" id="t-coords-${id}" placeholder="Lat, Lng">
                            <button class="btn btn-ghost gps-btn" onclick="getCurrentGps('t-coords-${id}')">üìç</button>
                            <button class="btn btn-primary gps-btn" onclick="openMapPicker('t-coords-${id}')">üó∫Ô∏è</button>
                        </div>
                    </div>
                    <div class="field-group"><label>Sug√°r (geofenceRadius)</label><input type="number" id="t-radius-${id}" value="15"></div>
                    <div class="field-group"><label>Helysz√≠n K√©p (taskImage)</label><input type="text" id="t-image-${id}" placeholder="pl. img/task1.png"></div>
                </div>

                <div class="field-group"><label>Helysz√≠n Sztori (story)</label><textarea id="t-story-${id}" rows="3"></textarea></div>
                <div class="field-group"><label>Konkr√©t Feladat (prompt)</label><textarea id="t-prompt-${id}" rows="2"></textarea></div>
                
                <div class="input-grid">
                    <div class="field-group"><label>Seg√≠ts√©g 1 (hint1)</label><input type="text" id="t-h1-${id}"></div>
                    <div class="field-group"><label>Seg√≠ts√©g 2 (hint2)</label><input type="text" id="t-h2-${id}"></div>
                </div>

                <div class="solution-zone">
                    <div class="field-group">
                        <label style="color:var(--primary);">Megold√°s (solution)</label>
                        <input type="text" id="t-sol-${id}" placeholder="Helyes v√°lasz...">
                    </div>
                    <div class="field-group">
                        <label>Megold√°s (disableSolution)</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" name="t-dis-${id}" id="dis-n-${id}" value="" checked><label for="dis-n-${id}">üîì Kik√©rhet≈ë</label></div>
                            <div class="radio-option"><input type="radio" name="t-dis-${id}" id="dis-y-${id}" value="1"><label for="dis-y-${id}">üîí Tiltva</label></div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    document.getElementById('plus-button').onclick = () => { taskCounter++; document.getElementById('task-groups-container').insertAdjacentHTML('beforeend', getTaskHTML(taskCounter)); };

    function openData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
            allGamesData = XLSX.utils.sheet_to_json(wb.Sheets['games']) || [];
            allTasksData = XLSX.utils.sheet_to_json(wb.Sheets['tasks']) || [];
            renderSidebar();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function renderSidebar() {
        const c = document.getElementById('game-list-container'); c.innerHTML = '';
        allGamesData.forEach(g => {
            const d = document.createElement('div'); d.className = 'game-list-item'; d.textContent = g.title || g.id;
            d.onclick = () => {
                document.querySelectorAll('.game-list-item').forEach(i => i.classList.remove('selected'));
                d.classList.add('selected');
                loadGame(g.id);
            };
            c.appendChild(d);
        });
        if(allGamesData.length > 0) loadGame(allGamesData[0].id);
    }

    function loadGame(gid) {
        const g = allGamesData.find(x => x.id === gid);
        const ts = allTasksData.filter(x => x.gameId === gid).sort((a,b) => a.index - b.index);
        
        document.getElementById('title').value = g.title || '';
        document.getElementById('generated-id').value = g.id || '';
        document.getElementById('type').value = g.type || 'normal';
        document.getElementById('location').value = g.location || '';
        document.getElementById('age').value = g.age || '';
        document.getElementById('price').value = g.price || '';
        document.getElementById('isHidden').value = g.isHidden || '';
        document.getElementById('start-coords').value = g.startLocationLat ? `${g.startLocationLat}, ${g.startLocationLng}` : '';
        document.getElementById('game-radius').value = g.geofenceRadius || '';
        document.getElementById('imageUrl').value = g.imageUrl || '';
        document.getElementById('headerLogo').value = g.headerLogo || '';
        document.getElementById('reviewUrl').value = g.reviewUrl || '';
        document.getElementById('maxPlayCount').value = g.maxPlayCount || '';
        document.getElementById('globalLimit').value = g.globalLimit || '';
        document.getElementById('description').value = g.description || '';
        document.getElementById('endStory').value = g.endStory || '';

        const tc = document.getElementById('task-groups-container'); tc.innerHTML = ''; taskCounter = 0;
        ts.forEach(t => {
            taskCounter++; tc.insertAdjacentHTML('beforeend', getTaskHTML(taskCounter));
            document.getElementById(`t-coords-${taskCounter}`).value = t.locationLat ? `${t.locationLat}, ${t.locationLng}` : '';
            document.getElementById(`t-radius-${taskCounter}`).value = t.geofenceRadius || '';
            document.getElementById(`t-image-${taskCounter}`).value = t.taskImage || '';
            document.getElementById(`t-story-${taskCounter}`).value = t.story || '';
            document.getElementById(`t-prompt-${taskCounter}`).value = t.prompt || '';
            document.getElementById(`t-h1-${taskCounter}`).value = t.hint1 || '';
            document.getElementById(`t-h2-${taskCounter}`).value = t.hint2 || '';
            document.getElementById(`t-sol-${taskCounter}`).value = t.solution || '';
            if(t.disableSolution == 1) document.getElementById(`dis-y-${taskCounter}`).checked = true;
        });
    }

    function saveData() {
        const gid = document.getElementById('generated-id').value;
        const gCoords = document.getElementById('start-coords').value.split(',');
        
        const gameObj = {
            id: gid, type: document.getElementById('type').value, title: document.getElementById('title').value,
            age: document.getElementById('age').value, price: document.getElementById('price').value,
            description: document.getElementById('description').value,
            startLocationLat: gCoords[0]?.trim() || '', startLocationLng: gCoords[1]?.trim() || '',
            geofenceRadius: document.getElementById('game-radius').value,
            endStory: document.getElementById('endStory').value, imageUrl: document.getElementById('imageUrl').value,
            location: document.getElementById('location').value, isHidden: document.getElementById('isHidden').value,
            headerLogo: document.getElementById('headerLogo').value, reviewUrl: document.getElementById('reviewUrl').value,
            maxPlayCount: document.getElementById('maxPlayCount').value, globalLimit: document.getElementById('globalLimit').value
        };

        const gIdx = allGamesData.findIndex(x => x.id === gid);
        if(gIdx > -1) allGamesData[gIdx] = gameObj; else allGamesData.push(gameObj);

        const newTasks = [];
        document.querySelectorAll('.task-group').forEach((el, i) => {
            const id = el.id.split('-').pop();
            const tC = document.getElementById(`t-coords-${id}`).value.split(',');
            newTasks.push({
                gameId: gid, index: i + 1,
                locationLat: tC[0]?.trim() || '', locationLng: tC[1]?.trim() || '',
                geofenceRadius: document.getElementById(`t-radius-${id}`).value,
                story: document.getElementById(`t-story-${id}`).value, prompt: document.getElementById(`t-prompt-${id}`).value,
                hint1: document.getElementById(`t-h1-${id}`).value, hint2: document.getElementById(`t-h2-${id}`).value,
                solution: document.getElementById(`t-sol-${id}`).value,
                disableSolution: document.querySelector(`input[name="t-dis-${id}"]:checked`).value,
                taskImage: document.getElementById(`t-image-${id}`).value
            });
        });

        allTasksData = allTasksData.filter(x => x.gameId !== gid).concat(newTasks);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allTasksData), "tasks");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allGamesData), "games");
        XLSX.writeFile(wb, `MystiGo_Database.xlsx`);
    }

    function initMap() { if(!map){ map = L.map('map-canvas').setView([47.497, 19.04], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); mapMarker = L.marker([47.497, 19.04], {draggable:true}).addTo(map); map.on('click', e => mapMarker.setLatLng(e.latlng)); } }
    function openMapPicker(id) { currentMapId = id; document.getElementById('map-modal').style.display='flex'; initMap(); setTimeout(()=>map.invalidateSize(),200); }
    function closeMap() { document.getElementById('map-modal').style.display='none'; }
    function confirmMapCoords() { const p = mapMarker.getLatLng(); document.getElementById(currentMapId).value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`; closeMap(); }
    function getCurrentGps(id) { navigator.geolocation.getCurrentPosition(p => document.getElementById(id).value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`); }

    window.onload = () => { if(taskCounter===0) document.getElementById('plus-button').click(); };
</script>

</body>
</html>