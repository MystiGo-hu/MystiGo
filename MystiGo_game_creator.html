<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MystiGo | Game Studio Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script> 
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --secondary: #64748b;
            --success: #059669;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --border: #cbd5e1;
            --text-dark: #0f172a;
            --text-muted: #475569;
            --sidebar-width: 320px;
        }

        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-main); 
            display: flex;
            flex-direction: column;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            color: var(--primary);
            font-weight: bold;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.7rem;
            line-height: 1.2;
            text-transform: none;
            font-weight: normal;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .view-selector {
            display: flex;
            justify-content: center;
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            gap: 10px;
        }

        .view-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .advanced-only {
            display: none !important;
        }

        body.advanced-mode .advanced-only {
            display: flex !important;
        }

        #mobile-nav {
            display: none;
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1001;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #game-list-sidebar { 
            width: var(--sidebar-width); 
            background: var(--bg-card); 
            height: 100vh; 
            border-right: 1px solid var(--border); 
            padding: 24px; 
            position: fixed; 
            overflow-y: auto; 
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .game-list-item { 
            padding: 12px; margin-bottom: 8px; background: #f8fafc; 
            border-radius: 8px; cursor: pointer; border: 1px solid var(--border); 
            transition: 0.2s; font-size: 0.9rem; font-weight: 500;
        }
        .game-list-item:hover { border-color: var(--primary); background: var(--primary-light); }
        .game-list-item.selected { background: var(--primary); color: white; border-color: var(--primary); }

        #main-layout { 
            margin-left: var(--sidebar-width); 
            width: calc(100% - var(--sidebar-width));
            padding: 40px; 
            box-sizing: border-box; 
            display: flex; 
            justify-content: center;
            min-height: 100vh;
        }
        #form-container { width: 100%; max-width: 1000px; }

        .card {
            background: var(--bg-card); border-radius: 16px; padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h3 { margin-top: 0; margin-bottom: 25px; color: var(--primary); border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; }

        .input-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .field-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }

        input, textarea, select { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 1rem; box-sizing: border-box;
            background: #fff;
        }
        textarea { resize: vertical; }

        .solution-zone {
            background: #f8fafc; border: 2px solid var(--primary-light);
            border-radius: 12px; padding: 20px; margin-top: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* M√ìDOS√çTOTT: Mobilbar√°t r√°di√≥ gombok */
        .radio-group {
            display: flex; 
            flex-wrap: wrap; /* Enged√©lyezi a t√∂rdel√©st */
            background: #fff; 
            border: 1px solid var(--border);
            padding: 4px; 
            border-radius: 8px; 
            gap: 4px; 
            width: fit-content;
            max-width: 100%; /* Ne l√≥gjon ki a kont√©nerb≈ël */
        }
        .radio-option input { display: none; }
        .radio-option label {
            display: block; 
            padding: 8px 12px; 
            border-radius: 6px;
            cursor: pointer; 
            font-size: 0.8rem; 
            margin: 0; 
            transition: 0.2s;
            white-space: nowrap; /* Sz√∂veg ne t√∂rj√∂n gombfeliraton bel√ºl */
            background: #f8fafc;
            border: 1px solid transparent;
        }
        .radio-option input:checked + label { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
        }

        .btn { padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: #e2e8f0; color: var(--text-dark); }

        .gps-container { display: flex; flex-direction: column; gap: 10px; }
        .gps-btn-group { display: flex; gap: 10px; width: 100%; }
        .gps-btn { flex: 1; height: 48px; aspect-ratio: auto !important; font-size: 0.85rem !important; }

        .sticky-actions {
            position: sticky; bottom: 20px; background: rgba(255,255,255,0.95);
            padding: 15px; border-radius: 16px; border: 1px solid var(--border);
            display: flex; gap: 10px; backdrop-filter: blur(10px); z-index: 50;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }

        #map-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 10px; }
        #map-content { width: 100%; max-width: 900px; height: 95vh; background: white; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; }
        #map-canvas { flex-grow: 1; border-radius: 12px; border: 1px solid var(--border); }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }

        .map-radius-container {
            margin-top: 15px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column; /* Felirat √©s gombok egym√°s al√° ker√ºlnek mobilon */
            align-items: flex-start;
            gap: 10px;
        }

        @media (max-width: 992px) {
            #mobile-nav { display: flex; }
            #game-list-sidebar { transform: translateX(-100%); width: 280px; }
            #game-list-sidebar.open { transform: translateX(0); }
            #main-layout { margin-left: 0; width: 100%; padding: 20px 15px; }
            .card { padding: 20px; }
            .sticky-actions { bottom: 10px; flex-direction: column; }
            .btn { width: 100%; }
            #sidebar-overlay.show { display: block; }
        }
    </style>
</head>
<body>

<div id="mobile-nav">
    <span style="font-weight: bold;">MystiGo Studio</span>
    <button class="btn btn-primary" onclick="toggleSidebar()" style="padding: 5px 12px; width: auto;">‚ò∞ J√°t√©kok</button>
</div>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="game-list-sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 1.1rem; color: var(--primary); margin: 0;">üìÇ Adatb√°zis</h2>
        <button class="btn btn-ghost" onclick="toggleSidebar()" style="display: none; width: auto;" id="sidebar-close-btn">‚úï</button>
    </div>
    <button class="btn btn-ghost" style="width:100%; margin-bottom:20px;" onclick="document.getElementById('file-input').click()">XLSX Bet√∂lt√©se</button>
    <div id="game-list-container"></div>
</div>

<div id="main-layout">
    <div id="form-container">
        
        <div class="view-selector">
            <button id="view-simple" class="view-btn active" onclick="setViewMode('simple')">Egyszer≈± n√©zet</button>
            <button id="view-advanced" class="view-btn" onclick="setViewMode('advanced')">Halad√≥ n√©zet</button>
        </div>

        <div class="card">
            <h3>üåç J√°t√©k Alapadatok</h3>
            <div class="input-grid">
                <div class="field-group">
                    <label>J√°t√©k c√≠me* <span class="tooltip">‚ìò<span class="tooltiptext">Adj meg egy vonz√≥ nevet! Ez fog megjelenni a j√°t√©klist√°ban.</span></span></label>
                    <input type="text" id="title" oninput="generateId(this.value)">
                </div>
                <div class="field-group advanced-only">
                    <label>Azonos√≠t√≥ (ID) <span class="tooltip">‚ìò<span class="tooltiptext">A j√°t√©k egyedi azonos√≠t√≥ja, a rendszer automatikusan gener√°lja a j√°t√©k nev√©b≈ël.</span></span></label>
                    <input type="text" id="generated-id" readonly style="background:#f1f5f9;">
                </div>
                <div class="field-group">
                    <label>T√≠pus* <span class="tooltip">‚ìò<span class="tooltiptext">Normal: a feladatok adott fix sorrendben egym√°s ut√°n k√∂vetkeznek. Explore: minden feladat l√°that√≥ a t√©rk√©pen √©s a j√°t√©kos d√∂nti el melyiket milyen sorrendben teljes√≠ti. Team: a kezd≈ëpont √©s az utols√≥ pont fix √©s az √∂sszes t√∂bbi k√∂ztes pontot v√©letlenszer≈±en dobja. Kids: kimondottan gyerekeknek sz√≥l, mes√©s t√∂rt√©nettel</span></span></label>
                    <select id="type">
                        <option value="normal">normal</option>
                        <option value="kids">kids</option>
                        <option value="team">team</option>
                        <option value="explore">explore</option>
                    </select>
                </div>
            </div>

            <div class="input-grid">
                <div class="field-group"><label>Helysz√≠n <span class="tooltip">‚ìò<span class="tooltiptext">Itt fel tudjuk sorolni, hogy milyen sz≈±r√©si param√©terekkel lehessen megtal√°lni a j√°t√©kot, pl. Budapest, XIX ker√ºlet, Erd≈ë, stb.</span></span></label><input type="text" id="location"></div>
                <div class="field-group"><label>√âletkor <span class="tooltip">‚ìò<span class="tooltiptext">Itt tudjuk megadni, hogy milyen koroszt√°lynak sz√≥l a j√°t√©k.</span></span></label><input type="text" id="age"></div>
                <div class="field-group"><label>√År <span class="tooltip">‚ìò<span class="tooltiptext">Itt tudjuk megadni, hogy az adott j√°t√©k mennyibe ker√ºl.</span></span></label><input type="text" id="price"></div>
                <div class="field-group advanced-only">
                    <label>Rejtett? <span class="tooltip">‚ìò<span class="tooltiptext">Ez a param√©ter √°ll√≠tja be, hogy alapb√≥l l√°that√≥ legyen e a j√°t√©k mindenkinek a j√°t√©kv√°laszt√≥ oldalon vagy sem.</span></span></label>
                    <select id="isHidden">
                        <option value="">Nem</option>
                        <option value="1">Igen (1)</option>
                    </select>
                </div>
            </div>

            <div class="input-grid">
                <div class="field-group">
                    <label>Indul√°si pont Koordin√°t√°i* <span class="tooltip">‚ìò<span class="tooltiptext">Ez a koordin√°ta lesz a j√°t√©k kezd≈ë pontja, itt lehet majd elind√≠tani a j√°t√©kot.</span></span></label>
                    <div class="gps-container">
                        <input type="text" id="start-coords" placeholder="Lat, Lng">
                        <div class="gps-btn-group">
                            <button class="btn btn-ghost gps-btn" onclick="getCurrentGps('start-coords')">üìç Poz√≠ci√≥m</button>
                            <button class="btn btn-primary gps-btn" onclick="openMapPicker('start-coords')">üó∫Ô∏è T√©rk√©p</button>
                        </div>
                    </div>
                </div>
                <div class="field-group"><label>Sug√°r (m) <span class="tooltip">‚ìò<span class="tooltiptext">A j√°t√©k kezd≈ë pontja ebben a sugar√≥ k√∂rben lesz elind√≠that√≥.</span></span></label><input type="number" id="game-radius" value="15"></div>
                <div class="field-group advanced-only"><label>Max J√°t√©k/F≈ë <span class="tooltip">‚ìò<span class="tooltiptext">Ez a param√©ter adja meg, hogy egy telefonr√≥l h√°nyszor j√°tszhatj√°k v√©gig az adott j√°t√©kot.</span></span></label><input type="number" id="maxPlayCount"></div>
                <div class="field-group advanced-only"><label>Glob√°lis Limit <span class="tooltip">‚ìò<span class="tooltiptext">Ez a param√©ter adja meg, hogy √∂sszesen mennyien j√°tszhatj√°k le az adott j√°t√©kot.</span></span></label><input type="number" id="globalLimit"></div>
                <div class="field-group"><label>B√≥nusz Pontok <span class="tooltip">‚ìò<span class="tooltiptext">Amennyiben szeretn√©nk v√©letlenszer≈± bonusz pontokat dob√°lni az adott j√°t√©khoz itt lehet megadni mennyi darabot szeretn√©nk. (minden pont +10 pont)</span></span></label><input type="number" id="bonuspoint" placeholder="0"></div>
            </div>

            <div class="input-grid advanced-only">
                <div class="field-group"><label>Bor√≠t√≥k√©p URL <span class="tooltip">‚ìò<span class="tooltiptext">Itt tudjuk megadni az adott j√°t√©k bor√≠t√≥k√©p√©nek a file nev√©t. A k√©pet k√ºl√∂n csatolm√°nyk√©nt kell elk√ºldeni.</span></span></label><input type="text" id="imageUrl"></div>
                <div class="field-group"><label>Header Logo <span class="tooltip">‚ìò<span class="tooltiptext">Amennyiben egyedi c√©ges log√≥t szeretn√©nk a fejl√©cben, annak a file nev√©t kell megadni √©s k√ºl√∂n csatolm√°nyk√©nt elk√ºldeni.</span></span></label><input type="text" id="headerLogo"></div>
                <div class="field-group"><label>√ârt√©kel√©s URL <span class="tooltip">‚ìò<span class="tooltiptext">Amennyiben szeretn√©nk egyedi √©rt√©kel≈ë lap URL-t megadni pl. google forms vagy microsoft amit a j√°t√©k v√©gezt√©vel van lehet≈ës√©ge kit√∂lteni a j√°t√©kosnak itt lehet megadni.</span></span></label><input type="text" id="reviewUrl"></div>
            </div>

            <div class="field-group"><label>Kezd≈ë T√∂rt√©net* <span class="tooltip">‚ìò<span class="tooltiptext">Ez a t√∂rt√©net fog megjelenni a j√°t√©kv√°laszt√≥ lapon illetve a j√°t√©k kezd√©sekor.</span></span></label><textarea id="description" rows="4"></textarea></div>
            <div class="field-group"><label>Z√°r√≥ T√∂rt√©net* <span class="tooltip">‚ìò<span class="tooltiptext">Ez a t√∂rt√©net fog megjelenni a j√°t√©k v√©g√©n.</span></span></label><textarea id="endStory" rows="4"></textarea></div>
        </div>

        <div id="task-groups-container"></div>

        <div class="sticky-actions">
            <button class="btn btn-success" id="plus-button" style="flex:1">‚ûï √öj Feladat</button>
            <button class="btn btn-primary" onclick="saveData()" style="flex:2">üíæ XLSX Ment√©se</button>
        </div>
    </div>
</div>

<div id="map-modal">
    <div id="map-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin:0; border:none;">V√°lassz helysz√≠nt</h3>
            <button class="btn btn-ghost" onclick="getCurrentGpsOnMap()" style="padding: 5px 15px; font-size: 0.8rem;">üìç Itt vagyok</button>
        </div>
        
        <div id="map-canvas"></div>
        
        <div class="map-radius-container">
            <label style="font-size: 0.7rem; font-weight: bold; color: var(--secondary); text-transform: uppercase;">Sug√°r:</label>
            <div class="radio-group">
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr5" value="5" onchange="updateMapCircle(5)"><label for="mr5">5m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr10" value="10" onchange="updateMapCircle(10)"><label for="mr10">10m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr15" value="15" onchange="updateMapCircle(15)"><label for="mr15">15m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr20" value="20" onchange="updateMapCircle(20)"><label for="mr20">20m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr25" value="25" onchange="updateMapCircle(25)"><label for="mr25">25m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr30" value="30" onchange="updateMapCircle(30)"><label for="mr30">30m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr40" value="40" onchange="updateMapCircle(40)"><label for="mr40">40m</label></div>
                <div class="radio-option"><input type="radio" name="map-radius-sel" id="mr50" value="50" onchange="updateMapCircle(50)"><label for="mr50">50m</label></div>
            </div>
        </div>

        <div style="margin-top:20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-ghost" onclick="closeMap()">M√©gse</button> 
            <button class="btn btn-success" onclick="confirmMapCoords()">Ment√©s</button>
        </div>
    </div>
</div>

<input type="file" id="file-input" accept=".xlsx" style="display:none" onchange="openData(event)">

<script>
    let taskCounter = 0;
    let allGamesData = [];
    let allTasksData = [];
    let map, mapMarker, mapCircle, currentMapId;

    function setViewMode(mode) {
        const body = document.body;
        const btnSimple = document.getElementById('view-simple');
        const btnAdvanced = document.getElementById('view-advanced');
        if (mode === 'advanced') {
            body.classList.add('advanced-mode');
            btnAdvanced.classList.add('active');
            btnSimple.classList.remove('active');
        } else {
            body.classList.remove('advanced-mode');
            btnSimple.classList.add('active');
            btnAdvanced.classList.remove('active');
        }
    }

    function toggleSidebar() {
        const sb = document.getElementById('game-list-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        sb.classList.toggle('open');
        overlay.classList.toggle('show');
    }

    function generateId(v) { 
        document.getElementById('generated-id').value = v.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, ''); 
    }

    function getTaskHTML(id) {
        return `
            <div class="card task-group" id="task-group-${id}">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; border:none;">üìç Feladat #${id}</h3>
                    <span style="font-weight:bold; color:var(--secondary); background:var(--bg-main); padding:4px 12px; border-radius:20px; font-size:0.8rem;">INDEX: ${id}</span>
                </div>
                
                <div class="input-grid">
                    <div class="field-group">
                        <label>Poz√≠ci√≥ (Lat, Lng) <span class="tooltip">‚ìò<span class="tooltiptext">Itt kell megadni az adott feladathoz tartoz√≥ GPS koordin√°t√°kat az adott form√°tumban. A "Poz√≠ci√≥m gomb megnyom√°s√°val az √©ppen aktu√°lis poz√≠ci√≥nk koordin√°t√°j√°t tudjuk berakni vagy a "T√©rk√©p" gomb megnyom√°s√°val manu√°lisan v√°laszthatunk egy pontot a t√©rk√©pen.</span></span></label>
                        <div class="gps-container">
                            <input type="text" id="t-coords-${id}" placeholder="Lat, Lng">
                            <div class="gps-btn-group">
                                <button class="btn btn-ghost gps-btn" onclick="getCurrentGps('t-coords-${id}')">üìç Poz√≠ci√≥m</button>
                                <button class="btn btn-primary gps-btn" onclick="openMapPicker('t-coords-${id}')">üó∫Ô∏è T√©rk√©p</button>
                            </div>
                        </div>
                    </div>
                    <div class="field-group"><label>Sug√°r (m) <span class="tooltip">‚ìò<span class="tooltiptext">Az adott feladat ebben a sugar√∫ k√∂rben fog aktiv√°l√≥dni.</span></span></label><input type="number" id="t-radius-${id}" value="15"></div>
                    <div class="field-group"><label>Feladat K√©p <span class="tooltip">‚ìò<span class="tooltiptext">Az itt megadott k√©p fog megjelenni az adott feladatn√°l. Ide a k√©p nev√©t √≠rd be √©s k√ºl√∂n csatolm√°nyk√©nt k√ºldd el nek√ºnk.</span></span></label><input type="text" id="t-image-${id}" placeholder="img/task.png"></div>
                </div>

                <div class="field-group"><label>Helysz√≠n Sztori <span class="tooltip">‚ìò<span class="tooltiptext">Ez a t√∂rt√©net fog megjelenni az adot feladatpontn√°l.</span></span></label><textarea id="t-story-${id}" rows="3"></textarea></div>
                <div class="field-group"><label>Konkr√©t Feladat / K√©rd√©s* <span class="tooltip">‚ìò<span class="tooltiptext">Ez az a k√©rd√©s, amit a felhaszn√°l√≥nak meg kell v√°laszolnia a helysz√≠nen.</span></span></label><textarea id="t-prompt-${id}" rows="2"></textarea></div>
                
                <div class="input-grid">
                    <div class="field-group"><label>Seg√≠ts√©g 1 <span class="tooltip">‚ìò<span class="tooltiptext">Ez az 1. sz√°m√∫ seg√≠ts√©g amit a j√°t√©kos ki tud k√©rni. Ha nem t√∂lt√∂d ki akkor nem lesz kik√©rhet≈ë seg√≠ts√©g.</span></span></label><input type="text" id="t-h1-${id}"></div>
                    <div class="field-group"><label>Seg√≠ts√©g 2 <span class="tooltip">‚ìò<span class="tooltiptext">Ez az 2. sz√°m√∫ seg√≠ts√©g amit a j√°t√©kos ki tud k√©rni. Ha nem t√∂lt√∂d ki akkor nem lesz kik√©rhet≈ë seg√≠ts√©g.</span></span></label><input type="text" id="t-h2-${id}"></div>
                </div>

                <div class="solution-zone">
                    <div class="field-group">
                        <label style="color:var(--primary);">Megold√°s* <span class="tooltip">‚ìò<span class="tooltiptext">Ez lesz a feladat megold√°sa. Amennyiben t√∂bb j√≥ megold√°st is elfogadunk akkor ; elv√°lasztva soroljuk fel a j√≥ megold√°sokat. Ezt fogja elfogadni a rendszer helyes v√°laszk√©nt.</span></span></label>
                        <input type="text" id="t-sol-${id}" placeholder="Helyes v√°lasz...">
                    </div>
                    <div class="field-group">
                        <label>Megold√°s √Åtugr√°sa <span class="tooltip">‚ìò<span class="tooltiptext">Ezzel a be√°ll√≠t√°ssal lehet megadni, hogy az adott feladathoz legyen e kik√©rhet≈ë megold√°s vagy sem.</span></span></label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" name="t-dis-${id}" id="dis-n-${id}" value="" checked><label for="dis-n-${id}">üîì Kik√©rhet≈ë</label></div>
                            <div class="radio-option"><input type="radio" name="t-dis-${id}" id="dis-y-${id}" value="1"><label for="dis-y-${id}">üîí Tiltva</label></div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    document.getElementById('plus-button').onclick = () => { 
        taskCounter++; 
        document.getElementById('task-groups-container').insertAdjacentHTML('beforeend', getTaskHTML(taskCounter)); 
    };

    function initMap() { 
        if(!map){ 
            map = L.map('map-canvas').setView([47.497, 19.04], 13); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map); 
            mapMarker = L.marker([47.497, 19.04], {draggable:true}).addTo(map);
            mapCircle = L.circle([47.497, 19.04], {
                color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 15
            }).addTo(map);

            map.on('click', e => {
                mapMarker.setLatLng(e.latlng);
                mapCircle.setLatLng(e.latlng);
            });
            mapMarker.on('drag', e => {
                mapCircle.setLatLng(e.target.getLatLng());
            });
        } 
    }
    
    function updateMapCircle(radius) {
        if(mapCircle) mapCircle.setRadius(parseInt(radius));
    }

    function getCurrentGpsOnMap() {
        if(!navigator.geolocation) { alert("GPS nem el√©rhet≈ë"); return; }
        navigator.geolocation.getCurrentPosition(p => {
            const latlng = [p.coords.latitude, p.coords.longitude];
            mapMarker.setLatLng(latlng);
            mapCircle.setLatLng(latlng);
            map.setView(latlng, 18);
        }, () => alert("Hiba a poz√≠ci√≥ lek√©r√©sekor"));
    }

    function openMapPicker(id) { 
        currentMapId = id;
        document.getElementById('map-modal').style.display='flex'; 
        initMap(); 

        let relatedRadiusId = id === 'start-coords' ? 'game-radius' : id.replace('coords', 'radius');
        let currentRad = document.getElementById(relatedRadiusId).value || 15;
        
        const radio = document.querySelector(`input[name="map-radius-sel"][value="${currentRad}"]`);
        if(radio) radio.checked = true; else document.getElementById('mr15').checked = true;
        updateMapCircle(currentRad);

        const val = document.getElementById(id).value;
        if(val && val.includes(',')) {
            const parts = val.split(',');
            const latlng = [parseFloat(parts[0]), parseFloat(parts[1])];
            mapMarker.setLatLng(latlng);
            mapCircle.setLatLng(latlng);
            map.setView(latlng, 18);
        }
        setTimeout(()=>map.invalidateSize(), 200); 
    }
    
    function closeMap() { document.getElementById('map-modal').style.display='none'; }
    
    function confirmMapCoords() { 
        const p = mapMarker.getLatLng(); 
        document.getElementById(currentMapId).value = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`; 
        const selectedRad = document.querySelector('input[name="map-radius-sel"]:checked').value;
        let relatedRadiusId = currentMapId === 'start-coords' ? 'game-radius' : currentMapId.replace('coords', 'radius');
        document.getElementById(relatedRadiusId).value = selectedRad;
        closeMap(); 
    }
    
    function getCurrentGps(id) { 
        if(!navigator.geolocation) { alert("GPS nem el√©rhet≈ë"); return; }
        navigator.geolocation.getCurrentPosition(p => {
            document.getElementById(id).value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`;
        }, () => alert("Hiba a poz√≠ci√≥ lek√©r√©sekor"));
    }

    function openData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
            allGamesData = XLSX.utils.sheet_to_json(wb.Sheets['games']) || [];
            allTasksData = XLSX.utils.sheet_to_json(wb.Sheets['tasks']) || [];
            renderSidebar();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function renderSidebar() {
        const c = document.getElementById('game-list-container'); c.innerHTML = '';
        allGamesData.forEach(g => {
            const d = document.createElement('div'); d.className = 'game-list-item'; d.textContent = g.title || g.id;
            d.onclick = () => {
                document.querySelectorAll('.game-list-item').forEach(i => i.classList.remove('selected'));
                d.classList.add('selected');
                loadGame(g.id);
                if(window.innerWidth <= 992) toggleSidebar();
            };
            c.appendChild(d);
        });
        if(allGamesData.length > 0) loadGame(allGamesData[0].id);
    }

    function loadGame(gid) {
        const g = allGamesData.find(x => x.id === gid);
        const ts = allTasksData.filter(x => x.gameId === gid).sort((a,b) => a.index - b.index);
        
        document.getElementById('title').value = g.title || '';
        document.getElementById('generated-id').value = g.id || '';
        document.getElementById('type').value = g.type || 'normal';
        document.getElementById('location').value = g.location || '';
        document.getElementById('age').value = g.age || '';
        document.getElementById('price').value = g.price || '';
        document.getElementById('isHidden').value = g.isHidden || '';
        document.getElementById('start-coords').value = g.startLocationLat ? `${g.startLocationLat}, ${g.startLocationLng}` : '';
        document.getElementById('game-radius').value = g.geofenceRadius || '15';
        document.getElementById('imageUrl').value = g.imageUrl || '';
        document.getElementById('headerLogo').value = g.headerLogo || '';
        document.getElementById('reviewUrl').value = g.reviewUrl || '';
        document.getElementById('description').value = g.description || '';
        document.getElementById('endStory').value = g.endStory || '';
        document.getElementById('maxPlayCount').value = g.maxPlayCount || '';
        document.getElementById('globalLimit').value = g.globalLimit || '';
        document.getElementById('bonuspoint').value = g.bonuspoint || '';

        const tc = document.getElementById('task-groups-container'); tc.innerHTML = ''; taskCounter = 0;
        ts.forEach(t => {
            taskCounter++; tc.insertAdjacentHTML('beforeend', getTaskHTML(taskCounter));
            document.getElementById(`t-coords-${taskCounter}`).value = t.locationLat ? `${t.locationLat}, ${t.locationLng}` : '';
            document.getElementById(`t-radius-${taskCounter}`).value = t.geofenceRadius || '15';
            document.getElementById(`t-image-${taskCounter}`).value = t.taskImage || '';
            document.getElementById(`t-story-${taskCounter}`).value = t.story || '';
            document.getElementById(`t-prompt-${taskCounter}`).value = t.prompt || '';
            document.getElementById(`t-h1-${t.index}`).value = t.hint1 || ''; // fix
            document.getElementById(`t-h2-${t.index}`).value = t.hint2 || ''; // fix
            document.getElementById(`t-sol-${taskCounter}`).value = t.solution || '';
            if(t.disableSolution == 1) document.getElementById(`dis-y-${taskCounter}`).checked = true;
        });
    }

    function saveData() {
        const gid = document.getElementById('generated-id').value;
        if(!gid) { alert("Adj meg egy c√≠met a ment√©shez!"); return; }
        const gCoords = document.getElementById('start-coords').value.split(',');
        const gameObj = {
            id: gid, type: document.getElementById('type').value, title: document.getElementById('title').value,
            age: document.getElementById('age').value, price: document.getElementById('price').value,
            description: document.getElementById('description').value,
            startLocationLat: gCoords[0]?.trim() || '', startLocationLng: gCoords[1]?.trim() || '',
            geofenceRadius: document.getElementById('game-radius').value,
            endStory: document.getElementById('endStory').value, imageUrl: document.getElementById('imageUrl').value,
            location: document.getElementById('location').value, isHidden: document.getElementById('isHidden').value,
            headerLogo: document.getElementById('headerLogo').value, reviewUrl: document.getElementById('reviewUrl').value,
            maxPlayCount: document.getElementById('maxPlayCount').value, globalLimit: document.getElementById('globalLimit').value,
            bonuspoint: document.getElementById('bonuspoint').value
        };
        const gIdx = allGamesData.findIndex(x => x.id === gid);
        if(gIdx > -1) allGamesData[gIdx] = gameObj; else allGamesData.push(gameObj);
        const newTasks = [];
        document.querySelectorAll('.task-group').forEach((el, i) => {
            const id = el.id.split('-').pop();
            const tC = document.getElementById(`t-coords-${id}`).value.split(',');
            newTasks.push({
                gameId: gid, index: i + 1, locationLat: tC[0]?.trim() || '', locationLng: tC[1]?.trim() || '',
                geofenceRadius: document.getElementById(`t-radius-${id}`).value,
                story: document.getElementById(`t-story-${id}`).value, prompt: document.getElementById(`t-prompt-${id}`).value,
                hint1: document.getElementById(`t-h1-${id}`).value, hint2: document.getElementById(`t-h2-${id}`).value,
                solution: document.getElementById(`t-sol-${id}`).value,
                disableSolution: document.querySelector(`input[name="t-dis-${id}"]:checked`).value,
                taskImage: document.getElementById(`t-image-${id}`).value
            });
        });
        allTasksData = allTasksData.filter(x => x.gameId !== gid).concat(newTasks);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allTasksData), "tasks");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(allGamesData), "games");
        XLSX.writeFile(wb, `MystiGo_DB_${gid}.xlsx`);
    }

    window.onload = () => { if(taskCounter===0) document.getElementById('plus-button').click(); };
</script>
</body>
</html>