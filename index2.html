<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0D2B45">
<link rel="apple-touch-icon" href="logo/icon-192_v3.png">
<link rel="icon" type="image/png" href="logo/icon-192_v3.png">
    <title>MystiGo - V√°rosi Kalandj√°t√©k Platform</title>
    

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>

.star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: center;
    gap: 10px;
}
.star-rating input { display: none; }
.star-rating label {
    font-size: 2.5rem;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
}
.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
    color: #FFA500;
}

/* Rating badge a thumbnailen */
.rating-badge {
    position: absolute;
    bottom: 35px;
    left: 8px;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 8px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 800;
    color: #0D2B45;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 25;
}



    /* Lebeg≈ë pontsz√°m anim√°ci√≥ */
    .score-float {
        position: fixed;
        pointer-events: none;
        font-weight: 800;
        font-size: 2rem;
        color: #FFA500;
        text-shadow: 0 0 10px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: floatUp 3s ease-out forwards;
    }

    @keyframes floatUp {
    0% { 
        transform: translate(-50%, -50%) translateY(0) scale(0.5); 
        opacity: 0; 
    }
    20% { 
        opacity: 1; 
        transform: translate(-50%, -50%) translateY(-20px) scale(1.2); 
    }
    100% { 
        transform: translate(-50%, -50%) translateY(-100px) scale(1); 
        opacity: 0; 
    }
}

    /* R√°zk√≥d√≥ anim√°ci√≥ hib√°s v√°lasz eset√©n az input mez≈ëre */
    .shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }
</style>



    
    <link rel="preload" href="logo/MystiGo_logo.png" as="image">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        // 1. Defini√°ld az alap√©rtelmezett beleegyez√©si √°llapotot a CMP k√≥dja el≈ëtt!
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('consent', 'default', {
            'ad_storage': 'denied', // Hirdet√©s t√°rol√°s tiltva
            'analytics_storage': 'denied', // Analitika t√°rol√°s tiltva
            'wait_for_update': 500 // 500 ms v√°rakoz√°s a CMP-re
        });
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1SBQQGDGL7"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'G-1SBQQGDGL7');
    </script>
    <script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"hu","siteId":2549400,"cookiePolicyId":40995967, "consentOnContinuedBrowsing": false, "callback": { onConsentGiven: function() { gtag('consent', 'update', { 'analytics_storage': 'granted', 'ad_storage': 'granted' }); }, onConsentRejected: function() { gtag('consent', 'update', { 'analytics_storage': 'denied', 'ad_storage': 'denied' }); }}};
    </script>
    <script type="text/javascript" src="https://cdn.iubenda.com/cs/tcf/stub.js"></script>
<script type="text/javascript" src="https://cdn.iubenda.com/cs/iubenda_cs.js" charset="utf-8"></script>
    <style>
        /* --- Arculat friss√≠tve a le√≠r√°s alapj√°n (t√ºrkiz, narancs, s√∂t√©tk√©k) --- */
        :root {
            --brand-cyan: #00CED1; /* T√ºrkiz */
            --brand-blue: #0D2B45; /* S√∂t√©tk√©k */
            --brand-orange: #FFA500; /* Narancs */
            --background-start: #E0F7FA;
            --background-end: #FFFFFF;
            --text-dark: #2D3748;
            --text-heading: var(--brand-blue);
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(180deg, var(--background-start) 0%, var(--background-end) 70%);
            overscroll-behavior-y: contain;
            touch-action: manipulation;
        }
       

#content-page-wrapper {
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }


/* Siker k√°rtya anim√°ci√≥ja */
.success-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: white;
    padding: 15px 25px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 11000;
    border: 2px solid #00CED1;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    min-width: 280px;
}

.success-toast.active {
    transform: translateX(-50%) translateY(0);
}

.success-toast .icon {
    font-size: 24px;
    background: #e0f7fa;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}



/* Avatar k√°rtya alapst√≠lus */
.avatar-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

/* Hover effektus (ha az eg√©r felette van) */
.avatar-card:hover:not(.selected) {
    transform: translateY(-2px);
    background-color: #f0fdfa; /* Halv√°ny t√ºrkiz */
    border-color: var(--brand-cyan);
}

/* Kijel√∂lt √°llapot anim√°ci√≥ja */
.avatar-card.selected {
    transform: scale(1.05);
    background: linear-gradient(135deg, #ffffff 0%, #e0f7fa 100%);
    border-color: var(--brand-cyan);
    box-shadow: 0 10px 15px -3px rgba(0, 206, 209, 0.2);
}

/* Kis pipa a kijel√∂lt k√°rtya sark√°ban */
.avatar-card.selected::after {
    content: '‚úì';
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--brand-cyan);
    color: white;
    font-size: 10px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}



/* Ellen≈ërz√∂tt pipa st√≠lusa az avatar sark√°ban */
.verified-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    background-color: #3b82f6;
    border: 1.5px solid white;
    border-radius: 50%;
    display: none; /* Alapb√≥l rejtve */
    align-items: center;
    justify-content: center;
    z-index: 10;
    width: 20px;   /* Itt n√∂velheted (pl. 14px-r≈ël 16px-re) */
    height: 20px;  /* Legyen ugyanakkora, mint a width */
    top: -3px;     /* Eltol√°s fentr≈ël (kicsit kijjebb l√≥gjon) */
    right: -3px;
}

/* Akt√≠v √°llapot */
.verified-badge.active {
    display: flex !important;
}

.verified-badge-sm { width: 12px; height: 12px; }
.verified-badge-sm svg { width: 7px; height: 7px; color: white; }

.verified-badge-lg { width: 20px; height: 20px; }
.verified-badge-lg svg { width: 15px; height: 15px; color: white; }

/* Egys√©ges avatar kont√©ner a m√©rethez */
.avatar-container {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;  
    height: 32px; 
    font-size: 1.5rem; 
}

	 .main-button {
            background-color: var(--brand-orange);
            color: white;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .main-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .content-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
        }
        #map { 
            height: 200px; 
            width: 100%;
            border-radius: 1rem; 
            border: 3px solid #E0F7FA; 
        }
        .hidden { display: none !important; }

        /* Ir√°nyt≈± jelleg≈± j√°t√©kos ikon */
.player-marker {
    width: 20px !important;
    height: 20px !important;
    background: none !important;   /* T√ñRL√âS: ne legyen k√©k h√°tt√©r */
    border: none !important;       /* T√ñRL√âS: ne legyen feh√©r keret */
    box-shadow: none !important;   /* T√ñRL√âS: ne legyen √°rny√©k */
    position: relative;
    z-index: 1000 !important;
    display: flex;
    align-items: center;
    justify-content: center;
}


.marker-visual {
    width: 20px;
    height: 20px;
    background-color: #007AFF;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 15px rgba(0, 122, 255, 0.6);
    position: relative;
    /* Ez a r√©sz forgatja a bels≈ët */
    transform: rotate(var(--rotation, 0deg));
    transition: transform 0.2s ease-out;
}

/* A ny√≠l a bels≈ë elemre ker√ºl */
.marker-visual::after {
    content: '';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 12px solid #007AFF;
}



        /* task-marker elt√°vol√≠tva, m√°r nem haszn√°ljuk */
        .modal-overlay { z-index: 2000; }
        .geofence-circle {
            animation: pulse 2s infinite;
        }
        
        /* Elt√°vol√≠tva a Leaflet alap√©rtelmezett sz√≠n fel√ºl√≠r√°sa a CSS-ben, hogy a JS vez√©relje azt */
        
        @keyframes pulse {
            0% { stroke-width: 2; opacity: 0.8; }
            70% { stroke-width: 4; opacity: 0.2; }
            100% { stroke-width: 2; opacity: 0.8; }
        }
        .text-brand-orange-500 { color: var(--brand-orange); } /* Seg√©doszt√°ly */
        .text-brand-cyan-500 { color: var(--brand-cyan); } /* Seg√©doszt√°ly */
	.bg-brand-cyan { background-color: var(--brand-cyan) !important; }


        /* JAV√çT√ÅS: Fejl√©c √°llapotjelz≈ë m√©ret√©nek glob√°lis cs√∂kkent√©se (kisebb bet≈±/sz√°m a jobb elrendez√©s√©rt) */
        .game-status-bar {
            font-size: 0.75rem; /* text-xs - Kisebb bet≈±m√©ret */
        }
        
/* --- JAV√çT√ÅS: Ugr√°l√≥ sz√°mok ellen --- */
.tabular-nums {
    font-variant-numeric: tabular-nums; /* Egys√©ges sz√©less√©g≈± sz√°mok */
    font-feature-settings: "tnum";
    letter-spacing: 0.5px; /* Kicsi ritk√≠t√°s az olvashat√≥s√°g√©rt */
    display: inline-block;
    min-width: 40px; /* Hely fenntart√°sa a sz√°moknak */
    text-align: center;
}

	.game-status-bar .flex {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }
        .game-status-bar .flex-col {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }

        /* Vizu√°lis visszajelz√©s a felhaszn√°lt, de √∫jra n√©zhet≈ë seg√≠ts√©gekre */
        button.used {
            background-color: #d1fae5; /* Z√∂ldes h√°tt√©r a megn√©zett seg√≠ts√©gre */
            color: #065f46; /* S√∂t√©tz√∂ld sz√∂veg */
            cursor: pointer;
            border: 1px solid #a7f3d0;
        }
        button.used:hover:not(:disabled) {
            background-color: #a7f3d0;
        }

        /* √ñsszecsukhat√≥ T√∂rt√©net doboz st√≠lusa */
        .story-details {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: #f7fafc;
            position: relative; /* Fontos a gomb abszol√∫t pozicion√°l√°s√°hoz */
        }
        .story-details summary {
            font-weight: 600;
            color: var(--brand-blue);
            cursor: pointer;
            outline: none;
            padding: 0.5rem 0;
            list-style: none; /* Elt√°vol√≠tja az alap√©rtelmezett nyilat */
            display: flex;
            align-items: center;
            position: relative; /* EZ BIZTOS√çTJA A GOMB FIX√ÅL√ÅS√ÅT A SUMMARY-N BEL√úL */
        }
        .story-details summary::-webkit-details-marker {
            display: none;
        }
        .story-details summary::before {
            content: '+';
            font-size: 1.25rem;
            margin-right: 0.5rem;
            transition: transform 0.2s;
            line-height: 0;
        }
        .story-details[open] summary::before {
            content: '-';
            transform: rotate(0deg);
        }
        .story-content {
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
            margin-top: 0.5rem;
        }
        /* Extra CSS a gomb garant√°lt megjelen√≠t√©s√©hez √©s poz√≠ci√≥j√°hoz (FELOLVAS√ì GOMB JAV√çT√ÅS) */
        #speak-story-btn {
            position: absolute;
            top: 50%; /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            transform: translateY(-50%); /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            right: 0.5rem; /* Be√°ll√≠tja a gomb v√≠zszintes helyzet√©t (bel√ºl) */
            display: flex !important; /* Er≈ësen kik√©nyszer√≠ti a l√°that√≥s√°got */
            width: 32px; /* Kisebb m√©ret */
            height: 32px; /* Kisebb m√©ret */
            align-items: center;
            justify-content: center;
            padding: 0.35rem; /* Kisebb padding */
        }
        
        /* EMOJI JAV√çT√ÅS PDF-HEZ: K√©nyszer√≠tj√ºk a sz√≠nes emoji fontokat */
.avatar-icon {
    display: inline-block;
    margin-right: 0.25rem;
    font-size: 1.5rem; /* Kicsit nagyobbra vessz√ºk */
    line-height: 1;
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
}
        
        /* J√ÅT√âK K√ñZBENI FEJL√âC √âS STATUS BAR ST√çLUSAI */
        #game-header-logo-container {
            position: absolute;
            top: 5px !important;  /* Teljesen a tetej√©re h√∫zzuk */
            left: 10px !important;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        
/* --- √öJ SZAB√ÅLY: Fejl√©c magass√°g√°nak n√∂vel√©se --- */
        
        #game-header-logo {
            height: 60px !important; /* Kisebb m√©ret, hogy ne l√≥gjon bele semmibe */
            width: auto;
            object-fit: contain;
        }
        
        /* 2. K√ñZ√âPS≈ê R√âSZ (N√©v + Avatar + Teszt felirat) */
        #center-header-content {
    position: absolute;
    top: 10px !important; /* 0px helyett 10px, √≠gy lejjebb ker√ºl */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1005;
    width: auto;
    padding-top: 5px;
}
        
        #team-name-container {
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            background-color: rgba(255, 255, 255, 0.9); /* Feh√©r h√°tt√©r, hogy olvashat√≥ legyen */
            padding: 2px 10px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2px; /* Hely a teszt feliratnak */
        }
        
        /* Teszt m√≥d felirat st√≠lusa */
        #test-mode-indicator {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0 4px;
            border-radius: 4px;
            font-size: 0.65rem !important; /* Kisebb bet≈±m√©ret, hogy elf√©rjen */
            line-height: 1.2;
        }
        
        /* 3. STATUS BAR (Pontsz√°m, Id≈ë - LEJJEBB TOLVA) */
        #game-status-bar {
             position: absolute;
             top: 67px !important; /* FONTOS: Ez tolja le a s√°vot, hogy ne fedje √°t a nevet! */
             left: 0;
             right: 0;
             z-index: 900;
             display: flex;
             justify-content: center;
        }
        
        /* 4. KIL√âP√âS GOMB (Jobb fels≈ë sarok) */
        #exit-game-btn {
            position: absolute;
            z-index: 1000;
            top: 5px !important; 
            right: 10px !important;
            /* Biztos√≠tjuk, hogy a gomb m√©rete fix legyen */
            width: 35px;
            height: 35px;
            padding: 6px;
        }

        /* Hiba bejelent√©s modal st√≠lusai */
        #report-error-modal {
            z-index: 9999; 
            background-color: rgba(0, 0, 0, 0.7);
        }
      


	 #report-error-modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 90%;
            width: 350px;
        }
        
        /* --- KALANDV√ÅLASZT√ì OLDAL FEJL√âC ST√çLUSAI (JAV√çTVA) --- */
        
                
        /* K√∂z√©ps≈ë log√≥ m√©ret√©nek kicsiny√≠t√©se a Kalandv√°laszt√≥ oldalon */
        #main-header-logo {
            max-width: 90px; /* Elegend≈ë helyet hagy az oldals√≥ k√©peknek √©s az alatta l√©v≈ë tartalomnak */
            height: auto;
        }
        
        /* --- LANDING PAGE (IND√çT√ì OLDAL) VISSZA√ÅLL√çTOTT ST√çLUSAI --- */
        #landing-page .w-full.h-\[20vh\] {
            height: 20vh; 
            padding-top: 2rem; 
        }
        
        /* Az SVG log√≥ eredeti m√©rete (a HTML-ben w-48) */
        #landing-page svg {
            width: 12rem; 
            height: auto;
        }
        /* Mivel a kor√°bbi k√≠s√©rletben beillesztett√ºk a #landing-logo-container-t, azt most elt√°vol√≠tjuk
           √©s vissza√°ll√≠tjuk az eredeti k√≥dot az ind√≠t√≥ oldalon. */
        
        /* √öJ CSS: T√©rk√©pes feladat v√°laszt√≥ marker EXPLORE m√≥dhoz */
        .task-selector-marker {
            background-color: var(--brand-cyan);
            border: 3px solid white;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            box-shadow: 0 0 10px var(--brand-cyan);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }



/* Iubenda lebeg≈ë ikon elrejt√©se */
        /* --- Iubenda GOMB TELJES ELT√úNTET√âSE (Mobilon is) --- */
#iubenda-cs-badge,         /* Asztali ID */
.iubenda-cs-badge,         /* Mobil Class */
.iubenda-cs-rat,           /* Egy√©b vari√°ci√≥ */
.iubenda-ibadge,           /* Lebeg≈ë badge class */
.iub-badge-container,      /* Kont√©ner */
#iubenda-iframe-footer {   /* Iframe alap√∫ l√°bl√©c */
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    width: 0 !important;
    height: 0 !important;
    z-index: -9999 !important;
}


/* --- T√©rk√©p copyright felirat kicsiny√≠t√©se --- */
.leaflet-control-attribution {
    font-size: 7px !important; /* Nagyon pici bet≈±m√©ret */
    line-height: 9px !important;
    background: rgba(255, 255, 255, 0.5) !important; /* F√©lig √°tl√°tsz√≥ h√°tt√©r */
    padding: 0 4px !important;
    border-radius: 4px 0 0 0;
    opacity: 0.6; /* Alapb√≥l halv√°ny */
    transition: opacity 0.3s;
}

/* Ha f√∂l√© viszi az egeret (desktopon), legyen olvashat√≥ */
.leaflet-control-attribution:hover {
    opacity: 1;
}

/* A linkek sz√≠ne legyen sz√ºrke, ne a felt≈±n≈ë k√©k */
.leaflet-control-attribution a {
    color: #555 !important; 
    text-decoration: none !important;
}

#team-name-input {
            margin-bottom: 2px !important; /* Itt √°ll√≠thatod a pixel √©rt√©ket */
        }


#filter-container {
            background-color: #f3f4f6 !important; /* Halv√°ny sz√ºrke h√°tt√©r */
            border-color: #d1d5db !important;     /* Hat√°rozottabb, er≈ësebb sz√ºrke szeg√©ly */
            border-width: 1px !important;         /* 2 pixel vastags√°g a j√≥ l√°that√≥s√°g√©rt */
            border-style: solid !important;
            border-radius: 1rem !important;      /* Lekerek√≠t√©s a t√∂bbi boxhoz igaz√≠tva */
        }

    </style>
</head>
<body class="overflow-hidden">

<div id="offline-indicator" class="hidden fixed top-0 left-0 text-[6px] font-mono font-bold text-red-900 opacity-50 z-[9999] pointer-events-none select-none tracking-widest" style="text-shadow: 0 0 2px white;">
    üî¥ Offline
</div>

    <div id="app-container" class="max-w-md mx-auto h-[100dvh] flex flex-col relative transition-all duration-500">

        <main id="landing-page" class="flex flex-col items-center justify-between text-center text-brand-blue h-full p-8">
            
            <div class="w-full h-[15vh] flex flex-col items-center justify-start pt-2">
                <h1 id="landing-title" class="text-6xl font-extrabold tracking-tight" style="text-shadow: 0 4px 15px rgba(0,0,0,0.1);"><span id="logo-o" class="text-brand-orange-500 cursor-pointer"></span></h1>
                
            </div>
            
            <div class="w-full flex flex-col justify-start flex-grow"> 
                <p id="loading-status" class="text-gray-600 my-4 h-5">Adatb√°zis automatikus bet√∂lt√©se...</p>
                
                
                <div id="game-order-setup" class="my-4 p-4 bg-gray-50 rounded-xl hidden"></div> 
            </div>
            
            </main>
        
        <div id="content-wrapper" class="hidden absolute inset-0 transition-transform duration-500 translate-y-full">
            <div id="header" class="relative text-text-heading text-center pt-1 pb-10">
                 <div id="main-header">

<span class="absolute top-0 right-2 text-[9px] text-gray-500 font-mono tracking-widest opacity-50 pointer-events-none select-none">
       v1.2.38

   </span>

   <div id="main-header-logo-row" class="flex justify-center items-center mb-2 px-4">
       
        <img id="main-header-logo" src="logo/MystiGo_logo.png" alt="MystiGo Log√≥" class="w-full max-w-xs mx-4">
                 
   </div>
   <h1 id="page-title" class="text-sm font-bold tracking-wider mb-1">Fedezd fel a v√°rost</h1>
</div>
                 
                 <div id="game-header-logo-container" class="hidden">
                    <img id="game-header-logo" src="logo/MystiGo_logo.png" alt="MystiGo Log√≥">
                 </div>
                 
                 <div id="center-header-content" class="hidden">
                     <span id="test-mode-indicator" class="text-[10px] font-bold text-brand-orange-500 hidden mb-1 leading-tight">TESZT M√ìD</span>
		     <div id="team-name-container" class="text-sm font-semibold text-brand-blue/80 block">
                        <span id="game-team-avatar-icon" class="avatar-icon"></span>
                        <span id="team-name-display"></span>
                     </div>
                  </div>
                 
                 <div id="game-status-bar" class="hidden px-2 w-full flex justify-center">
    <div class="bg-white/90 backdrop-blur-sm rounded-full flex justify-between items-center px-3 py-2 text-xs font-semibold shadow-md w-full max-w-sm border border-gray-100">
        
        <div class="px-2 whitespace-nowrap text-brand-blue -ml-2">
    Feladat: <span id="task-progress-display">1/10</span>
</div>
        
        <div class="flex items-center gap-1.5">
            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-brand-blue min-w-[70px]">
                <svg class="w-3 h-3 text-brand-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span id="timer-display" class="tabular-nums">00:00</span>
            </div>

            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-green-700 min-w-[70px]">
                <svg class="w-3 h-3 text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                <span id="geofence-timer-display" class="tabular-nums">00:00</span>
            </div>

            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-brand-orange-500 min-w-[50px]">
                <svg class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                <span id="score-display" class="tabular-nums">0</span>
            </div>
        </div>
    </div>
</div>
                 
                 <button id="exit-game-btn" onclick="showExitConfirmation()" 
    class="absolute top-4 right-4 p-2.5 rounded-full text-white 
           bg-gradient-to-br from-red-400 to-red-600 
           border-2 border-white 
           shadow-lg shadow-red-500/30 
           hover:scale-110 hover:from-red-500 hover:to-red-700 hover:shadow-red-500/50
           transition-all duration-200 ease-in-out hidden z-50">
    <svg class="w-5 h-5 drop-shadow-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
</button>
                 
                 <svg class="absolute bottom-0 left-0 w-full" viewBox="0 0 1440 120" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1440 120H0V65.1721C0 65.1721 289.431 0 720 0C1150.57 0 1440 65.1721 1440 65.1721V120Z" fill="white"/></svg>
            </div>
            
            <div id="content-page-wrapper" class="absolute top-40 bottom-0 left-0 right-0 overflow-y-auto px-6 pb-6 bg-white">
                
                <section id="game-list-page" class="hidden">
                    <div id="game-list-controls" class="space-y-4 mb-6">
                        
                        
                        <div id="secret-switches-container" class="mt-4 p-4 bg-gray-50 rounded-xl hidden">
                            <h2 id="developer-tools-toggle" class="text-xs font-bold text-text-heading mb-3 cursor-pointer select-none flex justify-between items-center">
                                Fejleszt≈ëi Eszk√∂z√∂k
                                <span class="text-gray-50">‚ñº</span>
                            </h2>
                            <div id="developer-options" class="space-y-2 hidden">
                                

<button onclick="openGlobalLeaderboard()" class="main-button w-full text-sm block !bg-purple-600 hover:!bg-purple-700 my-4 flex items-center justify-center gap-2">
    üåé Glob√°lis Ranglista (√ñsszes J√°t√©k)
</button>




				<button onclick="openStorageManager()" class="main-button w-full text-sm block !bg-gray-700 hover:!bg-gray-800 my-4 flex items-center justify-center gap-2">
				    üíæ LocalStorage Kezel≈ë (R√©szletes)
				</button>

				<button id="list-all-games-btn" class="main-button w-full text-sm block !bg-indigo-600 hover:!bg-indigo-700 my-4">
			         √ñsszes J√°t√©k List√°z√°sa (Rejtett is)
			        </button>
                             

                                <button onclick="window.open('MystiGo_game_creator.html', '_blank')" class="main-button w-full text-sm block !bg-blue-600 hover:!bg-blue-700 my-4">
                                     Game Creator (Megnyit√°s)
                                </button>
                                
                                                                
                                <fieldset id="game-mode-select-fieldset" class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                    <legend class="text-xs font-bold text-text-heading mb-2">J√°t√©k M√≥d V√°laszt√°sa:</legend>
                                    <div class="space-y-1">
                                        
                                        <label for="mode-normal" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-normal" name="game_mode_selection" value="normal" checked class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Norm√°l J√°t√©k (GPS sz√ºks√©ges)</span>
                                        </label>
                                        
                                                                             
                                        <label for="mode-mock" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-mock" name="game_mode_selection" value="mock" class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Manu√°lis GPS (T√©rk√©pen kattint√°s)</span>
                                        </label></div>
                                </fieldset>
                                <div id="game-mode-settings" class="p-4 bg-gray-100 rounded-xl border border-gray-200 mt-4">
                                    <p class="text-sm font-semibold text-brand-blue mb-2">Feladatok √©s Sorrend</p>
                                    
                                    <select id="task-order-select" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm mb-3">
                                        <option value="sequential">Szekvenci√°lis (Sorban)</option>
                                        <option value="random">V√©letlenszer≈± (Random)</option>
					<option value="explore">Explore (√∂sszes pont l√°tszik)</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                        
                        <details id="game-type-explanation" class="story-details mb-4" style="background-color: #fefce8; border-color: #fde68a;">
    <summary style="font-weight: 800; color: var(--brand-blue); padding: 0.5rem; display: flex; align-items: center;">
        <span class="text-xl mr-2">‚ÑπÔ∏è</span> Hogyan m≈±k√∂dik a MystiGo?
        <span style="position: absolute; right: 0.75rem; top: 0.8rem; font-size: 1.5rem;"></span>
    </summary>
                            <div class="story-content" style="border-top: 1px solid #fde68a; margin-top: 0.5rem; padding-top: 0.5rem;">
                                
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p>üì± Telefon + GPS + internet sz√ºks√©ges</p>
                                   <p>üîã T√∂ltsd fel az akkut (vagy hozz powerbankot)</p>
				   <div class="my-3 p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center gap-3">
    <div class="shrink-0 flex flex-col items-center gap-1">
    <img src="logo/verified.png" alt="Verified" class="h-12 w-auto object-contain">

    <div class="flex items-center gap-1">
        <img src="logo/google_logo.svg" alt="Google" class="h-4 w-auto object-contain">
        <span class="text-[16px] leading-none text-gray-600"><strong>‚úâÔ∏é</strong></span>
    </div>
</div>

<div class="ml-3"> <p class="font-bold text-brand-blue leading-tight text-[15px]">Mi√©rt √©rdemes bel√©pni?</p>
    <p class="text-[12px] leading-snug mt-1 text-gray-700">
    Regisztr√°lj, hogy a rendszer <strong>megjegyezze a neved √©s az avatarod</strong>! √çgy gy≈±jtheted az <strong>√∂sszes√≠tett ‚≠ê pontjaidat</strong>, felker√ºlhetsz az exkluz√≠v <strong>Dics≈ës√©gfal</strong> ‚ú® ranglist√°ra, az avatarod mell√© pedig megkapod a <strong>hiteles√≠tett (blue check)</strong> jelv√©nyt!
</p>
</div>
</div>

                                   <p>üìç Menj a j√°t√©k kezd≈ëpontj√°ra ‚Äì ott indul el a j√°t√©k</p>
                                   <p>üó∫Ô∏è K√∂vesd a t√©rk√©pen a c√©lpontokat</p>
                                   <p>üß© A k√©rd√©s csak a helysz√≠nen jelenik meg</p>
                                   <p>‚≠ê Minden feladat 50 pontot √©r</p>
                                   <p>üí° K√©rhetsz 2 seg√≠ts√©get (‚àí10 / ‚àí20 pont) vagy megold√°st (0 pont)</p>
                                   <p>‚ùå Minden rossz v√°lasz: ‚àí1 pont</p>
                                   
                                   <div class="mt-3 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                       <p class="font-bold text-brand-blue mb-1">üèÜ Rangsorol√°s sorrendje:</p>
                                       <ol class="list-decimal list-inside space-y-1 ml-1">
                                           <li><strong>‚≠êSzerzett Pontok</strong> (Ez a legfontosabb!)</li>
                                           <li><strong>üß©Feladat id≈ë</strong> (Csak a k√©rd√©s megold√°sa alatt telik)</li>
                                           <li><strong>‚è±Ô∏èTeljes id≈ë</strong> (S√©ta + gondolkod√°s)</li>
                                       </ol>
                                       <div class="mt-2 flex items-start gap-2 text-xs text-blue-800 bg-white p-2 rounded border border-blue-100">
                                           <span class="text-lg">üí°</span>
                                           <span><strong>Tipp:</strong> Nem kell rohanni a helysz√≠nek k√∂z√∂tt! A teljes id≈ë sz√°m√≠t legkev√©sb√©. Team j√°t√©kn√°l nyugodtan s√©t√°ljatok, a pontoss√°g √©s a biztons√°g a legfontosabb!</span>
                                       </div>
                                   </div>

                                   <p>‚è±Ô∏è K√©t id≈ëm√©r√©s a k√©perny≈ën:</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ üîµ K√©k = Teljes id≈ë (kev√©sb√© sz√°m√≠t)</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ üü¢ Z√∂ld = Feladat id≈ë (fontosabb!)</p>
                                   <p class="mt-2">‚ö†Ô∏è Ha gond van az adott feladattal, haszn√°ld a <strong>‚ÄûFeladat √°tugr√°sa‚Äù</strong> gombot, de ilyenkor az adott feladat 0 pontot fog √©rni.</p>
                                </div>
                                
                                <h2 class="text-lg font-bold text-text-heading mt-4 mb-2">Kaland T√≠pusok Magyar√°zata</h2>
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p><strong>Normal üß≠:</strong> √Åltal√°nos kaland, feln≈ëtt/tin√©dzser (14+) j√°t√©kosoknak sz√°nt k√©rd√©sekkel √©s feladatokkal. A feladatok sorrendben k√∂vetik egym√°st.</p>
                                    <p><strong>Kids üêà:</strong> Kimondottan 6-12 √©ves gyerekeknek sz√≥l√≥, egyszer≈±bb k√©rd√©sek, a Mysti cica t√∂rt√©net√©vel f≈±szerezve, sorban halad√≥ feladatokkal.</p>
                                    <p><strong>Team üßë‚Äçü§ù‚Äçüßë:</strong> Csapatj√°t√©kra optimaliz√°lt. A feladatok *v√°ltoz√≥ sorrendben* j√∂nnek egym√°s ut√°n, egyszerre tudnak indulni egy helyr≈ël a csapatok, √©s egy helyen v√©geznek a j√°t√©k v√©g√©n.</p>
                                    <p><strong>Explore üåç:</strong> A j√°t√©kos szabadon v√°laszt a t√©rk√©pen l√©v≈ë feladatok k√∂z√ºl. A c√©lpontok a j√°t√©k ind√≠t√°sa ut√°n egyszerre l√°that√≥k a t√©rk√©pen.</p>
				    <p><strong>Instant üé≤:</strong> B√°rhol elind√≠that√≥, <strong>"Azonnali kaland"</strong> a pillanatnyi tart√≥zkod√°si helyed k√∂r√© gener√°lt egyedi kaland, v√°laszthat√≥ tematik√°j√∫ √©s neh√©zs√©gi szint≈± feladatokkal.</p>
                                </div>


<div class="mt-6 pt-4 border-t border-gray-200">
                                    <p class="text-xs font-bold text-gray-500 mb-1 text-center uppercase tracking-wide">Probl√©m√°d ad√≥dott?</p>
                                    
                                    <p class="text-[10px] text-gray-400 text-center mb-3 italic">
                                        (Minden oldal legalj√°n is megtal√°lod ezt a gombot)
                                    </p>

                                    <a href="https://forms.gle/Kzt5CvVrCxec2bby9" target="_blank" 
                                       class="block w-full py-2.5 rounded-lg border border-red-200 bg-white text-xs font-bold text-center text-red-600 hover:bg-red-50 hover:border-red-300 transition shadow-sm flex items-center justify-center gap-2">
                                        <span>üì¢</span> Visszajelz√©s / Hiba bejelent√©se
                                    </a>
                                </div>
                                </div> </details>





                        <div id="team-setup" class="p-5 bg-blue-50 rounded-2xl border-2 border-blue-100 shadow-inner mb-6">
    
    <div class="flex justify-between items-center mb-3 px-1">
        <h2 class="text-sm font-bold text-brand-blue uppercase tracking-wider">J√°t√©kos<span class="text-red-500">*</span></h2>
        <label class="flex items-center cursor-pointer gap-2 select-none bg-yellow-100 px-2.5 py-1 rounded-full border border-yellow-200 hover:bg-yellow-200 transition">
            <span class="text-[10px] font-extrabold text-yellow-800 uppercase">Kids üêà</span>
            <input type="checkbox" id="kids-mode-checkbox" class="w-3.5 h-3.5 text-brand-orange border-gray-300 rounded accent-orange-500">
        </label>
    </div>

    <div class="flex items-center justify-between mb-1 bg-white/80 p-1 rounded-xl border border-white shadow-sm">
        <div class="flex items-center gap-2">
            <div id="auth-buttons-group" class="flex gap-2">
                <button id="google-login-btn" onclick="loginWithGoogle()" 
                        class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all active:scale-95"
                        title="Google">
                    <img src="logo/google_logo.svg" class="w-6 h-6">
                </button>

                <button id="email-auth-btn" onclick="openEmailAuthModal()" 
                        class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all active:scale-95" 
                        title="Email bejelentkez√©s">
                    <svg class="w-6 h-6 text-brand-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </button>
            </div>

            <div id="email-auth-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 10000;">
                <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl">
                    <h2 id="email-modal-title" class="text-xl font-bold text-brand-blue mb-4 text-center">Bejelentkez√©s</h2>
                    <div class="space-y-3">
                        <input type="email" id="auth-email" placeholder="Email c√≠m" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-brand-cyan">
                        <input type="password" id="auth-password" placeholder="Jelsz√≥" class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-brand-cyan">
                        <div id="email-auth-error" class="text-red-500 text-xs hidden font-bold"></div>
                    </div>
                    <button id="email-primary-btn" onclick="handleEmailAuth()" class="main-button w-full mt-4 !py-2 !text-sm">Bejelentkez√©s</button>
                    <div class="mt-4 text-center">
                        <button id="email-toggle-mode" onclick="toggleEmailAuthMode()" class="text-xs text-brand-cyan-500 font-semibold hover:underline">Nincs m√©g fi√≥kod? Regisztr√°ci√≥</button>
                    </div>
                    <button onclick="closeEmailAuthModal()" class="w-full mt-2 text-xs text-gray-400 hover:text-gray-600 py-1">M√©gse</button>
                </div>
            </div>

            <button id="logout-btn" onclick="logout()" 
                    class="hidden w-9 h-9 flex items-center justify-center bg-white border border-red-100 text-red-500 rounded-xl shadow-sm hover:bg-red-50 transition-all active:scale-95">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                </svg>
            </button>

            <div id="user-info-display" class="flex flex-col overflow-hidden">
                <p id="auth-status-label" class="text-[10px] font-bold text-gray-400 uppercase leading-none mb-1">St√°tusz</p>
                <p id="auth-user-name" class="text-xs font-bold text-brand-blue truncate max-w-[120px] leading-tight"></p>
            </div>
        </div>

        <div id="total-score-display" class="hidden flex items-center gap-2">
            <div class="text-right">
                <p class="text-[9px] font-bold text-gray-400 uppercase leading-none">√ñsszpont</p>
                <p class="text-sm font-black text-brand-blue tracking-tight leading-none"><span id="user-total-score">0</span> ‚≠ê</p>
            </div>
            <button onclick="openHallOfFame()" class="w-8 h-8 flex items-center justify-center bg-white border border-cyan-100 text-brand-cyan rounded-lg shadow-sm">
                <span class="text-sm">‚ú®</span>
            </button>
        </div>
    </div>

    <input type="text" id="team-name-input" maxlength="25" placeholder="Pl.: Vill√°m-Macsk√°k 2024" 
           class="w-full px-4 py-3 border-2 border-blue-100 rounded-xl text-sm focus:ring-2 focus:ring-brand-blue outline-none shadow-sm mb-4">

    <div class="flex flex-col items-center gap-2 mt-2 mb-6">
        <div class="relative cursor-pointer group" onclick="openAvatarSelector()">
            <div id="avatar-preview-container" 
                 class="w-20 h-20 rounded-full bg-white border-4 border-white shadow-lg flex items-center justify-center text-5xl transition-all duration-300 group-hover:scale-105 ring-4 ring-brand-cyan/10">
                ‚ùì
            </div>
            <div id="preview-verified-badge" class="verified-badge verified-badge-lg">
                <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
        </div>
        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Avatar v√°laszt√°sa</p>
    </div>

    <select id="team-avatar-select" class="hidden"></select>

    <div id="avatar-selector-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-[9999]">
        <div class="bg-white rounded-3xl w-full max-w-sm max-h-[75vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-brand-blue">V√°lassz karaktert</h3>
                <button onclick="closeAvatarSelector()" class="text-gray-400 p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="avatar-grid" class="p-6 overflow-y-auto grid grid-cols-4 gap-4 bg-white"></div>
        </div>
    </div>

   <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-blue-100">
    <button id="gps-test-btn" onclick="testGpsConnection()" 
            class="flex flex-col items-center justify-center py-1.5 px-3 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 rounded-xl transition-all shadow-sm active:scale-95">
        <span class="text-base mb-0.5">üõ∞Ô∏è</span> <span class="text-[10px] font-bold uppercase">GPS Teszt</span>
    </button>

    <button onclick="startSpecificTestGame()" 
            class="flex flex-col items-center justify-center py-1.5 px-3 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 rounded-xl transition-all shadow-sm active:scale-95">
        <span class="text-base mb-0.5">üéÆ</span> <span class="text-[10px] font-bold uppercase">Pr√≥ba J√°t√©k (GPS n√©lk√ºl)</span>
    </button>
</div>

    <div id="gps-test-container" class="hidden mt-4 bg-white/60 p-3 rounded-xl border border-blue-100 relative">
        <button onclick="closeGpsTest()" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 transition">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <p id="gps-test-status" class="text-[11px] font-bold text-center text-brand-blue mb-2">üì° Jel keres√©se...</p>
        <div id="gps-test-map" class="w-full h-32 rounded-lg border border-blue-100 mb-2"></div>
        <div id="gps-result-message" class="hidden p-2 rounded-lg text-[11px] font-bold text-center"></div>
        <div class="text-[9px] text-gray-400 text-center">Pontoss√°g: <span id="gps-accuracy-value">-</span> m</div>
    </div>
</div>
          

          
<div id="filter-container" class="bg-gray-200 p-4 rounded-xl shadow-sm border border-gray-100 mb-6 transition-all duration-300">
    <div onclick="toggleFilterSection()" class="cursor-pointer flex items-center justify-between select-none">
        <h3 class="text-sm font-bold text-brand-blue flex items-center">
            <span id="filter-toggle-icon" class="mr-2 text-lg font-extrabold text-black leading-none" style="margin-top: -2px;">+</span>
            
            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            Kaland Keres√©se & Sz≈±r√©se
        </h3>
    </div>
    
    <div id="filter-content" class="hidden mt-3 pt-3 border-t border-gray-100">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">Helysz√≠n</label>
                <select id="filter-location" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                    <option value="all">√ñsszes Helysz√≠n</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">T√≠pus</label>
                <select id="filter-type" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                    <option value="all">√ñsszes T√≠pus</option>
                    <option value="normal">Normal üß≠</option>
                    <option value="kids">Kids üêà</option>
                    <option value="team">Csapat üßë‚Äçü§ù‚Äçüßë</option>
                    <option value="explore">Explore üåç</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">Keres√©s (N√©v, ID, V√°ros...)</label>
            <div class="relative">
                <input type="text" id="filter-search" oninput="applyFilters()" placeholder="√çrj be valamit..." class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>
       
<div class="mt-3 pt-3 border-t border-gray-100">
            
            <button onclick="openGameMap()" class="w-full mb-2 py-2 bg-white border-2 border-brand-blue text-brand-blue hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
                üó∫Ô∏è J√°t√©kok megjelen√≠t√©se t√©rk√©pen
            </button>

            <button onclick="sortGamesNearby()" id="btn-sort-nearby" class="w-full py-2 bg-white border-2 border-brand-blue text-brand-blue hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
                üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)
            </button>
            
            <p id="nearby-status" class="text-[10px] text-center text-gray-400 mt-1 hidden"></p>
        </div>
    </div>
</div>


<div id="instant-adventure-container" class="relative bg-orange-50 p-4 rounded-xl border border-gray-200 mb-6 shadow-sm">
    <button onclick="openLeaderboardModal('instant_kozos')" 
            class="absolute top-2 right-2 bg-white text-orange-500 w-8 h-8 rounded-full shadow-md border border-orange-200 hover:bg-orange-100 transition flex items-center justify-center z-10">
        üèÜ
    </button>

    <div class="mb-3">
        <label class="text-[12px] font-bold text-gray-700 uppercase tracking-wide ml-1">Azonnali Kaland:</label>
    </div>

    <div id="instant-custom-header" onclick="toggleInstantCustomization()" class="cursor-pointer flex items-center justify-between bg-white/50 p-2 rounded-lg border border-orange-200 mb-3 select-none">
        <span class="text-[11px] font-bold text-orange-800 flex items-center">
            <span id="instant-custom-icon" class="mr-2 text-lg">+</span> ‚öôÔ∏è Testreszab√°s (Opcion√°lis)
        </span>
        <span id="target-status-dot" class="w-2 h-2 rounded-full bg-gray-300"></span>
    </div>

    <div id="instant-custom-content" class="hidden space-y-3 mb-4 pt-1">
        <div class="grid grid-cols-2 gap-2">
            <select id="instant-category-select" class="px-2 py-2 border-2 border-gray-200 rounded-lg text-[11px] bg-white font-bold text-gray-600">
                <option value="all">üé≠ √ñsszes t√©ma</option>
                <option value="movies">üé¨ Filmek √©s Zen√©k</option>
                <option value="tales">üêà Mes√©k</option>
                <option value="science">üî≠ Tudom√°ny</option>
                <option value="history">üìú T√∂rt√©nelem</option>
                <option value="sport">‚öΩ Sport</option>
                <option value="lifestyle">üè† Mindennapok</option>
                <option value="nature">üåø Term√©szet</option>
            </select>

            <select id="instant-difficulty-select" class="px-2 py-2 border-2 border-gray-200 rounded-lg text-[11px] bg-white font-bold text-gray-600">
    <option value="all">üîÄ B√°rmely szint</option>
    <option value="easy">üü¢ K√∂nny≈±</option>
    <option value="medium">üü° K√∂zepes</option>
    <option value="hard">üî¥ Neh√©z</option>
</select>

<div class="col-span-2 mt-1">
    <label class="text-[9px] font-bold text-gray-400 uppercase ml-1">Feladatok sz√°ma:</label>
    <select id="instant-task-count-select" class="w-full px-2 py-2 border-2 border-gray-200 rounded-lg text-[11px] bg-white font-bold text-gray-600">
        <option value="3">ü•â R√∂vid kaland (3 feladat)</option>
        <option value="5" selected>ü•à Norm√°l kaland (5 feladat)</option>
        <option value="8">ü•á Hossz√∫ kaland (8 feladat)</option>
        <option value="10">üèÜ Epikus kaland (10 feladat)</option>
    </select>
</div>
        </div>

        <div class="flex gap-2">
            <button onclick="openInstantTargetMap()" class="flex-1 py-2 bg-white border border-orange-300 text-orange-700 rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-1 shadow-sm">
                üéØ C√©lpont kijel√∂l√©se
            </button>
            <button id="reset-target-btn" onclick="resetInstantTarget()" class="hidden px-3 py-2 bg-red-50 text-red-500 border border-red-200 rounded-lg text-[10px] font-bold">
                ‚úï
            </button>
        </div>
        <p id="target-address-display" class="text-[9px] text-gray-500 italic text-center hidden"></p>
    </div>

    <button id="instant-adventure-btn" 
        onclick="startInstantAdventure()" 
        disabled 
        class="w-full py-3 bg-white border-2 border-brand-orange text-brand-orange hover:bg-orange-500 hover:text-white font-extrabold rounded-xl text-sm transition-all flex items-center justify-center gap-2 shadow-sm disabled:opacity-50">
        üé≤ Kaland Gener√°l√°sa
    </button>


<div id="instant-resume-ui" class="hidden mt-3 pt-3 border-t border-orange-200 justify-between items-center">
        <div class="flex flex-col">
            <span class="text-[10px] font-bold text-orange-600 uppercase">F√©lbehagyott kaland:</span>
            <span class="text-[11px] font-medium text-gray-600">Van egy mentett √°ll√°sod.</span>
        </div>
        <div class="flex gap-2">
            <button onclick="resumeInstantAdventure()" class="px-3 py-2 bg-green-500 text-white text-[10px] font-bold rounded-lg shadow-sm active:scale-95 transition uppercase">Folytat√°s</button>
            <button onclick="deleteInstantAdventure()" class="px-3 py-2 bg-white border border-red-200 text-red-500 text-[10px] font-bold rounded-lg active:scale-95 transition uppercase">T√∂rl√©s</button>
        </div>
    </div>


    </div>

<div id="target-picker-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col h-[70vh]">
        <div class="bg-orange-500 p-4 rounded-t-2xl flex justify-between items-center text-white">
            <h3 class="font-bold">V√°lassz c√©lpontot</h3>
            <button onclick="closeInstantTargetMap()" class="text-white/80">‚úï</button>
        </div>
        <div id="target-picker-map" class="flex-grow w-full"></div>
        <div class="p-4 bg-gray-50 rounded-b-2xl">
            <p class="text-[10px] text-gray-500 mb-2 text-center">B√∂kj a t√©rk√©pre, ahol a kaland √©rjen v√©get!</p>
            <button id="confirm-target-btn" disabled onclick="confirmInstantTarget()" class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl opacity-50">Kijel√∂l√©s meger≈ës√≠t√©se</button>
        </div>
    </div>
</div>


		<div id="game-list" class="space-y-6"></div>
                </section>
                
                <section id="game-page" class="hidden space-y-6">
                    <div class="content-card p-4">


                     
<div id="zoom-level-indicator" class="absolute top-1 left-1 bg-white/50 text-gray-200 text-[10px] px-1 rounded z-[1000] pointer-events-none font-mono">Z: -</div>


   <div id="map"></div>
                        

                        <div class="mt-3 mb-2 flex justify-between items-center px-2 w-full">
       <button id="google-maps-btn" class="flex flex-col items-center justify-center text-xs text-brand-blue font-semibold hover:text-brand-cyan-500 transition" onclick="startNavigation()">
            <img src="logo/google_maps_icon.png" alt="Maps" class="w-5 h-5 mb-0.5 object-contain">
            <span>Navig√°l√°s</span>
        </button>
    
    <div class="flex-1 flex justify-center">
        <p id="distance-info" class="text-center text-xs font-bold whitespace-nowrap"></p>
    </div>
    

<button id="report-error-btn" class="flex flex-col items-center justify-center text-[10px] text-gray-500 font-semibold hover:text-red-500 transition leading-tight" onclick="showReportModal()">
     <span>‚ö†Ô∏è</span>
            <span>Feladat</span>
            <span>√°tugr√°sa</span>
        </button>

</div>


	    <button id="back-to-map-btn" onclick="backToExploreMap()" 
    class="hidden w-full mt-4 mb-2 py-2.5 bg-cyan-50 border-2 border-cyan-500 text-cyan-700 hover:bg-cyan-500 hover:text-white font-bold rounded-xl text-xs transition-all flex items-center justify-center gap-2 shadow-sm transform active:scale-95">
            
    ‚¨ÖÔ∏è  Vissza a t√©rk√©pre (m√°sik feladatot v√°lasztok)
</button>
                        

                        <div id="start-task-button-container" class="mt-4 hidden">
                            <button id="start-game-btn" class="main-button w-full !text-lg !py-3 disabled:!bg-gray-400">
                                üöÄ Kaland Ind√≠t√°sa (Id≈ëm√©r√©s elindul)
                            </button>
                        </div>
                        <div id="explore-selection-container" class="mt-4 hidden text-center">
                            <h3 class="text-lg font-bold text-brand-blue mb-2">V√°lassz Feladatot a T√©rk√©pen!</h3>
                            <p class="text-sm text-gray-600 mb-4">A k√∂vetkez≈ë c√©lpont kiv√°laszt√°s√°hoz kattints egy k√©k jel√∂l≈ëre a t√©rk√©pen.</p>
                        </div>
                        </div>
                    
                    <div id="task-interaction-area"> 
                        <div id="normal-task-content">
                            <div class="content-card p-5">
                                
				<details id="story-details" class="story-details mb-4" open>
                                    <summary>
                                        T√∂rt√©net Olvas√°sa
                                        <button id="speak-story-btn" onclick="speakStory(event)" class="p-1.5 rounded-full bg-red-500 text-white hover:bg-red-600 transition" title="Felolvas√°s ind√≠t√°sa">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 12c0 1.767-1.026 3.29-2.5 4v-8c1.474.71 2.5 2.233 2.5 4zM16 12c0 2.222-1.39 4.14-3.333 4.889l1.455 1.455c2.427-.99 4.344-3.13 4.344-6.344s-1.917-5.354-4.344-6.344l-1.455 1.455C14.61 7.86 16 9.778 16 12zM8 9H4v6h4l5 5V4l-5 5z"/></svg>
                                        </button>
                                    </summary>
                                    <div class="story-content">
                                        <p id="story" class="text-text-dark"></p>
                                    </div>
                                </details>
                                
                                 <p id="prompt" class="font-bold text-lg text-text-heading mb-4"></p>


				<img id="task-image" onclick="openImageModal(this.src)" src="" alt="Feladat k√©p" class="hidden w-full max-h-64 object-contain rounded-xl shadow-sm mb-4 border border-gray-100 cursor-zoom-in hover:opacity-95 transition-opacity">



                                 <div id="answer-input-container" class="flex items-center gap-2">
    <div class="relative flex-grow">
        <input type="text" id="answer-input" placeholder="√çrd be vagy olvasd be..." class="w-full pl-4 pr-12 py-3 text-base border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:bg-gray-100">
        <button id="qr-scan-btn" onclick="openQrScanner()" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-brand-cyan-500 transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
    <button id="submit-answer-btn" class="p-3 bg-cyan-500 text-white rounded-full shadow-lg hover:bg-cyan-600 transition flex-shrink-0">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
    </button>
</div>

<div id="qr-scanner-modal" class="modal-overlay fixed inset-0 bg-black/90 hidden items-center justify-center z-[9999] p-4">
    <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-brand-blue">QR K√≥d Beolvas√°sa</h3>
            <button onclick="closeQrScanner()" class="text-gray-400 p-2 hover:bg-gray-100 rounded-full">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="p-4">
            <div id="qr-reader" class="overflow-hidden rounded-2xl border-2 border-dashed border-gray-200"></div>
            <p class="text-xs text-gray-500 text-center mt-4">Ir√°ny√≠tsd a kamer√°t a kihelyezett QR k√≥dra!</p>
        </div>
        <div class="p-4 bg-gray-50">
            <button onclick="closeQrScanner()" class="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-xl">M√©gse</button>
        </div>
    </div>
</div>


                                 
	     <div id="hint-buttons-container" class="flex justify-between gap-2 mt-4 text-[10px] font-semibold">
    <button id="hint1-btn" class="flex-1 flex flex-col items-center justify-center bg-gray-200 text-gray-700 py-2 rounded-xl disabled:opacity-50">
        <span>Seg√≠ts√©g 1</span>
        <span>(-10 Pont)</span>
    </button>
    
    <button id="hint2-btn" class="flex-1 flex flex-col items-center justify-center bg-gray-200 text-gray-700 py-2 rounded-xl disabled:opacity-50" disabled>
        <span>Seg√≠ts√©g 2</span>
        <span>(-20 Pont)</span>
    </button>
    
    <button id="solution-btn" class="flex-1 flex flex-col items-center justify-center bg-red-100 text-red-700 py-2 rounded-xl disabled:opacity-50" disabled>
        <span>Megold√°s</span>
        <span>(0 Pont)</span>
    </button>
</div>
                                
                                <div style="height: 14rem;">¬†</div>
                            </div>
                        </div>

                        <div id="rescue-task-content" class="hidden"></div> 
                    </div>
                    </section>
                
                <section id="end-page" class="hidden space-y-6 text-center flex flex-col items-center pt-8">
     <div id="pdf-content" class="flex flex-col items-center text-center w-full"> 
        
                        <h2 id="end-title" class="text-4xl font-bold text-text-heading mt-10">Sz√©p munka!</h2>
<p id="end-subtitle" class="text-lg text-text-dark mb-4">Teljes√≠tetted a kalandot.</p>
                         
                        <div id="route-map" style="height: 300px; width: 100%; border-radius: 1rem; border: 3px solid #E0F7FA; margin: 20px 0;"></div> 
                        <p id="end-story" class="text-text-dark my-4 max-w-prose"></p>
<div class="relative my-10"> <div class="absolute inset-0 flex flex-col items-center justify-center text-brand-orange-500">
        <span class="text-5xl font-extrabold" id="final-score" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);"></span> <span class="text-base font-bold">PONT</span> </div>
</div>
<div class="mt-4 text-center space-y-4 p-6 w-full max-w-xs bg-gray-200 rounded-lg mx-auto shadow-md">
    <p class="text-lg font-bold text-text-heading mb-1">
        <span id="final-team-avatar-icon" class="avatar-icon"></span>
        N√©v: <span id="final-team-display"></span>
    </p> 
    <p class="block">üß©Feladat Id≈ë: <strong id="final-geofence-time">00:00</strong></p>
    <p class="block">‚è±Ô∏èTeljes Id≈ë: <strong id="final-time">00:00</strong></p> 
    
<div class="border-t border-gray-200 mt-3 pt-2">
    <p id="end-timestamp" class="text-xs text-gray-400 pb-1 leading-relaxed"></p>
</div>


</div>
                  
                    </div> 



<button onclick="openLeaderboardModal()" class="main-button w-full max-w-xs mx-auto mt-6 mb-2 !bg-brand-blue hover:!bg-cyan-700 shadow-xl flex items-center justify-center gap-2">
    <span>üèÜ</span> Ranglista Megtekint√©se
</button>

 
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                       
    
                    </div>

                    
                    <p class="text-sm text-gray-500 mb-4 mt-4 font-semibold">Oszd meg a teljes√≠t√©sed a k√∂z√∂ss√©gi m√©di√°n:</p>
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                        <button onclick="shareResult('facebook')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Facebookon">
                            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.35c0 .732.593 1.325 1.325 1.325h11.495v-9.294h-3.143v-3.626h3.143v-2.128c0-3.12 1.847-4.815 4.673-4.815 1.326 0 2.464.099 2.802.143v3.25l-1.921.001c-1.503 0-1.802.714-1.802 1.768v2.316h3.618l-.471 3.626h-3.147v9.294h6.115c.732 0 1.325-.593 1.325-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/></svg>
                        </button>
                        <button onclick="shareResult('system')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Instagramon/TikTokon/Egyebek">
                            <img src="logo/share.png" alt="√Åltal√°nos megoszt√°s" class="w-8 h-8">
                        </button>
                    </div>
<p></p>
<p></p>
                    <p class="text-sm text-gray-500 mb-4 mt-10">Amennyiben tetszett a j√°t√©k az al√°bbi lehet≈ës√©geken kereszt√ºl tudsz t√°mogatni minket:</p>

                    <div class="flex space-x-6 justify-center">
                            <a href="https://Revolut.Me/krisztwaeo" target="_blank" title="T√°mogat√°s Revoluton"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="logo/revolut.png" alt="Revolut Log√≥" class="w-8 h-8">
                            </a>
                            
                            <a href="https://paypal.me/mystigohu" target="_blank" title="T√°mogat√°s PayPalon"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="logo/paypal.png" alt="PayPal Log√≥" class="w-8 h-8">
                            </a>
                    </div>                    
                                          
                     <a id="game-review-btn" 
   href="#" 
   target="_blank" 
   class="hidden main-button w-full max-w-xs !text-base hover:!bg-cyan-600 !text-white !font-extrabold mt-4 mb-4"
   style="background-color: var(--brand-cyan) !important;"
   title="√ârt√©keld a kalandot">
   K√©rlek, √âRT√âKELJ MINKET! ‚≠ê
</a>
                     
                     <button onclick="resetApp()" class="main-button w-full max-w-xs mt-auto !text-base">√öj Kaland</button>
                     
                     <div class="mt-4 p-2 text-center text-xs">
                        <a href="https://www.iubenda.com/privacy-policy/40995967" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Adatv√©delmi Szab√°lyzat">Adatv√©delem</a> | 
                        <a href="https://www.iubenda.com/privacy-policy/40995967/cookie-policy" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Cookie Szab√°lyzat">Cookie-k</a> | 
                        
                        <a href="#" class="iubenda-cs-preferences-link text-brand-blue/80 hover:text-brand-cyan-500 transition font-bold">
                            S√ºti Be√°ll√≠t√°sok
                        </a>
                    </div>
                    </section>

<div class="w-full mt-auto pt-6 pb-6 px-4">
                    <a href="https://forms.gle/Kzt5CvVrCxec2bby9" target="_blank" 
                       class="block w-full py-2 rounded-xl border border-gray-200 bg-gray-50 text-[10px] uppercase tracking-widest font-bold text-center text-gray-400 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all cursor-pointer no-underline shadow-sm">
                        üì¢ Visszajelz√©s / Hiba bejelent√©s
                    </a>
                </div>
                </div> </div>
    </div>


            </div>
        </div>
    </div>
 

<div id="pwa-install-container" class="hidden fixed bottom-24 left-4 right-4 z-[9999] animate-bounce">
    <div class="bg-white/95 backdrop-blur-md text-brand-blue p-4 rounded-2xl shadow-2xl border-2 border-brand-cyan flex items-center justify-between relative">
        
        <button onclick="document.getElementById('pwa-install-container').classList.add('hidden')" class="absolute -top-2 -right-2 bg-gray-200 text-gray-600 rounded-full p-1 hover:bg-gray-300 transition shadow-sm">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="flex items-center gap-3 pr-4">
            <img src="logo/MystiGo_logo.png" class="w-10 h-10 rounded-lg shadow-sm" alt="App">
            <div>
                <p class="font-bold text-sm text-[#0D2B45]">MystiGo Alkalmaz√°s</p>
                <p class="text-[10px] text-gray-500 font-medium">Telep√≠tsd a gyorsabb el√©r√©shez!</p>
            </div>
        </div>
        
        <button onclick="triggerPWAInstall()" class="bg-[#FFA500] text-white px-4 py-2 rounded-xl text-xs font-extrabold uppercase shadow-md active:scale-95 transition-transform shrink-0">
            Telep√≠t√©s
        </button>
    </div>
</div>



<div id="ios-install-guide" class="hidden fixed bottom-24 left-6 right-6 z-[9999]">
    <div class="bg-white/95 backdrop-blur-md text-[#0D2B45] p-5 rounded-3xl shadow-2xl border-2 border-[#00CED1] relative">
        <div class="flex flex-col items-center text-center gap-3">
            <div class="flex items-center gap-2">
                <img src="logo/MystiGo_logo.png" class="w-8 h-8 rounded-lg" alt="MystiGo">
                <p class="font-bold text-sm">Telep√≠tsd alkalmaz√°sk√©nt!</p>
            </div>
            <p class="text-xs leading-relaxed">
                Koppints a Safari-ban l√°that√≥ 
                <span class="inline-block bg-gray-100 p-1 rounded-md mx-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                </span> 
                "Megoszt√°s" ikonra, majd g√∂rgess le √©s v√°laszd a ‚ÄûF≈ëk√©perny≈ëh√∂z ad√°s‚Äù opci√≥t!
            </p>
        </div>
        <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[12px] border-t-white/95"></div>
    </div>
</div>



   
    <div id="loading-overlay" class="modal-overlay fixed inset-0 bg-black/50 hidden items-center justify-center"><div class="w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin"></div></div>
    
    <div id="message-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 text-center max-w-sm w-full shadow-xl">
            <h2 id="message-title" class="text-xl font-bold text-text-heading mb-2"></h2>
            <p id="message-body" class="text-text-dark mb-6 whitespace-pre-wrap"></p>
            <div id="modal-button-container" class="flex gap-4">
                <button id="modal-ok-button" class="main-button flex-1 !text-base">Rendben</button>
                <button id="modal-cancel-button" class="main-button flex-1 !text-base !bg-gray-400 hover:!bg-gray-500 hidden">M√©gse</button>
            </div>
        </div>
    </div>


<div id="rating-modal" class="modal-overlay fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center p-4" style="z-index: 10000;">
    <div class="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-[0_20px_50px_rgba(0,0,0,0.3)] text-center relative overflow-hidden border border-white/20">
        
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-orange-100 rounded-full opacity-50"></div>
        
        <div class="relative">
            <div class="bg-orange-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <span class="text-5xl">‚≠ê</span>
            </div>
            
            <h2 class="text-2xl font-black text-brand-blue mb-3 tracking-tight">Hogy tetszett?</h2>
            <p class="text-gray-500 mb-8 leading-relaxed px-4">√ârt√©keld a kalandot, hogy m√°sok is kedvet kapjanak hozz√°!</p>
            
            <div class="star-rating mb-10 flex flex-row-reverse justify-center gap-2">
                <input type="radio" id="star5" name="rating" value="5" checked class="hidden"><label for="star5" class="text-4xl cursor-pointer hover:scale-110 transition-transform">‚òÖ</label>
                <input type="radio" id="star4" name="rating" value="4" class="hidden"><label for="star4" class="text-4xl cursor-pointer hover:scale-110 transition-transform">‚òÖ</label>
                <input type="radio" id="star3" name="rating" value="3" class="hidden"><label for="star3" class="text-4xl cursor-pointer hover:scale-110 transition-transform">‚òÖ</label>
                <input type="radio" id="star2" name="rating" value="2" class="hidden"><label for="star2" class="text-4xl cursor-pointer hover:scale-110 transition-transform">‚òÖ</label>
                <input type="radio" id="star1" name="rating" value="1" class="hidden"><label for="star1" class="text-4xl cursor-pointer hover:scale-110 transition-transform">‚òÖ</label>
            </div>

            <div class="space-y-3">
                <button onclick="window.submitGameRating()" class="main-button w-full !bg-gradient-to-r from-orange-400 to-orange-500 !py-4 rounded-2xl shadow-lg shadow-orange-200 hover:shadow-orange-300 transition-all active:scale-95 font-bold text-lg">
                    √ârt√©kel√©s bek√ºld√©se
                </button>
                
                <button onclick="window.closeRatingModal()" class="w-full py-2 text-gray-400 text-sm font-semibold hover:text-gray-600 transition-colors uppercase tracking-widest">
                    Most nem √©rt√©kelem
                </button>
            </div>
        </div>
    </div>
</div>



    <div id="report-error-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center p-4">
        <div id="report-error-modal-content" class="content-card p-5 bg-red-50 border-red-200 border">
            <h2 class="text-xl font-bold text-red-600 mb-2">Feladat √°tugr√°sa</h2>
            <p class="text-sm text-gray-700 mb-4">Amennyiben a helysz√≠n valami okb√≥l kifoly√≥lag nem el√©rhet≈ë, √°tugorhatod az adott feladatot. A feladat ebben az esetben *0 ponttal* teljes√≠tettnek min≈ës√ºl.</p>

            <div class="flex justify-between gap-4 mt-4">
                <button onclick="hideReportModal()" class="main-button flex-1 !text-sm !bg-gray-400 hover:!bg-gray-500">M√©gse</button>
                <button id="submit-error-report" onclick="handleSubmitError()" class="main-button flex-1 !text-sm !bg-red-600 hover:!bg-red-700">Igen szeretn√©m √°tugrani</button>
            </div>
        </div>
    </div>


<div id="image-zoom-modal" onclick="closeImageModal()" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[9999] cursor-pointer p-4 transition-opacity duration-300">
    
    <button class="absolute top-4 right-4 text-white text-4xl font-bold opacity-70 hover:opacity-100">&times;</button>
    
    <img id="image-zoom-content" src="" alt="Nagy√≠tott k√©p" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl transform transition-transform duration-300 scale-95">
    
    <p class="absolute bottom-4 left-0 right-0 text-center text-white/50 text-xs pointer-events-none">Kattints b√°rhova a bez√°r√°shoz</p>
</div>





<div id="coupon-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl p-5 max-w-sm w-full shadow-2xl text-center border-t-4 border-[#FFA500]">
        <div class="text-3xl mb-2">üé´</div>
        <h2 class="text-lg font-bold text-[#0D2B45] mb-1">Fizet≈ës tartalom</h2>
        
        <div class="mb-3">
            <p class="text-xs text-gray-500 mb-1">Ez a kaland kuponk√≥ddal √©rhet≈ë el.</p>
            
            <div class="bg-gray-200 p-2 rounded-xl border border-gray-100">
                <p class="text-[12px] font-bold text-[#0D2B45] mb-1">
        Jegyv√°s√°rl√°s: <br> 
        <span class="font-normal">(Tetsz≈ëleges √∂sszeg≈± hozz√°j√°rul√°s)</span>
    </p>
    
    <a href="https://revolut.me/krisztwaeo" target="_blank" 
       class="text-[#FFA500] text-sm underline decoration-2 underline-offset-2 font-extrabold hover:text-[#e69500] transition-colors">
       revolut.me/krisztwaeo
    </a>
    
    <p class="text-[11px] text-gray-500 leading-tight mt-2 italic">
        Megjegyz√©sbe csak √≠rd be, hogy <span class="font-bold text-gray-700">"MystiGo"</span>, √©s v√°lasz √ºzenetben r√∂vid id≈ën bel√ºl meg fogod kapni a k√≥dot.
    </p>
            </div>
            
            <p class="text-xs text-gray-600 mt-2 font-semibold">Add meg a k√≥dod:</p>
        </div>
        
        <input type="text" id="coupon-input" placeholder="KUPONK√ìD" 
               style="text-transform: uppercase;"
               class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-center font-bold tracking-widest outline-none mb-3 focus:border-[#FFA500]">
        
        <div id="coupon-error" class="text-red-500 text-[10px] font-bold mb-3 hidden">‚ö†Ô∏è √ârv√©nytelen k√≥d!</div>

        <div class="flex gap-2">
            <button onclick="window.closeCouponModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-500 text-xs font-bold rounded-xl hover:bg-gray-200 transition">M√©gse</button>
            <button id="verify-coupon-btn" class="flex-1 py-2.5 bg-[#FFA500] text-white text-xs font-bold rounded-xl shadow-lg hover:bg-[#e69500] active:scale-95 transition-all">
                Ellen≈ërz√©s
            </button>
        </div>
    </div>
</div>



    <div id="gps-help-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 9999;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-red-600 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    GPS Hiba / Be√°ll√≠t√°s
                </h2>
            </div>
            
            <p class="text-sm text-gray-700 mb-4 font-semibold">Nem siker√ºlt lek√©rni a pontos helyzeted. K√©rlek, ellen≈ërizd az al√°bbiakat:</p>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>üçé iPhone (iOS)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>Be√°ll√≠t√°sok > <strong>Adatv√©delem √©s biztons√°g</strong></li>
                    <li>Helymeghat√°roz√°s > <strong>Bekapcsolva</strong></li>
                    <li>Keresd meg a list√°ban a b√∂ng√©sz≈ët (Safari/Chrome)</li>
                    <li>V√°laszd: <strong>"Az alkalmaz√°s haszn√°lata k√∂zben"</strong></li>
                    <li>Kapcsold be: <strong>"Pontos helyzet"</strong></li>
                </ul>
            </div>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>ü§ñ Android (Samsung, Xiaomi, stb.)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>H√∫zd le az √©rtes√≠t√©si s√°vot √©s kapcsold be a <strong>Helyzet / GPS</strong> ikont.</li>
                    <li>Ha ez megvan: Chrome be√°ll√≠t√°sok > Webhelybe√°ll√≠t√°sok > Tart√≥zkod√°si hely. "A webhelyek lek√©rhetik az √ñn helyadatait" legyen bekapcsolva. A "Nincs enged√©lyezve" list√°ban ne legyen ott a https://mystigo.hu. Esetleg m√©g itt is ellen≈ërizd: Tartsd nyomva a Chrome ikont > App inf√≥ > Enged√©lyek > Hely > <strong>Enged√©lyez√©s</strong>.</li>
                </ul>
            </div>
    
            <button onclick="document.getElementById('gps-help-modal').classList.add('hidden')" class="main-button w-full !text-sm !py-3">√ârtem, megpr√≥b√°lom √∫jra</button>
        </div>
    </div>



<div id="global-leaderboard-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col h-[85vh] overflow-hidden">
        
        <div class="bg-purple-700 p-4 flex justify-between items-center shrink-0">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                üåé Glob√°lis Admin Ranglista
            </h3>
            <button onclick="document.getElementById('global-leaderboard-modal').classList.add('hidden')" class="text-white/70 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="bg-gray-100 p-4 border-b-2 border-gray-200 flex flex-wrap gap-4 items-center shrink-0">
            <input type="text" id="global-search-input" onkeyup="filterGlobalLeaderboard()" placeholder="üîç Keres√©s (N√©v, J√°t√©k)..." class="px-4 py-2 border border-gray-300 rounded-lg text-xs w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-purple-500 shadow-sm">
            
            <select id="global-game-filter" onchange="filterGlobalLeaderboard()" class="px-4 py-2 border border-gray-300 rounded-lg text-xs w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-purple-500 shadow-sm cursor-pointer">
                <option value="all">üìÇ √ñsszes J√°t√©k</option>
            </select>
        </div>

        <div class="overflow-y-auto flex-grow bg-white p-0">
            <table class="min-w-full text-xs text-left">
                <thead class="bg-gray-50 text-gray-500 font-bold sticky top-0 shadow-sm">
                    <tr>
                        <th class="p-3 border-b">D√°tum</th>
                        <th class="p-3 border-b">J√°t√©k Neve (ID)</th>
                        <th class="p-3 border-b">N√©v</th>
                        <th class="p-3 border-b text-right">Pont</th>
                        <th class="p-3 border-b text-right">Id≈ë</th>
                    </tr>
                </thead>
                <tbody id="global-leaderboard-body" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>

        <div class="p-3 border-t border-gray-200 bg-gray-50 flex justify-between items-center shrink-0">
            <span id="global-count-display" class="text-xs text-gray-500 font-bold">0 eredm√©ny</span>
            <button onclick="document.getElementById('global-leaderboard-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-500 text-white text-xs font-bold rounded hover:bg-gray-600 transition">
                Bez√°r√°s
            </button>
        </div>
    </div>
</div>

    

        



<div id="hall-of-fame-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col h-[80vh] overflow-hidden">
        <div class="bg-brand-cyan p-4 flex justify-between items-center shrink-0 rounded-t-2xl">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                ‚ú® MystiGo Dics≈ës√©gfal
            </h3>
            <button onclick="document.getElementById('hall-of-fame-modal').classList.add('hidden');" class="text-white/70 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="bg-gray-50 p-3 border-b border-gray-200">
    <div class="flex rounded-lg bg-gray-200 p-1 mb-2">
        <button onclick="openHallOfFame('monthly')" id="btn-hof-monthly" class="flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm">
            üóìÔ∏è Havi Ranglista
        </button>
        <button onclick="openHallOfFame('all')" id="btn-hof-all" class="flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue">
            üèÜ √ñsszes√≠tett
        </button>
    </div>

    <div id="hof-month-selector-container" class="hidden animate-fade-in">
        <label class="text-[9px] font-bold text-gray-400 uppercase ml-1">Id≈ëszak v√°laszt√°sa:</label>
        <select id="hof-month-select" onchange="openHallOfFame('monthly')" class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-brand-blue outline-none focus:ring-2 focus:ring-brand-cyan">
            </select>
    </div>
</div>
        <div class="overflow-y-auto p-0 flex-grow bg-gray-50">
            <table class="min-w-full text-xs text-left">
                <thead class="bg-gray-100 border-b sticky top-0 z-10">
                    <tr>
                        <th class="px-3 py-2 text-center text-gray-500 w-8">#</th>
                        <th class="px-3 py-2 text-gray-500">J√°t√©kos</th>
                        <th class="px-3 py-2 text-right text-gray-500">√ñsszpont</th>
                    </tr>
                </thead>
                <tbody id="hall-of-fame-body" class="divide-y divide-gray-100 bg-white">
                    </tbody>
            </table>
        </div>
        <div class="p-4 border-t border-gray-100 bg-white rounded-b-2xl">
            <button onclick="document.getElementById('hall-of-fame-modal').classList.add('hidden');" class="main-button w-full !text-sm !py-2 !bg-gray-500 hover:!bg-gray-600">
                Bez√°r√°s
            </button>
        </div>
    </div>
</div>




<div id="leaderboard-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 3000;">
    <div class="bg-white rounded-2xl p-0 w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
        
        <div id="leaderboard-header" class="bg-white p-4 flex justify-between items-center shrink-0 border-b border-gray-200">
            <h3 class="text-xl font-bold text-brand-blue flex items-center gap-2">
                <span>üèÜ</span> Ranglista
            </h3>
            <button onclick="document.getElementById('leaderboard-modal').classList.add('hidden')" class="text-gray-400 hover:text-brand-blue transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="overflow-y-auto p-4 flex-grow bg-gray-50">
            <table class="min-w-full text-xs">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-2 py-2 text-left text-gray-500">#</th>
                        <th class="px-2 py-2 text-left text-gray-500">N√©v</th>
                        <th class="px-2 py-2 text-center text-gray-500">Pont</th>
                        <th class="px-2 py-2 text-right text-gray-500">Id≈ë</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-modal-body" class="divide-y divide-gray-200 bg-white"></tbody>
            </table>
        </div>
        <div class="p-4 border-t border-gray-100 shrink-0 bg-white flex gap-3">
    <button onclick="downloadLeaderboardPDF()" class="main-button flex-1 !text-sm !py-2 !bg-green-600 hover:!bg-green-700 flex items-center justify-center gap-2">
        <span>üíæ</span> Ment√©s
    </button>
    
    <button onclick="document.getElementById('leaderboard-modal').classList.add('hidden')" class="main-button flex-1 !text-sm !py-2 !bg-gray-500 hover:!bg-gray-600">
        Bez√°r√°s
    </button>
</div>
    </div>
</div>


<div id="storage-manager-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[85vh]">
        <div class="bg-gray-800 p-4 rounded-t-2xl flex justify-between items-center shrink-0">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                üíæ Mem√≥ria Kezel≈ë
            </h3>
            <button onclick="document.getElementById('storage-manager-modal').classList.add('hidden')" class="text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="overflow-y-auto p-2 flex-grow bg-gray-50" id="storage-list-container">
            </div>

        <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl shrink-0 flex justify-between items-center gap-3">
            <span id="storage-count-display" class="text-xs text-gray-500 font-bold"></span>
            <div class="flex gap-2">
                <button onclick="nukeAllStorage()" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 transition">
                    üî• MINDENT T√ñR√ñL
                </button>
                <button onclick="document.getElementById('storage-manager-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 transition">
                    Bez√°r√°s
                </button>
            </div>
        </div>
    </div>
</div>



<div id="game-map-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl flex flex-col h-[80vh]">
        
        <div class="bg-[#0D2B45] p-4 rounded-t-2xl flex justify-between items-center shrink-0">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                üó∫Ô∏è Kaland T√©rk√©p
            </h3>
            <button onclick="closeGameMap()" class="text-white/70 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>


<div class="bg-gray-50 border-b border-gray-200 py-2 px-4 flex flex-wrap justify-center gap-4 text-xs font-bold select-none shrink-0">
            <label class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-200 px-2 py-1 rounded transition">
                <input type="checkbox" id="chk-map-normal" checked onchange="updateMapMarkers()" class="accent-green-600 w-4 h-4"> 
                <span class="text-green-700">üß≠ Normal</span>
            </label>

            <label class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-200 px-2 py-1 rounded transition">
                <input type="checkbox" id="chk-map-kids" checked onchange="updateMapMarkers()" class="accent-orange-500 w-4 h-4"> 
                <span class="text-orange-600">üêà Kids</span>
            </label>

            <label class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-200 px-2 py-1 rounded transition">
                <input type="checkbox" id="chk-map-team" checked onchange="updateMapMarkers()" class="accent-indigo-600 w-4 h-4"> 
                <span class="text-indigo-700">üßë‚Äçü§ù‚Äçüßë Team</span>
            </label>
            
            <label class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-200 px-2 py-1 rounded transition">
                <input type="checkbox" id="chk-map-explore" checked onchange="updateMapMarkers()" class="accent-cyan-600 w-4 h-4"> 
                <span class="text-cyan-700">üåç Explore</span>
            </label>
        </div>



        <div class="relative flex-grow w-full bg-gray-100">
            <div id="game-selection-map" class="w-full h-full z-10"></div>
            
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow-lg border border-brand-blue z-[1000] text-xs font-bold text-brand-blue whitespace-nowrap pointer-events-none">
                Kattints egy ikonra a j√°t√©k ind√≠t√°s√°hoz!
            </div>
        </div>

        <div class="p-3 border-t border-gray-200 bg-white rounded-b-2xl shrink-0 flex justify-center">
            <button onclick="closeGameMap()" class="main-button !py-2 !text-sm !bg-gray-500 hover:!bg-gray-600 w-full max-w-xs">
                Bez√°r√°s
            </button>
        </div>
    </div>
</div>




<script>





// Seg√©df√ºggv√©ny: Sz√∂veg Hash-el√©se (SHA-256)
    // Ezt h√≠vjuk meg ellen≈ërz√©skor √©s bet√∂lt√©skor is
    window.hashString = function(text) {
        if (!text) return "";
        const cleanText = String(text).trim().toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9]/g, ''); 
        return CryptoJS.SHA256(cleanText).toString();
    };


// Offline jelz≈ë kapcsol√≥ja
window.updateOfflineIndicator = function(isOffline) {
    const el = document.getElementById('offline-indicator');
    if (el) {
        if (isOffline) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    }
};


 
window.checkOnlineStatus = function() {
    const indicator = document.getElementById('offline-indicator');
    const loadingStatus = document.getElementById('loading-status');
    
    // 1. Ha van internet kapcsolat
    if (navigator.onLine) {
        // Ha van net, de a Firebase m√©g inicializ√°l, ne mutassunk hiba jelz√©st
        if (!window.db || !window.ref) {
            console.log("H√°l√≥zat OK, Firebase bet√∂lt√©se folyamatban...");
            return; 
        }

        // Ha minden k√©sz (Net + Firebase), elrejtj√ºk a piros cs√≠kot
        if(indicator) indicator.classList.add('hidden');
        
        // Takar√≠tjuk a t√∂lt≈ëk√©perny≈ë sz√∂veg√©t
        if(loadingStatus && loadingStatus.textContent.includes('Offline')) {
            loadingStatus.textContent = "Csatlakozva.";
        }
    } else {
        // 2. T√©nyleg nincs internet -> Megjelen√≠tj√ºk a piros jelz≈ët
        if(indicator) indicator.classList.remove('hidden');
    }
};

 
 

 // 1. LIMIT ELLEN≈êRZ√âS √âS N√ñVEL√âS (SZIGOR√ö M√ìD)
  // 1. LIMIT ELLEN≈êRZ√âS √âS N√ñVEL√âS (SZIGOR√ö M√ìD) - JAV√çTOTT
window.checkGameLimitAndIncrement = async function(gameId, maxPlayers) {
    if(!gameId) return true; 
    if (!window.db || !window.runTransaction) return true;

    // 1. STATISZTIKAI ID MEGHAT√ÅROZ√ÅSA
    // Ha instant, akkor az "instant_kozos" mapp√°ba √≠runk, minden m√°s esetben a saj√°t ID-j√°ba
    const isInstant = String(gameId).startsWith('instant_');
    const statsId = isInstant ? 'instant_kozos' : gameId;

    const limit = parseInt(maxPlayers, 10);
    
    // 2. EL√âR√âSI √öT JAV√çT√ÅSA
    // Itt a statsId-t kell haszn√°lni, hogy ne j√∂jj√∂n l√©tre egyedi mappa!
    const gameRef = window.ref(window.db, 'game_stats/' + statsId + '/count');
    
    try {
        const result = await window.runTransaction(gameRef, (currentCount) => {
            const count = (currentCount || 0);

            // 3. LIMIT ELLEN≈êRZ√âSE
            // Csak akkor dobunk "undefined"-et (meg√°ll√≠t√°st), ha:
            // - NEM instant j√°t√©kr√≥l van sz√≥
            // - VAN √©rv√©nyes limit (nagyobb mint 0)
            // - √âS a sz√°ml√°l√≥ el√©rte azt
            if (!isInstant && !isNaN(limit) && limit > 0) {
                if (count >= limit) {
                    return undefined; // Megszak√≠tja a tranzakci√≥t, betelt
                }
            }

            // Minden m√°s esetben (instant j√°t√©k vagy nincs limit) n√∂velj√ºk a sz√°ml√°l√≥t
            return count + 1;
        });
          
        if (result.committed) {
            console.log(`Statisztika r√∂gz√≠tve (${statsId}). √öj l√©tsz√°m: ${result.snapshot.val()}`);
            return true;
        } else {
            // Ez csak akkor fut le, ha a fenti "return undefined" √°g aktiv√°l√≥dott
            console.warn(`Limit elutas√≠tva: Betelt (${limit} f≈ë).`);
            return false;
        }

    } catch (error) { 
        console.error("KRITIKUS Limit hiba:", error); 
        // Hiba eset√©n is engedj√ºk j√°tszani a felhaszn√°l√≥t, de napl√≥zzuk
        return true; 
    }
};



// √öJ F√úGGV√âNY: Csak ellen≈ërz√©s - JAV√çTOTT
window.checkGameLimitOnly = async function(gameId, maxPlayers) {
    if(!gameId) return true;
    if (!window.db || !window.get) return true;
    
    let statsId = String(gameId).startsWith('instant_') ? 'instant_kozos' : gameId; // R√∂vid√≠tett sz≈±r≈ë

    try {
        const snapshot = await window.get(window.ref(window.db, 'game_stats/' + statsId + '/count'));
        const currentCount = parseInt(snapshot.val() || 0, 10);
        const limit = parseInt(maxPlayers, 10);
        return currentCount < limit;
    } catch (error) { return false; }
};



// √öJ: Csak a l√©tsz√°m lek√©r√©se (megjelen√≠t√©shez) - JAV√çTOTT
window.getGameCurrentCount = async function(gameId) {
    if(!gameId) return 0;
    if (!window.db || !window.get) return 0;

    const statsId = String(gameId).startsWith('instant_') ? 'instant_kozos' : gameId;

    try {
        const snapshot = await window.get(window.ref(window.db, 'game_stats/' + statsId + '/count'));
        return parseInt(snapshot.val() || 0, 10);
    } catch (error) { return 0; }
};



// --- OFFLINE SZINKRONIZ√ÅCI√ìS LOGIKA ---
  
  const PENDING_UPLOADS_KEY = 'MystiGo_PendingUploads';

  // 1. Adat ment√©se az offline sorba
  function saveToPendingUploads(data) {
      try {
          let pending = JSON.parse(localStorage.getItem(PENDING_UPLOADS_KEY) || "[]");
          pending.push(data);
          localStorage.setItem(PENDING_UPLOADS_KEY, JSON.stringify(pending));
          console.log("üíæ Eredm√©ny elmentve offline m√≥dba (k√©s≈ëbbi felt√∂lt√©sre).");
      } catch (e) {
          console.error("Hiba az offline ment√©sn√©l:", e);
      }
  }

  // 2. Szinkroniz√°ci√≥ v√©grehajt√°sa (Felt√∂lt√©s) - JAV√çTOTT VERZI√ì
  window.syncPendingUploads = async function() {
    if (!navigator.onLine) return; 

    // ‚úÖ JAV√çT√ÅS: Csak akkor fusson, ha a modul m√°r bet√∂lt√∂tte a Firebase-t
    if (typeof window.push !== 'function' || !window.db) {
        console.warn("‚è≥ Firebase modul bet√∂lt√©se folyamatban...");
        return; 
    }

    let pending = JSON.parse(localStorage.getItem(PENDING_UPLOADS_KEY) || "[]");
      if (pending.length === 0) return; 

      console.log(`üîÑ Offline adatok szinkroniz√°l√°sa (${pending.length} db)...`);
      
      const newPending = [];
      let uploadCount = 0;

      for (const data of pending) {
          try {
              // ‚úÖ JAV√çT√ÅS: window.ref √©s window.db haszn√°lata
              const leaderboardRef = window.ref(window.db, 'leaderboard/' + data.gameId);
              
              // ‚úÖ JAV√çT√ÅS: window.push haszn√°lata
              await window.push(leaderboardRef, {
                  teamName: data.teamName,
                  teamAvatar: data.teamAvatar,
                  score: data.score,
                  totalTime: data.totalTime,
                  geofenceTime: data.geofenceTime,
                  timestamp: data.timestamp, 
                  dateString: data.dateString
              });

              if (window.incrementGameCompletion) {
                  try {
                      await window.incrementGameCompletion(data.gameId);
                      console.log(`‚úÖ ${data.teamName}: Sz√°ml√°l√≥ n√∂velve.`);
                  } catch (cntErr) {
                      console.error(`‚ö†Ô∏è ${data.teamName}: Sz√°ml√°l√≥ hiba:`, cntErr);
                  }
              }
              
              uploadCount++;
              console.log(`‚úÖ ${data.teamName} eredm√©nye szinkroniz√°lva.`);

          } catch (error) {
              console.error("Szinkroniz√°ci√≥s hiba:", error);
              newPending.push(data);
          }
      }

      localStorage.setItem(PENDING_UPLOADS_KEY, JSON.stringify(newPending));
      
      if (uploadCount > 0) {
          console.log(`${uploadCount} offline eredm√©ny sikeresen bek√ºldve.`);
      }
  };




  // 3. Esem√©nyfigyel≈ëk ind√≠t√°sa (Internet visszat√©r√©s figyel√©se)
  window.addEventListener('online', () => {
      console.log("üåê Internet kapcsolat helyre√°llt.");
      
      // A) Piros felirat azonnali elt√ºntet√©se
      if(window.updateOfflineIndicator) window.updateOfflineIndicator(false);
      
      // B) Esetleges hiba√ºzenetek (Toast) elt√ºntet√©se
      const statusText = document.getElementById('loading-status');
      if(statusText && statusText.textContent.includes('Offline')) {
          statusText.textContent = "";
      }

      // C) Elmentett eredm√©nyek felt√∂lt√©se
      if(window.syncPendingUploads) window.syncPendingUploads();
      
      // D) Ha √©pp a f≈ëoldalon (j√°t√©klista) vagyunk, logolunk
      if (!document.getElementById('game-list-page').classList.contains('hidden')) {
          console.log("A lista n√©zet akt√≠v, a k√∂vetkez≈ë interakci√≥ m√°r online lesz.");
      }
  });

  // Amikor elmegy a net (j√°t√©k k√∂zben):
  window.addEventListener('offline', () => {
      console.log("‚ö†Ô∏è Internet kapcsolat megszakadt.");
      
      // Piros felirat azonnali megjelen√≠t√©se
      if(window.updateOfflineIndicator) window.updateOfflineIndicator(true);
  });

  // Ind√≠t√°skor is pr√≥b√°lja meg (h√°tha most van net, de tegnap nem volt)
  setTimeout(() => { if(window.syncPendingUploads) window.syncPendingUploads(); }, 6000);


  // 2. MENT√âS (Biztons√°gos verzi√≥ - Offline t√°mogat√°ssal) - JAV√çTOTT
  // --- MENT√âS LOGIKA (0 PONT ELLEN≈êRZ√âSSEL) ---
window.saveScoreToFirebase = function(data) {
    if (!data.gameId) return;

    // Pontsz√°m ellen≈ërz√©se: Ha 0 vagy kevesebb, nem ment√ºnk semmit
    let safeScore = Number(data.score);
    if (isNaN(safeScore) || safeScore <= 0) {
        console.log("0 pontos eredm√©ny - nem ker√ºl ment√©sre a ranglist√°ra.");
        return; 
    }

    const now = new Date();
    const readableDate = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    let safeTeamName = String(data.teamName || "N√©vtelen").trim();
    if (safeTeamName.length === 0) safeTeamName = "N√©vtelen J√°t√©kos";

const user = window.auth ? window.auth.currentUser : null;

    const scoreData = {
        gameId: data.gameId,
        teamName: safeTeamName,
        teamAvatar: data.teamAvatar || "no avatar",
	uid: user ? user.uid : null,
        isRegistered: !!(window.auth && window.auth.currentUser),
        score: safeScore,
        totalTime: data.totalTime || 0,
        geofenceTime: data.geofenceTime || 0,
        timestamp: Date.now(),
        dateString: readableDate
    };

    if (navigator.onLine && window.db && window.push) {
        let targetLeaderboardId = data.gameId;
        if (String(targetLeaderboardId).startsWith('instant_')) {
            targetLeaderboardId = 'instant_kozos';
        }

        const leaderboardRef = window.ref(window.db, 'leaderboard/' + targetLeaderboardId);
        window.push(leaderboardRef, scoreData).then(() => {
            console.log("‚úÖ Ment√©s sikeres!");
            if (window.incrementGameCompletion) window.incrementGameCompletion(data.gameId);
        }).catch((error) => {
            console.warn("‚ö†Ô∏è Hiba a felt√∂lt√©skor:", error);
            saveToPendingUploads(scoreData);
        });
    } else {
        saveToPendingUploads(scoreData);
    }
};

// --- √âRT√âKEL√âSI FUNKCI√ìK ---
window.closeRatingModal = function() {
    const modal = document.getElementById('rating-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

window.submitGameRating = async function() {
    const selectedStar = document.querySelector('input[name="rating"]:checked');
    if (!selectedStar) {
        alert("K√©rlek, v√°lassz egy csillagot!");
        return;
    }

    const ratingValue = parseInt(selectedStar.value);
    const gameId = window.currentGameId;

    if (!gameId || !window.db || !window.runTransaction) return;

    let statsId = String(gameId).startsWith('instant_') ? 'instant_kozos' : gameId;
    showLoading(true);
    
    const statsRef = window.ref(window.db, `game_stats/${statsId}/rating`);

    try {
        await window.runTransaction(statsRef, (currentData) => {
            if (currentData === null) {
                return { sum: ratingValue, count: 1, average: ratingValue };
            } else {
                const newCount = (currentData.count || 0) + 1;
                const newSum = (currentData.sum || 0) + ratingValue;
                return {
                    sum: newSum,
                    count: newCount,
                    average: Math.round((newSum / newCount) * 10) / 10
                };
            }
        });
        
        window.closeRatingModal();
        showMessage("K√∂sz√∂nj√ºk!", "Az √©rt√©kel√©sedet r√∂gz√≠tett√ºk.");
    } catch (e) {
        console.error("√ârt√©kel√©si hiba:", e);
    } finally {
        showLoading(false);
    }
};



 // --- √öJ FEJLETT RANGLISTA LOGIKA

// Glob√°lis v√°ltoz√≥ az adatok t√°rol√°s√°ra
  window.currentLeaderboardData = [];

  // 1. MODAL MEGNYIT√ÅSA √âS UI EL≈êK√âSZ√çT√âSE (JAV√çTVA: M√©g sz≈±kebb oszlopok √©s paddingok)
  window.openLeaderboardModal = async function(specificGameId = null) {
      let gameId = specificGameId || window.currentGameId;

      if (!gameId) {
        alert("Nincs akt√≠v j√°t√©k azonos√≠t√≥. El≈ëbb v√°lassz egy j√°t√©kot!");
        return;
    }

    // ‚úÖ M√ìDOS√çT√ÅS: Ha ez azonnali kaland, a k√∂z√∂s ID-t haszn√°ljuk lek√©rdez√©shez
    if (String(gameId).startsWith('instant_')) {
        gameId = 'instant_kozos';
    }

      const modal = document.getElementById('leaderboard-modal');
      const listBody = document.getElementById('leaderboard-modal-body');
      
      const modalHeader = document.getElementById('leaderboard-header'); 
      let filterContainer = document.getElementById('leaderboard-filters');
      
      if (!filterContainer && modalHeader) {
          filterContainer = document.createElement('div');
          filterContainer.id = 'leaderboard-filters';
          filterContainer.className = "bg-white border-b border-gray-200 p-3 space-y-3";
          filterContainer.innerHTML = `
    <div class="flex rounded-lg bg-gray-100 p-1 mb-2">
        <button onclick="filterLeaderboard('today')" id="btn-filter-today" 
    class="flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm">
    üìÖ Ma
</button>
        <button onclick="filterLeaderboard('monthly')" id="btn-filter-monthly" class="flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue">
            üóìÔ∏è Havi
        </button>
        <button onclick="filterLeaderboard('all')" id="btn-filter-all" class="flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue">
            üèÜ √ñsszes
        </button>
    </div>
    
    <div id="month-selector-container" class="hidden mb-2">
        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Id≈ëszak v√°laszt√°sa:</label>
        <select id="leaderboard-month-select" onchange="filterLeaderboard('monthly')" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs font-bold text-brand-blue outline-none focus:ring-2 focus:ring-brand-blue">
            </select>
    </div>

    <div class="relative">
        <input type="text" id="leaderboard-search" onkeyup="filterLeaderboard()" placeholder="üîç N√©v keres√©se..." class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs focus:ring-2 focus:ring-brand-blue outline-none">
        <svg class="w-4 h-4 text-gray-400 absolute left-2.5 top-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
    </div>
`;
          modalHeader.insertAdjacentElement('afterend', filterContainer);
      }



window.populateMonthSelector = function() {
    const select = document.getElementById('leaderboard-month-select');
    if (!select || !window.currentLeaderboardData) return;

    const monthOptions = new Set();
    const now = new Date();
    // Alap√©rtelmezett kulcs a jelenlegi h√≥naphoz (pl: "2024-05")
    const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    // V√©gigmegy√ºnk az √∂sszes adaton √©s kigy≈±jtj√ºk az egyedi √©v-h√≥nap p√°rosokat
    window.currentLeaderboardData.forEach(entry => {
        if (entry.timestamp) {
            const d = new Date(entry.timestamp);
            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            // Sz√©p n√©v a list√°ba (pl: "2024. m√°jus")
            const label = d.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
            monthOptions.add(JSON.stringify({ key, label }));
        }
    });

    // Biztos√≠tjuk, hogy az aktu√°lis h√≥nap mindig v√°laszthat√≥ legyen
    const currentLabel = now.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
    monthOptions.add(JSON.stringify({ key: currentMonthKey, label: currentLabel }));

    // Sorba rendezz√ºk: a legfrissebb h√≥nap legyen legfel√ºl
    const sortedMonths = Array.from(monthOptions)
        .map(s => JSON.parse(s))
        .sort((a, b) => b.key.localeCompare(a.key));

    // Leg√∂rd√ºl≈ë men√º felt√∂lt√©se
    select.innerHTML = sortedMonths.map(m => 
        `<option value="${m.key}">${m.label}</option>`
    ).join('');
    
    // Alapb√≥l a legfrissebb (fels≈ë) h√≥napot jel√∂lj√ºk ki
    if (sortedMonths.length > 0) {
        select.value = sortedMonths[0].key;
    }
};



// --- RANGLISTA PDF MENT√âSE ---
  window.downloadLeaderboardPDF = function() {
      // 1. Az elemek kiv√°laszt√°sa
      const listBody = document.getElementById('leaderboard-modal-body');
      if (!listBody || listBody.rows.length === 0) {
          alert("Nincs mit menteni, a lista √ºres.");
          return;
      }

      // Visszajelz√©s a gombon (opcion√°lis UX)
      const btn = event.currentTarget;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Gener√°l√°s...';
      btn.disabled = true;

      // 2. Ideiglenes kont√©ner l√©trehoz√°sa a PDF gener√°l√°shoz
      // Ez az√©rt kell, hogy "kivegy√ºk" a t√°bl√°zatot a g√∂rgethet≈ë (scroll) ablakb√≥l,
      // √≠gy a PDF-ben a teljes lista l√°tszani fog, nem csak ami √©pp a k√©perny≈ën van.
      const wrapper = document.createElement('div');
      wrapper.style.padding = '20px';
      wrapper.style.fontFamily = 'sans-serif';
      wrapper.style.background = 'white';
      wrapper.style.color = '#0D2B45';

      // C√≠m √©s d√°tum
      const dateStr = new Date().toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' });
      const activeGameId = window.currentGameId || "Ismeretlen";
      
      wrapper.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 24px; color: #0D2B45;">üèÜ MystiGo Ranglista</h1>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Kaland: <strong>${activeGameId}</strong> | D√°tum: ${dateStr}</p>
        </div>
      `;

      // T√°bl√°zat kl√≥noz√°sa
      const originalTable = document.querySelector('#leaderboard-modal table');
      const clonedTable = originalTable.cloneNode(true);
      
      // St√≠lus igaz√≠t√°s a PDF-hez (hogy biztosan sz√©p legyen feh√©r h√°tt√©rrel)
      clonedTable.style.width = '100%';
      clonedTable.style.borderCollapse = 'collapse';
      clonedTable.style.fontSize = '12px';
      
      // Fejl√©c sz√≠nez√©se a kl√≥nban
      const thead = clonedTable.querySelector('thead');
      if(thead) thead.style.backgroundColor = '#f3f4f6';
      
      wrapper.appendChild(clonedTable);

      // 3. PDF Gener√°l√°s
      const opt = {
          margin:       10,
          filename:     `MystiGo_Ranglista_${activeGameId}_${new Date().toISOString().slice(0,10)}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().from(wrapper).set(opt).save().then(() => {
          // Vissza√°ll√≠t√°s
          btn.innerHTML = originalText;
          btn.disabled = false;
      }).catch(err => {
          console.error(err);
          alert("Hiba t√∂rt√©nt a ment√©s k√∂zben.");
          btn.innerHTML = originalText;
          btn.disabled = false;
      });
  };


      // --- T√ÅBL√ÅZAT FEJL√âC SZ≈∞K√çT√âSE ---
      const tableHead = modal.querySelector('thead');
      if (tableHead) {
          tableHead.innerHTML = `
            <tr>
                <th class="px-1 py-2 text-center text-gray-500 w-6">#</th>
                
                <th class="px-1 py-2 text-left text-gray-500">N√©v</th>
                
                <th class="pl-1 pr-0 py-2 text-right text-gray-500 w-10">Pont</th> 
                
                <th class="pl-1 pr-1 py-2 text-right text-gray-500 w-24">Id≈ë</th> 
            </tr>
          `;
      }

      
// 1. Megnyitjuk a modalt
    modal.classList.remove('hidden');
    listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8"><div class="animate-spin h-6 w-6 border-2 border-brand-blue border-t-transparent rounded-full mx-auto mb-2"></div>Bet√∂lt√©s...</td></tr>';

    // 2. ADATLEK√âR√âS (JAV√çTOTT)
    // Ellen≈ërizz√ºk, hogy el√©rhet≈ë-e a Firebase (window.db, window.get, stb.)
    if (!window.db || !window.get || !window.query) {
        listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-500">Nincs kapcsolat a szerverrel (Offline).</td></tr>';
        return;
    }

    try {
        // M√ìDOS√çTVA: window.query, window.ref, window.get haszn√°lata
        const q = window.query(window.ref(window.db, 'leaderboard/' + gameId));
        const snapshot = await window.get(q);

        if (!snapshot.exists()) {
            listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">M√©g nincs eredm√©ny ehhez a j√°t√©khoz.</td></tr>';
            window.currentLeaderboardData = [];
            return;
        }

        let results = [];
        snapshot.forEach((child) => {
            const val = child.val();
            if (val.score === undefined || val.score === null) {
                val.score = 0; 
                val.teamName = (val.teamName || "Hib√°s adat") + " (Nincs pont)";
            }
            results.push(val);
        });

        // 1. Az √∂sszes adat elment√©se a glob√°lis v√°ltoz√≥ba
        window.currentLeaderboardData = results;

        // 2. A h√≥napv√°laszt√≥ leg√∂rd√ºl≈ë men√º felt√∂lt√©se az adatok alapj√°n
        window.populateMonthSelector(); 

        // 3. A sz≈±r√©s elind√≠t√°sa "today" (Ma) param√©terrel
        setTimeout(() => {
            filterLeaderboard('today'); 
            
            // 4. Opcion√°lis: G√∂rget√©s a saj√°t eredm√©nyhez (ha van)
            setTimeout(() => {
                const myRow = document.getElementById('my-leaderboard-row');
                if (myRow) {
                    myRow.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }, 100);
            
        }, 50);

    } catch (error) {
        console.error("Hiba:", error);
        listBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Hiba t√∂rt√©nt: ${error.message}</td></tr>`;
    }
};


  // 2. SZ≈∞R≈ê LOGIKA (JAV√çTOTT SORREND: Sz≈±r√©s -> Rendez√©s -> Rangsorol√°s -> Keres√©s)
  window.filterLeaderboard = function(modeParam) {
    let mode = modeParam;
    const btnToday = document.getElementById('btn-filter-today');
    const btnMonthly = document.getElementById('btn-filter-monthly');
    const btnAll = document.getElementById('btn-filter-all');
    const monthContainer = document.getElementById('month-selector-container');
    
    // Aktu√°lis m√≥d meghat√°roz√°sa, ha nincs param√©ter
    if (!mode) {
        if (btnToday.classList.contains('bg-white')) mode = 'today';
        else if (btnMonthly.classList.contains('bg-white')) mode = 'monthly';
        else mode = 'all';
    }

    // Gombok vizu√°lis friss√≠t√©se
    [btnToday, btnMonthly, btnAll].forEach(b => {
        b.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue hover:bg-gray-200";
    });
    
    const activeBtn = mode === 'today' ? btnToday : (mode === 'monthly' ? btnMonthly : btnAll);
    activeBtn.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm";

    // H√≥napv√°laszt√≥ megjelen√≠t√©se/elrejt√©se
    monthContainer.classList.toggle('hidden', mode !== 'monthly');

    const searchInput = document.getElementById('leaderboard-search');
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : "";
    let data = [...window.currentLeaderboardData];

    // SZ≈∞R√âS
    if (mode === 'today') {
        const startOfToday = new Date().setHours(0, 0, 0, 0);
        data = data.filter(r => r.timestamp >= startOfToday);
    } else if (mode === 'monthly') {
        const selectedMonth = document.getElementById('leaderboard-month-select').value; // Pl: "2024-05"
        data = data.filter(r => {
            const d = new Date(r.timestamp);
            const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            return key === selectedMonth;
        });
    }

    // RENDEZ√âS (Pont -> Feladat id≈ë -> Teljes id≈ë)
    data.sort((a, b) => {
        const scoreDiff = b.score - a.score;
        if (scoreDiff !== 0) return scoreDiff;
        const taskTimeDiff = (a.geofenceTime || 0) - (b.geofenceTime || 0);
        if (taskTimeDiff !== 0) return taskTimeDiff;
        return (a.totalTime || 0) - (b.totalTime || 0);
    });

    // Helyez√©sek kioszt√°sa √©s keres√©s
    data = data.map((item, index) => ({ ...item, actualRank: index + 1 }));
    if (searchTerm) {
        data = data.filter(r => r.teamName.toLowerCase().includes(searchTerm));
    }

    renderLeaderboardTable(data);
};



// 3. T√ÅBL√ÅZAT MEGJELEN√çT√âSE (JAV√çTVA: N√©v mez≈ë 100px, Paddingok minimaliz√°lva)
 window.renderLeaderboardTable = function(results) {
    const listBody = document.getElementById('leaderboard-modal-body');
    
    if (results.length === 0) {
        listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 italic">Nincs a sz≈±r√©snek megfelel≈ë tal√°lat.</td></tr>';
        return;
    }

       
    const fmt = (s) => {
        const m = Math.floor(s / 60).toString().padStart(2,'0');
        const sec = (s % 60).toString().padStart(2,'0');
        return `${m}:${sec}`;
    };
    
    const fmtDate = (ms) => { 
        const d = new Date(ms);
        const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}. ${timeStr}`; 
    };

    let html = "";
    
    results.slice(0, 100).forEach((r) => {
        const iconEmoji = AVATAR_ICONS[r.teamAvatar] || 'üë§';
const isRegistered = !!r.isRegistered; //
const isMyTeam = (Math.abs(r.timestamp - Date.now()) < 120000 && r.score == window.currentScoreForHighlight);

// 2. Az egys√©ges√≠tett avatar kont√©ner l√©trehoz√°sa (ugyanaz, mint a fejl√©cben)
const avatarHtml = `
    <div class="avatar-container">
        ${iconEmoji}
        ${isRegistered ? `
            <div class="verified-badge verified-badge-sm active">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>` : ''}
    </div>
`;



let rowBg = isMyTeam ? "bg-blue-200 border-l-4 border-l-red-400" : "";
const rowId = isMyTeam ? 'id="my-leaderboard-row"' : '';

// 3. A t√°bl√°zat sor√°nak √∂ssze√°ll√≠t√°sa az √∫j avatarHtml haszn√°lat√°val
html += `
    <tr ${rowId} class="transition border-b border-gray-100 last:border-0 ${rowBg}">
        <td class="px-1 py-3 font-bold text-gray-500 text-center text-sm w-6 align-middle">${r.actualRank}.</td>
        <td class="px-1 py-3 align-middle">
            <div class="font-bold text-brand-blue flex items-center gap-1.5">
                ${avatarHtml}
                <span class="text-sm leading-tight break-words whitespace-normal min-w-0 w-[100px]" title="${r.teamName}">
                    ${r.teamName}
                </span>
            </div>
            <div class="text-[10px] text-gray-400 ml-10 flex items-center gap-1 mt-1">
                ‚è±Ô∏è ${fmtDate(r.timestamp)}
            </div>
        </td>
        <td class="pl-1 pr-0 py-3 text-right font-extrabold text-brand-orange-500 text-base w-10 align-middle">
            ${r.score}
        </td>
        <td class="pl-1 pr-1 py-3 text-right text-xs text-gray-600 leading-tight w-24 align-middle">
            <div class="flex flex-col items-end gap-1">
                <div title="Feladat id≈ë" class="font-semibold text-green-700 bg-green-50 px-1.5 py-0.5 rounded w-fit whitespace-nowrap">
                    üß© ${fmt(r.geofenceTime || 0)}
                </div>
                <div title="Teljes id≈ë" class="font-semibold text-brand-blue bg-blue-50 px-1.5 py-0.5 rounded w-fit whitespace-nowrap">
                    ‚è±Ô∏è ${fmt(r.totalTime || 0)}
                </div>
            </div>
        </td>
    </tr>`;
    });
    listBody.innerHTML = html;
};



  // --- RANGLISTA K√ìD V√âGE ---

// --- √öJ R√âSZ: Befejezett j√°t√©kok sz√°mol√°sa (Atomic Increment) ---
  window.incrementGameCompletion = async function(gameId) {
    if(!gameId) return;
    if (!window.db || !window.runTransaction) return;

    const statsId = String(gameId).startsWith('instant_') ? 'instant_kozos' : gameId;

    const gameRef = window.ref(window.db, 'game_stats/' + statsId + '/completed');
    try {
        await window.runTransaction(gameRef, (currentCount) => {
            return (currentCount || 0) + 1;
        });
    } catch (error) { console.error("Completion stats hiba:", error); }
};



// --- GLOB√ÅLIS RANGLISTA KEZEL≈ê ---
  
  window.globalLeaderboardData = []; // Cache az adatoknak

window.openGlobalLeaderboard = async function() {
    const modal = document.getElementById('global-leaderboard-modal');
    const tbody = document.getElementById('global-leaderboard-body');
    const gameSelect = document.getElementById('global-game-filter');
    
    modal.classList.remove('hidden');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10"><div class="animate-spin h-8 w-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-2"></div>Adatok bet√∂lt√©se a Firebase-r≈ël...</td></tr>';

    if (!window.db || !window.get) {
         tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-red-600">Nincs Firebase kapcsolat.</td></tr>';
         return;
    }

    try {
        const snapshot = await window.get(window.ref(window.db, 'leaderboard'));
        
        if (!snapshot.exists()) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">M√©g nincs egyetlen eredm√©ny sem az adatb√°zisban.</td></tr>';
            return;
        }
        
        const rawData = snapshot.val();
        let flatData = [];
        const gameIdsSet = new Set();
        
        Object.keys(rawData).forEach(gameId => {
    const gameScores = rawData[gameId];
    
    // BIZTONS√ÅGI ELLEN≈êRZ√âS: Csak akkor megy√ºnk tov√°bb, ha vannak pontsz√°mok
    if (gameScores && typeof gameScores === 'object') {
        const gameObj = window.games ? window.games[gameId] : null;
        const gameTitle = gameObj ? gameObj.title : gameId;
        
        gameIdsSet.add(JSON.stringify({id: gameId, title: gameTitle})); 

        Object.keys(gameScores).forEach(scoreId => {
            const entry = gameScores[scoreId];
            flatData.push({
                gameId: gameId,
                gameTitle: gameTitle,
                teamName: entry.teamName || "N√©vtelen",
                teamAvatar: entry.teamAvatar || "cat",
                score: entry.score || 0,
                totalTime: entry.totalTime || 0,
                timestamp: entry.timestamp || 0,
                dateString: entry.dateString || "-"
            });
        });
    }
});

        flatData.sort((a, b) => b.timestamp - a.timestamp);
        window.globalLeaderboardData = flatData;
        
        // Sz≈±r≈ë leg√∂rd√ºl≈ë felt√∂lt√©se
        gameSelect.innerHTML = '<option value="all">üìÇ √ñsszes J√°t√©k</option>';
        Array.from(gameIdsSet).map(s => JSON.parse(s)).sort((a, b) => a.title.localeCompare(b.title)).forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.title;
            gameSelect.appendChild(opt);
        });

        window.filterGlobalLeaderboard();

    } catch (error) {
        console.error("Global Leaderboard Error:", error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-600">Hiba t√∂rt√©nt: ${error.message}</td></tr>`;
    }
};

window.filterGlobalLeaderboard = function() {
    const searchTerm = document.getElementById('global-search-input').value.toLowerCase();
    const selectedGameId = document.getElementById('global-game-filter').value;
    const tbody = document.getElementById('global-leaderboard-body');
    const countDisplay = document.getElementById('global-count-display');

    if (!window.globalLeaderboardData) return;

    const filtered = window.globalLeaderboardData.filter(item => {
        if (selectedGameId !== 'all' && item.gameId !== selectedGameId) return false;
        if (searchTerm) {
            const textToSearch = `${item.teamName} ${item.gameTitle} ${item.gameId}`.toLowerCase();
            if (!textToSearch.includes(searchTerm)) return false;
        }
        return true;
    });

    if (countDisplay) countDisplay.textContent = `${filtered.length} eredm√©ny`;

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">Nincs tal√°lat.</td></tr>';
        return;
    }

    const renderLimit = 500;
    let html = "";

    const fmtTime = (s) => {
       const m = Math.floor(s / 60).toString().padStart(2,'0');
       const sec = (s % 60).toString().padStart(2,'0');
       return `${m}:${sec}`;
    };

    filtered.slice(0, renderLimit).forEach(r => {
        // ITT HASZN√ÅLJUK A K√ñZPONTI LIST√ÅT:
        const icon = AVATAR_ICONS[r.teamAvatar] || 'üë§';
        
        const dateObj = new Date(r.timestamp);
        const niceDate = `${dateObj.getFullYear()}.${String(dateObj.getMonth() + 1).padStart(2, '0')}.${String(dateObj.getDate()).padStart(2, '0')} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;

        html += `
          <tr class="hover:bg-purple-50 transition">
              <td class="p-3 border-b text-gray-500 whitespace-nowrap font-mono text-[11px]">${niceDate}</td>
              <td class="p-3 border-b">
                  <div class="font-bold text-gray-800">${r.gameTitle}</div>
                  <div class="text-[10px] text-gray-400 font-mono">${r.gameId}</div>
              </td>
              <td class="p-3 border-b">
                  <div class="flex items-center gap-2">
                      <span class="text-xl">${icon}</span>
                      <span class="font-semibold text-purple-900">${r.teamName}</span>
                  </div>
              </td>
              <td class="p-3 border-b text-right font-bold text-orange-600 text-lg">${r.score}</td>
              <td class="p-3 border-b text-right text-gray-600 font-mono">${fmtTime(r.totalTime)}</td>
          </tr>
        `;
    });

    tbody.innerHTML = html;
};



window.openHallOfFame = async function(mode = 'monthly') {
    const modal = document.getElementById('hall-of-fame-modal');
    const tbody = document.getElementById('hall-of-fame-body');
    const btnAll = document.getElementById('btn-hof-all');
    const btnMonthly = document.getElementById('btn-hof-monthly');
    const monthContainer = document.getElementById('hof-month-selector-container');
    const monthSelect = document.getElementById('hof-month-select');
    
    modal.classList.remove('hidden');
    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-10"><div class="animate-spin h-6 w-6 border-2 border-brand-cyan border-t-transparent rounded-full mx-auto mb-2"></div>Adatok √∂sszes√≠t√©se...</td></tr>';

    if(mode === 'all') {
        btnAll.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm";
        btnMonthly.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue";
        monthContainer.classList.add('hidden');
    } else {
        btnMonthly.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm";
        btnAll.className = "flex-1 py-1.5 text-[11px] font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue";
        monthContainer.classList.remove('hidden');
    }

    if (!window.db || !window.get) return;

    try {
        if (mode === 'all') {
            // √ñSSZES√çTETT: Csak a regisztr√°lt profilok (marad a r√©gi)
            const snapshot = await window.get(window.ref(window.db, 'users'));
            let players = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const data = child.val().profile;
                    if (data && data.teamName) {
                        players.push({
                            name: data.teamName,
                            avatar: data.avatar || 'cat',
                            score: parseInt(data.totalScore || 0),
                            isRegistered: true
                        });
                    }
                });
            }
            renderHofTable(players, tbody);
        } else {
            // HAVI N√âZET: Leaderboard aggreg√°ci√≥
            const snapshot = await window.get(window.ref(window.db, 'leaderboard'));
            if (!snapshot.exists()) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-10 text-gray-400">Nincs adat.</td></tr>';
                return;
            }

            const allGames = snapshot.val();
            const monthMap = new Set();
            const monthlyAggregator = {};
            
            // 1. H√≥napok kigy≈±jt√©se a leg√∂rd√ºl≈ëh√∂z
            Object.values(allGames).forEach(gameResults => {
                Object.values(gameResults).forEach(entry => {
                    if (entry.timestamp && entry.isRegistered === true) {
                        const d = new Date(entry.timestamp);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        monthMap.add(key);
                    }
                });
            });

            // H√≥napv√°laszt√≥ felt√∂lt√©se, ha √ºres
            if (monthSelect.options.length === 0) {
                const sortedMonths = Array.from(monthMap).sort().reverse();
                monthSelect.innerHTML = sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    const label = new Date(year, month - 1).toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
                    return `<option value="${m}">${label}</option>`;
                }).join('');
            }

            const targetMonthKey = monthSelect.value;

            // 2. Pontok √∂sszegez√©se a v√°lasztott h√≥napra (UID ALAP√ö AZONOS√çT√ÅSSAL)
            Object.values(allGames).forEach(gameResults => {
                Object.values(gameResults).forEach(entry => {
                    if (entry.timestamp && entry.isRegistered === true) {
                        const d = new Date(entry.timestamp);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (key === targetMonthKey) {
                            // ‚úÖ KRITIKUS V√ÅLTOZ√ÅS: UID-t haszn√°lunk kulcsnak, ha van. 
                            // Ha r√©gi adat √©s nincs UID, akkor marad a n√©v.
                            const playerKey = entry.uid || entry.teamName; 
                            
                            if (!monthlyAggregator[playerKey]) {
                                monthlyAggregator[playerKey] = { 
                                    score: 0, 
                                    name: entry.teamName, 
                                    avatar: entry.teamAvatar, 
                                    isRegistered: true 
                                };
                            }
                            // Mindig a legfrissebb nevet/avatart tartsuk meg a kijelz√©shez
                            monthlyAggregator[playerKey].name = entry.teamName;
                            monthlyAggregator[playerKey].avatar = entry.teamAvatar;
                            monthlyAggregator[playerKey].score += parseInt(entry.score || 0);
                        }
                    }
                });
            });

            const players = Object.values(monthlyAggregator).map((data) => ({
    name: data.name, // Itt az objektumon bel√ºli 'name' tulajdons√°got haszn√°ljuk (ami a teamName)
    avatar: data.avatar,
    score: data.score,
    isRegistered: data.isRegistered
            }));

            renderHofTable(players, tbody);
        }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-10 text-red-500">Hiba t√∂rt√©nt az adatok bet√∂lt√©sekor.</td></tr>';
    }
};





// Seg√©df√ºggv√©ny a t√°bl√°zat kirajzol√°s√°hoz
function renderHofTable(players, tbody) {
    players.sort((a, b) => b.score - a.score);
    let html = "";
    if (players.length === 0) {
        html = '<tr><td colspan="3" class="text-center py-10 text-gray-400">Ebben az id≈ëszakban nem sz√ºletett eredm√©ny.</td></tr>';
    } else {
        players.forEach((u, i) => {
            const emoji = AVATAR_ICONS[u.avatar] || 'üë§';
            html += `
                <tr class="hover:bg-cyan-50 transition">
                    <td class="px-3 py-3 text-center font-bold text-gray-400">${i + 1}.</td>
                    <td class="px-3 py-3">
                        <div class="flex items-center gap-2">
                            <div class="avatar-container v-sm !w-8 !h-8 !text-base">
                                ${emoji}
                                ${u.isRegistered ? '<div class="verified-badge verified-badge-sm active"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path d="M5 13l4 4L19 7" /></svg></div>' : ''}
                            </div>
                            <div class="font-bold text-brand-blue leading-tight">${u.name}</div>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-right font-black text-brand-cyan-500 text-sm">
                        ${u.score.toLocaleString()} ‚≠ê
                    </td>
                </tr>`;
        });
    }
    tbody.innerHTML = html;
}



 

// Itt j√∂n a script blokk v√©ge
window.isFirebaseModuleLoaded = true;

</script>



       
<script>
        // --- GLOBAL STATE & CONSTANTS ---
        window.games = {}; // A "let" t√∂rl√©se √©s window-ra rak√°sa megoldja a l√°that√≥s√°got
	window.badWordsList = [];

fetch('badwords.json')
    .then(response => {
        if (!response.ok) throw new Error("Nem siker√ºlt bet√∂lteni a badwords.json f√°jlt");
        return response.json();
    })
    .then(data => {
        window.badWordsList = data;
        console.log("‚úÖ Tilt√≥lista bet√∂ltve:", window.badWordsList.length, "sz√≥.");
    })
    .catch(error => {
        console.error("‚ö†Ô∏è Hiba a tilt√≥lista bet√∂lt√©sekor:", error);
        // Hiba eset√©n marad √ºres, vagy ide √≠rhatsz p√°r alap tiltott sz√≥t v√©szhelyzetre
    });

	

window.validateTeamName = function(name) {
    // K√∂telez≈ë kit√∂lt√©s ellen≈ërz√©se
    if (!name || name.trim() === "") {
        return { valid: false, error: "A n√©v mez≈ë kit√∂lt√©se k√∂telez≈ë a j√°t√©k ind√≠t√°s√°hoz!" };
    }
    
    const normalizedText = name.toLowerCase().trim();
    // Tiltott szavak ellen≈ërz√©se
    const hasBadWord = badWordsList.some(word => normalizedText.includes(word.toLowerCase()));
    
    if (hasBadWord) {
        return { valid: false, error: "A v√°lasztott n√©v nem megengedett kifejez√©st tartalmaz!" };
    }
    
    return { valid: true };
};


window.updateInstantButtonEligibility = function() {
    const name = document.getElementById('team-name-input').value.trim();
    const avatar = document.getElementById('team-avatar-select').value;
    const btn = document.getElementById('instant-adventure-btn');

    if (!btn) return;

    // Felt√©tel: n√©v legal√°bb 2 karakter √âS van v√°lasztott avatar
    const isValid = name.length >= 2 && avatar !== "" && avatar !== null;
    
    btn.disabled = !isValid;
};




window.normalizeForComparison = function(text) {
    if (!text) return "";
    return text.toLowerCase().trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
        .replace(/\s+/g, '')
        .replace(/[.#$\[\]/]/g, ""); // √öJ: Minden tiltott Firebase karaktert t√∂r√∂l
};



window.showHiddenGames = false;        
	// *** KONSTANSOK ***
        const GEOFENCE_DEFAULT_RADIUS = 20; 
        const DEFAULT_SCORE_PER_TASK = 50; 
        const HINT1_PENALTY = 10; 
        const HINT2_PENALTY = 20; 
        const WRONG_ANSWER_PENALTY = 1; 
        const RESCUE_TASK_CORRECT_ANSWER = '4'; 
        const RESCUE_TASK_SCORE = 0; 
        const HINT_SECRET_KEY = "MystiGo_Szuper_Titkos_Kulcs_2025";
        const LOCAL_STORAGE_PREFIX = 'MystiGoGameState_'; 
        const DEFAULT_GAME_FILE = 'games/games.xlsx'; 

        const AVATAR_ICONS = {
cat: 'üê±', dog: 'üê∂', panda: 'üêº', monkey: 'üêµ', shark: 'ü¶à', parrot: 'ü¶ú', bear: 'üêª', cow: 'üêÆ', elephant: 'üêò', detective: 'üïµÔ∏è', explorer: 'üß≠', wizard: 'üßô', robot: 'ü§ñ', ghost: 'üëª', skull: '‚ò†Ô∏è', lock: 'üîí', magician: 'üé©', mask: 'üé≠', fire: 'üî•', knight: '‚öîÔ∏è', hamburger: 'üçî', pizza: 'üçï', doughnut: 'üç©', cupcake: 'üßÅ', lollipop: 'üç≠', smile: 'üòé', zombie: 'üßü',ballerina: 'ü©∞',police: 'üöì',firefighter: 'üöí',ambulance: 'üöë',star: '‚≠êÔ∏è', heart: '‚ù§Ô∏è', crown: 'üëë', laptop: 'üíª', floppy: 'üíæ', dragon: 'üê≤', alien: 'üëΩ', rocket: 'üöÄ', ninja: 'ü•∑', unicorn: 'ü¶Ñ', cactus: 'üåµ', guitar: 'üé∏', soccer: '‚öΩ', coffee: '‚òï', butterfly: 'ü¶ã', lion: 'ü¶Å', tiger: 'üêØ', owl: 'ü¶â', superhero: 'ü¶∏', pirate: 'üè¥‚Äç‚ò†Ô∏è', gamepad: 'üéÆ', camera: 'üì∑', rainbow: 'üåà', diamond: 'üíé', ufo: 'üõ∏', sloth: 'ü¶•', poop: 'üí©', chicken: 'üêî', dino: 'ü¶ñ', avocado: 'ü•ë', ice_cream: 'üç¶', frog: 'üê∏', penguin: 'üêß'
        };

        window.appState = {};
        let modalCloseCallback = null;
        let manualMarker = null; 
        let speechSynth = window.speechSynthesis; 

function decryptHintText(encryptedText) {
    if (!encryptedText) return "Nincs seg√≠ts√©g megadva.";
    try {
        const bytes = CryptoJS.AES.decrypt(encryptedText, HINT_SECRET_KEY);
        const originalText = bytes.toString(CryptoJS.enc.Utf8);
        return originalText || "Hiba a visszafejt√©sn√©l (√ºres adat).";
    } catch (e) {
        console.error("Decryption error:", e);
        return "Hiba: A seg√≠ts√©g sz√∂vege s√©r√ºlt vagy nem titkos√≠tott.";
    }
}


// --- √öJ T√âRK√âP R√âTEG KEZEL≈ê (403/API HIBA BIZTOS VERZI√ì) ---
window.addSmartTileLayer = function(mapInstance) {
    if (!mapInstance) return;
    
    // Ha m√°r hozz√°adtunk r√©teget, ne csin√°ljunk semmit (dupl√°z√°s elker√ºl√©se)
    if (mapInstance._layerAdded) return;
    mapInstance._layerAdded = true; // Azonnal megjel√∂lj√ºk, hogy folyamatban van

    // 1. Be√°ll√≠t√°sok
    const apiKey = 'kKSQCwzDF42YIfRHO4T5';
    const mapTilerUrl = `https://api.maptiler.com/maps/streets-v4/{z}/{x}/{y}.png?key=${apiKey}`;
    const osmUrl = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';

    const mapTilerOptions = {
        crossOrigin: true,
        tileSize: 512,
        zoomOffset: -1,
        minZoom: 1,
        maxZoom: 20,
        attribution: 'MapTiler'
    };

    const osmOptions = {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    };

    // 2. Felder√≠t≈ë URL (Egy konkr√©t csempe Budapest felett)
    // Ez csak egy teszt k√©r√©s, nem jelenik meg a t√©rk√©pen
    const testUrl = `https://api.maptiler.com/maps/streets-v4/10/550/350.png?key=${apiKey}`;

    // 3. A D√ñNT√âS LOGIK√ÅJA
    console.log("üîç T√©rk√©p szolg√°ltat√≥ ellen≈ërz√©se...");

    fetch(testUrl, { method: 'HEAD' }) // Csak a fejl√©cet k√©rj√ºk le (gyors)
        .then(response => {
            if (response.ok) {
                // SIKER (200 OK): A MapTiler m≈±k√∂dik, van keret, j√≥ a kulcs.
                console.log("‚úÖ MapTiler el√©rhet≈ë. Pr√©mium r√©teg bet√∂lt√©se.");
                L.tileLayer(mapTilerUrl, mapTilerOptions).addTo(mapInstance);
            } else {
                // HIBA (403 Forbidden, 401 Unauthorized, stb.)
                console.warn(`‚ö†Ô∏è MapTiler hiba (${response.status}). V√°lt√°s OpenStreetMap-re.`);
                L.tileLayer(osmUrl, osmOptions).addTo(mapInstance);
            }
        })
        .catch(error => {
            // H√ÅL√ìZATI HIBA (Pl. offline, vagy DNS hiba)
            console.warn("‚ö†Ô∏è H√°l√≥zati hiba az ellen≈ërz√©sn√©l. V√°lt√°s OpenStreetMap-re.");
            L.tileLayer(osmUrl, osmOptions).addTo(mapInstance);
        });
};



window.checkInstantProgress = function() {
    const resumeUI = document.getElementById('instant-resume-ui');
    if (!resumeUI) return;

    // Megkeress√ºk az instant ment√©st (GameState)
    const saveKey = Object.keys(localStorage).find(key => key.startsWith('MystiGoGameState_instant_'));

    if (saveKey) {
        // HA VAN MENT√âS: Megjelen√≠tj√ºk (flex)
        resumeUI.classList.remove('hidden');
        resumeUI.classList.add('flex');
    } else {
        // HA NINCS: Teljesen elrejtj√ºk (hidden) √©s levessz√ºk a flex-et
        resumeUI.classList.add('hidden');
        resumeUI.classList.remove('flex');
    }
};

/**
 * Instant Kaland folytat√°sa: Bet√∂lti az adatokat √©s az √°ll√°st is
 */
window.resumeInstantAdventure = function() {
    const saveKey = Object.keys(localStorage).find(key => key.startsWith('MystiGoGameState_instant_'));
    if (!saveKey) return;

    const gameId = saveKey.replace('MystiGoGameState_', '');
    const dataKey = `MystiGo_GameData_${gameId}`;
    const savedGameData = localStorage.getItem(dataKey);

    if (savedGameData) {
        // Fontos: El≈ëbb a j√°t√©k defin√≠ci√≥t kell vissza√°ll√≠tani a window.games-be
        window.games[gameId] = JSON.parse(savedGameData);
        // Majd bet√∂lteni az √°llapotot
        loadGameById(gameId);
    } else {
        alert("A kaland adatai elvesztek.");
        window.deleteInstantAdventure(true);
    }
};



window.deleteInstantAdventure = function(force = false) {
    const saveKey = Object.keys(localStorage).find(key => key.startsWith('MystiGoGameState_instant_'));
    
    if (!saveKey) {
        window.checkInstantProgress();
        return;
    }

    // Ez a f√ºggv√©ny csak a t√∂rl√©ssel foglalkozik
    const performDeletion = () => {
        const gameId = saveKey.replace('MystiGoGameState_', '');
        localStorage.removeItem(saveKey); 
        localStorage.removeItem(`MystiGo_GameData_${gameId}`); 
        
        if (window.games && window.games[gameId]) {
            delete window.games[gameId];
        }
        window.checkInstantProgress();
   window.resetAllInstantCustomization();
        console.log("Instant j√°t√©k t√∂r√∂lve, fel√ºlet friss√≠tve.");
    };

    if (force) {
        performDeletion();
    } else {
        showMessage(
            'Azonnali kaland t√∂rl√©se', 
            'Biztosan t√∂r√∂lni szeretn√©d a folyamatban l√©v≈ë azonnali kalandot? Ezt a folyamatot nem lehet visszavonni.', 
            performDeletion, 
            true
        );
    }
};

// --- TESTRESZAB√ÅS √âS C√âLPONT FUNKCI√ìK (Most m√°r glob√°lisan el√©rhet≈ëek) ---
appState.instantTarget = null;
let targetPickerMap = null;
let targetPickerMarker = null;
let userMarkerOnPicker = null;

window.toggleInstantCustomization = function() {
    const content = document.getElementById('instant-custom-content');
    const icon = document.getElementById('instant-custom-icon');
    if (!content) return;
    content.classList.toggle('hidden');
    icon.textContent = content.classList.contains('hidden') ? '+' : '‚Äì';
};



window.openInstantTargetMap = function() {
    document.getElementById('target-picker-modal').classList.remove('hidden');
    document.getElementById('target-picker-modal').classList.add('flex');
    
    if (!targetPickerMap) {
        // Alap√©rtelmezett n√©zet
        targetPickerMap = L.map('target-picker-map', { zoomControl: false }).setView([47.4979, 19.0402], 13);
        window.addSmartTileLayer(targetPickerMap);
        
        targetPickerMap.on('click', (e) => {
            const { lat, lng } = e.latlng;
            if (targetPickerMarker) {
                targetPickerMarker.setLatLng(e.latlng);
            } else {
                // Ez a narancss√°rga/alap marker lesz a c√©lpont
                targetPickerMarker = L.marker(e.latlng, { draggable: true }).addTo(targetPickerMap);
            }
            document.getElementById('confirm-target-btn').disabled = false;
            document.getElementById('confirm-target-btn').classList.remove('opacity-50');
        });
    }

    // Seg√©df√ºggv√©ny a k√©k p√∂tty megjelen√≠t√©s√©hez
    const showUserLocation = (lat, lng) => {
        const userIcon = L.divIcon({
            className: 'user-pos-marker',
            html: '<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg"></div>',
            iconSize: [16, 16]
        });

        if (userMarkerOnPicker) {
            userMarkerOnPicker.setLatLng([lat, lng]);
        } else {
            userMarkerOnPicker = L.marker([lat, lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(targetPickerMap);
        }
        targetPickerMap.setView([lat, lng], 15);
    };

    // 1. Ha m√°r tudjuk hol van a user, azonnal kirakjuk a p√∂tty√∂t
    if (appState.userPosition) {
        showUserLocation(appState.userPosition.lat, appState.userPosition.lng);
    }

    // 2. Friss√≠tj√ºk is a helyzetet, hogy pontos legyen
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                appState.userPosition = { lat, lng };
                showUserLocation(lat, lng);
            },
            (err) => console.warn("GPS hiba a v√°laszt√≥n√°l:", err),
            { enableHighAccuracy: true, timeout: 5000 }
        );
    }
    
    setTimeout(() => targetPickerMap.invalidateSize(), 200);
};



window.confirmInstantTarget = function() {
    if (targetPickerMarker) {
        const pos = targetPickerMarker.getLatLng();
        appState.instantTarget = { lat: pos.lat, lng: pos.lng };
        document.getElementById('target-status-dot').classList.replace('bg-gray-300', 'bg-green-500');
        document.getElementById('reset-target-btn').classList.remove('hidden');
        document.getElementById('target-address-display').textContent = `C√©lpont kijel√∂lve: ${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)}`;
        document.getElementById('target-address-display').classList.remove('hidden');
        closeInstantTargetMap();
    }
};

window.closeInstantTargetMap = function() {
    document.getElementById('target-picker-modal').classList.add('hidden');
    document.getElementById('target-picker-modal').classList.remove('flex');
};

window.resetInstantTarget = function() {
    appState.instantTarget = null;
    if (targetPickerMarker) { 
        targetPickerMarker.remove(); 
        targetPickerMarker = null; 
    }
    // Megjegyz√©s: userMarkerOnPicker-t NEM t√∂r√∂lj√ºk, az maradjon ott t√°mpontnak
    document.getElementById('target-status-dot').classList.replace('bg-green-500', 'bg-gray-300');
    document.getElementById('reset-target-btn').classList.add('hidden');
    document.getElementById('target-address-display').classList.add('hidden');
    document.getElementById('confirm-target-btn').disabled = true;
    document.getElementById('confirm-target-btn').classList.add('opacity-50');
};


window.resetAllInstantCustomization = function() {
    // 1. Leg√∂rd√ºl≈ë men√ºk (dropdowns) vissza√°ll√≠t√°sa alaphelyzetbe
    const catSelect = document.getElementById('instant-category-select');
    const diffSelect = document.getElementById('instant-difficulty-select');
    const countSelect = document.getElementById('instant-task-count-select');

    if (catSelect) catSelect.value = 'all';
    if (diffSelect) diffSelect.value = 'all';
    if (countSelect) countSelect.value = '5';

    // 2. C√©lpont √©s t√©rk√©p t√∂rl√©se (a m√°r megl√©v≈ë f√ºggv√©ny√ºnkkel)
    if (typeof window.resetInstantTarget === 'function') {
        window.resetInstantTarget();
    }

    // 3. A testreszab√°s men√º becsuk√°sa (hogy tiszta legyen a fel√ºlet)
    const content = document.getElementById('instant-custom-content');
    const icon = document.getElementById('instant-custom-icon');
    if (content && !content.classList.contains('hidden')) {
        content.classList.add('hidden');
        if (icon) icon.textContent = '+';
    }
    
    console.log("Minden instant testreszab√°s alaphelyzetbe √°ll√≠tva.");
};




window.applyRotation = function(deg) {
    const activeMarker = appState.playerMarker || manualMarker;
    if (!activeMarker) return;
    
    const el = activeMarker.getElement();
    if (el) {
        // Megkeress√ºk a bels≈ë k√©k k√∂rt √©s csak azt forgatjuk el
        const visual = el.querySelector('.marker-visual');
        if (visual) {
            visual.style.setProperty('--rotation', `${deg}deg`);
        }
    }
};


        function initializeState() {
            appState = { 
                currentPage: 'landing-page', 
                selectedGameId: null, 
                lastMapInteraction: 0,
		currentGame: null, 
                currentTaskIndex: 0, 
                score: 0, 
                timerInterval: null, 
                geofenceTimerInterval: null, 
                startTime: null, 
                map: null, 
                playerMarker: null, 
                taskMarker: null, 
                geofenceCircle: null, 
                userPosition: null, 
                geoWatchId: null, 
                isInZone: false, 
                isTestModeEnabled: false, 
                isManualMock: false, 
                teamName: null, 
                teamAvatar: null, 
                taskOrder: 'sequential', 
                totalTime: 0, 
                geofenceTime: 0, 
                isTimerRunning: false, 
                routeCoordinates: [],
                completedTasks: [], 
                availableTasks: [], 
                taskMarkers: {},
		lastAutoZoomTime: 0,
	        visibleGamesLimit: 5,
		currentFilteredGames: null
            };
        }

        // --- LOCAL STORAGE LOGIC ---
        function getStorageKey(gameId) {
            return LOCAL_STORAGE_PREFIX + gameId;
        }

        function saveGameState() {
            if (!appState.currentGame) return;

            const stateToSave = {
                gameId: appState.currentGame.id, 
                currentTaskIndex: appState.currentTaskIndex,
                score: appState.score,
                totalTime: appState.totalTime,
                geofenceTime: appState.geofenceTime,
                isTimerRunning: appState.isTimerRunning,
                teamName: appState.teamName,
                teamAvatar: appState.teamAvatar,
                isTestModeEnabled: appState.isTestModeEnabled,
                isManualMock: appState.isManualMock,
                routeCoordinates: appState.routeCoordinates,
                completedTasks: appState.completedTasks,
                availableTasks: appState.availableTasks,
                taskOrder: appState.taskOrder,
                tasks: appState.currentGame.tasks 
            };
            
            try {
                localStorage.setItem(getStorageKey(appState.currentGame.id), JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Hiba az √°llapot ment√©sekor:", e);
            }
        }


function loadGameById(gameId) {
            try {
                const savedStateJson = localStorage.getItem(getStorageKey(gameId));
                if (!savedStateJson) return false;

                // --- BIZTONS√ÅGI JAV√çT√ÅS (CRASH FIX) ---
                // Ellen≈ërizz√ºk, hogy l√©tezik-e m√©g a j√°t√©k az Excel adatb√°zisban
                if (!games[gameId]) {
                    console.warn(`A mentett j√°t√©k (${gameId}) m√°r nem tal√°lhat√≥ az adatb√°zisban. Ment√©s t√∂rl√©se.`);
                    // T√∂r√∂lj√ºk a beragadt, hib√°s ment√©st, hogy ne omoljon √∂ssze √∫jra
                    deleteSavedGame(gameId); 
                    return false; 
                }
                // --------------------------------------

                const state = JSON.parse(savedStateJson);
                if (!state.gameId || state.gameId !== gameId) return false;

                appState.currentGame = JSON.parse(JSON.stringify(games[gameId]));




// --- √öJ K√ìD: J√°t√©k fejl√©c log√≥ be√°ll√≠t√°sa (Ment√©sn√©l is!) ---
                const gameLogo = document.getElementById('game-header-logo');
                if (gameLogo) {
                     gameLogo.src = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
                }
                // ----

		window.currentGameId = gameId;                

                appState.currentTaskIndex = state.currentTaskIndex;
                appState.score = state.score;
                appState.totalTime = state.totalTime;
                appState.geofenceTime = state.geofenceTime;
                appState.isTimerRunning = state.isTimerRunning;
                appState.teamName = state.teamName;
                appState.teamAvatar = state.teamAvatar;
                appState.isTestModeEnabled = state.isTestModeEnabled;
                appState.isManualMock = state.isManualMock;
                appState.routeCoordinates = state.routeCoordinates || [];
                appState.completedTasks = state.completedTasks || [];
                appState.availableTasks = state.availableTasks || [];
                
                // TaskOrder helyre√°ll√≠t√°sa
                appState.taskOrder = state.taskOrder;
                if (appState.currentGame) {
                    appState.currentGame.taskOrder = state.taskOrder;
                }
                
                if (state.tasks) {
                    appState.currentGame.tasks = state.tasks;
                }

                showPage('game-page');
                
                setTimeout(() => {
                    initializeMap();
                    if(appState.map) appState.map.invalidateSize();
                    if(appState.isManualMock) {
                        toggleMapClickMock(true);
                    } else {
                        if (manualMarker) { manualMarker.remove(); manualMarker = null; }
                        watchPosition(); 
                    }
                    
                    updateStatusDisplays();
                    
                    if (appState.isTimerRunning) {
                        appState.timerInterval = setInterval(updateTimer, 1000);
                        lastTimeUpdate = new Date().getTime(); 
                    }
                    
                    if (appState.currentGame.taskOrder === 'explore') {
                         if (appState.currentTaskIndex === 0 && appState.isTimerRunning) {
                             showTaskSelectionMap();
                             showMessage("Visszat√©r√©s", `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik a t√©rk√©pes v√°laszt√≥n√°l.`);
                             return true; 
                         }
                    } 
                    
                    loadTask(appState.currentTaskIndex); 
                    
                    let msg = `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik.`;
                    showMessage("Folytat√°s", msg, null);

                }, 100);

                return true;

            } catch (e) {
                console.error("Hiba az √°llapot bet√∂lt√©sekor:", e);
                return false;
            }
        }

        function deleteSavedGame(gameId) {
    // Saj√°t mod√°lis ablak haszn√°lata meger≈ës√≠t√©sre
    showMessage(
        'Ment√©s t√∂rl√©se', 
        'Biztosan t√∂r√∂lni szeretn√©d a mentett √°ll√°st? Ez a folyamat nem vonhat√≥ vissza, a kalandot el√∂lr≈ël kell majd kezdened √©s ha fizett√©l √©rte akkor √∫j kupont kell hozz√° v√°s√°rolnod.', 
        () => {
            // Ez a r√©sz csak akkor fut le, ha az "Igen" gombra nyomnak
            localStorage.removeItem(getStorageKey(gameId));
            
            // UI friss√≠t√©se (eredeti logik√°d meg≈ërz√©se)
            const urlParams = new URLSearchParams(window.location.search);
            const pGameId = urlParams.get('game') || urlParams.get('id');
            const pLoc = urlParams.get('location') || urlParams.get('helyszin');
            const pType = urlParams.get('type') || urlParams.get('tipus');

            if (pGameId || pLoc || pType) {
                console.log("Ment√©s t√∂r√∂lve, URL sz≈±r√©s friss√≠t√©se...");
                handleInitialUrlFiltering();
            } else {
                console.log("Ment√©s t√∂r√∂lve, Dropdown sz≈±r√©s friss√≠t√©se...");
                applyFilters(); 
            }
        }, 
        true // Ez a param√©ter kapcsolja be a "M√©gse" gombot a modalban
    );
}
        
        // Ezt a f√ºggv√©nyt m√°sold be a loadLocalXlsx helyett/mell√©
window.initializeGamesFromFirebase = async function() {
    showLoading(true);
    const statusText = document.getElementById('loading-status');

    // ‚úÖ √öJ: V√°rakoz√°s, ha a Firebase modul m√©g nem t√∂lt√∂tt be (max 5 mp)
    let retryCount = 0;
    while ((!window.db || !window.child) && retryCount < 50) {
        if(statusText) statusText.textContent = "Firebase motor ind√≠t√°sa...";
        await new Promise(r => setTimeout(r, 100));
        retryCount++;
    }

    if(statusText) statusText.textContent = "Csatlakoz√°s a szerverhez...";

    const CACHE_KEY_LIST = 'MystiGo_Cached_GameList';

    // 1. ELLEN≈êRZ√âS: Van-e Firebase motor?
    if (!window.db || !window.get) {
        console.warn("A Firebase motor nem el√©rhet≈ë. Offline m√≥d ind√≠t√°sa.");
        loadFromCacheOrError("Offline m√≥d");
        return;
    }

    try {
        const dbRef = window.ref(window.db);
        const urlParams = new URLSearchParams(window.location.search);
        const pGameId = urlParams.get('game') || urlParams.get('id');
        
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Network Timeout')), 15000)
        );
        
        let fetchPromise;
        if (pGameId) {
            fetchPromise = window.get(window.child(dbRef, `games/public_games_list/${pGameId}`));
        } else {
            fetchPromise = window.get(window.child(dbRef, "games/public_games_list"));
        }

        const snapshot = await Promise.race([fetchPromise, timeoutPromise]);

        if (snapshot.exists()) {
            // --- SIKERES ONLINE LET√ñLT√âS ---
            // üü¢ JELZ≈ê ELREJT√âSE
            if(window.updateOfflineIndicator) window.updateOfflineIndicator(false);

            const data = snapshot.val();
            
            if (pGameId) {
                window.games = { [pGameId]: data };
            } else {
                window.games = data;
            }

            localStorage.setItem(CACHE_KEY_LIST, JSON.stringify(window.games));
            console.log("‚úÖ J√°t√©klista sikeresen friss√≠tve a szerverr≈ël.");
            
            if(statusText) statusText.textContent = "Sikeres friss√≠t√©s!";
            processGameDataAndRender();
        } else {
            loadFromCacheOrError("A k√©rt adat nem tal√°lhat√≥ a szerveren.");
        }

    } catch (error) {
        console.warn("‚ö†Ô∏è Nem siker√ºlt friss√≠teni (Offline vagy lass√∫ net):", error);
        loadFromCacheOrError("Offline m√≥d");
    }

    function loadFromCacheOrError(reasonMsg) {
        const cachedList = localStorage.getItem(CACHE_KEY_LIST);
        
        if (cachedList) {
            console.log("üìÇ Mentett (Offline) lista bet√∂lt√©se...");
            
            // üî¥ JELZ≈ê BEKAPCSOL√ÅSA (Mert cache-b≈ël t√∂lt√ºnk)
            if(window.updateOfflineIndicator) window.updateOfflineIndicator(true);

            try {
                window.games = JSON.parse(cachedList);
                if(statusText) {
                    statusText.innerHTML = `<span style='color:orange'>${reasonMsg}: Mentett adatok bet√∂lt√©se...</span>`;
                }
                processGameDataAndRender();
                
                setTimeout(() => {
                    if(!document.getElementById('game-list-page').classList.contains('hidden')){
                         // Opcion√°lis toast √ºzenet
                    }
                }, 1000);

            } catch(e) {
                console.error("A mentett adatok s√©r√ºltek:", e);
                document.getElementById('game-list').innerHTML = `<div class="text-center p-4 text-red-500">A mentett adatok s√©r√ºltek.<br>Internet sz√ºks√©ges a jav√≠t√°shoz!</div>`;
                showLoading(false);
            }
        } else {
            document.getElementById('game-list').innerHTML = `<div class="text-center p-4 text-red-500">Nem siker√ºlt kapcsol√≥dni.<br>Az els≈ë ind√≠t√°shoz internet sz√ºks√©ges!</div>`;
            showLoading(false);
        }
    }

    function processGameDataAndRender() {
        if(window.games) {
            Object.values(window.games).forEach(g => {
                if (g.tasks && !Array.isArray(g.tasks)) g.tasks = Object.values(g.tasks).filter(Boolean);
                if (!g.tasks) g.tasks = [];
                if (g.price) g.price = parseInt(g.price);
                if ((g.startLocationLat || g.startLocationLng) && !g.startLocation) g.startLocation = {};
                if (g.startLocationLat) g.startLocation.lat = parseFloat(g.startLocationLat);
                if (g.startLocationLng) g.startLocation.lng = parseFloat(g.startLocationLng);
            });
        }
        populateLocationFilter();
        showPage('game-list-page');
        handleInitialUrlFiltering(); 
        if (typeof autoSortGamesByDistance === 'function') {
            try { autoSortGamesByDistance(); } catch(e){} 
        }
        showLoading(false); 
    }
};
       



 // --- I18N ---
        const I18N = { 
            hu: { 
                correct_title: 'Helyes!', 
                correct_body: `√úgyes vagy! (+${DEFAULT_SCORE_PER_TASK} pont)`, 
                wrong_title: 'Sajnos nem j√≥.', 
                wrong_body: `Pr√≥b√°ld √∫jra! Rossz v√°lasz: -${WRONG_ANSWER_PENALTY} pont.`, 
                far_title: 'M√©g messze vagy', 
                far_body: 'L√©pj be a z√≥n√°ba a megold√°s bek√ºld√©s√©hez, vagy a seg√≠ts√©g k√©r√©s√©hez!', 
                in_zone: 'A c√©lter√ºleten vagy!', 
                out_zone: (m) => `M√©g kb. ${m} m√©terre vagy a c√©lt√≥l.`, 
                hint1_body: (h) => `${h} `, 
                hint2_body: (h) => `${h} `, 
                rescue_correct: `Megker√ºl≈ë sikeres! (+${RESCUE_TASK_SCORE} pont)`, 
                rescue_wrong: 'Megker√ºl≈ë hib√°s. Pr√≥b√°ld √∫jra!', 
                gps_required: 'K√©rj√ºk, enged√©lyezd a GPS-t az eszk√∂z√∂d√∂n a kaland elind√≠t√°s√°hoz. Normal m√≥dban a j√°t√©k csak m≈±k√∂d≈ë GPS-szel indul el.' 
            } 
        };
        const t = (key, ...args) => I18N.hu[key] ? (typeof I18N.hu[key] === 'function' ? I18N.hu[key](...args) : I18N.hu[key]) : key;

 // --- PDF GENERATION (Avatarral kieg√©sz√≠tve) ---
       function downloadPDF() {
            const element = document.getElementById('pdf-content');
            if (!element) return;
            
            showLoading(true); 
            document.getElementById('loading-status').textContent = "Eredm√©nylap gener√°l√°sa...";

            const originalStyle = element.style.cssText;
            
            // --- UNIVERZ√ÅLIS JAV√çT√ÅS (Desktop + Mobil) ---
            
            // 1. K√©nyszer√≠tj√ºk a sz√©less√©get A4 m√©retre (kb. 800px)
            // √çgy nem "cs√∫szik el" semmilyen k√©perny≈ën.
            element.style.width = '790px'; 
            element.style.margin = '0 auto'; // K√∂z√©pre igaz√≠t√°s
            element.style.padding = '20px'; 
            element.style.backgroundColor = '#ffffff';
            
            // 2. Biztons√°gos bet≈±t√≠pus
            element.style.fontFamily = 'Arial, Helvetica, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"';
            element.style.lineHeight = '1.5';
            // ---------------------------

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0'); 

            const fileNameTimestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
            
            const safeTeamName = (appState && appState.teamName) ? appState.teamName : 'n√©v';
            const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';
            const gameId = window.currentGameId || 'Eredm√©ny'; 

            const fileName = `MystiGo_${gameId}_${safeTeamName}_${safeAvatar}_${fileNameTimestamp}.pdf`;

            setTimeout(() => {
                html2pdf().from(element).set({
                    margin: 10, 
                    filename: fileName, 
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        logging: false, 
                        useCORS: true, 
                        letterRendering: false, 
                        scrollY: 0,
                        // KULCSFONTOSS√ÅG√ö: A virtu√°lis ablak sz√©less√©ge egyezzen meg az elem sz√©less√©g√©vel!
                        windowWidth: 800,
                        width: 800,
                        x: 0
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save().then(() => {
                    element.style.cssText = originalStyle;
                    document.getElementById('loading-status').textContent = ""; 
                    showLoading(false);
                }).catch(err => {
                    console.error("PDF gener√°l√°si hiba:", err);
                    element.style.cssText = originalStyle;
                    document.getElementById('loading-status').textContent = "";
                    showLoading(false);
                });
            }, 500); 
        }


async function sharePdfViaEmail() {
    const element = document.getElementById('pdf-content');
    if (!element) return;

    const originalStyle = element.style.cssText;
    
    // --- UNIVERZ√ÅLIS JAV√çT√ÅS ITT IS ---
    element.style.width = '790px'; 
    element.style.margin = '0 auto';
    element.style.padding = '20px';
    element.style.backgroundColor = '#ffffff';
    element.style.fontFamily = 'Arial, Helvetica, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"';
    element.style.lineHeight = '1.5';
    // ----------------------------------

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0'); 
    
    const fileNameTimestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
    const safeTeamName = (appState && appState.teamName) ? appState.teamName : 'n√©v';
    const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';
    const gameId = window.currentGameId || 'Eredm√©ny';

    const fileName = `MystiGo_${gameId}_${safeTeamName}_${safeAvatar}_${fileNameTimestamp}.pdf`;

    showLoading(true); 

    try {
        const pdfBlob = await html2pdf().from(element).set({
            margin: 10,
            filename: fileName, 
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                logging: false, 
                useCORS: true,
                letterRendering: false, 
                scrollY: 0,
                // Fix 800px sz√©less√©g itt is
                windowWidth: 800,
                width: 800,
                x: 0
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).output('blob');

        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

        element.style.cssText = originalStyle;
        showLoading(false);

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'J√°t√©k Eredm√©ny',
                    text: `Sziasztok! Itt van a J√°t√©kom eredm√©nye. Kaland: ${gameId}, N√©v: ${safeTeamName}`
                });
            } catch (error) {
                if (error.name !== 'AbortError') console.error(error);
            }
        } else {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            alert('A PDF let√∂lt√©sre ker√ºlt.');
        }

    } catch (err) {
        console.error("Hiba:", err);
        element.style.cssText = originalStyle;
        showLoading(false);
    }
}







        // --- CORE APP & PAGE LOGIC ---
        function showPage(pageId) {
            // --- GA4 Virtual Pageview ---
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    'page_title': pageId,
                    'page_location': window.location.href + '#' + pageId
                });
            }

            // --- POZ√çCI√ìK BE√ÅLL√çT√ÅSA (JAV√çTOTT - 330px) ---
            const contentWrapperEl = document.getElementById('content-page-wrapper');
            const headerEl = document.getElementById('header'); 

            // 1. T√∂r√∂lj√ºk a kor√°bbi oszt√°lyokat √©s st√≠lusokat
            contentWrapperEl.classList.remove('top-40', 'top-52', 'top-32');
            contentWrapperEl.style.top = ''; 
            headerEl.style.paddingBottom = ''; 

            if (pageId === 'game-page') {
                // --- J√ÅT√âK N√âZET ---
                headerEl.style.paddingBottom = '60px'; 
                contentWrapperEl.style.top = '115px'; 
                
            } else if (pageId === 'end-page') {
    // --- JAV√çT√ÅS: 330px helyett szabv√°nyos 160px ---
    // √çgy a g√∂rgethet≈ë ter√ºlet feljebb kezd≈ëdik, nem l√≥g ki a k√©perny≈ër≈ël mobilon.
    // A tartalom (Sz√©p munka felirat) √≠gy is l√°tsz√≥dni fog, de biztons√°gosabb.
    contentWrapperEl.style.top = '160px'; 

} else {
                // --- MEN√ú √âS EGY√âB OLDALAK ---
                contentWrapperEl.style.top = '160px'; 
            }
            // ---------------------------------------------------------

            const landingPage = document.getElementById('landing-page');
            const contentWrapper = document.getElementById('content-wrapper');
            
            if (pageId === 'landing-page') {
                landingPage.classList.remove('hidden');
                contentWrapper.classList.add('translate-y-full');
            } else {
                landingPage.classList.add('hidden');
                contentWrapper.classList.remove('hidden');
                setTimeout(() => contentWrapper.classList.remove('translate-y-full'), 10);
                showContentPage(pageId);
            }
        }

        function showContentPage(pageId) {
            document.querySelectorAll('#content-wrapper section').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            const contentWrapper = document.getElementById('content-page-wrapper');
            if (contentWrapper) contentWrapper.scrollTo({ top: 0, behavior: 'instant' });

            const mainHeader = document.getElementById('main-header');
            const statusBar = document.getElementById('game-status-bar');
            const exitButton = document.getElementById('exit-game-btn'); 
            const gameHeaderLogoContainer = document.getElementById('game-header-logo-container');
            const centerHeaderContent = document.getElementById('center-header-content');
            const teamNameContainer = document.getElementById('team-name-container');
            const teamNameDisplay = document.getElementById('team-name-display');
            const teamAvatarIcon = document.getElementById('game-team-avatar-icon'); 
            const testModeIndicator = document.getElementById('test-mode-indicator');
            const mainHeaderLogoRow = document.getElementById('main-header-logo-row'); 
            const titleEl = document.getElementById('page-title'); // <--- ITT DEFINI√ÅLJUK
            
            if (pageId === 'game-page') {
                mainHeader.classList.add('hidden');
                statusBar.classList.remove('hidden');
                exitButton.classList.remove('hidden'); 
                gameHeaderLogoContainer.classList.remove('hidden');
                centerHeaderContent.classList.remove('hidden');
                testModeIndicator.classList.toggle('hidden', !appState.isTestModeEnabled);
                
                if (appState.teamName) {
        const avatarEmoji = AVATAR_ICONS[appState.teamAvatar] || '';
        const isRegistered = !!(window.auth && window.auth.currentUser);

        // Alkalmazzuk az egys√©ges strukt√∫r√°t
        teamAvatarIcon.className = "avatar-container"; 
        teamAvatarIcon.innerHTML = `
    ${avatarEmoji}
    ${isRegistered ? `
        <div class="verified-badge verified-badge-sm active">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
        </div>` : ''}
`;
        teamNameDisplay.textContent = appState.teamName;
    teamNameContainer.classList.remove('hidden');
} else {
                    teamNameContainer.classList.add('hidden');
                }
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.add('hidden');
            } else {
                mainHeader.classList.remove('hidden');
                statusBar.classList.add('hidden');
                exitButton.classList.add('hidden'); 
                gameHeaderLogoContainer.classList.add('hidden');
                centerHeaderContent.classList.add('hidden');
                testModeIndicator.classList.add('hidden');
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.remove('hidden');
                
                // --- M√ìDOS√çT√ÅS: C√çM KEZEL√âSE ---
                if (pageId === 'end-page') {
                    // Ha a j√°t√©k v√©g√©n vagyunk, ELREJTJ√úK a c√≠met, csak a log√≥ marad
                    if (titleEl) titleEl.classList.add('hidden');
                } else {
                    // Minden m√°s oldalon (pl. Kalandv√°laszt√≥) MEGJELEN√çTJ√úK
                    if (titleEl) {
                        titleEl.classList.remove('hidden');
                        const titles = { 'game-list-page': 'Fedezd fel a v√°rost' };
                        titleEl.textContent = titles[pageId] || 'MystiGo';
                    }
                }
                // -------------------------------
                
                if (pageId === 'game-list-page') {
                    // Log√≥ vissza√°ll√≠t√°sa a f≈ëmen√ºben
                    window.checkInstantProgress();
		    const mainHeaderLogo = document.getElementById('main-header-logo');
                    if (mainHeaderLogo) {
                        // Megn√©zz√ºk, hogy be van-e kapcsolva a Kids m√≥d
                        const isKidsMode = localStorage.getItem('mystigo_pref_kidsMode') === 'true';
                        
                        // Ennek megfelel≈ëen √°ll√≠tjuk be a k√©pet
                        mainHeaderLogo.src = isKidsMode ? "logo/MystiGo_logo_cat.png" : "logo/MystiGo_logo.png";
                    }

                    if (Object.keys(games).length > 0) applyFilters();
                    if (Object.keys(games).length > 0) document.getElementById('team-setup').classList.remove('hidden');
                    
		    if (typeof window.checkInstantProgress === 'function') window.checkInstantProgress();


                    // Titkos kapcsol√≥ vissza√°ll√≠t√°sa a c√≠m mell√© (csak ha van c√≠m elem √©s l√°that√≥)
                    if (titleEl && !titleEl.classList.contains('hidden')) {
                        const secretTrigger = document.createElement('span');
                        secretTrigger.id = 'secret-trigger';
                        secretTrigger.className = 'text-brand-black-500 cursor-pointer ml-1 font-extrabold';
                        secretTrigger.textContent = '!';
                        titleEl.appendChild(secretTrigger);
                    }

                } else {
                    document.getElementById('secret-switches-container').classList.add('hidden');
                }
            }
        }
            

  window.resetApp = function() {
            // 1. T√©rk√©p √©s markerek takar√≠t√°sa
            if (appState.map) {
                appState.map.remove();
                appState.map = null;
            }
            if (manualMarker) {
                manualMarker.remove();
                manualMarker = null;
            }
            if (appState.geoWatchId) {
                stopAllGpsActivity();
            }
            if (appState.timerInterval) clearInterval(appState.timerInterval);

            // 2. V√°ltoz√≥k alaphelyzetbe √°ll√≠t√°sa
            initializeState();

            // 3. UI vissza√°ll√≠t√°sa
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('content-wrapper').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.remove('translate-y-full');
            
            // UI elemek elrejt√©se a biztons√°g kedv√©√©rt
            document.getElementById('task-interaction-area').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            document.getElementById('game-status-bar').classList.add('hidden');

            // 4. J√°t√©klista bet√∂lt√©se Firebase-b≈ël
            initializeGamesFromFirebase(); 
            
            // 5. Oldalv√°lt√°s a list√°ra
            // (A initializeGamesFromFirebase a v√©g√©n √∫gyis megh√≠vja a showPage-t, 
            // de nem baj, ha itt is megvan, a bet√∂lt√©sjelz≈ë addig l√°tszik)
        };

        window.showLoading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        
        window.showMessage = function(title, body, onClose, showCancel = false) {
            // --- iPad / Mobil FIX KEZDIDE ---
    		        // 1. Ha nyitva a billenty≈±zet (mert a beviteli mez≈ën van a f√≥kusz), bez√°rjuk
 		           if (document.activeElement instanceof HTMLElement) {
 		               document.activeElement.blur();
     		       }
            
       			     // 2. Azonnal a tartalom tetej√©re g√∂rget√ºnk, hogy az ablak biztosan l√°that√≥ legyen
	              window.scrollTo(0, 0);
   				         const contentWrapper = document.getElementById('content-page-wrapper');
 				           if (contentWrapper) {
 			               contentWrapper.scrollTo({ top: 0, behavior: 'instant' });
    				        }
          				  // --- iPad / Mobil FIX V√âGE ---
	    document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').innerHTML = DOMPurify.sanitize(body, { ADD_ATTR: ['style'], ADD_TAGS: ['strong', 'em', 'p', 'br'] }); 
            const okButton = document.getElementById('modal-ok-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            okButton.textContent = 'Rendben';
            cancelButton.classList.add('hidden');

            if (showCancel) {
                okButton.textContent = 'Igen'; cancelButton.textContent = 'Nem'; cancelButton.classList.remove('hidden');
                okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
                cancelButton.onclick = hideMessage; 
            } else {
                 okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
            }
            modalCloseCallback = null; 
            document.getElementById('message-modal').classList.remove('hidden');
        }

        window.hideMessage = function() { 
            document.getElementById('message-modal').classList.add('hidden');
            if(typeof modalCloseCallback === 'function') { modalCloseCallback(); modalCloseCallback = null; }
            document.getElementById('modal-ok-button').onclick = hideMessage;
        }
        
        window.showReportModal = function() {
            if (!appState.currentGame) return;
            
            // Friss√≠tj√ºk a z√≥na ellen≈ërz√©st (hogy l√°ssuk, benne vagyunk-e)
            checkGeofence();
            
            // Megjelen√≠tj√ºk az ablakot
            document.getElementById('report-error-modal').classList.remove('hidden');
            
            // EZT A SORT T√ñR√ñLT√úK KI, MERT EZ OKOZTA A HIB√ÅT:
            // document.getElementById('error-description-input').value = '';
        }


// --- K√âP NAGY√çT√ì FUNKCI√ìK ---

window.openImageModal = function(imgSrc) {
    if (!imgSrc) return;
    
    const modal = document.getElementById('image-zoom-modal');
    const modalImg = document.getElementById('image-zoom-content');
    
    // Be√°ll√≠tjuk a k√©pet
    modalImg.src = imgSrc;
    
    // Megjelen√≠tj√ºk a modalt (flex-re v√°ltunk a hidden helyett)
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Kis anim√°ci√≥ a megjelen√©shez
    setTimeout(() => {
        modalImg.classList.remove('scale-95');
        modalImg.classList.add('scale-100');
    }, 10);
};

window.closeImageModal = function() {
    const modal = document.getElementById('image-zoom-modal');
    const modalImg = document.getElementById('image-zoom-content');
    
    // Anim√°ci√≥ vissza
    modalImg.classList.remove('scale-100');
    modalImg.classList.add('scale-95');
    
    // Elt√ºntet√©s kis k√©sleltet√©ssel
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modalImg.src = ""; // T√∂r√∂lj√ºk a forr√°st
    }, 200);
};



        window.hideReportModal = function() { 
            document.getElementById('report-error-modal').classList.add('hidden'); 
        }

        window.handleSubmitError = function() {
    if (!appState.currentGame) return;
    const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex); 
    if (!currentTask) return;

    // --- M√ìDOS√çT√ÅS KEZDETE ---
    // Ha a 0. feladatot (Start pont) ugorjuk √°t, akkor el kell ind√≠tani a rendszert!
    if (currentTask.index === 0) {
        // Ez a f√ºggv√©ny elind√≠tja az id≈ët, a GPS r√∂gz√≠t√©st, √©s bet√∂lti a k√∂vetkez≈ë feladatot (Task 1)
        startTimersAndGPS();
        
        hideReportModal();
        
        // Jelz√ºnk a felhaszn√°l√≥nak, de NEM h√≠vjuk meg a handleCorrectAnswer-t,
        // mert a startTimersAndGPS() m√°r elv√©gezte a lapoz√°st.
        showMessage("J√°t√©k Elind√≠tva", "A kezd≈ëpontot √°tugrottad. A j√°t√©k √©s az id≈ëm√©r√©s elindult!", null);
        return; 
    }
    // --- M√ìDOS√çT√ÅS V√âGE ---

    // Ez marad a r√©gi a t√∂bbi feladathoz:
    currentTask.taskScore = 0;
    currentTask.skipped = true; 
    updateStatusDisplays(); hideReportModal();
    showMessage("√Åtugorva", "A feladatot teljes√≠tettnek jel√∂lt√ºk (0 pont). A j√°t√©k folytat√≥dik.", () => { handleCorrectAnswer(); });
}
        
        function handleExitGame() { resetApp(); }

        window.showExitConfirmation = function() {
            showMessage('Kil√©p√©s', 'Biztosan vissza l√©psz a f≈ëmen√ºbe? A j√°t√©k √°ll√°sa elment√©sre ker√ºl.', handleExitGame, true);
        }

        // --- DATA PROCESSING ---
        function assertCols(obj, req, ctx) {
            const missing = req.filter(k => !(k in obj) || obj[k] === null || String(obj[k]).trim() === '');
            if (missing.length > 0) throw new Error(`'${ctx}' munkalap hiba: A(z) ${missing.map(m => `"${m}"`).join(', ')} mez≈ë(k) hi√°nyzik/√ºres.`);
        }



// --- SZ≈∞R≈ê DOBOZ LENYIT√ÅSA / BECSUK√ÅSA ---
        window.toggleFilterSection = function() {
    const content = document.getElementById('filter-content');
    const icon = document.getElementById('filter-toggle-icon');
    
    if (!content || !icon) return;

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = '‚Äì';
        icon.classList.remove('text-brand-orange-500');
        icon.classList.add('text-brand-blue');
    } else {
        content.classList.add('hidden');
        icon.textContent = '+';
        icon.classList.add('text-brand-orange-500');
        icon.classList.remove('text-brand-blue');
    }
};



      


                populateLocationFilter(); 
                
                // Most h√≠vjuk meg a sz≈±r≈ët - biztosan van m√°r adat!
                if (window.checkUrlParametersAndFilter) {
                    checkUrlParametersAndFilter();
                }
                
               
        
        // --- UI RENDERING ---
        function renderGameList(gamesToRender = null) {
            const listEl = document.getElementById('game-list');
            listEl.innerHTML = '';
            
            // ... (A rendez√©si √©s sz≈±r√©si logika v√°ltozatlan marad) ...
            // ... (sourceData, rawArray, displayableGames stb.) ...

            const sourceData = gamesToRender || games;
            let rawArray = Object.values(sourceData);

            if (rawArray.length > 0 && typeof rawArray[0]._calculatedDistance !== 'undefined') {
                rawArray.sort((a, b) => a._calculatedDistance - b._calculatedDistance);
            }

            const displayableGames = rawArray.filter(game => {
                 // ... (itt marad a megl√©v≈ë sz≈±r√©si logik√°d) ...
                 // (csak a helytakar√©koss√°g miatt nem m√°solom be az eg√©szet)
                 if (gamesToRender) return true;
                 if (window.showHiddenGames) return true;
                 if (game.isHidden) return false;
                 
                 let playCount = parseInt(localStorage.getItem('MystiGo_Perm_Count_' + game.id) || 0);
                 const oldBooleanSave = localStorage.getItem('MystiGo_Perm_Completed_' + game.id);
                 if (playCount === 0 && oldBooleanSave === 'true') playCount = 1;

                 const isManuallyDisabled = (game.maxPlayCount === -1);
                 const isLimitReached = (game.maxPlayCount > 0 && playCount >= game.maxPlayCount);

                 if (isManuallyDisabled || isLimitReached) return false;

                 return true;
            });

            if (displayableGames.length === 0) {
                 // ... (√ºres lista kezel√©se marad) ...
                 listEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-gray-500 font-semibold">Nincs a sz≈±r√©snek megfelel≈ë j√°t√©k.</p>
                    <button onclick="applyFilters()" class="text-brand-blue underline mt-2 text-sm">Sz≈±r≈ëk friss√≠t√©se</button>
                 </div>`; 
                 return;
            }
            
            if (!gamesToRender) {
                populateLocationFilter();
            }

            const currentLimit = appState.visibleGamesLimit;
            const visibleGames = displayableGames.slice(0, currentLimit);

            visibleGames.forEach(game => {
                const hasSave = localStorage.getItem(getStorageKey(game.id)) !== null;
                const placeholderImage = `https://placehold.co/600x300/${game.type === 'kids' ? 'FFF8E1' : 'E0F7FA'}/${game.type === 'kids' ? 'F57C00' : '0A2B4C'}?text=${encodeURIComponent(game.title)}`;
                
                // ... (t√≠pus badge, priceText, locationBadge logika v√°ltozatlan) ...
                let gameTypeBadge = '';
                if (game.type === 'kids') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-0.5 text-xs font-medium text-yellow-800">Kids üêà</span>`;
                else if (game.type === 'team') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-indigo-100 px-3 py-0.5 text-xs font-medium text-indigo-800">Team üßë‚Äçü§ù‚Äçüßë</span>`;
                else if (game.type === 'explore') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-cyan-100 px-3 py-0.5 text-xs font-medium text-cyan-800">Explore üåç</span>`;
                else gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-green-100 px-3 py-0.5 text-xs font-medium text-green-800">Normal üß≠</span>`;

                const priceText = game.price > 0 ? `${game.price.toLocaleString('hu-HU')} Ft` : 'Ingyenes';
                const gameTitleForMessage = game.title.replace(/'/g, "\\'");
                const locationBadge = game.location ? `<span class="text-xs text-gray-500 font-semibold flex items-center mt-1"><svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${game.location}</span>` : '';

                // ... (playCount, contentOpacityClass, saveIndicator logika v√°ltozatlan) ...
                let playCount = parseInt(localStorage.getItem('MystiGo_Perm_Count_' + game.id) || 0);
                const oldBooleanSave = localStorage.getItem('MystiGo_Perm_Completed_' + game.id);
                if (playCount === 0 && oldBooleanSave === 'true') playCount = 1;
                
                const isManuallyDisabled = (game.maxPlayCount === -1);
                const isLimitReached = (game.maxPlayCount > 0 && playCount >= game.maxPlayCount);
                
                let contentOpacityClass = ""; 
                let completedBadge = "";

                if (!window.showHiddenGames && (isLimitReached || isManuallyDisabled)) {
                    contentOpacityClass = "opacity-40 grayscale"; 
                    if (isManuallyDisabled) {
                        completedBadge = `<div class="bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded absolute top-2 right-2 shadow-md z-20">üîí JELENLEG NEM EL√âRHET≈ê</div>`;
                    } else {
                        completedBadge = `<div class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded absolute top-2 right-2 shadow-md z-20">TELJES√çTVE (${playCount}/${game.maxPlayCount}) ‚úÖ</div>`;
                    }
                }

                let saveIndicator = "";
                let cardBorder = "";
                if (hasSave) {
                    saveIndicator = `<div class="bg-brand-orange text-white text-xs font-bold px-2 py-1 rounded absolute top-2 left-2 shadow-md z-20">MENTVE</div>`;
                    cardBorder = "border-2 border-brand-orange";
                }

                // T√°vols√°g badge
                let distanceBadge = "";
                if (game._calculatedDistance !== undefined) {
                    const distText = game._calculatedDistance > 100 
                        ? Math.round(game._calculatedDistance) + " km" 
                        : game._calculatedDistance.toFixed(1) + " km";
                    distanceBadge = `<div class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded absolute bottom-2 left-2 shadow-md z-20 flex items-center gap-1">üìç ${distText}</div>`;
                }

                // -----------------------------------------------------
                // --- √öJ K√ìD: LIMIT JELV√âNY (Jobb als√≥ sarok a k√©pen) ---
                // -----------------------------------------------------
                let limitBadgeHtml = "";
                if (game.globalLimit && game.globalLimit > 0) {
                     limitBadgeHtml = `<div id="limit-badge-${game.id}" class="bg-gray-200 text-white text-xs font-bold px-2 py-1 rounded absolute bottom-2 right-2 shadow-md z-20 flex items-center gap-1 backdrop-blur-sm bg-opacity-20">
                        <span class="text-[10px]">üë•</span> <span class="loading-dots">...</span> / ${game.globalLimit}
                    </div>`;
                }
                // -----------------------------------------------------

// T√°vols√°g jelv√©ny ut√°n, limit jelv√©ny mell√©:
    let ratingBadgeHtml = `<div id="rating-badge-${game.id}" class="rating-badge hidden">
        <span class="text-orange-500">‚òÖ</span> <span class="rating-val">0.0</span>
    </div>`;


                let deleteButtonHtml = "";
                if (hasSave) {
                    deleteButtonHtml = `
                        <button onclick="event.stopPropagation(); deleteSavedGame('${game.id}');" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 shadow-md z-30" title="√öjrakezd√©s (Ment√©s t√∂rl√©se)">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                }

                const leaderboardBtnHtml = `
                    <button onclick="event.stopPropagation(); openLeaderboardModal('${game.id}');" 
                            class="absolute bottom-4 right-4 bg-white text-brand-blue border border-gray-200 p-2 rounded-full shadow-lg hover:bg-brand-orange hover:text-white hover:scale-110 transition-all z-30"
                            title="Ranglista megtekint√©se">
                        üèÜ
                    </button>
                `;

                listEl.innerHTML += `
                    <div class="content-card overflow-hidden cursor-pointer hover:shadow-xl transition-shadow relative ${cardBorder}" 
                         onclick="handleGameSelect('${game.id}', '${gameTitleForMessage}', '${game.type}', '${priceText}', ${hasSave})">
                        ${saveIndicator}
                        ${completedBadge}
                        ${deleteButtonHtml}
                        ${leaderboardBtnHtml}
                        
                        <div class="relative">
                            <img src="${game.imageUrl || placeholderImage}" alt="${game.title}" class="h-40 w-full object-cover ${contentOpacityClass}" onerror="this.onerror=null;this.src='${placeholderImage}';">
                            ${distanceBadge}
                            ${ratingBadgeHtml}
			    ${limitBadgeHtml}  </div>

                        <div class="p-5 ${contentOpacityClass}">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-text-heading">${game.title}</h3>
                                ${gameTypeBadge}
                            </div>
                            ${locationBadge}
                            <p class="text-text-dark mt-1 text-sm">${game.description || 'Nincs le√≠r√°s megadva.'}</p>
                            <p class="text-xs font-semibold mt-3 text-brand-orange-500 pr-10">${priceText}</p>
                            ${hasSave ? '<p class="text-xs font-bold text-green-600 mt-2">Kattints a folytat√°shoz!</p>' : ''}
                        </div>
                    </div>`;
            });
            
            // "Tov√°bbiak bet√∂lt√©se" gomb
            if (displayableGames.length > currentLimit) {
                const remaining = displayableGames.length - currentLimit;
                listEl.innerHTML += `
                    <div class="text-center pt-4 pb-2">
                        <button onclick="loadMoreGames()" class="bg-white border-2 border-gray-200 text-gray-500 hover:text-brand-blue hover:border-brand-blue font-bold py-3 px-6 rounded-full shadow-sm transition w-full">
                            Tov√°bbi kalandok bet√∂lt√©se (${remaining} db) ‚ñº
                        </button>
                    </div>
                `;
            }

            // ----------------------------------------------------------------
            // --- √öJ K√ìD: Adatok bet√∂lt√©se a gener√°l√°s ut√°n (ASZINKRON) ---
            // ----------------------------------------------------------------
            visibleGames.forEach(game => {
                
                // --- EZT A R√âSZT M√ìDOS√çTJUK ---
                if (window.db && window.get) {
                    window.get(window.ref(window.db, `game_stats/${game.id}/rating/average`)).then(snap => {
                        if (snap.exists()) {
                            const avg = parseFloat(snap.val()); // Sz√°mm√° alak√≠tjuk
                            const badge = document.getElementById(`rating-badge-${game.id}`);
                            
                            if (badge) {
                                // Csak akkor mutatjuk, ha el√©ri a 4.0-√°t
                                if (avg >= 4.0) {
                                    badge.classList.remove('hidden');
                                    const valSpan = badge.querySelector('.rating-val');
                                    if (valSpan) valSpan.textContent = avg.toFixed(1);
                                } else {
                                    // Ha 4.0 alatt van vagy nincs adat, elrejtj√ºk
                                    badge.classList.add('hidden');
                                }
                            }
                        }
                    });
                }

		// Csak akkor k√©rdezz√ºk le, ha van limit, k√ºl√∂nben felesleges terhel√©s
                if (game.globalLimit && game.globalLimit > 0) {
                    if (window.getGameCurrentCount) {
                        window.getGameCurrentCount(game.id).then(count => {
                            const badgeEl = document.getElementById(`limit-badge-${game.id}`);
                            if (badgeEl) {
                                const isFull = count >= game.globalLimit;
                                // Tartalom friss√≠t√©se
                                badgeEl.innerHTML = `<span class="text-[10px]">üë•</span> ${count} / ${game.globalLimit}`;
                                
                                // Ha betelt, pirosra v√°ltjuk
                                if (isFull) {
                                    badgeEl.classList.remove('bg-gray-200');
                                    badgeEl.classList.add('bg-red-600');
                                    badgeEl.title = "A limit betelt!";
                                }
                            }
                        });
                    }
                }
            });
            // ----------------------------------------------------------------
        }
  



// --- √öJ SZ≈∞R≈ê F√úGGV√âNYEK ---
       function populateLocationFilter() {
    const locationSelect = document.getElementById('filter-location');
    if (!locationSelect) return;

    // Megjegyezz√ºk, mi volt kiv√°lasztva
    const currentValue = locationSelect.value;
    const locations = new Set();
    
    Object.values(games).forEach(game => {
        // --- M√ìDOS√çT√ÅS: Ha nem vagyunk fejleszt≈ëi m√≥dban, rejtj√ºk a rejtetteket ---
        if (!window.showHiddenGames && game.isHidden) return; 
        // ------------------------------------------------------------------------

        const rawLocation = String(game.location || "");

        if (rawLocation && rawLocation !== 'Egy√©b' && rawLocation !== 'undefined') {
            const parts = rawLocation.split(','); 
            parts.forEach(part => {
                const cleanLoc = part.trim();
                if (cleanLoc) locations.add(cleanLoc);
            });
        }
    });

    // Opci√≥k √∫jra√©p√≠t√©se
    locationSelect.innerHTML = '<option value="all">√ñsszes Helysz√≠n</option>';
    Array.from(locations).sort((a, b) => a.localeCompare(b, 'hu')).forEach(loc => {
        const option = document.createElement('option');
        option.value = loc;
        option.textContent = loc;
        locationSelect.appendChild(option);
    });

    // Vissza√°ll√≠tjuk a kiv√°laszt√°st
    if (Array.from(locationSelect.options).some(option => option.value === currentValue)) {
        locationSelect.value = currentValue;
    } else {
        locationSelect.value = 'all';
    }
}

// --- EZ HI√ÅNYZOTT: Sz≈±r√©s v√©grehajt√°sa ---
window.applyFilters = function() {
            const locSelect = document.getElementById('filter-location');
            const typeSelect = document.getElementById('filter-type');
            const searchInput = document.getElementById('filter-search'); // √öJ MEZ≈ê
            
            if (!locSelect || !typeSelect) return;

            const location = locSelect.value;
            const type = typeSelect.value;
            // Keres√©si sz√∂veg kisbet≈±s√≠tve √©s sz√≥k√∂z√∂k n√©lk√ºl
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : ''; 

            // MINDIG vissza√°ll√≠tjuk a limitet 5-re √∫j sz≈±r√©skor
            appState.visibleGamesLimit = 5;

            // HA MINDEN ALAP√âRTELMEZETT (Nincs sz≈±r√©s √©s nincs keres√©s sem)
            if (location === 'all' && type === 'all' && searchTerm === '') {
                appState.currentFilteredGames = null; 
                renderGameList(null); // Alap lista (5 db + load more)
                return;
            }

            const filteredGames = {};

            Object.values(games).forEach(game => {
                if (!window.showHiddenGames && game.isHidden) return; 

                // 1. Helysz√≠n sz≈±r√©s
                let locMatch = (location === 'all');
                if (!locMatch) {
                    const gameLocs = game.location ? String(game.location).split(',').map(s => s.trim()) : [];
                    locMatch = gameLocs.includes(location);
                }

                // 2. T√≠pus sz≈±r√©s
                const typeMatch = (type === 'all' || game.type === type);

                // 3. √öJ: Sz√∂veges keres√©s (ID, C√≠m, Helysz√≠n, T√≠pus)
                let searchMatch = true;
                if (searchTerm !== '') {
                    // √ñsszef≈±zz√ºk a kereshet≈ë mez≈ëket egy hossz√∫ stringg√©
                    const searchableText = `${game.id} ${game.title} ${game.location} ${game.type}`.toLowerCase();
                    // Megn√©zz√ºk, benne van-e a keresett sz√≥
                    searchMatch = searchableText.includes(searchTerm);
                }

                // Csak akkor adjuk hozz√°, ha MINDEN felt√©tel igaz
                if (locMatch && typeMatch && searchMatch) {
                    filteredGames[game.id] = game;
                }
            });

            // Elmentj√ºk √©s kirajzoljuk a tal√°latokat
            appState.currentFilteredGames = filteredGames;
            renderGameList(filteredGames);
        }

// --- √öJ AUTOMATIKUS RENDEZ≈ê F√úGGV√âNY ---
        // --- JAV√çTOTT GPS RENDEZ√âS (WatchPosition tr√ºkk) ---
window.autoSortGamesByDistance = function() {
    if (!navigator.geolocation) return;

    console.log("üìç Automatikus GPS rendez√©s ind√≠t√°sa...");

    // Ez a tr√ºkk: watchPosition-t haszn√°lunk, mert az er≈ësebben "k√©nyszer√≠ti" a telefont
    // a poz√≠ci√≥ friss√≠t√©s√©re, mint a sima getCurrentPosition.
    const geoOptions = {
        enableHighAccuracy: true, // Megpr√≥b√°ljuk a pontos helyet
        timeout: 10000,           // 10 m√°sodpercig pr√≥b√°lkozunk
        maximumAge: 0             // Nem fogadunk el r√©gi (cache-elt) adatot, frisset k√©r√ºnk
    };

    const watchId = navigator.geolocation.watchPosition(
        (position) => {
            // SIKERES POZ√çCI√ìSZERZ√âS
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            console.log(`üìç Poz√≠ci√≥ megvan! Pontoss√°g: ${accuracy}m`);

            // Mivel megvan a poz√≠ci√≥, azonnal le√°ll√≠tjuk a figyel√©st, hogy ne fogyassza az akkut
            navigator.geolocation.clearWatch(watchId);

            // T√°vols√°gok kisz√°m√≠t√°sa minden j√°t√©khoz
            Object.values(games).forEach(game => {
                if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                    const dist = haversineDistance(
                        { lat: userLat, lng: userLng },
                        { lat: game.startLocation.lat, lng: game.startLocation.lng }
                    );
                    game._calculatedDistance = dist / 1000; // km
                } else {
                    game._calculatedDistance = 99999;
                }
            });

            // Lista √∫jrarajzol√°sa
            // Fontos: Az √©ppen aktu√°lis sz≈±r√©st (appState.currentFilteredGames) adjuk √°t neki,
            // hogy ne √°ll√≠tsa vissza a list√°t alap√°llapotba, ha a user k√∂zben sz≈±rt.
            renderGameList(appState.currentFilteredGames);
        },
        (error) => {
            // Hiba eset√©n (pl. timeout vagy letilt√°s) csak logolunk, nem zavarjuk a felhaszn√°l√≥t
            console.warn("Automatikus GPS rendez√©s nem siker√ºlt:", error.message);
            
            // Ha timeout volt (k√≥d: 3), megpr√≥b√°lhatjuk √∫jra laz√°bb be√°ll√≠t√°sokkal (opcion√°lis)
            if (error.code === 3) {
                console.log("√öjrapr√≥b√°lkoz√°s alacsonyabb pontoss√°ggal...");
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                         // Ha itt siker√ºl, ugyanaz a logika fut le...
                         // (Egyszer≈±s√≠t√©s v√©gett itt most nem duplik√°lom a k√≥dot, 
                         // a watchPosition √°ltal√°ban megoldja a gondot)
                    }, 
                    null, 
                    { enableHighAccuracy: false, timeout: 15000, maximumAge: 60000 }
                );
            }
        },
        geoOptions
    );
};

// --- √öJ F√úGGV√âNY: T√°vols√°g alap√∫ rendez√©s (JAV√çTVA: L√°that√≥s√°g sz≈±r√©ssel) ---
        window.sortGamesNearby = function() {
            const btn = document.getElementById('btn-sort-nearby');
            const status = document.getElementById('nearby-status');
            
            if (!navigator.geolocation) {
                alert("A b√∂ng√©sz≈ëd nem t√°mogatja a helymeghat√°roz√°st.");
                return;
            }

            // UI visszajelz√©s
            btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-brand-blue border-t-transparent rounded-full"></div> Helyzet lek√©r√©se...`;
            btn.disabled = true;
            status.textContent = "GPS jel keres√©se...";
            status.classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    status.textContent = "T√°vols√°gok sz√°m√≠t√°sa √©s sz≈±r√©s...";

                    const gamesArray = [];
                    const sortedGames = {};

                    // J√°t√©kok feldolgoz√°sa
                    Object.values(games).forEach(game => {
                        
                        // --- JAV√çT√ÅS ITT: Sz≈±r√©s a l√°that√≥s√°g alapj√°n ---
                        // Ha NEM vagyunk fejleszt≈ëi m√≥dban (showHiddenGames hamis), akkor sz≈±r√ºnk:
                        if (!window.showHiddenGames) {
                            // 1. Rejtett j√°t√©kok kisz≈±r√©se
                            if (game.isHidden) return;
                            
                            // 2. Nem j√°tszhat√≥ (Letiltott) j√°t√©kok kisz≈±r√©se
                            if (game.maxPlayCount === -1) return;
                        }
                        // ------------------------------------------------

                        if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                            const dist = haversineDistance(
                                { lat: userLat, lng: userLng }, 
                                { lat: game.startLocation.lat, lng: game.startLocation.lng }
                            );
                            game._calculatedDistance = dist / 1000; // km
                        } else {
                            game._calculatedDistance = 99999; 
                        }
                        gamesArray.push(game);
                    });

                    // Rendez√©s (legkisebb el≈ël)
                    gamesArray.sort((a, b) => a._calculatedDistance - b._calculatedDistance);

                    // Visszaalak√≠t√°s objektumm√°
                    gamesArray.forEach(game => {
                        sortedGames[game.id] = game;
                    });

                    // Be√°ll√≠tjuk, hogy ez a "sz≈±rt" lista
                    appState.currentFilteredGames = sortedGames;
                    appState.visibleGamesLimit = 5;

                    // √öjrarajzol√°s (Most m√°r csak a sz≈±rt elemeket tartalmazza a sortedGames)
                    renderGameList(sortedGames);

                    // UI vissza√°ll√≠t√°s
                    btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (Friss√≠tve)`;
                    btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                    btn.disabled = false;
                    status.textContent = `Sikeres rendez√©s a poz√≠ci√≥d alapj√°n.`;
                    
                    setTimeout(() => {
                        btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)`;
                        btn.classList.remove('bg-green-50', 'border-green-500', 'text-green-700');
                        status.classList.add('hidden');
                    }, 5000);

                },
                (error) => {
                    console.error("GPS Hiba:", error);
                    alert("Nem siker√ºlt lek√©rni a helyzeted. K√©rlek, enged√©lyezd a GPS-t!");
                    
                    btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)`;
                    btn.disabled = false;
                    status.classList.add('hidden');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        };




  // --- √öJ, BIZTOSABB URL SZ≈∞R≈ê LOGIKA (Adat-vez√©relt) ---
        function handleInitialUrlFiltering() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Param√©terek kiolvas√°sa
            const pGameId = urlParams.get('game') || urlParams.get('id');
            const pLoc = urlParams.get('location') || urlParams.get('helyszin');
            const pType = urlParams.get('type') || urlParams.get('tipus');

            // Ha nincs semmilyen param√©ter, nem csin√°lunk semmit (minden l√°tszik)
            if (!pGameId && !pLoc && !pType) return;

            console.log("üîç URL Sz≈±r√©s akt√≠v:", { pGameId, pLoc, pType });

            let filteredGames = {};
            let matchFound = false;

            // --- √öJ BLOKK KEZDETE (Rejtett j√°t√©kok list√°z√°sa) ---
            if (pType === 'hidden' || pType === 'rejtett') {
                Object.values(games).forEach(game => {
                    if (game.isHidden) {
                        filteredGames[game.id] = game;
                        matchFound = true;
                    }
                });
                
                if (matchFound) {
                    console.log("Rejtett j√°t√©kok list√°z√°sa...");
                    // FONTOS: Itt is el kell menteni az √°llapotot!
                    appState.currentFilteredGames = filteredGames; 
                    renderGameList(filteredGames);
                    updateFilterUI(null, 'hidden', null);
                    return; 
                } else {
                     alert("Nincsenek rejtett j√°t√©kok az adatb√°zisban.");
                     return;
                }
            }
            // ----------------------------------------------------

            // 1. ESET: Konkr√©t j√°t√©k ID keres√©se
            if (pGameId) {
                const searchKey = pGameId.trim().toLowerCase();
                const realId = Object.keys(games).find(id => id.trim().toLowerCase() === searchKey);

                if (realId) {
                    filteredGames[realId] = games[realId];
                    matchFound = true;
                    console.log("‚úÖ J√°t√©k megtal√°lva:", realId);

                    if (games[realId].headerLogo) {
                        const mainHeaderLogo = document.getElementById('main-header-logo');
                        if (mainHeaderLogo) {
                            mainHeaderLogo.src = games[realId].headerLogo;
                        }
                    }

                } else {
                    console.warn("‚ùå A keresett j√°t√©k ID nem tal√°lhat√≥:", pGameId);
                    alert(`A k√©rt j√°t√©k (${pGameId}) nem tal√°lhat√≥.`);
                    return; 
                }
            } 
            // 2. ESET: Helysz√≠n √©s/vagy T√≠pus sz≈±r√©s
            else {
                Object.values(games).forEach(game => {
                    let locMatch = true;
                    let typeMatch = true;

                    if (pLoc) {
                        const gameLocs = (game.location || "").toLowerCase().split(',').map(s => s.trim());
                        const searchLoc = pLoc.toLowerCase().trim();
                        locMatch = gameLocs.some(l => l.includes(searchLoc));
                    }

                    if (pType) {
                        if (game.type !== pType.toLowerCase()) {
                            typeMatch = false;
                        }
                    }

                    if (locMatch && typeMatch) {
                        filteredGames[game.id] = game;
                        matchFound = true;
                    }
                });
            }

            // 3. EREDM√âNY KIRAJZOL√ÅSA
            if (matchFound) {
                // --- EZT A SORT KELLETT HOZZ√ÅADNI: ---
                appState.currentFilteredGames = filteredGames; 
                // --------------------------------------

                renderGameList(filteredGames);
                updateFilterUI(pLoc, pType, pGameId);
            } else {
                // Ha nincs tal√°lat, null√°zzuk a sz≈±rt √°llapotot is
                appState.currentFilteredGames = null; 
                
                document.getElementById('game-list').innerHTML = `
                    <div class="text-center p-8 bg-red-50 rounded-xl border border-red-200">
                        <p class="text-red-600 font-bold">Nincs tal√°lat a megadott felt√©telekre.</p>
                        <button onclick="window.location.href=window.location.pathname" class="text-brand-blue underline mt-2 text-sm">√ñsszes j√°t√©k mutat√°sa</button>
                    </div>`;
            }
        }



        // Seg√©df√ºggv√©ny a Dropdown-ok be√°ll√≠t√°s√°hoz (Csak vizu√°lis!)
        function updateFilterUI(locParam, typeParam, gameIdParam) {
            const filterContainer = document.getElementById('filter-container');
            // ‚úÖ √öJ: Azonnali Kaland doboz kiv√°laszt√°sa
            const instantContainer = document.getElementById('instant-adventure-container');
            
            const locSelect = document.getElementById('filter-location');
            const typeSelect = document.getElementById('filter-type');

            // --- M√ìDOS√çT√ÅS: Ha b√°rmilyen URL param√©ter van, ELREJTJ√úK a dobozokat ---
            if (gameIdParam || locParam || typeParam) {
                if (filterContainer) {
                    filterContainer.classList.add('hidden'); // Sz≈±r≈ë doboz elrejt√©se
                }
                // ‚úÖ √öJ: Azonnali Kaland doboz elrejt√©se is
                if (instantContainer) {
                    instantContainer.classList.add('hidden');
                }
                
                // Mivel elrejtett√ºk, nem kell tov√°bb √°ll√≠tgatni a select-eket
                return;
            }
            
            // Ha NINCS param√©ter, biztos√≠tjuk, hogy l√°that√≥ak legyenek
            if (filterContainer) {
                filterContainer.classList.remove('hidden');
            }
            // ‚úÖ √öJ: Azonnali Kaland megjelen√≠t√©se is
            if (instantContainer) {
                instantContainer.classList.remove('hidden');
            }

            // --- INNENT≈êL A R√âGI LOGIKA (Csak akkor fut le, ha nincs URL sz≈±r√©s) ---
            
            // Helysz√≠n be√°ll√≠t√°sa
            if (locParam && locSelect) {
                const option = Array.from(locSelect.options).find(opt => 
                    opt.value.toLowerCase().includes(locParam.toLowerCase())
                );
                if (option) {
                    locSelect.value = option.value;
                }
            }

            // T√≠pus be√°ll√≠t√°sa
            if (typeParam && typeSelect) {
                typeSelect.value = typeParam.toLowerCase();
            }
        }

      
        window.handleGameSelect = async function(gameId, title, type, price, hasSave, skipConfirmation = false) {

    if (hasSave) {
        loadGameById(gameId);
        return; 
    }

    const gameConfig = games[gameId];
    const nameInput = document.getElementById('team-name-input');
    const avatarSelect = document.getElementById('team-avatar-select');
    const val = nameInput.value.trim();

    // 1. Alap valid√°ci√≥ (√ºres mez≈ë, tiltott szavak)
    const validation = window.validateTeamName(val);
    if (!validation.valid) {
        showMessage('Figyelem', validation.error, () => {
            nameInput.value = "";
            nameInput.focus();
        });
        return; 
    }

    // 2. KRITIKUS JAV√çT√ÅS: Adatb√°zis ellen≈ërz√©s (Vend√©geknek is!)
    showLoading(true);
    const isUnique = await window.checkNameUniqueness(val);
if (!isUnique) {
    showMessage('Foglalt n√©v', 'Ez a n√©v m√°r foglalt egy regisztr√°lt felhaszn√°l√≥ √°ltal. K√©rlek v√°lassz m√°sikat!');
    return; // Itt meg√°ll a folyamat, nem indul el a j√°t√©k
}
    showLoading(false);

    if (!isUnique) {
        showMessage('Foglalt n√©v', 'Sajnos ez a n√©v m√°r foglalt (egy regisztr√°lt felhaszn√°l√≥ m√°r lefoglalta). K√©rlek, v√°lassz egy m√°sikat!', () => {
            nameInput.focus();
        });
        if(skipConfirmation) window.closeGameMap();
        return; 
    }

// Ha a valid√°ci√≥ sikeres, folytat√≥dik a j√°t√©k ind√≠t√°sa
const limitFromExcel = gameConfig.globalLimit;
            const MAX_PLAYERS = (limitFromExcel && limitFromExcel > 0) ? parseInt(limitFromExcel) : 1000000;

            if (window.checkGameLimitOnly) {
                try {
                    showLoading(true);
                    const allowed = await window.checkGameLimitOnly(gameId, MAX_PLAYERS);
                    showLoading(false);
                    if (!allowed) {
                        showMessage('A j√°t√©k betelt! üé´', `Sajn√°ljuk, a(z) ${title} kaland betelt.`);
                        return;
                    }
                } catch (e) {
                    showLoading(false);
                    return; 
                }
            }

        const proceedToStart = async () => {
    if (gameConfig.price > 0) {
        window.openCouponModal(gameId, title);
        return;
    }

    // JAV√çT√ÅS: Csak akkor mentsen profilt, ha be van l√©pve √âS NEM anonim
    if (window.auth && window.auth.currentUser && !window.auth.currentUser.isAnonymous) {
        try {
            showLoading(true);
            await window.saveUserProfile(nameInput.value, avatarSelect.value);
        } catch (e) {
            showLoading(false); // JAV√çT√ÅS: Itt false kell, hogy ne ragadjon be a t√∂lt≈ë
            showMessage('Hiba', e.message);
            return; 
        }
    }

    // √çgy a vend√©gek √©s a regisztr√°ltak is eljutnak ide:
    await window.loadGameDataAndStart(gameId);
    requestGpsAndStart(gameId);
};


            if (skipConfirmation) {
                proceedToStart();
            } else {
                showMessage('Kaland Ind√≠t√°sa', `Biztosan elind√≠tod a(z) <strong>${title}</strong> kalandot?`, () => proceedToStart(), true);
            }
        };



// --- INTERAKT√çV FEEDBACK RENDSZER DEFIN√çCI√ì ---
const MystiSounds = {
    success: () => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(440, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    },
    error: () => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.2);
    }
};

window.triggerVictoryUI = function(points) {
    if (typeof confetti === 'function') {
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
            colors: ['#00CED1', '#FFA500', '#0D2B45'],
     gravity: 0.8,    // Alap√©rtelmezett: 1. Min√©l kisebb, ann√°l lassabban hullik.
     ticks: 300,      // Alap√©rtelmezett: 200. Min√©l nagyobb, ann√°l tov√°bb marad a k√©perny≈ën.
     startVelocity: 25 // Kezd≈ë sebess√©g cs√∂kkent√©se (kevesebb "robban√°s" hat√°s).
        });
    }
    MystiSounds.success();
    const float = document.createElement('div');
    float.className = 'score-float';
    float.innerHTML = `+${points} ‚≠ê`;
    float.style.left = '50%';
    float.style.top = '50%';
    document.body.appendChild(float);
    setTimeout(() => float.remove(), 3000);

    // Automatikus k√°rtya √©s tov√°bbl√©p√©s
    const toast = document.createElement('div');
    toast.className = 'success-toast';
    toast.innerHTML = `<div class="icon">‚ú®</div><div><div style="font-weight: 800; color: #0D2B45;">HELYES V√ÅLASZ!</div><div style="font-weight: 600; color: #00CED1;">+${points} pont</div></div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('active'), 100);
    setTimeout(() => {
        toast.classList.remove('active');
        setTimeout(() => { toast.remove(); handleCorrectAnswer(); }, 500);
    }, 3000);
};

window.triggerErrorUI = function(pointsRemaining) {
    // 1. Hangjelz√©s √©s r√°zk√≥d√°s elind√≠t√°sa
    MystiSounds.error();
    const inputContainer = document.getElementById('answer-input-container');
    if (inputContainer) {
        inputContainer.classList.add('shake');
        setTimeout(() => inputContainer.classList.remove('shake'), 500);
    }

    // 2. Lebeg≈ë "-1 ‚≠ê" anim√°ci√≥ a k√©perny≈ë k√∂zep√©n
    const float = document.createElement('div');
    float.className = 'score-float';
    float.style.color = '#ef4444'; // Piros sz√≠n
    float.innerHTML = `-1 ‚≠ê`;
    float.style.left = '50%';
    float.style.top = '50%';
    float.style.transform = 'translate(-50%, -50%)';
    float.style.marginLeft = '-20px'; 
    document.body.appendChild(float);
    setTimeout(() => float.remove(), 3000);

    // 3. Piros szeg√©ly≈± be√∫sz√≥ k√°rtya (Toast) l√©trehoz√°sa
    const toast = document.createElement('div');
    toast.className = 'success-toast';
    // Fel√ºl√≠rjuk az alap t√ºrkiz sz√≠nt pirosra
    toast.style.borderColor = '#ef4444'; 
    toast.innerHTML = `
        <div class="icon" style="background: #fee2e2;">‚ùå</div>
        <div>
            <div style="font-weight: 800; color: #b91c1c;">SAJNOS NEM J√ì</div>
            <div style="font-weight: 600; color: #ef4444;">M√©g maradt: ${pointsRemaining} pont</div>
        </div>`;
    
    document.body.appendChild(toast);
    
    // Aktiv√°l√°s (be√∫sz√°s)
    setTimeout(() => toast.classList.add('active'), 100);
    
    // Automatikus elt√ºntet√©s 3 m√°sodperc ut√°n
    setTimeout(() => {
        toast.classList.remove('active');
        setTimeout(() => toast.remove(), 500);
    }, 3000);
};



window.triggerHintUI = function(hintText, cost, pointsRemaining, onOk) {
    if (window.isPopupActive) return; 
    window.isPopupActive = true;

    const toast = document.createElement('div');
    toast.className = 'success-toast';
    toast.style.borderColor = '#FFA500';
    toast.style.flexDirection = 'column';
    toast.style.alignItems = 'flex-start';
    toast.style.gap = '15px';
    toast.style.height = 'auto';
    toast.style.minWidth = '280px';
    toast.style.padding = '20px';

    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
            <div class="icon" style="background: #fff7ed; min-width: 40px;">üí°</div>
            <div style="flex-grow: 1;">
                <div style="font-weight: 800; color: #0D2B45; font-size: 16px;">SEG√çTS√âG</div>
                <div style="font-weight: 600; color: #ef4444; font-size: 13px;">M√©g maradt: ${pointsRemaining} pont</div>
            </div>
        </div>
        <div style="font-size: 14px; color: #4b5563; line-height: 1.5; width: 100%; word-break: break-word; font-weight: 500;">
            ${hintText}
        </div>
        <button id="hint-ok-btn" class="main-button" style="width: 100%; padding: 12px; font-size: 14px; background-color: #FFA500 !important; margin-top: 5px;">
            RENDBEN
        </button>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('active'), 100);

    const okBtn = toast.querySelector('#hint-ok-btn');
    okBtn.onclick = () => {
        toast.classList.remove('active');
        setTimeout(() => {
            toast.remove();
            window.isPopupActive = false;
            if (onOk) onOk();
        }, 500);
    };
};


window.triggerSolutionUI = function(solutionText, onOk) {
    if (window.isPopupActive) return;
    window.isPopupActive = true;

    const toast = document.createElement('div');
    toast.className = 'success-toast';
    toast.style.borderColor = '#FFA500';
    toast.style.flexDirection = 'column';
    toast.style.alignItems = 'flex-start';
    toast.style.gap = '15px';
    toast.style.height = 'auto';
    toast.style.minWidth = '280px';
    toast.style.padding = '20px';

    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
            <div class="icon" style="background: #fff7ed; min-width: 40px;">üîë</div>
            <div style="flex-grow: 1;">
                <div style="font-weight: 800; color: #0D2B45; font-size: 16px;">MEGOLD√ÅS</div>
                <div style="font-size: 11px; font-weight: 700; color: #ef4444;">A feladat 0 pontot √©r.</div>
            </div>
        </div>
        <div style="font-size: 14px; color: #4b5563; line-height: 1.5; width: 100%; word-break: break-word; font-weight: 500;">
            A helyes v√°lasz: <br> ${solutionText}
        </div>
        <button id="sol-ok-btn" class="main-button" style="width: 100%; padding: 12px; font-size: 14px; background-color: #FFA500 !important; margin-top: 5px;">
            RENDBEN, TOV√ÅBB
        </button>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('active'), 100);

    const okBtn = toast.querySelector('#sol-ok-btn');
    okBtn.onclick = () => {
        toast.classList.remove('active');
        setTimeout(() => {
            toast.remove();
            window.isPopupActive = false;
            if (onOk) onOk();
        }, 500);
    };
};


        
        function formatTime(seconds) {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${minutes}:${secs}`;
        }


// --- JAV√çTOTT ID≈êZ√çT≈ê LOGIKA (PONTOSABB + SZINKRONIZ√ÅLT) ---
        let lastTimeUpdate = 0;
        let timeAccumulator = 0;

        function updateTimer() {
            if (!appState.isTimerRunning) return;

            const now = Date.now();
            if (!lastTimeUpdate) lastTimeUpdate = now;

            const dt = now - lastTimeUpdate;
            lastTimeUpdate = now;
            
            timeAccumulator += dt;

            // Ha eltelt legal√°bb 1 m√°sodperc
            if (timeAccumulator >= 1000) {
                const secondsToAdd = Math.floor(timeAccumulator / 1000);
                timeAccumulator %= 1000;

                // 1. Teljes id≈ë n√∂vel√©se
                appState.totalTime += secondsToAdd;

                // 2. Feladat id≈ë n√∂vel√©se (csak ha a feladat akt√≠v)
                const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (currentTask && currentTask.isTaskTimerActive && !currentTask.isStartTask) {
                    appState.geofenceTime += secondsToAdd;
                    
                    if (typeof currentTask.timeSpent === 'undefined') currentTask.timeSpent = 0;
                    currentTask.timeSpent += secondsToAdd;
                    
                    const geoTimerDisplay = document.getElementById('geofence-timer-display');
                    if (geoTimerDisplay) geoTimerDisplay.textContent = formatTime(appState.geofenceTime);
                }

                // --- BIZTONS√ÅGI SZINKRONIZ√ÅCI√ì ---
                // Ez jav√≠tja a hib√°t: A teljes id≈ë sosem lehet kevesebb, mint a r√©szid≈ë!
                if (appState.totalTime < appState.geofenceTime) {
                    appState.totalTime = appState.geofenceTime;
                }
                // ---------------------------------

                // UI Friss√≠t√©s
                const timerDisplay = document.getElementById('timer-display');
                if (timerDisplay) timerDisplay.textContent = formatTime(appState.totalTime);

                // Ritk√°bb ment√©s
                if (appState.totalTime % 5 === 0) {
                    saveGameState();
                }
            }
        }



   // ASYNC lett a f√ºggv√©ny, mert v√°rni kell a Firebase-re
      window.startTimersAndGPS = async function() {
    // ‚úÖ √öJ: Profil ment√©se ind√≠t√°skor
if (window.auth && window.auth.currentUser) {
    console.log("Profil adatok ment√©se a felh≈ëbe...");
    // A pontsz√°m helyett a v√°lasztott nevet √©s avatart mentj√ºk el
    window.saveUserProfile(appState.teamName, appState.teamAvatar)
        .then(() => console.log("‚úÖ Profil szinkroniz√°lva."))
        .catch(e => console.error("‚ùå Ment√©si hiba:", e));
}    
    if (appState.isTimerRunning) return;
   
 // 1. Hang felold√°sa (iOS fix)
    if (window.AudioContext || window.webkitAudioContext) {
        try {
            const AudioCtxt = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioCtxt();
            ctx.resume();
        } catch (e) {}
    }

    if (appState.isTimerRunning) return;

    // Limit ellen≈ërz√©s (nem kritikus, csak logoljuk)
    if (appState.currentGame && typeof window.checkGameLimitAndIncrement === 'function') {
        try {
            const limitFromExcel = appState.currentGame.globalLimit;
            const MAX_PLAYERS = (limitFromExcel && limitFromExcel > 0) ? parseInt(limitFromExcel) : 1000000;
            window.checkGameLimitAndIncrement(appState.currentGame.id, MAX_PLAYERS).catch(e => console.warn(e));
        } catch (e) { console.warn(e); }
    }

    console.log("üöÄ J√°t√©k ind√≠t√°sa...");
    appState.startTime = new Date();
    appState.isTimerRunning = true;

    if (appState.timerInterval) clearInterval(appState.timerInterval);
    appState.timerInterval = setInterval(updateTimer, 1000);

    lastTimeUpdate = Date.now();
    timeAccumulator = 0;

    // START FELADAT -> 1. FELADAT V√ÅLT√ÅS
    if (appState.currentGame.taskOrder === 'explore') {
        if (appState.completedTasks.indexOf(0) === -1) appState.completedTasks.push(0);
        showTaskSelectionMap();
    } else {
        // --- JAV√çT√ÅS: MEGB√çZHAT√ì LAPOZ√ÅS AZ 1. FELADATRA ---
        if (appState.currentGame.tasks && appState.currentGame.tasks.length > 1) {
            // Megkeress√ºk a k√∂vetkez≈ë feladatot (index alapj√°n)
            // A tasks t√∂mbben a 0. elem a Start, az 1. elem az els≈ë val√≥di feladat
            const nextTask = appState.currentGame.tasks[1];

            if (nextTask) {
                console.log("‚úÖ V√°lt√°s a k√∂vetkez≈ë feladatra:", nextTask.index);
                appState.currentTaskIndex = nextTask.index;
                
                // Feladat bet√∂lt√©se
                loadTask(appState.currentTaskIndex);
                
                // --- T√âRK√âP K√âNYSZER√çTETT FRISS√çT√âSE ---
                // Ez biztos√≠tja, hogy a t√©rk√©p a Start pontr√≥l √°tugorjon az 1. feladatra
                if (appState.map && nextTask.location) { 
                    appState.map.invalidateSize(); 
                    updateTaskMarker(nextTask.location); 
                }
            } else {
                console.error("‚ùå HIBA: Nem tal√°lhat√≥ a k√∂vetkez≈ë feladat!");
                showMessage("Hiba", "Hiba t√∂rt√©nt a feladatok bet√∂lt√©sekor. Pr√≥b√°ld √∫jraind√≠tani a j√°t√©kot.");
            }
        } else {
            showMessage("Hiba", "Ehhez a j√°t√©khoz nincsenek feladatok t√∂ltve, vagy hib√°s az adatszerkezet.");
        }
    }

    if (appState.map) checkGeofence();
    updateStatusDisplays();
    saveGameState();
};


        
        function updateStatusDisplays() {
            if (!appState.currentGame) return;
            document.getElementById('score-display').textContent = appState.score;
            const totalTasks = appState.currentGame.tasks.length - 1; 
            let displayedTask;
            if (appState.currentGame.taskOrder === 'explore') {
                 displayedTask = appState.completedTasks.filter(index => index > 0).length; 
            } else {
                 const currentIndexInArray = appState.currentGame.tasks.findIndex(t => t.index === appState.currentTaskIndex);
                 displayedTask = (currentIndexInArray > 0) ? currentIndexInArray : 0; 
            }
            document.getElementById('task-progress-display').textContent = `${displayedTask} / ${totalTasks}`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }





        function startGame(gameId, modeOverride = null) {
    // --- √öJ: iOS IR√ÅNYT≈∞ ENGED√âLY K√âR√âSE ---
    // Ez v√°ltja ki iPhone-on a felugr√≥ ablakot
    if (typeof window.requestCompassPermission === 'function') {
        window.requestCompassPermission();
    }

    // --- GOOGLE ANALYTICS M√âR√âS ---
    if (typeof gtag === 'function') {
        gtag('event', 'game_start', {
            'game_id': gameId,
            'game_mode': modeOverride || 'normal',
            'team_name': document.getElementById('team-name-input').value || 'unknown'
        });
    }

    window.currentGameId = gameId;
    if (speechSynth.speaking) speechSynth.cancel();

    // M√≥d be√°ll√≠t√°sa
    let gameMode;
    if (modeOverride) {
        gameMode = modeOverride;
    } else {
        const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
        gameMode = selectedMode ? selectedMode.value : 'normal';
    }

    appState.isTestModeEnabled = (gameMode === 'test' || gameMode === 'mock');
    appState.isManualMock = (gameMode === 'mock');

    if (!appState.isManualMock && manualMarker) {
        manualMarker.remove();
        manualMarker = null;
    }

    // J√°t√©k adatainak m√©ly m√°sol√°sa
    appState.currentGame = JSON.parse(JSON.stringify(games[gameId]));

    // --- 1. JAV√çT√ÅS: ADATOK AUTOMATIKUS JAV√çT√ÅSA (INDEXEK √âS KOORDIN√ÅT√ÅK) ---
    // Ez biztos√≠tja, hogy akkor is m≈±k√∂dj√∂n, ha az adatb√°zisban hi√°nyosak az indexek
    if (appState.currentGame.tasks) {
        appState.currentGame.tasks = appState.currentGame.tasks.map((t, i) => {
            // Ha nincs index, vagy null, be√°ll√≠tjuk a t√∂mb sorsz√°m√°t
            if (t.index === undefined || t.index === null) t.index = i;
            // Ha string (pl. "1"), √°talak√≠tjuk sz√°mm√°
            if (typeof t.index === 'string') t.index = parseInt(t.index);
            
            // Koordin√°t√°k biztos√≠t√°sa
            if (t.location) {
                if(typeof t.location.lat === 'string') t.location.lat = parseFloat(t.location.lat);
                if(typeof t.location.lng === 'string') t.location.lng = parseFloat(t.location.lng);
            }
            return t;
        });
    }
    // -----------------------------------------------------------------------

    // Log√≥ be√°ll√≠t√°sa
    const gameLogo = document.getElementById('game-header-logo');
    if (gameLogo) {
        let logoSrc = appState.currentGame.headerLogo;
        
        // Ha a logoSrc "logo/default.png" vagy √ºres, akkor haszn√°ljuk a MystiGo log√≥t
        if (!logoSrc || logoSrc === "logo/default.png") {
            logoSrc = "logo/MystiGo_logo.png";
        }
        
        gameLogo.src = logoSrc;
        
        // Extra biztons√°g: Ha m√©gsem t√∂ltene be, cser√©lj√ºk le hibakezel≈ëvel
        gameLogo.onerror = function() {
            this.src = "logo/MystiGo_logo.png";
            this.onerror = null; // V√©gtelen ciklus elker√ºl√©se
        };
    }

    // Feladat sorrend be√°ll√≠t√°sa
    appState.taskOrder = document.getElementById('task-order-select').value;
    if (appState.currentGame.type === 'team' && appState.taskOrder !== 'explore') appState.taskOrder = 'random';
    else if (appState.currentGame.type === 'explore') appState.taskOrder = 'explore';
    appState.currentGame.taskOrder = appState.taskOrder;

    if (appState.taskOrder === 'explore') {
        appState.completedTasks = [];
        appState.availableTasks = appState.currentGame.tasks.filter(t => t.index > 0).map(t => t.index);
        appState.taskMarkers = {};
    }

    appState.currentTaskIndex = 0;
    appState.score = 0;
    appState.totalTime = 0;
    appState.geofenceTime = 0;
    appState.startTime = null;
    appState.isTimerRunning = false;
    appState.routeCoordinates = [];

    appState.teamName = document.getElementById('team-name-input').value.trim() || null;
    appState.teamAvatar = document.getElementById('team-avatar-select').value || null;

    // Start feladat sablon
    const startTaskTemplate = {
    index: 0,
    isStartTask: true,
    location: appState.currentGame.startLocation,
    geofenceRadius: GEOFENCE_DEFAULT_RADIUS,
    // ITT CSER√âLD LE:
    story: appState.currentGame.type === "Instant" 
        ? `<strong>√údv√∂zl√ºnk az Azonnali Kalandban!</strong> üé≤<br><br>Gener√°ltunk sz√°modra egy egyedi √∫tvonalat, amelyet a jelenlegi poz√≠ci√≥dhoz igaz√≠tottunk. K√©rj√ºk, <strong>mindig √ºgyelj a biztons√°godra!</strong> Amennyiben valamelyik √°llom√°s elz√°rt ter√ºletre esne, vagy nem k√∂zel√≠thet≈ë meg biztons√°gosan, egyszer≈±en haszn√°ld a <strong>'Feladat √°tugr√°sa'</strong> lehet≈ës√©get, √©s haladj tov√°bb a k√∂vetkez≈ë c√©lponthoz.`
        : `<span class="text-lg font-bold text-brand-blue">${appState.currentGame.title}</span><br><br>${appState.currentGame.description || ''}<br><br>Indulj el a megjel√∂lt Start Helysz√≠nre. Amikor el√©red a z√≥n√°t, nyomd meg a <strong>Kaland Ind√≠t√°sa</strong> gombot.`,
    prompt: '',
    hints: [],
    solution: '',
    acceptedAnswers: [],
    hintsUsed: 0,
    timeSpent: 0,
    taskScore: 0,
    isTaskTimerActive: false
};

    // --- 2. JAV√çT√ÅS: A VAL√ìDI FELADATOK KIV√ÅLOGAT√ÅSA ---
    // Itt most m√°r biztosan van index√ºk, √≠gy nem lesz √ºres a lista
    let realTasks = appState.currentGame.tasks.filter(t => t.index > 0);

    if (appState.taskOrder === 'random' && realTasks.length >= 1) {
        const maxIndex = realTasks.reduce((max, task) => Math.max(max, task.index), 0);
        const finalTask = realTasks.find(t => t.index === maxIndex);
        let tasksToShuffle = realTasks.filter(t => t.index !== maxIndex);
        tasksToShuffle = shuffleArray(tasksToShuffle);
        appState.currentGame.tasks = [startTaskTemplate, ...tasksToShuffle, ...(finalTask ? [finalTask] : [])];
    } else {
        appState.currentGame.tasks = [startTaskTemplate, ...realTasks];
    }

    appState.currentTaskIndex = startTaskTemplate.index;

    // UI alaphelyzetbe √°ll√≠t√°sa
    document.getElementById('timer-display').textContent = '‚Äî:‚Äî';
    document.getElementById('geofence-timer-display').textContent = '‚Äî:‚Äî';
    document.getElementById('task-progress-display').textContent = `0 / ${Math.max(0, appState.currentGame.tasks.length - 1)}`;

    clearInterval(appState.timerInterval);
    document.getElementById('test-mode-indicator').classList.toggle('hidden', !appState.isTestModeEnabled);
    
    showPage('game-page');

    // --- 3. JAV√çT√ÅS: T√âRK√âP IND√çT√ÅS K√âSLELTET√âSE + K√âNYSZER√çT√âSE ---
    setTimeout(() => {
        console.log("üé¨ J√°t√©k n√©zet bet√∂ltve, t√©rk√©p ind√≠t√°sa...");

        initializeMap();

        // K√©nyszer√≠tj√ºk a t√©rk√©pet, hogy vegye √©szre a m√©reteit
        if (appState.map) {
            appState.map.invalidateSize();
        }

        loadTask(appState.currentTaskIndex);

        if (!appState.isManualMock) {
            watchPosition();
        } else {
            toggleMapClickMock(true);
        }

        updateStatusDisplays();
        saveGameState();
    }, 600); // 600ms v√°rakoz√°s a CSS anim√°ci√≥ miatt
}

  function updateHintButtons(task) {
            const hint1Btn = document.getElementById('hint1-btn');
            const hint2Btn = document.getElementById('hint2-btn');
            const solutionBtn = document.getElementById('solution-btn');


if (task.isStartTask || task.completed || task.isCorrectlySolved) { 
        if(hint1Btn) hint1Btn.disabled = true; 
        if(hint2Btn) hint2Btn.disabled = true; 
        if(solutionBtn) solutionBtn.disabled = true; 
        return; 
    }


            // --- ADATOK ELLEN≈êRZ√âSE ---
            const hints = task.hints || [];
            // Akkor tekintj√ºk l√©tez≈ënek a seg√≠ts√©get, ha van benne sz√∂veg
            const hasHint1Data = (hints[0] && String(hints[0]).trim() !== "");
            const hasHint2Data = (hints[1] && String(hints[1]).trim() !== "");

            // Ha ez a Start feladat, mindent letiltunk
            if (task.isStartTask) { 
                if(hint1Btn) hint1Btn.disabled = true; 
                if(hint2Btn) hint2Btn.disabled = true; 
                if(solutionBtn) solutionBtn.disabled = true; 
                return; 
            }

            const hintsUsed = parseInt(task.hintsUsed || 0);
            
            // --- 1. SEG√çTS√âG GOMB ---
            if (hint1Btn) {
                if (!hasHint1Data) {
                    hint1Btn.style.display = 'none';
                } else {
                    hint1Btn.style.display = 'inline-block';
                    hint1Btn.disabled = false; 
                    if (hintsUsed >= 1) {
                        hint1Btn.classList.add('used');
                        hint1Btn.textContent = "1. Seg√≠ts√©g (Felhaszn√°lva)";
                    } else {
                        hint1Btn.classList.remove('used');
                        hint1Btn.innerHTML = `Seg√≠ts√©g 1<br> (-${HINT1_PENALTY} Pont)`;
                    }
                }
            }

            // --- 2. SEG√çTS√âG GOMB ---
            if (hint2Btn) {
                if (!hasHint2Data) {
                    hint2Btn.style.display = 'none';
                } else {
                    hint2Btn.style.display = 'inline-block';
                    // A 2-es gomb csak akkor akt√≠v, ha az 1-est m√°r megn√©zt√©k
                    hint2Btn.disabled = (hintsUsed < 1);
                    
                    if (hintsUsed >= 2) {
                        hint2Btn.classList.add('used');
                        hint2Btn.textContent = "2. Seg√≠ts√©g (Felhaszn√°lva)";
                    } else {
                        hint2Btn.classList.remove('used');
                        hint2Btn.innerHTML = `Seg√≠ts√©g 2<br> (-${HINT2_PENALTY} Pont)`;
                    }
                }
            }
            
            // --- MEGOLD√ÅS GOMB (DINAMIKUS LOGIKA) ---
            if (solutionBtn) {
                if (task.disableSolution) {
                    solutionBtn.style.display = 'none';
                } else {
                    solutionBtn.style.display = 'flex';
                    
                    let canShowSolution = false;

                    // DINAMIKUS FELT√âTEL:
                    if (hasHint2Data) {
                        // Ha van m√°sodik seg√≠ts√©g, akkor azt ki kell k√©rni a megold√°shoz
                        canShowSolution = (hintsUsed >= 2);
                    } else if (hasHint1Data) {
                        // Ha csak els≈ë seg√≠ts√©g van, akkor az ut√°n m√°r nyithat a megold√°s
                        canShowSolution = (hintsUsed >= 1);
                    } else {
                        // Ha egy√°ltal√°n nincs seg√≠ts√©g megadva, akkor alapb√≥l nyitva a megold√°s
                        canShowSolution = true;
                    }

                    // Explore m√≥d utols√≥ feladat√°n√°l biztons√°gi tilt√°s (opcion√°lis)
                    const isFinalInExplore = appState.currentGame?.taskOrder === 'explore' && appState.availableTasks?.length === 1;
                    if (isFinalInExplore) canShowSolution = false;

                    solutionBtn.disabled = !canShowSolution;
                }
            }
        }

                 

        function loadTask(taskIndex) {
            if (speechSynth.speaking) speechSynth.cancel();
            
            document.getElementById('content-page-wrapper').scrollTo({ top: 0, behavior: 'instant' });
            
            const task = appState.currentGame.tasks.find(t => t.index === taskIndex);
            
            if (!task) {
                console.error(`‚ùå loadTask: Nem tal√°lhat√≥ feladat ezzel az index-szel: ${taskIndex}`);
                return;
            }

            // --- üõ†Ô∏è AUTOMATIKUS KOORDIN√ÅTA JAV√çT√ÅS ---
            if (!task.location) { task.location = {}; }
            if (typeof task.location.lat === 'undefined') {
                if (task.lat) task.location.lat = parseFloat(task.lat);
                else if (task.locationLat) task.location.lat = parseFloat(task.locationLat);
            }
            if (typeof task.location.lng === 'undefined') {
                if (task.lng) task.location.lng = parseFloat(task.lng);
                else if (task.locationLng) task.location.lng = parseFloat(task.locationLng);
            }

            // --- üõ†Ô∏è JAV√çTOTT HINT (SEG√çTS√âG) KEZEL√âS ---
            // Biztos√≠tjuk, hogy a hints t√∂mb l√©tezzen
            if (!task.hints || !Array.isArray(task.hints)) {
                task.hints = [];
            }

            // A push() helyett direkt indexel√©st haszn√°lunk, hogy a sorrend fix maradjon!
            // √çgy ha hi√°nyzik a hint1, akkor a 0. index √ºres marad, √©s nem cs√∫szik oda a hint2.
            
            // 1. Seg√≠ts√©g be√°ll√≠t√°sa (Index 0)
            if (task.hint1 !== undefined) {
                task.hints[0] = task.hint1;
            } else if (typeof task.hints[0] === 'undefined') {
                task.hints[0] = ""; // Legyen √ºres string, ha nincs adat
            }

            // 2. Seg√≠ts√©g be√°ll√≠t√°sa (Index 1)
            if (task.hint2 !== undefined) {
                task.hints[1] = task.hint2;
            } else if (typeof task.hints[1] === 'undefined') {
                task.hints[1] = ""; // Legyen √ºres string, ha nincs adat
            }
            // -----------------------------------------------------------

            // --- üõ†Ô∏è MEGOLD√ÅS ADAT JAV√çT√ÅSA ---
            if (!task.solution || String(task.solution).trim() === "") {
                if (task.acceptedAnswers && task.acceptedAnswers.length > 0) {
                    // ‚úÖ √öJ SOR: HTML <strong> tagek hozz√°ad√°sa a vastag√≠t√°shoz
                    task.solution = "<strong>" + task.acceptedAnswers[0] + "</strong>";
                }
            }

            appState.currentTaskIndex = taskIndex;
            const isStartTask = task.isStartTask;
            
            if (typeof task.isTaskTimerActive === 'undefined') task.isTaskTimerActive = false;

            if (!isStartTask) {
                if (typeof task.taskScore === 'undefined' || task.taskScore === null) {
                    task.taskScore = DEFAULT_SCORE_PER_TASK;
                }
                task.taskScore = parseInt(task.taskScore);
            } else {
                task.taskScore = 0;
            }

            document.getElementById('normal-task-content').classList.remove('hidden');
            document.getElementById('explore-selection-container').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            document.getElementById('google-maps-btn').classList.remove('hidden');
            document.getElementById('report-error-btn').classList.remove('hidden');

            const backBtn = document.getElementById('back-to-map-btn');
            if (backBtn) {
                if (appState.currentGame.taskOrder === 'explore' && !isStartTask) {
                    backBtn.classList.remove('hidden');
                } else {
                    backBtn.classList.add('hidden');
                }
            }

            const speakBtn = document.getElementById('speak-story-btn');
            if (speakBtn && ('speechSynthesis' in window)) speakBtn.style.display = 'block'; 
            else if (speakBtn && speakBtn.parentElement) speakBtn.remove();
            
            if (isStartTask) task.startTime = 0;
            
            // Tartalom megjelen√≠t√©se
            document.getElementById('story').innerHTML = task.story || "Nincs t√∂rt√©net.";
            document.getElementById('prompt').innerHTML = task.prompt || "";


// --- √öJ R√âSZ KEZDETE: Task Image Kezel√©s ---
const taskImageEl = document.getElementById('task-image');
if (taskImageEl) {
    // Ellen≈ërizz√ºk, hogy van-e k√©p az adatb√°zisban ehhez a feladathoz
    if (task.taskImage && task.taskImage.trim() !== "") {
        taskImageEl.src = task.taskImage; // Be√°ll√≠tjuk a forr√°st
        taskImageEl.classList.remove('hidden'); // Megjelen√≠tj√ºk
    } else {
        taskImageEl.classList.add('hidden'); // Elrejtj√ºk, ha nincs k√©p
        taskImageEl.src = ""; // Kit√∂r√∂lj√ºk a forr√°st a biztons√°g kedv√©√©rt
    }
}

            document.getElementById('answer-input').value = '';
            
            const detailsEl = document.getElementById('story-details');
            if(detailsEl) detailsEl.open = true;
            
            if(typeof task.hintsUsed === 'undefined') task.hintsUsed = 0;
            
            if (!isStartTask) {
                 document.getElementById('submit-answer-btn').disabled = true; 
                 document.getElementById('answer-input').disabled = true;
                 
                 // Hint gombok friss√≠t√©se (Ez h√≠vja meg a kor√°bban jav√≠tott logik√°t!)
                 if (typeof updateHintButtons === 'function') updateHintButtons(task);
                 
                 document.getElementById('answer-input-container').classList.remove('hidden');
                 document.getElementById('hint-buttons-container').classList.remove('hidden');
                 document.getElementById('prompt').classList.remove('hidden'); 
            } else {
                 document.getElementById('submit-answer-btn').disabled = true;
                 document.getElementById('answer-input').disabled = true;
                 
                 // Start feladatn√°l biztosan elrejtj√ºk
                 if(document.getElementById('hint1-btn')) document.getElementById('hint1-btn').style.display = 'none';
                 if(document.getElementById('hint2-btn')) document.getElementById('hint2-btn').style.display = 'none';
                 if(document.getElementById('solution-btn')) document.getElementById('solution-btn').style.display = 'none';
                 
                 document.getElementById('answer-input-container').classList.add('hidden');
                 document.getElementById('hint-buttons-container').classList.add('hidden');
                 document.getElementById('prompt').classList.remove('hidden');
                 
                 if (appState.currentGame.taskOrder === 'explore') {
                     document.getElementById('start-game-btn').disabled = false; 
                     document.getElementById('start-task-button-container').classList.remove('hidden');
                 }
            }

            // --- T√âRK√âP FRISS√çT√âS ---
            if (appState.map) {
                if (task.location && typeof task.location.lat !== 'undefined') {
                    updateTaskMarker(task.location);
                }
                Object.values(appState.taskMarkers).forEach(m => m.remove());
                appState.taskMarkers = {};
            }
            
            checkGeofence();
            updateStatusDisplays();
        }




        function handleCorrectAnswer() {
    if (speechSynth.speaking) speechSynth.cancel();

    const currentTask = appState.currentGame.tasks.find(t => Number(t.index) === Number(appState.currentTaskIndex));

    if (!currentTask || currentTask.completed) return;

    currentTask.completed = true;

    // Pontsz√°m √©s id≈ë r√∂gz√≠t√©se
    currentTask.timeSpent = appState.geofenceTime - (currentTask.startTime || 0);
    currentTask.isTaskTimerActive = false;

    if (currentTask.taskScore > 0 && !currentTask.isStartTask) {
        appState.score = parseInt(appState.score || 0) + parseInt(currentTask.taskScore);
    }

    if (appState.currentGame.taskOrder === 'explore') {
        if (!currentTask.isStartTask) {
            const indexToRemove = appState.availableTasks.indexOf(appState.currentTaskIndex);
            if (indexToRemove > -1) appState.availableTasks.splice(indexToRemove, 1);
            if (appState.completedTasks.indexOf(currentTask.index) === -1) {
                appState.completedTasks.push(currentTask.index);
            }
        }

        if (appState.availableTasks.length === 0) {
            endGame();
        } else {
            appState.currentTaskIndex = 0;
            showTaskSelectionMap();
        }
    } else {
        // SZEKVENCI√ÅLIS M√ìD JAV√çT√ÅSA
        const currentIndexInArray = appState.currentGame.tasks.findIndex(t => Number(t.index) === Number(appState.currentTaskIndex));
        const nextIndexInArray = currentIndexInArray + 1;

        if (nextIndexInArray < appState.currentGame.tasks.length) {
            const nextTaskIndex = appState.currentGame.tasks[nextIndexInArray].index;
            loadTask(nextTaskIndex);
        } else {
            // Ez az √°g fut le az utols√≥ feladatn√°l
            endGame();
        }
    }

    updateStatusDisplays();
    saveGameState();
}
        
function endGame() {
    // 1. AZONNALI OLDALV√ÅLT√ÅS √âS ID≈êZ√çT≈êK LE√ÅLL√çT√ÅSA
    showContentPage('end-page');
    
    // --- √öJ: Sz√∂vegek dinamikus m√≥dos√≠t√°sa a pontsz√°m alapj√°n ---
    const endTitle = document.getElementById('end-title');
    const endSubtitle = document.getElementById('end-subtitle');
    
    if (appState.score > 0) {
        if (endTitle) endTitle.textContent = "Sz√©p munka!";
        if (endSubtitle) endSubtitle.textContent = "Teljes√≠tetted a kalandot.";
    } else {
        if (endTitle) endTitle.textContent = "Sajnos ez most nem siker√ºlt...";
        if (endSubtitle) endSubtitle.textContent = "Ne add fel, pr√≥b√°ld meg legk√∂zelebb!";
    }
    // ---------------------------------------------------------

    if (speechSynth.speaking) speechSynth.cancel();
    clearInterval(appState.timerInterval);
    if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
    
    // F≈ë t√©rk√©p takar√≠t√°sa a mem√≥ri√°b√≥l
    if (appState.map) { appState.map.remove(); appState.map = null; }
    if (window.manualMarker) { window.manualMarker.remove(); window.manualMarker = null; }

    const finalTotalTime = appState.totalTime; 
    const finalTaskTime = appState.geofenceTime; 
    window.currentGameId = appState.currentGame ? appState.currentGame.id : null;
    window.currentScoreForHighlight = appState.score;

    // --- GOOGLE ANALYTICS ---
    if (typeof gtag === 'function') {
        gtag('event', 'game_complete', {
            'game_id': appState.currentGame ? appState.currentGame.id : 'unknown',
            'score': appState.score,
            'total_time': finalTotalTime,
            'team_name': appState.teamName
        });
    }

    // --- TART√ìS SZ√ÅML√ÅL√ìK FRISS√çT√âSE ---
    if (appState.currentGame) {
        const countKey = 'MystiGo_Perm_Count_' + appState.currentGame.id;
        let currentCount = parseInt(localStorage.getItem(countKey) || 0);
        if (currentCount === 0 && localStorage.getItem('MystiGo_Perm_Completed_' + appState.currentGame.id) === 'true') {
            currentCount = 1;
        }
        localStorage.setItem(countKey, currentCount + 1);
        localStorage.setItem('MystiGo_Perm_Completed_' + appState.currentGame.id, 'true');
    }

    // --- MENT√âS √âS PONTAD√ÅS (Csak ha nem teszt m√≥d) ---
    if (!appState.isTestModeEnabled || (appState.currentGame && appState.currentGame.id === 'teszt-game')) { 
        if (appState.currentGame && window.saveScoreToFirebase) {
            window.saveScoreToFirebase({
                gameId: appState.currentGame.id,
                teamName: appState.teamName,
                teamAvatar: appState.teamAvatar,
                score: appState.score,
                totalTime: finalTotalTime,
                geofenceTime: finalTaskTime
            });
            
            if (window.incrementGameCompletion) {
                window.incrementGameCompletion(appState.currentGame.id);
            }
        }
    }

    // --- √ñSSZPONTSZ√ÅM N√ñVEL√âSE (CSAK √âLES √âS >0 PONTN√ÅL) ---
    if (!appState.isTestModeEnabled && appState.score > 0) {
        if (window.auth && window.auth.currentUser) { 
            const finalScoreValue = parseInt(appState.score) || 0;
            window.addPointsToUser(finalScoreValue)
                .then(() => console.log("‚úÖ √ñsszpontsz√°m friss√≠tve a profilban."))
                .catch(e => console.error("‚ùå Profil hiba:", e));
        }
    }

    // --- UI KIT√ñLT√âSE √âS LOG√ìK ---
    const endTime = new Date();
    const formattedEndTime = `${endTime.getFullYear()}.${String(endTime.getMonth()+1).padStart(2,'0')}.${String(endTime.getDate()).padStart(2,'0')} ${String(endTime.getHours()).padStart(2,'0')}:${String(endTime.getMinutes()).padStart(2,'0')}`;
    
    if (appState.currentGame) {
    // Csak akkor √≠rjuk ki a sz√∂veget, ha a pontsz√°m nagyobb, mint 0
    if (appState.score > 0) {
        document.getElementById('end-story').innerHTML = appState.currentGame.endStory;
    } else {
        // Ha 0 vagy kevesebb a pont, √ºresen hagyjuk vagy egy vigaszsz√∂veget √≠runk
        document.getElementById('end-story').innerHTML = ""; 
    }
    
    // A log√≥ be√°ll√≠t√°sa v√°ltozatlan marad
    const logoPath = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
    if(document.getElementById('end-page-logo')) document.getElementById('end-page-logo').src = logoPath;
    if(document.getElementById('main-header-logo')) document.getElementById('main-header-logo').src = logoPath;
}

    document.getElementById('final-score').textContent = appState.score;
    document.getElementById('final-team-display').textContent = appState.teamName || "N√©vtelen";
    document.getElementById('final-time').textContent = formatTime(finalTotalTime); 
    document.getElementById('final-geofence-time').textContent = formatTime(finalTaskTime);

    const saveStatusText = navigator.onLine ? "Adatok felt√∂ltve." : "Offline m√≥d: Adatok elmentve.";
    const colorClass = navigator.onLine ? 'text-green-600' : 'text-red-500';
    document.getElementById('end-timestamp').innerHTML = `Befejez√©s: ${formattedEndTime}<br><span class="${colorClass} font-bold">${saveStatusText}</span>`;

    // Avatar √©s Verified badge
    const finalAvatarEl = document.getElementById('final-team-avatar-icon');
    if (finalAvatarEl) {
        const isRegistered = !!(window.auth && window.auth.currentUser);
        finalAvatarEl.className = "avatar-container"; 
        finalAvatarEl.innerHTML = `${AVATAR_ICONS[appState.teamAvatar] || ''}${isRegistered ? '<div class="verified-badge verified-badge-lg active"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div>' : ''}`;
    }

    // √ârt√©kel√©s √©s PDF gombok
    const reviewBtn = document.getElementById('game-review-btn');
    if (reviewBtn && appState.currentGame?.reviewUrl) {
        reviewBtn.href = appState.currentGame.reviewUrl; 
        reviewBtn.classList.replace('hidden', 'block'); 
    }

    // √ötvonal t√©rk√©p √∫jrarajzol√°sa (Megl√©v≈ë logika megtartva)
    const oldMapDiv = document.getElementById('route-map');
    if (oldMapDiv) {
        const newMapDiv = document.createElement('div');
        newMapDiv.id = 'route-map';
        newMapDiv.style.cssText = "height: 300px; width: 85%; max-width: 400px; border-radius: 1rem; border: 3px solid #E0F7FA; margin: 20px auto; display: block;";
        oldMapDiv.parentNode.replaceChild(newMapDiv, oldMapDiv);
    }

    // T√©rk√©p adatok bet√∂lt√©se
    try {
        if (appState.routeCoordinates.length > 0) {
            const endMap = L.map('route-map', { zoomControl: false, dragging: false, touchZoom: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false, tap: false, zoomAnimation: false, markerZoomAnimation: false, fadeAnimation: false, preferCanvas: true });
            endMap.attributionControl.setPrefix(false);
            addSmartTileLayer(endMap);
            const polyline = L.polyline(appState.routeCoordinates, { color: 'var(--brand-orange)', weight: 5, opacity: 0.8 }).addTo(endMap);
            // --- JAV√çT√ÅS: Markerek kirajzol√°sa ---
            appState.currentGame.tasks.forEach(task => {
                // Csak akkor rajzolunk, ha nem a kezd≈ëpont (index 0) √©s van koordin√°t√°ja
                if (task.index > 0 && task.location && task.location.lat) {
                    
                    // Ikon kiv√°laszt√°sa: Ha √°tugrotta (skipped), akkor piros X, egy√©bk√©nt z√∂ld pipa
                    const iconEmoji = task.skipped ? "‚ùå" : "‚úÖ";
                    const iconColor = task.skipped ? "bg-red-100 border-red-500" : "bg-green-100 border-green-500";

                    const taskIcon = L.divIcon({
                        className: 'end-game-marker',
                        html: `<div class="${iconColor} w-8 h-8 rounded-full border-2 shadow-md flex items-center justify-center text-sm">${iconEmoji}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    L.marker([task.location.lat, task.location.lng], { icon: taskIcon })
                     .addTo(endMap)
                     .bindPopup(`<b>${task.index}. feladat</b><br>${task.skipped ? '√Åtugorva' : 'Sikeresen megoldva'}`);
                }
            });
            // -------------------------------------

            endMap.fitBounds(polyline.getBounds().pad(0.2), { animate: false }); 
        }
    } catch (err) { console.error("T√©rk√©p hiba a befejez√©sn√©l:", err); }

    // --- LEZ√ÅR√ÅS ---
    setTimeout(() => { 
        if(typeof downloadPDF === 'function') downloadPDF(); 
        
        // --- √öJ: √ârt√©kel≈ë ablak CSAK > 0 pontn√°l ---
        if (appState.score > 0) {
            setTimeout(() => {
                const rModal = document.getElementById('rating-modal');
                if(rModal) {
                    rModal.classList.remove('hidden');
                    rModal.classList.add('flex');
                }
            }, 1500);
        }

        if (appState.currentGame) {
            localStorage.removeItem(getStorageKey(appState.currentGame.id));
            localStorage.removeItem(`MystiGo_GameData_${appState.currentGame.id}`);
        }
        if (typeof window.resetAllInstantCustomization === 'function') {
            window.resetAllInstantCustomization();
        }
        appState.currentGame = null; 
    }, 1500);
}     


  
        function toggleMapClickMock(enable) {
    if (!appState.map) return;
    
    if (appState.currentGame && appState.currentGame.taskOrder === 'explore' && appState.currentTaskIndex === 0 && appState.isTimerRunning) {
        if (appState.map.clickHandler) { 
            appState.map.off('click', appState.map.clickHandler); 
            appState.map.clickHandler = null; 
        }
        return;
    }

    if (enable) {
        if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
        appState.geoWatchId = null;

        if (!appState.map.clickHandler) {
            appState.map.clickHandler = (e) => {
                const latLng = e.latlng;
                
                // DivIcon l√©trehoz√°sa (a .player-marker oszt√°ly viszi a CSS form√°z√°st √©s a forgat√°st)
                const mockIcon = L.divIcon({ 
    className: 'player-marker', 
    iconSize: [20, 20], 
    iconAnchor: [10, 10], 
    html: '<div class="marker-visual"></div>' // Ezt a div-et adjuk hozz√°
});

                if (manualMarker) {
                    manualMarker.setLatLng(latLng);
                } else {
                    manualMarker = L.marker(latLng, { icon: mockIcon }).addTo(appState.map);
                }

                appState.userPosition = { lat: latLng.lat, lng: latLng.lng };

                // --- √öJ: AUTOMATIKUS FORGAT√ÅS ---
                const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (currentTask && currentTask.location) {
                    // Kisz√°moljuk az ir√°nyt a kattintott pont √©s a c√©lpont k√∂z√∂tt
                    const bearing = calculateBearing(
                        latLng.lat, latLng.lng, 
                        currentTask.location.lat, currentTask.location.lng
                    );
                    // Alkalmazzuk a forgat√°st az √∫j k√∂zponti f√ºggv√©ny√ºnkkel
                    window.applyRotation(bearing);
                }
                // --- √öJ R√âSZ V√âGE ---

                if (appState.isTimerRunning) { 
                    appState.routeCoordinates.push([latLng.lat, latLng.lng]); 
                    saveGameState(); 
                }

                checkGeofence();

                // T√©rk√©p igaz√≠t√°sa a poz√≠ci√≥nk √©s a c√©lpont k√∂z√©
                if (currentTask && currentTask.location) {
                    const bounds = L.latLngBounds(
                        [latLng.lat, latLng.lng], 
                        [currentTask.location.lat, currentTask.location.lng]
                    );
                    appState.map.fitBounds(bounds.pad(0.2));
                }
            };
            appState.map.on('click', appState.map.clickHandler);
        }
    } else {
        if (appState.map.clickHandler) { 
            appState.map.off('click', appState.map.clickHandler); 
            appState.map.clickHandler = null; 
        }
        if (manualMarker) { 
            manualMarker.remove(); 
            manualMarker = null; 
        }
        if (appState.isManualMock) { 
            appState.userPosition = null; 
            watchPosition(); 
        }
    }
}
        
  function initializeMap(gameData = null) {
    const mapContainer = document.getElementById('map');
    
    // BIZTONS√ÅGI ELLEN≈êRZ√âS
    if (!mapContainer || mapContainer.clientHeight === 0) {
        console.warn("‚ö†Ô∏è T√©rk√©p kont√©ner m√©g rejtett vagy 0 magas. √öjrapr√≥b√°lkoz√°s 100ms m√∫lva...");
        setTimeout(() => initializeMap(gameData), 100); // Itt is tov√°bbadjuk az adatot!
        return;
    }

    // Ha m√°r l√©tezik t√©rk√©p, takar√≠tsuk el
    if (appState.map) {
        appState.map.remove();
        appState.map = null;
    }

    appState.playerMarker = null;
    appState.geofenceCircle = null;
    appState.taskMarkers = {};
    if (typeof manualMarker !== 'undefined' && manualMarker) {
        manualMarker = null;
    }

    // Start poz√≠ci√≥ meghat√°roz√°sa
    let startLat = 47.4979; // Budapest default
    let startLng = 19.0402; // Budapest default
    
    // ‚úÖ JAV√çT√ÅS: Priorit√°s kezel√©s
    // 1. Ha kaptunk direkt adatot (bet√∂lt√©skor), azt haszn√°ljuk
    // 2. Ha nincs, akkor a fut√≥ j√°t√©k√©t (appState)
    const source = gameData || appState.currentGame;

    if (source && source.startLocation) {
        startLat = source.startLocation.lat;
        startLng = source.startLocation.lng;
    }

    console.log(`üó∫Ô∏è T√©rk√©p l√©trehoz√°sa itt: ${startLat}, ${startLng}`);

    appState.map = L.map('map', { 
        zoomControl: false, 
        fadeAnimation: true
    }).setView([startLat, startLng], 16);

    appState.map.attributionControl.setPrefix(false);

    addSmartTileLayer(appState.map);

    // Zoom kezel√©s
    const updateZoomDisplay = () => {
        const el = document.getElementById('zoom-level-indicator');
        if(el && appState.map) el.textContent = 'Zoom: ' + appState.map.getZoom().toFixed(1);
    };
    appState.map.on('zoomend', updateZoomDisplay);
    appState.map.on('moveend', updateZoomDisplay);
    updateZoomDisplay();

    appState.map.on('mousedown touchstart dragstart zoomstart', () => {
        appState.lastMapInteraction = Date.now();
    });

    // Mock click handler visszakapcsol√°sa, ha sz√ºks√©ges
    if (appState.isManualMock) {
        toggleMapClickMock(true);
    }
    
    // V√©gs≈ë m√©ret friss√≠t√©s
    setTimeout(() => {
        if(appState.map) appState.map.invalidateSize();
    }, 200);
}




        function updatePlayerMarker(lat, lng, heading) {
    if (!appState.map) return;

// GPS ALAP√ö IR√ÅNYSZ√ÅM√çT√ÅS (Ha mozogsz, ez stabiliz√°l)
    if (lastGpsLat !== null && lastGpsLng !== null) {
        const dist = haversineDistance({lat: lastGpsLat, lng: lastGpsLng}, {lat: lat, lng: lng});
        if (dist > 2) { // Csak 2 m√©tern√©l nagyobb elmozdul√°sn√°l sz√°molunk
            movementHeading = calculateBearing(lastGpsLat, lastGpsLng, lat, lng);
        }
    }
    lastGpsLat = lat;
    lastGpsLng = lng;

    // 1. Poz√≠ci√≥ ment√©se
    appState.userPosition = { lat: lat, lng: lng };

    // √ötvonal r√∂gz√≠t√©se
    if (appState.isTimerRunning) {
        appState.routeCoordinates.push([lat, lng]);
    }

    if (!appState.isTestModeEnabled && !appState.isManualMock) {
        const latLng = new L.LatLng(lat, lng);

        // 2. Marker (k√©k/s√°rga p√∂tty) kezel√©se
        if (appState.playerMarker) {
            appState.playerMarker.setLatLng(latLng);
        } else {
            const playerIcon = L.divIcon({
    className: 'player-marker',
    html: '<div class="marker-visual"></div>', // Beker√ºlt a bels≈ë elem
    iconSize: [20, 20],
    iconAnchor: [10, 10],
    popupAnchor: [0, -10]
});
            
            appState.playerMarker = L.marker(latLng, { 
                icon: playerIcon,
                zIndexOffset: 1000 
            }).addTo(appState.map);
        }

        
        
        // 3. T√©rk√©p igaz√≠t√°sa (Zoom logika) - SPECI√ÅLIS JAV√çT√ÅS
        const now = Date.now();
        const timeSinceLastInteraction = now - (appState.lastMapInteraction || 0);

        // EXPLORE M√ìD KEZEL√âSE
        const isExploreSelection = (
            appState.currentGame &&
            appState.currentGame.taskOrder === 'explore' &&
            !document.getElementById('explore-selection-container').classList.contains('hidden')
        );

        if (isExploreSelection) {
            if (timeSinceLastInteraction < 5000) { 
                checkGeofence();
                return; 
            }

            const markerKeys = Object.keys(appState.taskMarkers);
            if (markerKeys.length > 0) {
                const bounds = [];
                markerKeys.forEach(key => {
                    if(appState.taskMarkers[key]) bounds.push(appState.taskMarkers[key].getLatLng());
                });
                bounds.push(latLng);
                appState.map.fitBounds(L.latLngBounds(bounds).pad(0.1), { animate: true });
            }
            checkGeofence();
            return; 
        }

        // R√âGI LOGIKA (Norm√°l j√°t√©kmenethez)
        if (timeSinceLastInteraction > 3000) {
            if (appState.geofenceCircle && appState.playerMarker) { 
                const targetLatLng = appState.geofenceCircle.getLatLng();
                const distance = latLng.distanceTo(targetLatLng);
                const radius = appState.geofenceCircle.getRadius();

                if (distance <= radius + 20) {
                    appState.map.setView(latLng, 19, { animate: true });
                } else {
                    const bounds = L.latLngBounds(latLng, targetLatLng);
                    appState.map.fitBounds(bounds.pad(0.1), { maxZoom: 19, animate: true }); 
                }
            } else {
                appState.map.setView(latLng, 19);
            }
        }
    }
    
    checkGeofence();
}




        function updateTaskMarker(location) {
    // BIZTONS√ÅGI ELLEN≈êRZ√âS: Ha nincs t√©rk√©p vagy nincs √©rv√©nyes location, kil√©p√ºnk
    if (!appState.map) return;
    
    // Itt volt a hiba: Ha a location null/undefined, a location.lat hib√°t dobott
    if (!location || typeof location.lat === 'undefined' || typeof location.lng === 'undefined') {
        console.warn("‚ö†Ô∏è updateTaskMarker: √ârv√©nytelen koordin√°ta, a marker nem friss√ºlt.", location);
        return;
    }

    const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (!currentTask) return;

    const currentTaskLoc = L.latLng(location.lat, location.lng);
    const currentRadius = (currentTask.geofenceRadius && currentTask.geofenceRadius > 0) ? currentTask.geofenceRadius : GEOFENCE_DEFAULT_RADIUS;

    if (appState.geofenceCircle) {
        appState.geofenceCircle.setLatLng(currentTaskLoc); 
        appState.geofenceCircle.setRadius(currentRadius); 
        appState.geofenceCircle.addTo(appState.map);
    } else {
        appState.geofenceCircle = L.circle(currentTaskLoc, { 
            radius: currentRadius, 
            color: 'red', 
            fillColor: 'red', 
            fillOpacity: 0.1, 
            weight: 2, 
            className: 'geofence-circle' 
        }).addTo(appState.map);
    }

    const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
    
    if (playerMarkerForBounds) {
        const bounds = L.latLngBounds(playerMarkerForBounds.getLatLng(), currentTaskLoc);
        appState.map.fitBounds(bounds.pad(0.2), { maxZoom: 19, animate: true }); 
    } else {
        appState.map.setView(currentTaskLoc, 16); 
    }
}


function stopAllGpsActivity() {
    if (appState.geoWatchId !== null) {
        navigator.geolocation.clearWatch(appState.geoWatchId);
        appState.geoWatchId = null;
        console.log("üõ∞Ô∏è GPS figyel√©s le√°ll√≠tva.");
    }
}



        function watchPosition() {
    // EL≈êSZ√ñR LE√ÅLL√çTJUK A R√âGIT, HA VAN
    stopAllGpsActivity();

    // --- √öJ: IR√ÅNYT≈∞ (ELFORGAT√ÅS) FIGYEL√âSE ---
    // Megpr√≥b√°ljuk figyelni a telefon ir√°nyt≈±j√©t
    if (window.DeviceOrientationEvent) {
        // Elt√°vol√≠tjuk a r√©git, hogy ne legyen t√∂bb p√©ld√°nyban, majd hozz√°adjuk
        window.removeEventListener('deviceorientationabsolute', handleOrientation);
        window.removeEventListener('deviceorientation', handleOrientation);

        if ('ondeviceorientationabsolute' in window) {
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        } else {
            window.addEventListener('deviceorientation', handleOrientation, true);
        }
    }

    if (!appState.isTestModeEnabled && !appState.isManualMock && 'geolocation' in navigator) {
        appState.geoWatchId = navigator.geolocation.watchPosition(
            (pos) => { 
                // SIKER: √Åtadjuk a koordin√°t√°kat √âS a GPS alap√∫ ir√°nyt (heading) is
                updatePlayerMarker(pos.coords.latitude, pos.coords.longitude, pos.coords.heading); 
            }, 
            (err) => {
                // HIBA KEZEL√âSE (Megl√©v≈ë logik√°d)
                console.warn(`GEO ERROR(${err.code}): ${err.message}`);
                
                appState.geoWatchId = null; 
                
                if (!appState.isTestModeEnabled) { 
                    showLoading(false); 
                    
                    if (appState.isTimerRunning) {
                        const distEl = document.getElementById('distance-info');
                        if (distEl) {
                            distEl.className = 'text-center text-xs font-bold mt-2 text-red-600 animate-pulse';
                            distEl.innerHTML = '‚ö†Ô∏è GPS jel elveszett! Menj ny√≠lt terepre...';
                        }
                        
                        setTimeout(() => {
                            if(!appState.geoWatchId && appState.isTimerRunning) {
                                console.log("‚ôªÔ∏è GPS √∫jraind√≠t√°si k√≠s√©rlet...");
                                watchPosition();
                            }
                        }, 5000);
                    } 
                    else {
                        document.getElementById('gps-help-modal').classList.remove('hidden');
                    }
                } 
                else { 
                    showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d folytat√≥dik.'); 
                    checkGeofence(); 
                }
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
        console.log("üõ∞Ô∏è √öj GPS figyel√©s ind√≠tva, ID:", appState.geoWatchId);
    } else if (appState.isTestModeEnabled && !appState.isManualMock) {
         const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
         appState.userPosition = task ? { lat: task.location.lat, lng: task.location.lng } : { lat: appState.currentGame.startLocation.lat, lng: appState.currentGame.startLocation.lng };
         checkGeofence();
    } else if (appState.isManualMock) {
         appState.userPosition = (manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : null;
         checkGeofence();
    }
}

// --- √öJ K√çS√âR≈ê F√úGGV√âNY AZ IR√ÅNYT≈∞H√ñZ ---
let smoothedHeading = null;
const smoothingFactor = 0.12; // 0.1 = 10% √∫j adat, 90% r√©gi adat. Kisebb sz√°m = sim√°bb, de lassabb mozg√°s.
let lastGpsLat = null;
let lastGpsLng = null;
let movementHeading = null;


function handleOrientation(event) {
    let currentHeading = null;

    // Szenzoradatok kinyer√©se (iOS / Android)
    if (event.webkitCompassHeading) {
        currentHeading = event.webkitCompassHeading;
    } else if (event.absolute && event.alpha !== null) {
        currentHeading = 360 - event.alpha;
    }

    if (currentHeading !== null && appState.playerMarker) {
        let targetHeading = currentHeading;

        // Ha mozogsz (van GPS ir√°nyunk), akkor az stabiliz√°lja az ir√°nyt≈±t
        if (movementHeading !== null) {
            let geoDiff = movementHeading - currentHeading;
            if (geoDiff > 180) geoDiff -= 360;
            if (geoDiff < -180) geoDiff += 360;
            targetHeading = currentHeading + (geoDiff * 0.2); 
        }

        if (smoothedHeading === null) smoothedHeading = targetHeading;

        // --- JAV√çT√ÅS: A LEGR√ñVIDEBB √öT KISZ√ÅM√çT√ÅSA ---
        // Kisz√°moljuk a k√ºl√∂nbs√©get a c√©l √©s a jelenlegi (kumulat√≠v) sz√∂g k√∂z√∂tt
        let diff = (targetHeading - (smoothedHeading % 360) + 540) % 360 - 180;
        
        // Hozz√°adjuk a k√ºl√∂nbs√©get a kumulat√≠v √©rt√©khez (sim√≠t√°ssal)
        smoothedHeading += diff * smoothingFactor;

        // Megjelen√≠t√©s a t√©rk√©pen (NINCS modulo reset!)
        const markerEl = appState.playerMarker.getElement();
        if (markerEl) {
            markerEl.style.transformOrigin = "center center";
            window.applyRotation(smoothedHeading);
        }
    }
}




window.requestCompassPermission = async function() {
    // Csak iOS 13+ eset√©n van sz√ºks√©g erre a specifikus enged√©lyk√©r√©sre
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
            const permissionState = await DeviceOrientationEvent.requestPermission();
            if (permissionState === 'granted') {
                console.log("‚úÖ iOS Ir√°nyt≈± enged√©lyezve");
                // Az enged√©ly megad√°sa ut√°n √∫jraind√≠tjuk a figyel√©st, hogy a szenzor adatok meg√©rkezzenek
                if (typeof watchPosition === 'function') watchPosition();
            } else {
                console.warn("‚ùå iOS Ir√°nyt≈± enged√©ly elutas√≠tva");
            }
        } catch (error) {
            console.error("Ir√°nyt≈± hiba:", error);
        }
    } else {
        // Android vagy r√©gebbi/asztali b√∂ng√©sz≈ë eset√©n nincs sz√ºks√©g k√ºl√∂n gombnyom√°sos enged√©lyre
        console.log("Ezen az eszk√∂z√∂n nem sz√ºks√©ges k√ºl√∂n ir√°nyt≈± enged√©ly.");
    }
};


        
        function haversineDistance(c1, c2) {
            // --- BIZTONS√ÅGI ELLEN≈êRZ√âS ---
            // Ha b√°rmelyik koordin√°ta hi√°nyzik vagy hib√°s, ne omoljon √∂ssze a rendszer.
            if (!c1 || !c2 || typeof c1.lat === 'undefined' || typeof c2.lat === 'undefined' || typeof c1.lng === 'undefined' || typeof c2.lng === 'undefined') {
                // Konzolon jelezz√ºk a hib√°t, de nem √°ll√≠tjuk meg a j√°t√©kot
                // console.warn("‚ö†Ô∏è T√°vols√°gm√©r√©s kihagyva: hi√°nyz√≥ koordin√°ta."); 
                return 99999999; // Visszaadunk egy √≥ri√°si t√°vols√°got (√≠gy nem hiszi azt a j√°t√©k, hogy c√©lba √©rt√©l)
            }
            // -----------------------------

            const R = 6371e3; 
            const toRad = x => x * Math.PI / 180;
            const p1 = toRad(c1.lat);
            const p2 = toRad(c2.lat);
            const dp = toRad(c2.lat - c1.lat);
            const dl = toRad(c2.lng - c1.lng);
            
            const a = Math.sin(dp/2) * Math.sin(dp/2) +
                      Math.cos(p1) * Math.cos(p2) *
                      Math.sin(dl/2) * Math.sin(dl/2);
            
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function checkGeofence() {
            const taskInteractionArea = document.getElementById('task-interaction-area');
            const distEl = document.getElementById('distance-info');
            const startButtonContainer = document.getElementById('start-task-button-container'); 
            const exploreSelectionContainer = document.getElementById('explore-selection-container');
            const currentLocation = (appState.isManualMock && manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : appState.userPosition;
            const currentTask = appState.currentGame ? appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex) : null;
            if (!currentTask) return;

            const currentRadius = (currentTask.geofenceRadius && currentTask.geofenceRadius > 0) ? currentTask.geofenceRadius : GEOFENCE_DEFAULT_RADIUS;
            const isStartTask = currentTask.isStartTask; 
            
            if (appState.currentGame.taskOrder === 'explore' && isStartTask) {
                 startButtonContainer.classList.remove('hidden');
                 document.getElementById('start-game-btn').disabled = false;
                 taskInteractionArea.classList.remove('hidden'); 
                 document.getElementById('prompt').classList.add('hidden');
                 distEl.textContent = "Kaland ind√≠that√≥ b√°rhol!";
                 distEl.className = 'text-center text-xs font-bold mt-2 text-green-600';
                 if (appState.geofenceCircle) { appState.geofenceCircle.remove(); appState.geofenceCircle = null; }
                 if (appState.isTimerRunning) showTaskSelectionMap();
                 return; 
            }
            if (appState.currentGame.taskOrder === 'explore' && appState.isTimerRunning && appState.currentTaskIndex === 0) {
                 taskInteractionArea.classList.add('hidden');
                 exploreSelectionContainer.classList.remove('hidden');
                 renderTaskMarkers();
                 return; 
            }
            
            if (!document.getElementById('report-error-modal').classList.contains('hidden')) {
                 if (currentLocation) {
                    const distance = haversineDistance(currentLocation, currentTask.location);
                    appState.isInZone = distance <= currentRadius;
                    distEl.textContent = appState.isInZone ? t('in_zone') : t('out_zone', Math.round(distance));
                }
                return;
            }

            startButtonContainer.classList.add('hidden');
            exploreSelectionContainer.classList.add('hidden'); 
            
            if (appState.isTestModeEnabled && !appState.isManualMock) {
                appState.isInZone = true;
		        playArrivalNotification();                
                if (!currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
		            playArrivalNotification();
                    if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                if (isStartTask) { 
                    startButtonContainer.classList.remove('hidden');
                    taskInteractionArea.classList.remove('hidden'); 
                    document.getElementById('prompt').classList.add('hidden');
                } else {
                     document.getElementById('submit-answer-btn').disabled = false;
                     document.getElementById('answer-input').disabled = false;
                     taskInteractionArea.classList.remove('hidden'); 
                     document.getElementById('prompt').classList.remove('hidden');
                }
                distEl.textContent = "A Geo-fence inakt√≠v (TESZT M√ìD)";
                distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); }
                
            } else {
                if (!currentLocation) {
                    appState.isInZone = false;
                    document.getElementById('submit-answer-btn').disabled = true;
                    document.getElementById('answer-input').disabled = true;
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                    
                    if (appState.isManualMock) {
                        distEl.textContent = "Kattints a t√©rk√©pre a poz√≠ci√≥ be√°ll√≠t√°s√°hoz!";
                        distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    } else {
                        distEl.textContent = "Helyzet meghat√°roz√°sa...";
                        distEl.className='text-center text-xs font-bold mt-2 text-gray-500';
                    }
                    
                    if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); }
                    return; 
                }

                const distance = haversineDistance(currentLocation, currentTask.location);
                appState.isInZone = distance <= currentRadius; 
                
                if (appState.isInZone && !currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
                    playArrivalNotification();
			        if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                
                if (appState.isInZone) {
                    distEl.textContent = t('in_zone');
                    distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); 
                    document.getElementById('submit-answer-btn').disabled = false;
                    document.getElementById('answer-input').disabled = false;
                    taskInteractionArea.classList.remove('hidden'); 
                    if (isStartTask) {
                        startButtonContainer.classList.remove('hidden');
                        document.getElementById('submit-answer-btn').disabled = true; 
                        document.getElementById('answer-input').disabled = true;
                        taskInteractionArea.classList.remove('hidden'); 
                        document.getElementById('prompt').classList.add('hidden');
                    }
                } else {
                    distEl.textContent = t('out_zone', Math.round(distance));
                    distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); 
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                }
            }
            if (!currentTask.isStartTask) updateHintButtons(currentTask);
            if (currentTask && currentTask.isTaskTimerActive && !isStartTask) {
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('answer-input').disabled = false;
            }
            saveGameState(); 
        }

        function exploreSelectionMapMarkerSelectHandler(e) {
            if (!e.target || !e.target.options || e.target.options.taskIndex === undefined) return;
            loadTask(e.target.options.taskIndex);
            document.getElementById('explore-selection-container').classList.add('hidden');
            if (appState.isManualMock) toggleMapClickMock(true); 
        }
        
// --- √öJ F√úGGV√âNY: Visszal√©p√©s a t√©rk√©pre ---
function backToExploreMap() {
    const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (currentTask) currentTask.isTaskTimerActive = false;


    // Csak Explore m√≥dban √©rtelmezett
    if (appState.currentGame.taskOrder !== 'explore') return;

    // Elrejtj√ºk a feladat interakci√≥s fel√ºletet
    document.getElementById('task-interaction-area').classList.add('hidden');
    
    // Megjelen√≠tj√ºk a v√°laszt√≥ fel√ºletet
    document.getElementById('explore-selection-container').classList.remove('hidden');

    // --- √öJ SOR: A vissza gomb elrejt√©se ---
    document.getElementById('back-to-map-btn').classList.add('hidden');
    
    // --- IDE SZ√öRD BE AZ √öJ SORT: ---
    appState.lastAutoZoomTime = 0; // K√©nyszer√≠tett zoomol√°s gombnyom√°skor
    // --------------------------------
    
    // T√©rk√©p vissza√°ll√≠t√°sa v√°laszt√≥ m√≥dba
    showTaskSelectionMap();
    
    // Az aktu√°lis task index√©t vissza√°ll√≠tjuk 0-ra (vagyis "v√°laszt√°s alatt" √°llapotra)
    appState.currentTaskIndex = 0;
    
    // T√©rk√©p friss√≠t√©se (hogy a mock click handler rendben legyen)
    if (appState.isManualMock) {
        toggleMapClickMock(true);
    }
}



        function renderTaskMarkers() {
            // 1. Alapvet≈ë ellen≈ërz√©sek
            if (!appState.map || appState.currentGame.taskOrder !== 'explore') return;
            
            appState.map.invalidateSize();

            // 2. Takar√≠t√°s
            Object.values(appState.taskMarkers).forEach(m => m.remove());
            appState.taskMarkers = {};
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            
            const bounds = [];

            // 3. Biztons√°gi lista-√∫jrat√∂lt√©s
            if (!appState.availableTasks || appState.availableTasks.length === 0) {
                 if(appState.completedTasks.length <= 1) { 
                     appState.availableTasks = appState.currentGame.tasks.filter(t => t.index > 0).map(t => t.index);
                 }
            }

            // 4. MARKEREK KIRAJZOL√ÅSA
            appState.availableTasks.forEach(taskIndex => {
                const task = appState.currentGame.tasks.find(t => t.index === taskIndex);
                
                if (!task) return;

                // --- üõ†Ô∏è ADATB√ÅZIS ADAPTOR (EZ A L√âNYEG!) ---
                // L√©trehozzuk a location objektumot, ha nincs
                if (!task.location) { task.location = {}; }

                // Ha hi√°nyzik a 'lat', de van 'locationLat' (az adatb√°zisodb√≥l), akkor √°temelj√ºk
                if (typeof task.location.lat === 'undefined') {
                    if (task.locationLat !== undefined) {
                        task.location.lat = parseFloat(task.locationLat);
                    } else if (task.lat !== undefined) {
                        task.location.lat = parseFloat(task.lat);
                    }
                }

                // Ugyanez a 'lng' √©s 'locationLng' eset√©ben
                if (typeof task.location.lng === 'undefined') {
                    if (task.locationLng !== undefined) {
                        task.location.lng = parseFloat(task.locationLng);
                    } else if (task.lng !== undefined) {
                        task.location.lng = parseFloat(task.lng);
                    }
                }
                // -----------------------------------------------------------

                // Ellen≈ërz√©s: Siker√ºlt-e a jav√≠t√°s?
                if (typeof task.location.lat === 'undefined' || typeof task.location.lng === 'undefined' || isNaN(task.location.lat)) {
                    // Ha m√©g mindig nincs meg, csak akkor sz√≥lunk
                    console.warn(`Skipping task ${task.index}: Coordinates missing (Checked locationLat/locationLng).`);
                    return; 
                }

                // Ha id√°ig eljutottunk, megvannak a koordin√°t√°k!
                const taskIcon = L.divIcon({ 
                    className: 'task-selector-marker', 
                    html: task.index.toString(), 
                    iconSize: [30, 30], 
                    iconAnchor: [15, 30], 
                    popupAnchor: [0, -30] 
                });

                const marker = L.marker([task.location.lat, task.location.lng], { 
                    icon: taskIcon, 
                    title: `Feladat ${task.index} - V√°lassz`, 
                    taskIndex: task.index 
                })
                .addTo(appState.map)
                .bindPopup(`<b>Feladat ${task.index}</b><br>Kattints a kiv√°laszt√°shoz!`);
                
                marker.on('click', exploreSelectionMapMarkerSelectHandler);
                appState.taskMarkers[task.index] = marker;
                
                bounds.push([task.location.lat, task.location.lng]);
            });

            // 5. J√°t√©kos √©s Zoom be√°ll√≠t√°sa
            const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
            if (playerMarkerForBounds) bounds.push(playerMarkerForBounds.getLatLng());
            else if (appState.userPosition) bounds.push([appState.userPosition.lat, appState.userPosition.lng]);
            
            if (bounds.length > 0) {
                 if (appState.isTimerRunning) {
                     setTimeout(() => {
                         appState.map.fitBounds(L.latLngBounds(bounds).pad(0.2));
                         appState.map.invalidateSize();
                     }, 100);
                 } else {
                     const startTask = appState.currentGame.tasks.find(t => t.index === 0);
                     // Itt is figyel√ºnk a locationLat-ra a Start pontn√°l
                     let startLat = startTask?.location?.lat || startTask?.locationLat;
                     let startLng = startTask?.location?.lng || startTask?.locationLng;
                     
                     if(startLat && startLng) {
                         appState.map.setView([startLat, startLng], 16);
                     }
                 }
            }
        }




        function showTaskSelectionMap() {
            if (appState.currentGame.taskOrder !== 'explore' || !appState.map) return;
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            document.getElementById('task-interaction-area').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            const backBtn = document.getElementById('back-to-map-btn');
            if (backBtn) backBtn.classList.add('hidden');
            document.getElementById('explore-selection-container').classList.remove('hidden');
            
            // --- √öJ R√âSZ: T√°vols√°g inf√≥ t√∂rl√©se ---
            const distEl = document.getElementById('distance-info');
            if (distEl) {
                distEl.textContent = '';
                distEl.className = ''; // A st√≠lust is leszedj√ºk, hogy biztosan elt≈±nj√∂n
            }
            // --------------------------------------
            
            renderTaskMarkers();
        }

        function startNavigation() {
    if (!appState.currentGame) return showMessage('Hiba', 'Nincs aktu√°lis kaland elind√≠tva.');
    
    let lat, lng;
    // Ha m√©g a 0. feladatn√°l vagyunk (Start), akkor oda navig√°lunk
    if (appState.currentTaskIndex === 0) {
            const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location;
            lat = startLoc.lat; 
            lng = startLoc.lng;
            showMessage('Navig√°l√°s a kezd≈ëponthoz', 'A t√©rk√©p megnyit√°sa a Start Helysz√≠nre...');
    } else {
            // Egy√©bk√©nt az aktu√°lis feladathoz
            const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
            if (!task) return showMessage('Hiba', 'Nincs aktu√°lis feladat a navig√°ci√≥hoz.');
            lat = task.location.lat; 
            lng = task.location.lng;
    }

    // Mobil-bar√°t, univerz√°lis Google Maps URL
    // Ez megpr√≥b√°lja megnyitni az alkalmaz√°st, ha van, k√ºl√∂nben b√∂ng√©sz≈ëben nyitja meg.
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
 }

        function speakStory(event) {
            event.preventDefault(); 
            if (!('speechSynthesis' in window)) return showMessage('Felolvas√°si hiba', 'A b√∂ng√©sz≈ëje nem t√°mogatja a be√©p√≠tett hangfelolvas√°st (Web Speech API).');
            if (speechSynth.speaking) { speechSynth.cancel(); return; }
            const storyElement = document.getElementById('story');
            if (!storyElement) return;
            const storyText = storyElement.textContent.trim();
            if (storyText === "") return;
            const utterance = new SpeechSynthesisUtterance(storyText);
            const hungarianVoice = speechSynth.getVoices().find(voice => voice.lang.startsWith('hu-'));
            if (hungarianVoice) utterance.voice = hungarianVoice; else utterance.lang = 'hu-HU'; 
            speechSynth.speak(utterance);
        }
        
        function playArrivalNotification() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1); 
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.5); 
        }

        window.shareResult = function(platform) {
            const finalScore = document.getElementById('final-score').textContent;
            const finalTime = document.getElementById('final-time').textContent;
            const teamName = appState.teamName || "N√©v";
            const gameTitle = appState.currentGame ? appState.currentGame.title : "Kaland";
            const text = `√âppen most fejeztem be a(z) ${gameTitle} kalandot a(z) ${teamName} n√©ven! üèÜ Pontsz√°m: ${finalScore}, Teljes id≈ë: ${finalTime}. Pr√≥b√°ld ki te is! #MystiGo #V√°rosiKaland #KalandJ√°t√©k`;
            const url = 'https://www.mystigo.hu/'; 
            let shareUrl = '';
            switch (platform) {
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`; break;
                case 'system':
                    if (navigator.share) { navigator.share({ title: 'MystiGo Kaland Teljes√≠tve!', text: text, url: url }).catch(error => console.log('Megoszt√°s megszak√≠tva vagy hiba t√∂rt√©nt', error)); return; } 
                    shareUrl = `mailto:?subject=MystiGo Kaland&body=${encodeURIComponent(text + " " + url)}`; break;
                default: return;
            }
            if (shareUrl) window.open(shareUrl, '_blank');
        }
        
        function normalizeAnswer(str) { 
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '');
        }


// --- GPS TESZT GLOB√ÅLIS V√ÅLTOZ√ìK ---
let gpsTestMap = null;
let gpsTestMarker = null;
let gpsTestCircle = null;
let gpsTestWatchId = null;
let gpsTestInterval = null;
let bestAccuracy = 99999;
let lastTestLat = null;
let lastTestLng = null; 

// --- √öJ GPS TESZT F√úGGV√âNY ---
window.testGpsConnection = function() {
    stopAllGpsActivity();
    // UI elemek el≈ëk√©sz√≠t√©se
    const container = document.getElementById('gps-test-container');
    const statusText = document.getElementById('gps-test-status');
    const resultMsg = document.getElementById('gps-result-message');
    const accValue = document.getElementById('gps-accuracy-value');
    const testBtn = document.getElementById('gps-test-btn');

    // Resetel√©s
    container.classList.remove('hidden');
    resultMsg.classList.add('hidden');
    statusText.innerHTML = `üì° Jel keres√©se... <span id="gps-countdown">15</span>mp`;
    accValue.textContent = "-";
    bestAccuracy = 99999;
    lastTestLat = null; // T√∂r√∂lj√ºk az el≈ëz≈ët
    lastTestLng = null;
    testBtn.disabled = true;

    // 1. T√©rk√©p inicializ√°l√°sa
    if (!gpsTestMap) {
        gpsTestMap = L.map('gps-test-map', { 
            zoomControl: false, 
            attributionControl: false 
        }).setView([47.4979, 19.0402], 13);

        addSmartTileLayer(gpsTestMap);
    }
    container.classList.remove('hidden');
    setTimeout(() => { 
        // 1. Odag√∂rgetj√ºk a k√©perny≈ët a dobozhoz
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 2. Friss√≠tj√ºk a t√©rk√©p m√©ret√©t (hogy ne legyen sz√ºrke)
        if (gpsTestMap) gpsTestMap.invalidateSize(); 
    }, 200);

    if (!navigator.geolocation) {
        finishGpsTest(false, "A b√∂ng√©sz≈ë nem t√°mogatja a GPS-t.");
        return;
    }

    // 2. Visszasz√°ml√°l√≥ (15 mp)
    let timeLeft = 15;
    if (gpsTestInterval) clearInterval(gpsTestInterval);

    gpsTestInterval = setInterval(() => {
        timeLeft--;
        const counterEl = document.getElementById('gps-countdown');
        if(counterEl) counterEl.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            finishGpsTest(); // Id≈ë lej√°rt
        }
    }, 1000);

// --- √öJ F√úGGV√âNY: GPS Teszt ablak bez√°r√°sa √©s folyamatok le√°ll√≠t√°sa ---
window.closeGpsTest = function() {
    // 1. Minden fut√≥ folyamat le√°ll√≠t√°sa (hogy ne fogyassza az akkut)
    if (typeof gpsTestWatchId !== 'undefined' && gpsTestWatchId !== null) {
        navigator.geolocation.clearWatch(gpsTestWatchId);
        gpsTestWatchId = null;
    }
    if (typeof gpsTestInterval !== 'undefined' && gpsTestInterval !== null) {
        clearInterval(gpsTestInterval);
        gpsTestInterval = null;
    }

    // 2. Ablak elrejt√©se
    const container = document.getElementById('gps-test-container');
    if (container) container.classList.add('hidden');

    // 3. Ind√≠t√≥ gomb √∫jra enged√©lyez√©se
    const testBtn = document.getElementById('gps-test-btn');
    if (testBtn) testBtn.disabled = false;

    console.log("GPS teszt megszak√≠tva √©s bez√°rva.");
};


    // 3. Poz√≠ci√≥ figyel√©se
    gpsTestWatchId = navigator.geolocation.watchPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = Math.round(pos.coords.accuracy);

            // √öJ: Ments√ºk el a poz√≠ci√≥t, hogy a v√©g√©n tudjunk vele sz√°molni
            lastTestLat = lat;
            lastTestLng = lng;

            // Legjobb pontoss√°g ment√©se
            if (accuracy < bestAccuracy) bestAccuracy = accuracy;
            accValue.textContent = accuracy;

            // T√©rk√©pelem friss√≠t√©se
            updateTestMapMarker(lat, lng, accuracy);

            // --- JAV√çTOTT GYORS LE√ÅLL√çT√ÅS ---
            // A legjobb √©rt√©ket n√©zz√ºk, √©s ha az j√≥, azonnal meg√°llunk!
            if (bestAccuracy <= 10) {
                console.log("J√≥ jel tal√°lva:", bestAccuracy); // Debug info
                finishGpsTest(); 
            }
        },
        (err) => {
            console.warn("GPS Teszt hiba:", err);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
};

// Seg√©df√ºggv√©ny a t√©rk√©prajzol√°shoz
function updateTestMapMarker(lat, lng, accuracy) {
    if (!gpsTestMap) return;
    try {
        const latLng = [lat, lng];
        
        if (!gpsTestMarker) {
            const icon = L.divIcon({ className: 'player-marker', iconSize: [15, 15] });
            gpsTestMarker = L.marker(latLng, { icon: icon }).addTo(gpsTestMap);
            gpsTestCircle = L.circle(latLng, { radius: accuracy, color: 'blue', weight: 1, fillOpacity: 0.1 }).addTo(gpsTestMap);
            gpsTestMap.setView(latLng, 16);
        } else {
            gpsTestMarker.setLatLng(latLng);
            if (gpsTestCircle) {
                gpsTestCircle.setLatLng(latLng);
                gpsTestCircle.setRadius(accuracy);
            }
            if (!gpsTestMap.getBounds().contains(latLng)) {
                gpsTestMap.panTo(latLng);
            }
        }
    } catch (e) {
        console.error("T√©rk√©p hiba:", e);
    }
}

// --- GPS TESZT LEZ√ÅR√ÅSA (SORBARENDEZ√âSSEL) ---
function finishGpsTest(forceError = false, errorMsg = "") {
    // Minden figyel√©s azonnali le√°ll√≠t√°sa
    if (gpsTestWatchId) {
        navigator.geolocation.clearWatch(gpsTestWatchId);
        gpsTestWatchId = null;
    }
    if (gpsTestInterval) {
        clearInterval(gpsTestInterval);
        gpsTestInterval = null;
    }

    const statusText = document.getElementById('gps-test-status');
    const resultMsg = document.getElementById('gps-result-message');
    const testBtn = document.getElementById('gps-test-btn');
    
    if(testBtn) testBtn.disabled = false;

    if (forceError) {
        statusText.textContent = "Hiba t√∂rt√©nt!";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-red-100 text-red-700 block";
        resultMsg.innerHTML = `‚ö†Ô∏è ${errorMsg}`;
        return;
    }

    // EREDM√âNY KI√çR√ÅSA
    if (bestAccuracy <= 50) {
        statusText.textContent = "Teszt k√©sz."; 
        
        let successText = "";
        let colorClass = "";
        
        if (bestAccuracy <= 10) {
             colorClass = "bg-green-100 text-green-700";
             successText = `üöÄ Szuper jel!<br>Pontoss√°g: ${bestAccuracy}m`;
             if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'green', fillColor: 'green' });
        } else {
             colorClass = "bg-green-100 text-green-700";
             successText = `‚úÖ GPS M≈±k√∂dik!<br>Pontoss√°g: ${bestAccuracy}m`;
             if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'green', fillColor: 'green' });
        }

        // --- √öJ R√âSZ: SORBARENDEZ√âS AUTOMATIKUSAN ---
        if (lastTestLat !== null && lastTestLng !== null) {
            console.log("Sikeres teszt -> Lista rendez√©se...");
            
            // 1. T√°vols√°gok √∫jrasz√°mol√°sa a teszt koordin√°t√°ival
            Object.values(games).forEach(game => {
                if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                    const dist = haversineDistance(
                        { lat: lastTestLat, lng: lastTestLng }, 
                        { lat: game.startLocation.lat, lng: game.startLocation.lng }
                    );
                    game._calculatedDistance = dist / 1000; // km
                } else {
                    game._calculatedDistance = 99999; 
                }
            });

            // 2. Lista √∫jrarajzol√°sa (ez automatikusan sorba rendezi a _calculatedDistance alapj√°n)
            renderGameList();

            // 3. Visszajelz√©s
            successText += `<br><span class="text-[10px] uppercase font-bold mt-1 block">üìç J√°t√©klista friss√≠tve!</span>`;
        }
        // ---------------------------------------------

        resultMsg.className = `mt-2 p-2 rounded text-xs font-bold text-center block ${colorClass}`;
        resultMsg.innerHTML = successText;
        
    } else if (bestAccuracy < 99999) {
        // Gyenge jel (s√°rga)
        statusText.textContent = "Teszt k√©sz.";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-yellow-100 text-yellow-800 block";
        resultMsg.innerHTML = `‚ö†Ô∏è Gyenge jel (${bestAccuracy}m).<br>Menj ny√≠lt terepre!`;
        if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'orange', fillColor: 'orange' });
    
    } else {
        // Nincs jel (piros)
        statusText.textContent = "Nincs jel.";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-red-100 text-red-700 block";
        resultMsg.innerHTML = `‚ùå Nem siker√ºlt poz√≠ci√≥t tal√°lni.<br>Ellen≈ërizd a be√°ll√≠t√°sokat!`;
    }
    
    resultMsg.classList.remove('hidden');
}



 // ‚úÖ STABIL J√ÅT√âKIND√çT√ì - JAV√çTOTT VERZI√ì
window.loadGameDataAndStart = async function(gameId) {
    const currentName = document.getElementById('team-name-input').value.trim();
    const avatarKey = localStorage.getItem('mystigo_pref_teamAvatar') || 'cat';
    const normalized = window.normalizeForComparison(currentName);
    const user = window.auth.currentUser;

    showLoading(true);

    try {
        // 1. N√âVFOGLAL√ÅS (Csak regisztr√°ltaknak, √©s nem teszt j√°t√©kn√°l)
        if (user && !user.isAnonymous && normalized && gameId !== 'teszt-game') {
            const nameRef = window.ref(window.db, `taken_team_names/${normalized}`);
            await window.runTransaction(nameRef, (currentUid) => {
                if (currentUid === null || currentUid === user.uid) return user.uid;
                return; 
            });
        }

        // 2. ADATOK BET√ñLT√âSE
        const storageKey = `MystiGo_GameData_${gameId}`;
        const basicInfo = window.games ? window.games[gameId] : null;
        
        let gameData = null;

        // Csak az instant j√°t√©kn√°l nincs secure let√∂lt√©s. 
        // A 'teszt-game' mostant√≥l RENDESEN let√∂lti a feladatokat!
        if (gameId.startsWith('instant_')) {
            gameData = basicInfo;
        } else {
            const dbRef = window.ref(window.db, 'games/secure_game_contents/' + gameId);
            const snapshot = await window.get(dbRef);
            
            if (snapshot.exists()) {
                gameData = { ...basicInfo, ...snapshot.val() };
                localStorage.setItem(storageKey, JSON.stringify(gameData));
            } else {
                const cached = localStorage.getItem(storageKey);
                if (cached) gameData = JSON.parse(cached);
                else throw new Error("A j√°t√©k tartalma nem √©rhet≈ë el.");
            }
        }

        // 3. J√ÅT√âK IND√çT√ÅSA
        if (!gameData || !gameData.tasks) {
            throw new Error("Ehhez a j√°t√©khoz nincsenek feladatok t√∂ltve.");
        }

        window.games[gameId] = gameData;
        appState.currentGame = gameData;
        appState.teamName = currentName;
        appState.teamAvatar = avatarKey;
        
        document.getElementById('game-list-page').classList.add('hidden');
        document.getElementById('game-page').classList.remove('hidden');

        if (typeof initializeMap === 'function') {
            initializeMap(gameData);
        }

        showLoading(false);
        setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 200);

    } catch (error) {
        showLoading(false);
        console.error("Ind√≠t√°si hiba:", error);
        showMessage("Hiba", error.message);
    }
}; 





// --- √öJ TESZT IND√çT√ì F√úGGV√âNY ---
window.startSpecificTestGame = async function() {
    const FIX_GAME_ID = "teszt-game"; 

    if (!window.games || !window.games[FIX_GAME_ID]) {
        alert(`HIBA: A '${FIX_GAME_ID}' azonos√≠t√≥j√∫ j√°t√©k nem tal√°lhat√≥...`);
        return;
    }

    const nameInput = document.getElementById('team-name-input');
    const avatarSelect = document.getElementById('team-avatar-select');

    // JAV√çT√ÅS: Automatikus kit√∂lt√©s t√∂r√∂lve, helyette valid√°ci√≥
    const validation = window.validateTeamName(nameInput.value);
    if (!validation.valid) {
        showMessage('Figyelem', validation.error, () => {
            nameInput.value = "";
            localStorage.removeItem('mystigo_pref_teamName');
            nameInput.focus();
        });
        return; 
    }

    if (!avatarSelect.value) {
        showMessage('Hi√°nyz√≥ Adat', 'K√©rlek, v√°lassz egy Avatart!');
        return; 
    }

    // Ha id√°ig eljut, az adatok rendben vannak
    try {
        console.log(`üì• Teszt j√°t√©k adatainak let√∂lt√©se...`);
        await window.loadGameDataAndStart(FIX_GAME_ID);
        startGame(FIX_GAME_ID, 'mock');
    } catch (error) {
        console.error("Teszt j√°t√©k ind√≠t√°si hiba:", error);
    }
};



function requestGpsAndStart(gameId) {
            const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
            const gameMode = selectedMode ? selectedMode.value : 'normal';

            if (gameMode === 'mock') { startGame(gameId, 'mock'); return; }
            
            if (!navigator.geolocation) { 
                // Ha a b√∂ng√©sz≈ë egy√°ltal√°n nem t√°mogatja, akkor is j√∂het a help ablak
                document.getElementById('gps-help-modal').classList.remove('hidden');
                return; 
            }
            
            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    showLoading(false);
                    updatePlayerMarker(pos.coords.latitude, pos.coords.longitude); 
                    startGame(gameId, 'normal');
                },
                (err) => { 
                    showLoading(false);
                    
                    if (gameMode === 'normal') {
                        // JAV√çT√ÅS: Itt most m√°r a sz√©p ablakot nyitjuk meg a showMessage helyett!
                        document.getElementById('gps-help-modal').classList.remove('hidden');
                    }
                    else { 
                        showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d miatt a j√°t√©k elindul.'); 
                        startGame(gameId, 'test'); 
                    }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000, frequency: 3000 } 
            );
        }
      
// --- STORAGE MANAGER LOGIKA ---

window.openStorageManager = function() {
    renderStorageList();
    document.getElementById('storage-manager-modal').classList.remove('hidden');
};

window.renderStorageList = function() {
    const container = document.getElementById('storage-list-container');
    container.innerHTML = '';
    
    const keys = Object.keys(localStorage);
    document.getElementById('storage-count-display').textContent = `${keys.length} bejegyz√©s`;

    if (keys.length === 0) {
        container.innerHTML = `<div class="text-center p-8 text-gray-400 italic">A LocalStorage √ºres.</div>`;
        return;
    }

    // Rendez√©s, hogy a hasonl√≥ak egym√°s mell√© ker√ºljenek
    keys.sort();

    keys.forEach(key => {
        let displayTitle = key;
        let icon = 'üìÑ';
        let bgColor = 'bg-white';
        let borderColor = 'border-gray-200';
        let textColor = 'text-gray-600';

        // Kateg√≥ri√°k felismer√©se a szebb megjelen√≠t√©s√©rt
        if (key.startsWith('MystiGoGameState_')) {
            icon = 'üéÆ';
            displayTitle = key.replace('MystiGoGameState_', 'MENT√âS: ');
            bgColor = 'bg-orange-50';
            borderColor = 'border-orange-200';
            textColor = 'text-orange-800';
        } else if (key.startsWith('MystiGo_Perm_Completed_')) {
            icon = 'üèÜ';
            displayTitle = key.replace('MystiGo_Perm_Completed_', 'K√âSZ: ');
            bgColor = 'bg-green-50';
            borderColor = 'border-green-200';
            textColor = 'text-green-800';
        
	} else if (key.startsWith('MystiGo_Perm_Count_')) {
            icon = 'üî¢';
            displayTitle = key.replace('MystiGo_Perm_Count_', 'J√ÅT√âK SZ√ÅML√ÅL√ì: ');
            bgColor = 'bg-purple-50';
            borderColor = 'border-purple-200';
            textColor = 'text-purple-800';

	} else if (key.startsWith('mystigo_pref_')) {
            icon = '‚öôÔ∏è';
            displayTitle = key.replace('mystigo_pref_', 'BE√ÅLL√çT√ÅS: ');
            bgColor = 'bg-blue-50';
            borderColor = 'border-blue-200';
            textColor = 'text-blue-800';
        }

        // Egy sor HTML k√≥dja
        const itemHtml = `
            <div class="flex items-center justify-between p-3 mb-2 rounded-lg border ${bgColor} ${borderColor} shadow-sm transition hover:shadow-md group">
                <div class="overflow-hidden mr-3">
                    <div class="text-xs font-bold ${textColor} truncate flex items-center gap-1.5" title="${key}">
                        <span>${icon}</span> ${displayTitle}
                    </div>
                    <div class="text-[10px] text-gray-400 truncate font-mono mt-0.5">
                        ${key}
                    </div>
                </div>
                <button onclick="deleteStorageItem('${key}')" 
                        class="shrink-0 bg-white border border-gray-200 text-red-500 hover:bg-red-500 hover:text-white p-1.5 rounded-md transition shadow-sm"
                        title="T√∂rl√©s">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `;
        container.innerHTML += itemHtml;
    });
};

window.deleteStorageItem = function(key) {
    if (confirm(`Biztosan t√∂rl√∂d ezt a kulcsot?\n${key}`)) {
        localStorage.removeItem(key);
        renderStorageList(); // Lista friss√≠t√©se t√∂rl√©s ut√°n
        
        // Ha √©pp a fut√≥ j√°t√©kot t√∂r√∂lt√ºk, jelezz√ºk
        if (window.currentGameId && key.includes(window.currentGameId)) {
            alert("Figyelem: A jelenleg fut√≥ vagy kiv√°lasztott j√°t√©k adatait t√∂r√∂lted. √ârdemes √∫jrat√∂lteni az oldalt.");
        }
    }
};

window.nukeAllStorage = function() {
    if (confirm("‚ö†Ô∏è FIGYELEM!\n\nEz t√∂rli az √ñSSZES ment√©st, be√°ll√≠t√°st √©s teljes√≠t√©st.\nBiztosan folytatod?")) {
        localStorage.clear();
        renderStorageList();
        alert("A mem√≥ria teljesen t√∂r√∂lve lett. Az oldal √∫jrat√∂lt≈ëdik.");
        location.reload();
    }
};



// --- √öJ FUNKCI√ìK: T√©rk√©pes J√°t√©kv√°laszt√≥ ---

window.gameSelectionMapInstance = null;
window.gameSelectionMarkers = [];

window.openGameMap = function() {
    const modal = document.getElementById('game-map-modal');
    modal.classList.remove('hidden');

    // T√©rk√©p l√©trehoz√°sa, ha m√©g nincs
    if (!window.gameSelectionMapInstance) {
        window.gameSelectionMapInstance = L.map('game-selection-map', { zoomControl: false }).setView([47.1625, 19.5033], 7);
	window.gameSelectionMapInstance.attributionControl.setPrefix(false);
        addSmartTileLayer(window.gameSelectionMapInstance);
    }

    // M√©ret friss√≠t√©se
    setTimeout(() => {
        window.gameSelectionMapInstance.invalidateSize();
    }, 200);

    // Sz≈±r≈ëk vissza√°ll√≠t√°sa alaphelyzetbe minden nyit√°skor (hogy minden l√°tsz√≥djon)
    document.getElementById('chk-map-normal').checked = true;
    document.getElementById('chk-map-kids').checked = true;
    document.getElementById('chk-map-team').checked = true;
    document.getElementById('chk-map-explore').checked = true;

    // Markerek kirajzol√°sa
    window.updateMapMarkers();
};

// 2. MARKEREK FRISS√çT√âSE (Ez fut a pip√°l√°skor is)
window.updateMapMarkers = function() {
    if (!window.gameSelectionMapInstance) return;

    // R√©gi markerek t√∂rl√©se
    window.gameSelectionMarkers.forEach(m => m.remove());
    window.gameSelectionMarkers = [];

    // Sz≈±r≈ë √°llapotok lek√©r√©se
    const showNormal = document.getElementById('chk-map-normal').checked;
    const showKids = document.getElementById('chk-map-kids').checked;
    const showTeam = document.getElementById('chk-map-team').checked;
    const showExplore = document.getElementById('chk-map-explore').checked;

    const bounds = [];

    Object.values(games).forEach(game => {
        // --- 1. Glob√°lis sz≈±r√©sek (Rejtett/Limit) ---
        if (!window.showHiddenGames) {
            if (game.isHidden) return;
            if (game.maxPlayCount === -1) return;
        }

        // --- 2. T√≠pus szerinti sz≈±r√©s (CHECKBOXOK) ---
        if (game.type === 'normal' && !showNormal) return; // Ha normal, de nincs pipa, kihagyjuk
        if (game.type === 'kids' && !showKids) return;
        if (game.type === 'team' && !showTeam) return;
        if (game.type === 'explore' && !showExplore) return;

        // Ha √°tment a sz≈±r≈ëk√∂n, kirajzoljuk
        if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
            
            // Ikon √©s Sz√≠n be√°ll√≠t√°sa (A k√©rt Ir√°nyt≈±s m√≥dos√≠t√°ssal!)
            let markerEmoji = 'üß≠'; 
            let markerColor = 'bg-green-600'; 
            
            if (game.type === 'kids') { markerEmoji = 'üêà'; markerColor = 'bg-yellow-500'; }
            else if (game.type === 'team') { markerEmoji = 'üßë‚Äçü§ù‚Äçüßë'; markerColor = 'bg-indigo-600'; }
            else if (game.type === 'explore') { markerEmoji = 'üåç'; markerColor = 'bg-cyan-500'; }

            const customIcon = L.divIcon({
                className: 'custom-game-marker',
                html: `<div class="${markerColor} w-8 h-8 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-lg">${markerEmoji}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            const marker = L.marker([game.startLocation.lat, game.startLocation.lng], { 
                icon: customIcon,
                title: game.title 
            })
            .addTo(window.gameSelectionMapInstance)
            .bindPopup(`
                <div class="text-center min-w-[160px]">
                    <h3 class="font-bold text-sm text-[#0D2B45] mb-1 leading-tight">${game.title}</h3>
                    <p class="text-[10px] text-gray-500 mb-3 uppercase tracking-wide">${game.type} t√≠pus</p>
                    
                    <div class="flex items-center justify-center gap-2">
                        <button id="map-start-btn-${game.id}" class="bg-[#FFA500] text-white text-xs font-bold py-1.5 px-3 rounded-md shadow hover:bg-orange-600 transition">
                            Ind√≠t√°s
                        </button>
                        <button id="map-cancel-btn-${game.id}" class="bg-gray-200 text-gray-600 text-xs font-bold py-1.5 px-3 rounded-md hover:bg-gray-300 transition">
                            M√©gsem
                        </button>
                    </div>
                </div>
            `);

            marker.on('popupopen', () => {
                const startBtn = document.getElementById(`map-start-btn-${game.id}`);
                if(startBtn) {
                    startBtn.onclick = () => {
                        window.closeGameMap();
                        const priceText = game.price > 0 ? `${game.price} Ft` : 'Ingyenes';
                        const hasSave = localStorage.getItem('MystiGoGameState_' + game.id) !== null;
                        
                        // JAV√çT√ÅS: Itt √°tadjuk a 'true' √©rt√©ket utols√≥ param√©terk√©nt!
                        handleGameSelect(game.id, game.title, game.type, priceText, hasSave, true);
                    };
                }
                const cancelBtn = document.getElementById(`map-cancel-btn-${game.id}`);
                if(cancelBtn) {
                    cancelBtn.onclick = () => { marker.closePopup(); };
                }
            });

            window.gameSelectionMarkers.push(marker);
            bounds.push([game.startLocation.lat, game.startLocation.lng]);
        }
    });

    // Felhaszn√°l√≥ poz√≠ci√≥ja (ha van)
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            
            // Csak akkor rajzoljuk √∫jra a saj√°t poz√≠ci√≥t, ha nincs m√°r a t√©rk√©pen
            // (Egyszer≈±s√≠t√©s: itt most mindig √∫jrarajzoljuk a tisztas√°g kedv√©√©rt)
            const userIcon = L.divIcon({
                className: 'user-pos-marker',
                html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-md pulse-ring"></div>',
                iconSize: [16, 16]
            });
            const userMarker = L.marker([userLat, userLng], { icon: userIcon }).addTo(window.gameSelectionMapInstance);
            window.gameSelectionMarkers.push(userMarker);
            bounds.push([userLat, userLng]);

            // Csak a legels≈ë bet√∂lt√©skor (amikor bounds √ºres volt el≈ëtte) zoomolunk r√° mindenre,
            // hogy pip√°lgat√°s k√∂zben ne ugr√°ljon a t√©rk√©p.
            // De egyszer≈±bb, ha csak sim√°n hagyjuk a zoomot, kiv√©ve ha "nyit√°s" van.
        });
    }

    // Opcion√°lis: Ha nagyon szeretn√©d, hogy sz≈±r√©skor is igazodjon a t√©rk√©p, 
    // akkor ide betehetsz egy fitBounds h√≠v√°st, de jobb, ha a felhaszn√°l√≥ kez√©ben hagyod az ir√°ny√≠t√°st.
};






window.closeGameMap = function() {
    document.getElementById('game-map-modal').classList.add('hidden');
};


let currentCouponGameId = null;

window.openCouponModal = function(gameId, title) {
    currentCouponGameId = gameId;
    const modal = document.getElementById('coupon-modal');
    const btn = document.getElementById('verify-coupon-btn'); // Gomb lek√©r√©se
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // RESET: Alaphelyzetbe √°ll√≠tjuk a beviteli mez≈ët √©s a gombot
    document.getElementById('coupon-input').value = '';
    document.getElementById('coupon-error').classList.add('hidden');
    
    if (btn) {
        btn.disabled = false;           // √öjra kattinthat√≥ legyen
        btn.textContent = "Ellen≈ërz√©s"; // Eredeti sz√∂veg vissza√°ll√≠t√°sa
    }
    
    document.getElementById('verify-coupon-btn').onclick = () => validateAndUseCoupon();
};

window.closeCouponModal = function() {
    const modal = document.getElementById('coupon-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
};

async function validateAndUseCoupon() {
    // 1. El≈ëk√©sz√≠t√©s
    const code = document.getElementById('coupon-input').value.trim().toUpperCase();
    const errorEl = document.getElementById('coupon-error');
    const btn = document.getElementById('verify-coupon-btn');

    if (!code) return;

    btn.disabled = true;
    btn.textContent = "Ellen≈ërz√©s...";
    errorEl.classList.add('hidden');

    try {
        // 2. Els≈ë l√©p√©s: Csak ellen≈ërizz√ºk, hogy l√©tezik-e a k√≥d
        const couponRef = window.ref(window.db, 'coupons/' + code);
        const snapshot = await window.get(couponRef);

        if (snapshot.exists()) {
    console.log("üé´ Kupon √©rv√©nyes, pr√≥b√°ljuk megnyitni a j√°t√©kot...");

    try {
        await window.loadGameDataAndStart(currentCouponGameId);
        await window.set(couponRef, null);
        
        // Vissza√°ll√≠tjuk a gombot a siker ut√°n is, miel≈ëtt bez√°rjuk
        btn.disabled = false; 
        btn.textContent = "Ellen≈ërz√©s";

        window.closeCouponModal();
                
                console.log("‚úÖ J√°t√©k elindult, kupon sikeresen el√©getve.");
                
                // Modal bez√°r√°sa √©s GPS k√©r√©s (ez a szok√°sos folyamat v√©ge)
                
                if (typeof requestGpsAndStart === 'function') {
                    requestGpsAndStart(currentCouponGameId);
                }

            } catch (loadError) {
                // Ha a j√°t√©k bet√∂lt√©se nem siker√ºlt (pl. elment a net)
                console.error("J√°t√©k bet√∂lt√©si hiba:", loadError);
                alert("Hiba: A j√°t√©k adatait nem siker√ºlt let√∂lteni. A kuponod NEM veszett el, k√©rlek pr√≥b√°ld √∫jra stabilabb internettel!");
                btn.disabled = false;
                btn.textContent = "Ellen≈ërz√©s";
            }
        } else {
            // Nem l√©tezik a k√≥d
            errorEl.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = "Ellen≈ërz√©s";
        }
    } catch (e) {
        console.error("Kupon ellen≈ërz√©si hiba:", e);
        alert("Hiba t√∂rt√©nt a szerverrel val√≥ kommunik√°ci√≥ sor√°n.");
        btn.disabled = false;
        btn.textContent = "Ellen≈ërz√©s";
    }
}




  
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- √öJ R√âSZ KEZDETE: N√©v √©s Avatar automatikus ment√©se/bet√∂lt√©se ---
            const nameInputEl = document.getElementById('team-name-input');

nameInputEl.addEventListener('blur', async () => {
    const val = nameInputEl.value.trim();
    if (val.length < 2) return; 

    // 1. Alap valid√°ci√≥ (k√°romkod√°s sz≈±r≈ë)
    const validation = window.validateTeamName(val);
    if (!validation.valid) {
        showMessage('Figyelem', validation.error, () => {
            nameInputEl.value = "";
            nameInputEl.focus();
        });
        return;
    }

    // 2. ADATB√ÅZIS ELLEN≈êRZ√âS (Taken team names)
    showLoading(true);
    const isUnique = await window.checkNameUniqueness(val);
    showLoading(false);

    if (!isUnique) {
        showMessage('Foglalt n√©v', 'Sajnos ez a n√©v m√°r foglalt! K√©rlek, v√°lassz egy m√°sikat.', () => {
            nameInputEl.value = ""; 
            nameInputEl.focus();
        });
    }
});



            const avatarSelectEl = document.getElementById('team-avatar-select');


// --- √öJ GOMB ESEM√âNYKEZEL≈êJE (√ñsszes j√°t√©k list√°z√°sa) ---
    // --- EZ A FRISS√çTETT VERZI√ì (CSER√âLD LE A R√âGIT ERRE) ---
    const listAllGamesBtn = document.getElementById('list-all-games-btn');
    if (listAllGamesBtn) {
        listAllGamesBtn.addEventListener('click', () => {
            // 1. Bekapcsoljuk a glob√°lis v√°ltoz√≥t, hogy l√°ssuk a rejtetteket
            window.showHiddenGames = true;

            // 2. √öjragener√°ljuk a helysz√≠n list√°t (most m√°r a rejtett v√°rosok is benne lesznek)
            populateLocationFilter();

            // 3. Kirajzoljuk a j√°t√©kokat
            renderGameList(games);
            
            // 4. Fejleszt≈ëi men√º bez√°r√°sa (hogy l√°ssuk az eredm√©nyt)
            const devOptions = document.getElementById('developer-options');
            if (devOptions) devOptions.classList.add('hidden');
            const devToggle = document.getElementById('developer-tools-toggle');
            if(devToggle) devToggle.querySelector('span').textContent = '‚ñº';

        });
    }
  

const isIos = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    };

    const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

    if (isIos() && !isInStandaloneMode()) {
        const iosGuide = document.getElementById('ios-install-guide');
        if (iosGuide) {
            // 3 m√°sodperc m√∫lva megjelenik
            setTimeout(() => {
                iosGuide.classList.remove('hidden');
            }, 3000);

            // Els≈ë kattint√°sra elt≈±nik
            document.addEventListener('click', () => {
                iosGuide.classList.add('hidden');
            }, { once: true });
        }
    }



  // --------------------------------------------------------

            // 1. Bet√∂lt√©s: Megn√©zz√ºk, van-e elmentve adat
            const savedName = localStorage.getItem('mystigo_pref_teamName');
            const savedAvatar = localStorage.getItem('mystigo_pref_teamAvatar');

            if (savedName) {
                nameInputEl.value = savedName;
            }
            if (savedAvatar) {
                // Nem csak az √©rt√©ket √°ll√≠tjuk be, hanem l√©trehozzuk az opci√≥t is,
                // √≠gy a select elemnek lesz √©rv√©nyes v√°lasztott √©rt√©ke.
                avatarSelectEl.innerHTML = `<option value="${savedAvatar}" selected>${savedAvatar}</option>`;
            }

            // 2. Ment√©s: Figyelj√ºk a v√°ltoz√°st √©s azonnal ment√ºnk
            if (nameInputEl) {
                nameInputEl.addEventListener('input', (e) => {
                    localStorage.setItem('mystigo_pref_teamName', e.target.value);
		window.updateInstantButtonEligibility();
                });
            }

// --- √öJ KIDS M√ìD LOGIKA ---
            const kidsCheckbox = document.getElementById('kids-mode-checkbox');
            const mainLogo = document.getElementById('main-header-logo');
            const filterTypeSelect = document.getElementById('filter-type');

            function toggleKidsMode(isKidsActive) {
                // 1. Logo csere (Ez marad a r√©gi)
                if (mainLogo) {
                    mainLogo.src = isKidsActive ? "logo/MystiGo_logo_cat.png" : "logo/MystiGo_logo.png";
                }

                // 2. LOGIKA JAV√çT√ÅSA:
                // Megn√©zz√ºk, van-e akt√≠v URL sz≈±r√©s (Helysz√≠n vagy ID)
                const urlParams = new URLSearchParams(window.location.search);
                const pLoc = urlParams.get('location') || urlParams.get('helyszin');
                const pGameId = urlParams.get('game') || urlParams.get('id');

                // A) HA VAN URL PARAM√âTER (Akkor azt tiszteletben tartva sz≈±r√ºnk)
                if (pLoc || pGameId) {
                    console.log("Kids m√≥d v√°lt√°s URL kontextusban...");
                    
                    let filteredGames = {};

                    Object.values(games).forEach(game => {
                        // Alapvet≈ë l√°that√≥s√°gi sz≈±r√©s
                        if (!window.showHiddenGames && game.isHidden) return;
                        
                        // 1. Megfelel az URL-nek?
                        let matchesUrl = true;
                        
                        if (pGameId) {
                            // Ha konkr√©t j√°t√©kra sz≈±rt√ºnk
                            matchesUrl = (game.id.toLowerCase() === pGameId.trim().toLowerCase());
                        } else if (pLoc) {
                            // Ha helysz√≠nre sz≈±rt√ºnk
                            const gameLocs = (game.location || "").toLowerCase().split(',').map(s => s.trim());
                            matchesUrl = gameLocs.some(l => l.includes(pLoc.toLowerCase()));
                        }

                        if (!matchesUrl) return; // Ha nem illik az URL-re, eldobjuk

                        // 2. Megfelel a Kids m√≥dnak?
                        // Ha be van pip√°lva, csak a 'kids' t√≠pus maradhat.
                        if (isKidsActive) {
                            if (game.type !== 'kids') return;
                        }

                        // Ha id√°ig eljutott, akkor megfelel az URL-nek √âS a Kids m√≥dnak is
                        filteredGames[game.id] = game;
                    });

                    // FONTOS: Friss√≠tj√ºk a glob√°lis sz≈±rt √°llapotot, hogy a GPS rendez√©s is j√≥ maradjon
                    appState.currentFilteredGames = filteredGames;
                    renderGameList(filteredGames);
                } 
                
                // B) HA NINCS URL PARAM√âTER (Norm√°l m≈±k√∂d√©s a Dropdownok alapj√°n)
                else {
                    if (filterTypeSelect) {
                        filterTypeSelect.value = isKidsActive ? 'kids' : 'all';
                        if (typeof applyFilters === 'function') {
                            applyFilters();
                        }
                    }
                }
            }



            // Bet√∂lt√©skor
            const savedKidsMode = localStorage.getItem('mystigo_pref_kidsMode') === 'true';
            if (kidsCheckbox) {
                kidsCheckbox.checked = savedKidsMode;
                if (savedKidsMode) toggleKidsMode(true);

                // V√°ltoz√°skor
                kidsCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    localStorage.setItem('mystigo_pref_kidsMode', isChecked);
                    toggleKidsMode(isChecked);
                });
            }
            // -----


            if (avatarSelectEl) {
                // Glob√°liss√° tessz√ºk a f√ºggv√©nyt, hogy a Firebase modul is el√©rje
                window.updateAvatarPreview = () => {
    const previewContainer = document.getElementById('avatar-preview-container');
    // Megn√©zz√ºk, mi van a mem√≥ri√°ban (amit a Firebase is friss√≠t bel√©p√©skor)
    const savedAvatar = localStorage.getItem('mystigo_pref_teamAvatar');
    
    if (previewContainer && savedAvatar) {
        // Az AVATAR_ICONS glob√°lis objektumb√≥l olvassuk ki az emojit
        previewContainer.textContent = AVATAR_ICONS[savedAvatar] || '‚ùì';
        
        // Kis vizu√°lis visszajelz√©s
        previewContainer.classList.add('scale-110');
        setTimeout(() => previewContainer.classList.remove('scale-110'), 150);
    }
};

                // Esem√©nyfigyel≈ë hozz√°ad√°sa
                avatarSelectEl.addEventListener('change', window.updateAvatarPreview);

                // Kezdeti bet√∂lt√©s (mentett adatok alapj√°n)
                setTimeout(window.updateAvatarPreview, 200);
            }


            // --- √öJ R√âSZ V√âGE ---

	    initializeState();
            
            // Itt ind√≠tjuk a bet√∂lt√©st a Firebase-b≈ël
            const startAppDownload = () => {
                console.log("üöÄ Firebase jel meg√©rkezett, let√∂lt√©s ind√≠t√°sa...");
                initializeGamesFromFirebase();
            };

            if (window.isFirebaseReady) {
                startAppDownload();
            } else {
                window.addEventListener('firebase-ready', startAppDownload, { once: true });
            }

            // UI elemek
            const logoO = document.getElementById('logo-o'); 
            // A manu√°lis f√°jl v√°ltoz√≥k (manualFileSelectLabel, manualFileInput) INNEN T√ñR√ñLVE LETTEK

            // Fejleszt≈ëi eszk√∂z√∂k (ha vannak a HTML-ben)
            const devOptions = document.getElementById('developer-options');
            const devToggle = document.getElementById('developer-tools-toggle');

            // Mod√°lis ablak gombok kezel√©se
            const okBtn = document.getElementById('modal-ok-button');
            const cancelBtn = document.getElementById('modal-cancel-button');
            
            if (okBtn) okBtn.onclick = hideMessage;
            if (cancelBtn) cancelBtn.onclick = hideMessage;
            
            // Titkos men√º kapcsol√≥ (Logo 'O' bet≈±je)
            if (logoO) {
                logoO.addEventListener('click', () => {
                     const switchesContainer = document.getElementById('secret-switches-container');
                     if (switchesContainer) {
                        if (!document.getElementById('game-list-page').classList.contains('hidden')) {
                            switchesContainer.classList.toggle('hidden');
                        }
                     }
                });
            }
            
            const mainHeaderLogoContainer = document.querySelector('#main-header .flex.justify-center');
            if (mainHeaderLogoContainer) {
                mainHeaderLogoContainer.style.cursor = 'pointer'; 
                mainHeaderLogoContainer.addEventListener('click', () => { resetApp(); });
            }

            // --- ITT T√ñR√ñLT√úK KI A FELESLEGET ---
            
            const excelFileInput = document.getElementById('excel-file-input');

            document.body.addEventListener('click', (e) => {
                 if (e.target && e.target.id === 'secret-trigger') {
                    const container = document.getElementById('secret-switches-container');
                    if (container) container.classList.toggle('hidden');
                 }
            });
            
            if (devToggle && devOptions) {
                devToggle.addEventListener('click', () => {
                    devOptions.classList.toggle('hidden');
                    devToggle.querySelector('span').textContent = devOptions.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
                });
            }

            document.getElementById('submit-answer-btn').addEventListener('click', () => {
    const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (!task || task.isCorrectlySolved) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return;

                const rawInput = document.getElementById('answer-input').value;
                const normalizedUserAnswer = normalizeAnswer(rawInput);
                
                // Titkos√≠t√°s (Hash) ellen≈ërz√©se
                const userHash = window.hashString(rawInput);
                let isCorrect = false;

                if (task.solutionHash && task.solutionHash === userHash) {
                    isCorrect = true;
                }
                else if (task.acceptedHashes && task.acceptedHashes.includes(userHash)) {
                    isCorrect = true;
                }
                else if (typeof normalizedUserAnswer !== 'undefined') {
                    
                    // √ñsszegy≈±jtj√ºk az √∂sszes lehets√©ges helyes v√°laszt egy list√°ba
                    let possibleAnswers = [];

                    // A) Ha 'acceptedAnswers' t√∂mb l√©tezik (az Instant Adventure ezt t√∂lti fel)
                    if (task.acceptedAnswers && Array.isArray(task.acceptedAnswers)) {
                        possibleAnswers.push(...task.acceptedAnswers);
                    }

                    // B) Ha az adatb√°zisb√≥l nyers 'answers' vagy 'answer' j√∂n
                    if (task.answers) {
                         if (Array.isArray(task.answers)) possibleAnswers.push(...task.answers);
                         else if (typeof task.answers === 'string') possibleAnswers.push(...task.answers.split(';'));
                    }
                    if (task.answer && typeof task.answer === 'string') {
                        possibleAnswers.push(...task.answer.split(';'));
                    }

                    // C) V√©gs≈ë √∂sszehasonl√≠t√°s (minden v√°laszt normaliz√°lunk)
                    isCorrect = possibleAnswers.some(ans => normalizeAnswer(ans) === normalizedUserAnswer);
                }
                
                if (isCorrect) {
        task.isCorrectlySolved = true;
    updateHintButtons(task);
        
        // Azonnali UI tilt√°s
        document.getElementById('submit-answer-btn').disabled = true;
        document.getElementById('answer-input').disabled = true;

        if (typeof window.triggerVictoryUI === 'function') {
            window.triggerVictoryUI(task.taskScore);
        } else {
            handleCorrectAnswer();
        }
    } else {
                // --- EZT A R√âSZT CSER√âLD LE (2515. sor k√∂rny√©ke) ---
                let currentScore = parseInt(task.taskScore || 0);
                if (currentScore > 0) {
                    currentScore = Math.max(0, currentScore - WRONG_ANSWER_PENALTY);
                    task.taskScore = currentScore;
                }
                
                // Az √∫j, piros keretes be√∫sz√≥ ablak h√≠v√°sa a r√©gi showMessage helyett
                window.triggerErrorUI(task.taskScore);
            }
                updateStatusDisplays();
            });



document.getElementById('answer-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('submit-answer-btn').click();
    }
});



            document.getElementById('hint1-btn').addEventListener('click', (e) => {
    const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (!task) return;
    if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
    if (task.isStartTask) return; 

    const hints = task.hints || [];
    const hintText = hints[0] ? decryptHintText(hints[0]) : "Nincs seg√≠ts√©g.";

    if (task.hintsUsed < 1) { 
        // LEBEG≈ê CSILAG ANIM√ÅCI√ì
        const float = document.createElement('div');
        float.className = 'score-float';
        float.style.color = '#ef4444';
        float.innerHTML = `-${HINT1_PENALTY} ‚≠ê`;
        float.style.left = '50%';
        float.style.top = '50%';
        float.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 3000);
        MystiSounds.error(); // Hangeffekt a levon√°shoz

        task.taskScore = Math.max(0, parseInt(task.taskScore || 0) - HINT1_PENALTY); 
        task.hintsUsed = 1; 
        updateStatusDisplays(); 
        saveGameState(); 
        // Els≈ë lek√©r√©sn√©l itt m√°r helyesen 4 param√©ter van:
        window.triggerHintUI(hintText, HINT1_PENALTY, task.taskScore, () => { updateHintButtons(task); });
    } else {
        // JAV√çT√ÅS: Itt is meg kell adni a task.taskScore-t (3. param√©ter), hogy ne tol√≥djanak el az adatok
        window.triggerHintUI(hintText, 0, task.taskScore, () => { updateHintButtons(task); });
    }
});




           document.getElementById('hint2-btn').addEventListener('click', (e) => {
    const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (!task) return;
    if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body'));
    if (task.isStartTask) return;

    const hints = task.hints || [];
    const hintText = hints[1] ? decryptHintText(hints[1]) : "Nincs seg√≠ts√©g.";

    if (task.hintsUsed < 2) { 
        // LEBEG≈ê CSILLAG ANIM√ÅCI√ì
        const float = document.createElement('div');
        float.className = 'score-float';
        float.style.color = '#ef4444';
        float.innerHTML = `-${HINT2_PENALTY} ‚≠ê`;
        float.style.left = '50%';
        float.style.top = '50%';
        float.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 3000);
        MystiSounds.error();

        task.taskScore = Math.max(0, parseInt(task.taskScore || 0) - HINT2_PENALTY);
        task.hintsUsed = 2;
        updateStatusDisplays();
        saveGameState();
        // Itt m√°r eredetileg is 4 param√©ter volt
        window.triggerHintUI(hintText, HINT2_PENALTY, task.taskScore, () => { updateHintButtons(task); });
    } else {
        // JAV√çT√ÅS: Beillesztett√ºk a task.taskScore v√°ltoz√≥t harmadik param√©terk√©nt
        window.triggerHintUI(hintText, 0, task.taskScore, () => { updateHintButtons(task); });
    }
});
         


   
            
       

const solBtn = document.getElementById('solution-btn');
            
if (solBtn) {
    // Elt√°vol√≠tjuk a kor√°bbi esem√©nyfigyel≈ëket (hogy ne fusson le t√∂bbsz√∂r)
    const newSolBtn = solBtn.cloneNode(true);
    solBtn.parentNode.replaceChild(newSolBtn, solBtn);

    newSolBtn.addEventListener('click', () => {
        const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
        if (!task) return;

        if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body'));
        if (task.isStartTask) return;

        // 1. Pontsz√°m null√°z√°sa √©s ment√©s
        task.taskScore = 0;
        updateStatusDisplays();
        saveGameState();

        // 2. MEGOLD√ÅS SZ√ñVEG√âNEK EL≈êK√âSZ√çT√âSE (JAV√çTOTT R√âSZ)
        let solutionText = "";
        let cleanAnswer = "";

        // A) Ha van titkos√≠tott megold√°s (Adatb√°zisb√≥l j√∂n)
        if (task.solution) {
            let decrypted = decryptHintText(task.solution);
            
            // üßπ TAKAR√çT√ÅS: Kiszedj√ºk a "A helyes v√°lasz:" r√©szt √©s a HTML k√≥dokat, ha benne maradtak
            // √çgy csak a tiszta v√°lasz marad (pl. "Mark Zuckerberg")
            cleanAnswer = decrypted.replace(/^A helyes v√°lasz:\s*/i, "").replace(/<[^>]*>/g, "").trim();
        } 
        
        // B) Ha nincs titkos√≠tva, de van elfogadott v√°lasz (R√©gi j√°t√©kok / Azonnali kaland)
        if ((!cleanAnswer || cleanAnswer === "") && task.acceptedAnswers && task.acceptedAnswers.length > 0) {
            cleanAnswer = task.acceptedAnswers[0];
        }

        // C) V√©gs≈ë form√°z√°s: Csak a v√°lasz legyen vastag!
        if (cleanAnswer && !cleanAnswer.includes("Technikai hiba")) {
            solutionText = `<strong>${cleanAnswer}</strong>`;
        } else {
            // Hiba eset√©n
            solutionText = cleanAnswer || "Technikai hiba: Nincs el√©rhet≈ë megold√°s.";
        }

        // 3. √úzenet megjelen√≠t√©se (FONTOS: Kivettem a k√ºls≈ë <strong> taget!)
        window.triggerSolutionUI(solutionText, () => {
            
            // V√°lasz automatikus be√≠r√°sa a mez≈ëbe (csak a tiszta sz√∂veget)
            const answerInput = document.getElementById('answer-input');
            if (answerInput && cleanAnswer) {
                // Ha nem hiba√ºzenet, akkor be√≠rjuk
                if(!cleanAnswer.includes("Technikai hiba")) {
                    answerInput.value = cleanAnswer;
                }
            }

            // 4. TOV√ÅBBL√âP√âS
            console.log("Megold√°s elfogadva, tov√°bbugr√°s...");
            setTimeout(() => {
                handleCorrectAnswer();
            }, 100); 
        });
    });
}
     



            document.getElementById('start-game-btn').addEventListener('click', startTimersAndGPS);
            document.getElementById('exit-game-btn').addEventListener('click', showExitConfirmation);
            document.getElementById('report-error-btn').addEventListener('click', showReportModal); 
            document.getElementById('submit-error-report').addEventListener('click', handleSubmitError); 

            document.addEventListener('visibilitychange', () => {
    if (!appState.currentGame) return;
    if (document.hidden) { 
        if (speechSynth.speaking) speechSynth.cancel();
        // Haszn√°ld a k√∂zponti f√ºggv√©nyt a manu√°lis clearWatch helyett:
        stopAllGpsActivity(); 
    } 
    else if (!appState.geoWatchId) { 
        watchPosition(); 
    }
});

          document.getElementById('answer-input').addEventListener('focus', (e) => {
    const inputElement = e.target;
    
    // Csak egy r√∂vid k√©sleltet√©st haszn√°lunk, hogy a billenty≈±zetnek legyen ideje felugrani
    setTimeout(() => {
        const wrapper = document.getElementById('content-page-wrapper');
        // Kisz√°moljuk a poz√≠ci√≥t a wrapperen bel√ºl
        const offset = 100; // Ennyi pixelt hagyunk a tetej√©t≈ël
        inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
});

window.updateInstantButtonEligibility();
        }); 


window.loadMoreGames = function() {
            // N√∂velj√ºk a limitet
            appState.visibleGamesLimit += 5;
            
            // √öJ: Azt a list√°t rajzoljuk √∫jra, ami √©ppen akt√≠v (sz≈±rt vagy eredeti)
            renderGameList(appState.currentFilteredGames);
        };

    </script>

<script>
    let deferredPrompt;

    // 1. Service Worker regisztr√°l√°sa
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log("Service Worker regisztr√°lva."));
    }

    // 2. Telep√≠t√©si esem√©ny elkap√°sa
   window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    const installBtn = document.getElementById('pwa-install-container');
    if (installBtn) {
        installBtn.classList.remove('hidden');

        // AUTO-ELT√úNTET√âS: 8 m√°sodperc ut√°n elrejti, ha addig nem nyomtak r√°
        setTimeout(() => {
    if (!installBtn.classList.contains('hidden')) {
        installBtn.classList.add('opacity-0');
        setTimeout(() => installBtn.classList.add('hidden'), 500);
    }
}, 8000);
    }
});

    // 3. Telep√≠t√©s ind√≠t√°sa a gombra kattintva
    async function triggerPWAInstall() {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('A felhaszn√°l√≥ telep√≠tette az appot.');
        }
        deferredPrompt = null;
        document.getElementById('pwa-install-container').classList.add('hidden');
    }
</script>



<script>
    // V√©gs≈ë biztons√°gi ellen≈ërz√©s
    setTimeout(() => {
        const loader = document.getElementById('loading-overlay');
        // Ha m√©g mindig l√°tszik a t√∂lt≈ë
        if (loader && !loader.classList.contains('hidden')) {
            console.warn("‚ö†Ô∏è A t√∂lt√©s beragadt, k√©nyszer√≠tett felold√°s...");
            
            // Ha a j√°t√©klista bet√∂lt≈ë f√ºggv√©ny l√©tezik, h√≠vjuk meg k√©zzel
            if (typeof window.initializeGamesFromFirebase === 'function') {
                window.initializeGamesFromFirebase();
            } else {
                // Ha m√©g a f√ºggv√©ny sem l√©tezik (nagyon nagy baj van), legal√°bb vegy√ºk le a t√∂lt≈ët
                loader.classList.add('hidden');
                alert("Kritikus hiba: A rendszer nem tudott elindulni. K√©rlek friss√≠tsd az oldalt!");
            }
        }
    }, 4000);
</script>


<script>


function calculateBearing(lat1, lng1, lat2, lng2) {
    const toRad = (deg) => deg * Math.PI / 180;
    const toDeg = (rad) => rad * 180 / Math.PI;

    const dLon = toRad(lng2 - lng1);
    const y = Math.sin(dLon) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
    return (toDeg(Math.atan2(y, x)) + 360) % 360;
}

/**
 * Ellen≈ërzi, hogy a c√©lir√°ny beleesik-e az enged√©lyezett tartom√°nyba
 */
function isWithinAngle(currentBearing, targetBearing, maxDeviation = 90) {
    if (currentBearing === null) return true; // Az els≈ë pontn√°l b√°rmilyen ir√°ny j√≥
    let diff = Math.abs(currentBearing - targetBearing);
    if (diff > 180) diff = 360 - diff;
    return diff <= maxDeviation;
}




function calculateNextPoint(lat, lng, distanceMeters, bearingDegrees) {
    const R = 6371e3; // F√∂ld sugara m√©terben
    const toRad = (deg) => deg * Math.PI / 180;
    const toDeg = (rad) => rad * 180 / Math.PI;

    const phi1 = toRad(lat);
    const lam1 = toRad(lng);
    const brng = toRad(bearingDegrees);
    const d = distanceMeters;

    const phi2 = Math.asin(Math.sin(phi1) * Math.cos(d / R) +
        Math.cos(phi1) * Math.sin(d / R) * Math.cos(brng));
    const lam2 = lam1 + Math.atan2(Math.sin(brng) * Math.sin(d / R) * Math.cos(phi1),
        Math.cos(d / R) - Math.sin(phi1) * Math.sin(phi2));

    return {
        lat: toDeg(phi2),
        lng: toDeg(lam2)
    };
}




function getPointPriority(poi) {
    let priority = 1; // Alap√©rtelmezett priorit√°s
    const name = (poi.name || "").toLowerCase();

    const high = ['m√∫zeum', 'szobor', 'eml√©km≈±', 'kast√©ly', 'v√°r', 'templom', 'kil√°t√≥', 'torony'];
    const low = ['pad', 'fa', '√≥ra', 'bench', 'tree'];

    // Alap priorit√°s meghat√°roz√°sa t√≠pus alapj√°n
    if (high.some(h => name.includes(h))) {
        priority = 100;
    } else if (low.some(l => name.includes(l))) {
        priority = 5;
    } else if (poi.name && poi.name !== "√ârdekes pont") {
        priority = 50;
    }

    // --- ITT AZ √öJ R√âSZ ---
    // Ha van egyedi neve (√©s nem csak az alap√©rtelmezett "√ârdekes pont"), kap +10 b√≥nuszt
    if (poi.name && poi.name !== "√ârdekes pont") {
        priority += 10; 
    }

    return priority;
}




/**
 * AZONNALI KALAND GENER√ÅTOR (JSON strukt√∫r√°hoz igaz√≠tva)
 */
window.startInstantAdventure = async function() {
    const btn = document.getElementById('instant-adventure-btn');
    const diffSelect = document.getElementById('instant-difficulty-select');
    const catSelect = document.getElementById('instant-category-select'); 
    const countSelect = document.getElementById('instant-task-count-select');
    
    if (!btn) return;

    // Ellen≈ërz√©s, hogy van-e m√°r folyamatban l√©v≈ë kaland
    const saveKey = Object.keys(localStorage).find(key => key.startsWith('MystiGoGameState_instant_'));
    if (saveKey) {
        showMessage(
            '√öj kaland gener√°l√°sa', 
            'Van egy m√°r folyamatban l√©v≈ë azonnali kalandod. Ha √∫jat gener√°lsz, a jelenlegi √°ll√°sod elveszik. Biztosan √∫jat szeretn√©l?', 
            () => {
                window.deleteInstantAdventure(true); 
                setTimeout(() => window.startInstantAdventure(), 100);
            }, 
            true
        );
        return;
    }

    const selectedDiff = diffSelect ? diffSelect.value : 'all';
    const selectedCat = catSelect ? catSelect.value : 'all';
    // √öJ: A v√°lasztott feladatsz√°m lek√©r√©se
    const taskCount = countSelect ? parseInt(countSelect.value) : 5;
    
    const originalContent = btn.innerHTML;
    
    try {
        btn.innerHTML = `üîç ${taskCount} √°llom√°s tervez√©se...`;
        btn.disabled = true;

        if (!window.db) throw new Error("A rendszer m√©g nem √°llt fel.");

        // 1. Aktu√°lis helyzet lek√©r√©se
        let {lat: startLat, lng: startLng} = await new Promise((resolve) => {
            navigator.geolocation.getCurrentPosition(
                (p) => resolve({lat: p.coords.latitude, lng: p.coords.longitude}),
                () => resolve({lat: 47.4979, lng: 19.0402}),
                { enableHighAccuracy: true }
            );
        });

        // 2. POI-k lek√©r√©se
        const fetchRadius = 2500;
        const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node(around:${fetchRadius},${startLat},${startLng})[~"^(tourism|historic|amenity|leisure|man_made|information)$"~"^(viewpoint|monument|memorial|statue|artwork|bench|park|fountain|place_of_worship|wayside_cross|wayside_shrine|museum|playground|tree|board|map|castle|ruins|city_gate|boundary_stone|tower|water_tower|fitness_station|public_bookcase|clock|binoculars)$"];out;`;

        let pool = [];
        try {
            const response = await fetch(overpassUrl);
            const osmData = await response.json();
            pool = osmData.elements.map(el => ({ lat: el.lat, lng: el.lon, name: el.tags.name || "√ârdekes pont" }));
        } catch (e) { console.warn("Overpass hiba."); }

        // 3. L√°ncolt √∫tvonal gener√°l√°sa (Dinamikus hossz√∫s√°ggal)
        let routePoints = [];
        let currentPos = { lat: startLat, lng: startLng };
        let lastBearing = null;
        
        if (appState.instantTarget) {
            lastBearing = calculateBearing(startLat, startLng, appState.instantTarget.lat, appState.instantTarget.lng);
        }

        const MIN_STEP = 100;
        const MAX_STEP = 400;

        for (let i = 0; i < taskCount; i++) {
            if (appState.instantTarget) {
                lastBearing = calculateBearing(currentPos.lat, currentPos.lng, appState.instantTarget.lat, appState.instantTarget.lng);
            }

            let candidates = pool.filter(poi => {
                const dist = haversineDistance(currentPos, poi);
                const bearingToPoi = calculateBearing(currentPos.lat, currentPos.lng, poi.lat, poi.lng);
                const isCorrectDist = dist >= MIN_STEP && dist <= MAX_STEP;
                const isNew = !routePoints.some(p => p.lat === poi.lat && p.lng === poi.lng);
                const deviationLimit = appState.instantTarget ? 45 : 85;
                const isForward = isWithinAngle(lastBearing, bearingToPoi, deviationLimit);
                return isCorrectDist && isNew && isForward;
            });

            let nextPoint;
            if (candidates.length > 0) {
                candidates.sort((a, b) => {
                    const pA = getPointPriority(a);
                    const pB = getPointPriority(b);
                    if (pA !== pB) return pB - pA;
                    return haversineDistance(currentPos, a) - haversineDistance(currentPos, b);
                });
                nextPoint = candidates[0]; 
            } else {
                const randomAngleOffset = (Math.random() * 90) - 45;
                const targetAngle = (lastBearing === null) ? Math.random() * 360 : (lastBearing + randomAngleOffset);
                const randomDist = MIN_STEP + (Math.random() * (MAX_STEP - MIN_STEP));
                nextPoint = calculateNextPoint(currentPos.lat, currentPos.lng, randomDist, targetAngle);
                nextPoint.name = "Felfedez≈ë pont";
            }

            lastBearing = calculateBearing(currentPos.lat, currentPos.lng, nextPoint.lat, nextPoint.lng);
            
            // Ha ez az utols√≥ pont √©s van c√©lpontunk, oda tessz√ºk
            if (appState.instantTarget && i === (taskCount - 1)) {
                 nextPoint = { ...appState.instantTarget, name: "V√©gs≈ë C√©l√°llom√°s" };
            }

            routePoints.push(nextPoint);
            currentPos = nextPoint;
        }

        // 4. Feladatok sz≈±r√©se az adatb√°zisb√≥l
        const snapshot = await window.get(window.ref(window.db, 'generic_tasks'));
        const allTasks = Object.values(snapshot.val() || {});
        let filteredTasks = allTasks.filter(task => {
            const matchesDiff = (selectedDiff === 'all' || (task.category || task.difficulty) === selectedDiff);
            const taskType = task.Type || task.type;
            return matchesDiff && (selectedCat === 'all' || taskType === selectedCat);
        });

        if (filteredTasks.length < taskCount) {
            filteredTasks = allTasks.sort(() => 0.5 - Math.random());
        }

        const shuffledTasks = filteredTasks.sort(() => 0.5 - Math.random()).slice(0, taskCount);
        const tasksWithLocation = shuffledTasks.map((task, index) => ({
            ...task,
            index: index + 1,
            location: routePoints[index],
            prompt: task.prompt || task.question || "Keresd meg a v√°laszt!",
            geofenceRadius: 40 
        }));

        const themeLabel = (selectedCat !== 'all' && catSelect) ? 
                           catSelect.options[catSelect.selectedIndex].text.split(' ')[1] : "V√°rosi";

        const instantGameId = "instant_" + Date.now();
        const instantGame = {
            id: instantGameId,
            title: `${themeLabel} Kaland üé≤`,
            type: "Instant",
            tasks: tasksWithLocation,
            startLocation: { lat: startLat, lng: startLng },
            description: `Ir√°ny√≠tott ${themeLabel} kaland (${taskCount} feladat).`,
            endStory: "Gratul√°lunk! Sikeresen teljes√≠tetted a gener√°lt √∫tvonalat!"
        };

        window.games[instantGameId] = instantGame;
        localStorage.setItem(`MystiGo_GameData_${instantGameId}`, JSON.stringify(instantGame));
        
        appState.currentGame = instantGame;
        saveGameState(); 
        window.checkInstantProgress();

        handleGameSelect(instantGameId, instantGame.title, "Instant", "Ingyenes", false, true);

    } catch (error) {
        alert("Hiba: " + error.message);
    } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
};

   


   

</script>





<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, child, push, update, set, query, runTransaction, onValue } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification} 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ‚úÖ FONTOS: Ide a SAJ√ÅT konfigur√°ci√≥dat m√°sold be!
    const firebaseConfig = {
        apiKey: "AIzaSyCA7V1WXFCVhmw2BygHkrwhrSy1Taoohyw", 
        authDomain: "mystigo-7b149.firebaseapp.com",
        databaseURL: "https://mystigo-7b149-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mystigo-7b149",
        storageBucket: "mystigo-7b149.appspot.com",
        messagingSenderId: "367383637666",
        appId: "1:367383637666:web:156184517316377e641775"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Glob√°lis el√©r√©s biztos√≠t√°sa a t√∂bbi scriptnek
        window.db = db;
        window.auth = auth;
	window.isPopupActive = false;
        window.ref = ref; 
        window.get = get; 
        window.child = child; // Ez hi√°nyzott!
        window.push = push;   // Ez is hi√°nyzott!
        window.set = set; 
        window.update = update; 
        window.query = query; // Ez is hi√°nyzott!
        window.onValue = onValue; // Ez is hi√°nyzott!
        window.runTransaction = runTransaction;
        window.isFirebaseReady = true;
	window.dispatchEvent(new Event('firebase-ready')); 
	console.log("‚úÖ Firebase modul bet√∂ltve √©s jelz√©s elk√ºldve.");



// --- EMAIL AUTH LOGIKA ---
let isRegistrationMode = false;

window.openEmailAuthModal = function() {
    isRegistrationMode = false;
    updateEmailModalUI();
    document.getElementById('email-auth-modal').classList.remove('hidden');
    document.getElementById('email-auth-modal').classList.add('flex');
    document.getElementById('email-auth-error').classList.add('hidden');
};

window.closeEmailAuthModal = function() {
    document.getElementById('email-auth-modal').classList.add('hidden');
    document.getElementById('email-auth-modal').classList.remove('flex');
};

window.toggleEmailAuthMode = function() {
    isRegistrationMode = !isRegistrationMode;
    updateEmailModalUI();
};

function updateEmailModalUI() {
    const title = document.getElementById('email-modal-title');
    const primaryBtn = document.getElementById('email-primary-btn');
    const toggleBtn = document.getElementById('email-toggle-mode');
    
    if (isRegistrationMode) {
        title.textContent = "Regisztr√°ci√≥";
        primaryBtn.textContent = "Fi√≥k l√©trehoz√°sa";
        toggleBtn.textContent = "M√°r van fi√≥kod? Bejelentkez√©s";
    } else {
        title.textContent = "Bejelentkez√©s";
        primaryBtn.textContent = "Bejelentkez√©s";
        toggleBtn.textContent = "Nincs m√©g fi√≥kod? Regisztr√°ci√≥";
    }
}

window.handleEmailAuth = async function() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    const errorEl = document.getElementById('email-auth-error');
    
    if (!email || !password) {
        errorEl.textContent = "K√©rj√ºk, t√∂ltsd ki mindk√©t mez≈ët!";
        errorEl.classList.remove('hidden');
        return;
    }

    try {
        errorEl.classList.add('hidden');
        showLoading(true);
        
        let user; // Deklar√°ljuk a v√°ltoz√≥t k√≠v√ºl, hogy minden √°g el√©rje
        if (isRegistrationMode) {
            // --- REGISZTR√ÅCI√ì ---
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            user = userCredential.user; // JAV√çT√ÅS: a kinti 'user' v√°ltoz√≥t haszn√°ljuk, nem hozunk l√©tre √∫jat const-al

            // KRITIKUS JAV√çT√ÅS: R√∂vid v√°rakoz√°s (setTimeout), hogy a Firebase Auth token 
            // √©rv√©nyess√© v√°ljon az adatb√°zis sz√°m√°ra is.
            setTimeout(async () => {
                try {
                    await set(ref(db, 'private_user_data/' + user.uid), {
    						email: email,
   						 authMethod: 'email',
    						registeredAt: Date.now()
			});
                    console.log("‚úÖ Private data ment√©se sikeres.");
                } catch (dbErr) {
                    console.error("‚ùå Adatb√°zis ment√©si hiba (Permission Denied lehet):", dbErr);
                }
            }, 500); // 500ms k√©sleltet√©s
            
            await sendEmailVerification(user);
            
            showLoading(false);
            closeEmailAuthModal();
            showMessage("Sikeres regisztr√°ci√≥!", "Kik√ºldt√ºnk egy meger≈ës√≠t≈ë e-mailt a(z) " + email + " c√≠mre. K√©rj√ºk, aktiv√°ld a fi√≥kod! (n√©zd meg a SPAM mapp√°dat is)");
            
        } else {
            // --- BEJELENTKEZ√âS ---
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            user = userCredential.user;

            // JAV√çT√ÅS: Bejelentkez√©skor is √©rdemes friss√≠teni/menteni, ha kor√°bban elmaradt volna
            setTimeout(async () => {
                try {
                    await update(ref(db, 'private_user_data/' + user.uid), {
    email: email,
    authMethod: 'email',
    lastLogin: Date.now()
});
                } catch (e) {
                    console.error("Adat friss√≠t√©si hiba bejelentkez√©skor:", e);
                }
            }, 500);

            closeEmailAuthModal();
            showLoading(false);
        }
        
    } catch (error) {
        showLoading(false);
        console.error("Firebase Auth/Database hiba:", error.code, error.message);
        errorEl.classList.remove('hidden');
        
        switch (error.code) {
            case 'auth/email-already-in-use': errorEl.textContent = "Ez az email c√≠m m√°r haszn√°latban van!"; break;
            case 'auth/invalid-email': errorEl.textContent = "√ârv√©nytelen email c√≠m form√°tum!"; break;
            case 'auth/weak-password': errorEl.textContent = "A jelsz√≥nak legal√°bb 6 karakternek kell lennie!"; break;
            case 'auth/user-not-found': 
            case 'auth/wrong-password': 
            case 'auth/invalid-credential': errorEl.textContent = "Hib√°s email c√≠m vagy jelsz√≥!"; break;
            default: errorEl.textContent = "Hiba t√∂rt√©nt: " + error.message;
        }
    }
};


// 1. N√©v tiszt√≠t√°sa az √∂sszehasonl√≠t√°shoz
window.normalizeForComparison = function(text) {
    if (!text) return "";
    return text.toLowerCase().trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // √âkezetek elt√°vol√≠t√°sa
        .replace(/\s+/g, ''); // Sz√≥k√∂z√∂k elt√°vol√≠t√°sa
};




// 2. Egyedis√©g ellen≈ërz√©se a Firebase-ben
window.checkNameUniqueness = async function(teamName) {
    if (!teamName) return false;
    const normalizedName = window.normalizeForComparison(teamName);
    const nameIndexRef = window.ref(window.db, `taken_team_names/${normalizedName}`);
    const user = window.auth.currentUser;

    try {
        const snapshot = await window.get(nameIndexRef);
        if (snapshot.exists()) {
            const takenByUid = snapshot.val();
            // Csak akkor engedj√ºk tov√°bb, ha a felhaszn√°l√≥ regisztr√°lt √âS az √∂v√© a n√©v
            if (user && !user.isAnonymous && takenByUid === user.uid) {
                return true; 
            }
            // Ha a n√©v l√©tezik az adatb√°zisban, de a user anonim (vagy nem az √∂v√©), akkor elutas√≠tjuk
            return false;
        }
        // Ha nem l√©tezik a rekord, b√°rki (anonim is) haszn√°lhatja a nevet
        return true; 
    } catch (e) {
        console.error("N√©v ellen≈ërz√©si hiba:", e);
        return false;
    }
};



        // --- PROFIL MENT√âSE √âS FRISS√çT√âSE (BIZTONS√ÅGOS VERZI√ì) ---
window.saveUserProfile = async (newName, avatarIndex) => {
    const user = auth.currentUser;

    // 1. Jogosults√°g ellen≈ërz√©se
    if (!user || user.isAnonymous) {
        console.log("‚ÑπÔ∏è Vend√©g m√≥d: Profil ment√©se kihagyva.");
        return;
    }

    const newNormalized = window.normalizeForComparison(newName);

    try {
        // 2. Jelenlegi profil lek√©r√©se (sz√ºks√©ges a r√©gi n√©v felszabad√≠t√°s√°hoz)
        const userRef = window.ref(window.db, `users/${user.uid}/profile`);
        const snapshot = await window.get(userRef);
        const currentProfile = snapshot.val() || {};
        
        const oldName = currentProfile.teamName || null;
        const oldNormalized = oldName ? window.normalizeForComparison(oldName) : null;

        // 3. TRANZAKCI√ì: √öj n√©v lefoglal√°sa
        // Csak akkor futtatjuk, ha a n√©v val√≥ban v√°ltozott
        if (newNormalized !== oldNormalized) {
            const nameRef = window.ref(window.db, `taken_team_names/${newNormalized}`);
            
            const result = await window.runTransaction(nameRef, (currentUid) => {
                // Ha a n√©v szabad (null) vagy m√°r a mi√©nk, akkor mehet
                if (currentUid === null || currentUid === user.uid) {
                    return user.uid;
                }
                // Egy√©bk√©nt megszak√≠tjuk (m√°s√© a n√©v)
                return; 
            });

            if (!result.committed) {
                throw new Error("Sajnos valaki √©pp most foglalta le ezt a nevet!");
            }
        }

        // 4. ATOMI FRISS√çT√âS: Minden adatot egyszerre √≠runk be
        const updates = {};
        
        // Ha v√°ltozott a n√©v √âS volt r√©gi neve, a r√©git t√∂r√∂lj√ºk a foglal√°si list√°b√≥l
        if (oldNormalized && oldNormalized !== newNormalized) {
            updates[`taken_team_names/${oldNormalized}`] = null;
        }
        
        // Profil adatok √∂ssze√°ll√≠t√°sa
        updates[`users/${user.uid}/profile/teamName`] = newName;
        updates[`users/${user.uid}/profile/avatar`] = avatarIndex;
        updates[`users/${user.uid}/profile/lastLogin`] = Date.now();
        // Biztons√°gi ment√©s a taken_team_names-be is (tranzakci√≥ ut√°n is illik az update-be tenni)
        updates[`taken_team_names/${newNormalized}`] = user.uid;

        await window.update(window.ref(window.db), updates);
        console.log("‚úÖ Profil √©s n√©vfoglal√°s sikeresen friss√≠tve.");

    } catch (error) {
        console.error("‚ùå Hiba a profil ment√©sekor:", error);
        throw error;
    }
};


        // --- PONTSZ√ÅM N√ñVEL√âSE ---
        window.addPointsToUser = async (points) => {
            const user = auth.currentUser;
            if (user) {
                // K√©nyszer√≠tj√ºk, hogy a 'points' val√≥di SZ√ÅM legyen
                const pointsToAdd = parseInt(points) || 0;
                if (pointsToAdd <= 0) {
                    console.log("‚ÑπÔ∏è Nincs hozz√°adand√≥ pont (0 vagy NaN).");
                    return;
                }

                const scoreRef = ref(db, `users/${user.uid}/profile/totalScore`);
                
                try {
                    const result = await runTransaction(scoreRef, (currentScore) => {
                        // Ha m√©g nincs pontja az adatb√°zisban, 0-r√≥l indul
                        const oldScore = parseInt(currentScore) || 0;
                        return oldScore + pointsToAdd;
                    });
                    
                    if (result.committed) {
                        console.log(`‚úÖ SIKER: ${pointsToAdd} pont hozz√°adva. √öj √∂ssz√©rt√©k: ${result.snapshot.val()}`);
                    }
                } catch (e) {
                    console.error("‚ùå Hiba az √∂sszpontsz√°m tranzakci√≥ k√∂zben:", e);
                }
            } else {
                console.warn("‚ö†Ô∏è Nincs bejelentkezett felhaszn√°l√≥, a pontok nem ment≈ëdnek a profilba.");
            }
        };

        // --- GOOGLE BEJELENTKEZ√âS (Glob√°liss√° t√©tel a window-val) ---
        window.loginWithGoogle = async () => {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Google e-mail ment√©se/friss√≠t√©se a priv√°t √°gba
        await update(ref(db, 'private_user_data/' + user.uid), {
    email: user.email,
    authMethod: 'google',
    lastLogin: Date.now()
        });

        if (user) console.log("‚úÖ Sikeres Google bel√©p√©s:", user.displayName);
    } catch (error) {
        console.error("‚ùå Bejelentkez√©si hiba:", error);
    }
};


window.logout = async () => {
    if(confirm("Biztosan ki szeretn√©l jelentkezni?")) {
        try {
            // 1. Mez≈ëk √ºr√≠t√©se a fel√ºleten
            const nameInput = document.getElementById('team-name-input');
            if (nameInput) nameInput.value = '';

            // 2. LocalStorage √ºr√≠t√©se (√≠gy nem jegyzi meg a regisztr√°lt nevet vend√©gk√©nt)
            localStorage.removeItem('mystigo_pref_teamName');
            localStorage.setItem('mystigo_pref_teamAvatar', 'cat'); // Vissza√°ll√°s cic√°ra

            // 3. Avatar vizu√°lis vissza√°ll√≠t√°sa
            if (typeof window.selectAvatar === 'function') {
                window.selectAvatar('cat'); 
            }

            // 4. Firebase kijelentkez√©s
            await signOut(auth);

            // 5. Gomb √°llapot√°nak friss√≠t√©se (letiltja az ind√≠t√°st n√©v n√©lk√ºl)
            if (typeof window.updateInstantButtonEligibility === 'function') {
                window.updateInstantButtonEligibility();
            }

            showMessage("Kijelentkez√©s", "Sikeresen kijelentkezt√©l.");

        } catch (e) { 
            console.error("Kijelentkez√©si hiba:", e);
            showMessage("Hiba", "Nem siker√ºlt kijelentkezni.");
        }
    }
};


        
        // --- UI √ÅLLAPOTFIGYEL≈ê ---
        let profileListener = null; // V√°ltoz√≥ a figyel≈ë le√°ll√≠t√°s√°hoz

onAuthStateChanged(auth, (user) => {
 

const btnGroup = document.getElementById('auth-buttons-group');
    const logoutBtn = document.getElementById('logout-btn');
    const scoreDisplay = document.getElementById('total-score-display');
    const scoreSpan = document.getElementById('user-total-score');
    const authUserName = document.getElementById('auth-user-name');
    const teamInput = document.getElementById('team-name-input');
    const avatarSelect = document.getElementById('team-avatar-select');
    const authStatusLabel = document.getElementById('auth-status-label');
    const previewVerifiedBadge = document.getElementById('preview-verified-badge');
    const previewContainer = document.getElementById('avatar-preview-container');

    // Kor√°bbi figyel≈ë le√°ll√≠t√°sa, ha volt
    if (profileListener) {
        profileListener();
        profileListener = null;
    }

    if (user) {
        // Bejelentkezve megjelen√≠tj√ºk a pip√°t (active oszt√°ly hozz√°ad√°sa)
        if (previewVerifiedBadge) previewVerifiedBadge.classList.add('active');

        const profileRef = ref(db, `users/${user.uid}/profile`);
        profileListener = onValue(profileRef, (snapshot) => {
            const profile = snapshot.val() || {};

            // Fel√ºlet alapvet≈ë be√°ll√≠t√°sa
            if (btnGroup) btnGroup.classList.add('hidden');
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            if (scoreDisplay) scoreDisplay.classList.remove('hidden');
            if (authStatusLabel) authStatusLabel.textContent = "Bel√©pve:";

            // N√©v √©s pontsz√°m ki√≠r√°sa
            const displayName = profile.teamName || user.displayName;
            if (authUserName) authUserName.textContent = displayName;
            if (scoreSpan) scoreSpan.textContent = profile.totalScore || 0;
            
            // Csapatn√©v mez≈ë √©s LocalStorage friss√≠t√©se
            if (teamInput && profile.teamName) {
                teamInput.value = profile.teamName;
                localStorage.setItem('mystigo_pref_teamName', profile.teamName);
            }
            
            // AVATAR FRISS√çT√âSE K√ñZVETLEN√úL FIREBASE-B≈êL
            if (profile.avatar) {
                // 1. Elmentj√ºk a mem√≥ri√°ba (LocalStorage)
                localStorage.setItem('mystigo_pref_teamAvatar', profile.avatar);
                
                // 2. Be√°ll√≠tjuk a nagy k√∂rt az emojira (AVATAR_ICONS mapping haszn√°lat√°val)
                if (previewContainer) {
                    previewContainer.textContent = AVATAR_ICONS[profile.avatar] || '‚ùì';
                }
                
                // 3. A rejtett select szinkronban tart√°sa (a j√°t√©k ind√≠t√°s√°hoz sz√ºks√©ges)
                if (avatarSelect) {
                    avatarSelect.innerHTML = `<option value="${profile.avatar}" selected>${profile.avatar}</option>`;
                }
            }
        });

    } else {
        // KIJELENTKEZ√âS KEZEL√âSE
        if (previewVerifiedBadge) previewVerifiedBadge.classList.remove('active');
        if (btnGroup) btnGroup.classList.remove('hidden');
        if (logoutBtn) logoutBtn.classList.add('hidden');
        if (scoreDisplay) scoreDisplay.classList.add('hidden');
        if (authUserName) authUserName.textContent = "";
        if (authStatusLabel) authStatusLabel.textContent = "Bejelentkez√©s";

        const savedName = localStorage.getItem('mystigo_pref_teamName');
        const savedAvatar = localStorage.getItem('mystigo_pref_teamAvatar');

        if (savedName) {
            if (teamInput) teamInput.value = savedName;
        } else {
            // HA NINCS MENTETT N√âV (Kijelentkez√©s ut√°n vagyunk), √úR√çTS√úNK!
            if (teamInput) teamInput.value = "";
        }

        if (savedAvatar) {
            if (typeof window.selectAvatar === 'function') {
                window.selectAvatar(savedAvatar);
            }
        } else {
            if (previewContainer) previewContainer.textContent = '‚ùì';
        }
    }
    // Az ellen≈ërz√©s futtat√°sa, hogy az "Ind√≠t√°s" gomb akt√≠v legyen, ha maradt bent n√©v
    setTimeout(() => {
        if (typeof window.updateInstantButtonEligibility === 'function') {
            window.updateInstantButtonEligibility();
        }
    }, 1000);
});

    } catch (error) { console.error("‚ùå Firebase inicializ√°l√°si hiba:", error); }




window.openAvatarSelector = function() {
    const grid = document.getElementById('avatar-grid');
    const currentKey = localStorage.getItem('mystigo_pref_teamAvatar');
    grid.innerHTML = ''; 

    // Eredeti elrendez√©s: 4 oszlop, alap√©rtelmezett t√©rk√∂z√∂k
    grid.className = "p-6 overflow-y-auto grid grid-cols-4 gap-4 bg-white";

    Object.keys(AVATAR_ICONS).forEach(key => {
        const char = AVATAR_ICONS[key];
        const isSelected = key === currentKey;
        
        const btn = document.createElement('button');
        // Vissza√°ll√≠tva az eredeti gomb st√≠lusra
        btn.className = `text-4xl p-2 rounded-2xl transition-all transform active:scale-90 border-2 ${isSelected ? 'border-brand-cyan bg-cyan-50' : 'border-transparent bg-gray-50'}`;
        btn.innerHTML = char;
        
        btn.onclick = () => {
            selectAvatar(key);
        };
        grid.appendChild(btn);
    });

    document.getElementById('avatar-selector-modal').classList.remove('hidden');
    document.getElementById('avatar-selector-modal').classList.add('flex');
};




window.closeAvatarSelector = function() {
    document.getElementById('avatar-selector-modal').classList.add('hidden');
    document.getElementById('avatar-selector-modal').classList.remove('flex');
};

window.selectAvatar = function(key) {
    const selectEl = document.getElementById('team-avatar-select');
    if (selectEl) {
        selectEl.innerHTML = `<option value="${key}" selected>${key}</option>`;
    }
    localStorage.setItem('mystigo_pref_teamAvatar', key);
    window.updateAvatarPreview(); 
    closeAvatarSelector();
window.updateInstantButtonEligibility();
};

// Az eredeti updateAvatarPreview m√≥dos√≠t√°sa
window.updateAvatarPreview = function() {
    const previewContainer = document.getElementById('avatar-preview-container');
    const savedAvatar = localStorage.getItem('mystigo_pref_teamAvatar');
    
    if (previewContainer && savedAvatar) {
        previewContainer.textContent = AVATAR_ICONS[savedAvatar] || '‚ùì';
    }
};


let html5QrCode = null;

window.openQrScanner = function() {
    // Ellen≈ërizz√ºk, hogy a feladat akt√≠v-e (z√≥n√°ban van-e a j√°t√©kos)
    const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
    if (!task || (!task.isTaskTimerActive && !appState.isTestModeEnabled)) {
        return showMessage('M√©g messze vagy', 'A QR olvas√≥ csak akkor haszn√°lhat√≥, ha m√°r a c√©lter√ºleten vagy!');
    }

    const modal = document.getElementById('qr-scanner-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // Inicializ√°ljuk az olvas√≥t
    html5QrCode = new Html5Qrcode("qr-reader");
    
    const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

    // Kamera ind√≠t√°sa (h√°ts√≥ kamera prefer√°l√°sa)
    html5QrCode.start(
        { facingMode: "environment" }, 
        qrConfig, 
        (decodedText) => {
            // SIKERES OLVAS√ÅS
            document.getElementById('answer-input').value = decodedText;
            playArrivalNotification(); // Hangjelz√©s
            closeQrScanner();
            
            // Opcion√°lis: Azonnali bek√ºld√©s beolvas√°s ut√°n
            setTimeout(() => { document.getElementById('submit-answer-btn').click(); }, 500);
        },
        (errorMessage) => {
            // Itt nem dobunk hib√°t, mert az olvas√≥ folyamatosan pr√≥b√°lkozik
        }
    ).catch((err) => {
        console.error("Kamera ind√≠t√°si hiba:", err);
        showMessage("Hiba", "Nem siker√ºlt el√©rni a kamer√°t. Ellen≈ërizd az enged√©lyeket!");
        closeQrScanner();
    });
};

window.closeQrScanner = function() {
    const modal = document.getElementById('qr-scanner-modal');
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }).catch(err => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
    } else {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
};



</script>



</body>
</html>