<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>MystiGo - V√°rosi Kalandj√°t√©k Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        // 1. Defini√°ld az alap√©rtelmezett beleegyez√©si √°llapotot a CMP k√≥dja el≈ëtt!
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('consent', 'default', {
            'ad_storage': 'denied', // Hirdet√©s t√°rol√°s tiltva
            'analytics_storage': 'denied', // Analitika t√°rol√°s tiltva
            'wait_for_update': 500 // 500 ms v√°rakoz√°s a CMP-re
        });
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1SBQQGDGL7"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'G-1SBQQGDGL7');
    </script>
    <script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"hu","siteId":2549400,"cookiePolicyId":40995967, "consentOnContinuedBrowsing": false, "callback": { onConsentGiven: function() { gtag('consent', 'update', { 'analytics_storage': 'granted', 'ad_storage': 'granted' }); }, onConsentRejected: function() { gtag('consent', 'update', { 'analytics_storage': 'denied', 'ad_storage': 'denied' }); }}};
    </script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/tcf/stub.js"></script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="utf-8"></script>
    <style>
        /* --- Arculat friss√≠tve a le√≠r√°s alapj√°n (t√ºrkiz, narancs, s√∂t√©tk√©k) --- */
        :root {
            --brand-cyan: #00CED1; /* T√ºrkiz */
            --brand-blue: #0D2B45; /* S√∂t√©tk√©k */
            --brand-orange: #FFA500; /* Narancs */
            --background-start: #E0F7FA;
            --background-end: #FFFFFF;
            --text-dark: #2D3748;
            --text-heading: var(--brand-blue);
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(180deg, var(--background-start) 0%, var(--background-end) 70%);
            overscroll-behavior-y: contain;
            touch-action: manipulation;
        }
        .main-button {
            background-color: var(--brand-orange);
            color: white;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .main-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .content-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
        }
        #map { 
            height: 200px; 
            width: 100%;
            border-radius: 1rem; 
            border: 3px solid #E0F7FA; 
        }
        .hidden { display: none !important; }

        .player-marker {
            background-color: var(--brand-orange);
            border: 2px solid white;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            box-shadow: 0 0 10px var(--brand-orange);
        }
        /* task-marker elt√°vol√≠tva, m√°r nem haszn√°ljuk */
        .modal-overlay { z-index: 2000; }
        .geofence-circle {
            animation: pulse 2s infinite;
        }
        
        /* Elt√°vol√≠tva a Leaflet alap√©rtelmezett sz√≠n fel√ºl√≠r√°sa a CSS-ben, hogy a JS vez√©relje azt */
        
        @keyframes pulse {
            0% { stroke-width: 2; opacity: 0.8; }
            70% { stroke-width: 4; opacity: 0.2; }
            100% { stroke-width: 2; opacity: 0.8; }
        }
        .text-brand-orange-500 { color: var(--brand-orange); } /* Seg√©doszt√°ly */
        .text-brand-cyan-500 { color: var(--brand-cyan); } /* Seg√©doszt√°ly */

        /* JAV√çT√ÅS: Fejl√©c √°llapotjelz≈ë m√©ret√©nek glob√°lis cs√∂kkent√©se (kisebb bet≈±/sz√°m a jobb elrendez√©s√©rt) */
        .game-status-bar {
            font-size: 0.75rem; /* text-xs - Kisebb bet≈±m√©ret */
        }
        .game-status-bar .flex {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }
        .game-status-bar .flex-col {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }

        /* Vizu√°lis visszajelz√©s a felhaszn√°lt, de √∫jra n√©zhet≈ë seg√≠ts√©gekre */
        button.used {
            background-color: #d1fae5; /* Z√∂ldes h√°tt√©r a megn√©zett seg√≠ts√©gre */
            color: #065f46; /* S√∂t√©tz√∂ld sz√∂veg */
            cursor: pointer;
            border: 1px solid #a7f3d0;
        }
        button.used:hover:not(:disabled) {
            background-color: #a7f3d0;
        }

        /* √ñsszecsukhat√≥ T√∂rt√©net doboz st√≠lusa */
        .story-details {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: #f7fafc;
            position: relative; /* Fontos a gomb abszol√∫t pozicion√°l√°s√°hoz */
        }
        .story-details summary {
            font-weight: 600;
            color: var(--brand-blue);
            cursor: pointer;
            outline: none;
            padding: 0.5rem 0;
            list-style: none; /* Elt√°vol√≠tja az alap√©rtelmezett nyilat */
            display: flex;
            align-items: center;
            position: relative; /* EZ BIZTOS√çTJA A GOMB FIX√ÅL√ÅS√ÅT A SUMMARY-N BEL√úL */
        }
        .story-details summary::-webkit-details-marker {
            display: none;
        }
        .story-details summary::before {
            content: '+';
            font-size: 1.25rem;
            margin-right: 0.5rem;
            transition: transform 0.2s;
            line-height: 0;
        }
        .story-details[open] summary::before {
            content: '-';
            transform: rotate(0deg);
        }
        .story-content {
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
            margin-top: 0.5rem;
        }
        /* Extra CSS a gomb garant√°lt megjelen√≠t√©s√©hez √©s poz√≠ci√≥j√°hoz (FELOLVAS√ì GOMB JAV√çT√ÅS) */
        #speak-story-btn {
            position: absolute;
            top: 50%; /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            transform: translateY(-50%); /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            right: 0.5rem; /* Be√°ll√≠tja a gomb v√≠zszintes helyzet√©t (bel√ºl) */
            display: flex !important; /* Er≈ësen kik√©nyszer√≠ti a l√°that√≥s√°got */
            width: 32px; /* Kisebb m√©ret */
            height: 32px; /* Kisebb m√©ret */
            align-items: center;
            justify-content: center;
            padding: 0.35rem; /* Kisebb padding */
        }
        
        /* Avat√°r ikonok CSS */
        .avatar-icon {
            display: inline-block;
            margin-right: 0.25rem;
            font-size: 1.25rem; /* text-xl */
            line-height: 1;
        }
        
        /* J√ÅT√âK K√ñZBENI FEJL√âC √âS STATUS BAR ST√çLUSAI */
        #game-header-logo-container {
            position: absolute;
            top: 0.5rem; 
            left: 1rem;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        /* LOG√ì M√âRET√âNEK DUPL√ÅZ√ÅSA (60px) */
        #game-header-logo {
            height: 60px; 
            width: auto;
        }
        
        /* √öJ KONT√âNER A K√ñZ√âPRE IGAZ√çTOTT CSAPATN√âVNEK √âS TESZT M√ìD INDIK√ÅTORNAK */
        #center-header-content {
            position: absolute;
            top: 2rem; 
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            width: 50%; 
            padding-top: 0.5rem;
        }
        #team-name-container {
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        
        /* AZ ID≈êZ√çT≈ê S√ÅV (STATUS BAR) LEJJEBB TOL√ÅSA */
        #game-status-bar {
             position: absolute;
             top: 5rem; /* Elegend≈ë hely a log√≥nak/csapatn√©vnek */
             left: 0;
             right: 0;
        }
        
        /* KIL√âP√âS GOMB EL≈êT√âRBE HOZ√ÅSA */
        #exit-game-btn {
            z-index: 1000;
            top: 1rem; 
        }

        /* Hiba bejelent√©s modal st√≠lusai */
        #report-error-modal {
            z-index: 9999; 
            background-color: rgba(0, 0, 0, 0.7);
        }
      


	 #report-error-modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 90%;
            width: 350px;
        }
        
        /* --- KALANDV√ÅLASZT√ì OLDAL FEJL√âC ST√çLUSAI (JAV√çTVA) --- */
        
        /* Oldals√≥ k√©pek m√©ret√©nek szab√°lyoz√°sa a Kalandv√°laszt√≥ oldalon */
        .side-header-asset-image {
            height: 50px; /* Kisebb m√©ret, hogy ne l√≥gjon bele (pl. 40px) */
            width: auto;
            margin: 0 2.5rem; /* Kisebb marg√≥ a log√≥t√≥l */
        }
        
        /* K√∂z√©ps≈ë log√≥ m√©ret√©nek kicsiny√≠t√©se a Kalandv√°laszt√≥ oldalon */
        #main-header-logo {
            max-width: 90px; /* Elegend≈ë helyet hagy az oldals√≥ k√©peknek √©s az alatta l√©v≈ë tartalomnak */
            height: auto;
        }
        
        /* --- LANDING PAGE (IND√çT√ì OLDAL) VISSZA√ÅLL√çTOTT ST√çLUSAI --- */
        #landing-page .w-full.h-\[20vh\] {
            height: 20vh; 
            padding-top: 2rem; 
        }
        
        /* Az SVG log√≥ eredeti m√©rete (a HTML-ben w-48) */
        #landing-page svg {
            width: 12rem; 
            height: auto;
        }
        /* Mivel a kor√°bbi k√≠s√©rletben beillesztett√ºk a #landing-logo-container-t, azt most elt√°vol√≠tjuk
           √©s vissza√°ll√≠tjuk az eredeti k√≥dot az ind√≠t√≥ oldalon. */
        
        /* √öJ CSS: T√©rk√©pes feladat v√°laszt√≥ marker EXPLORE m√≥dhoz */
        .task-selector-marker {
            background-color: var(--brand-cyan);
            border: 3px solid white;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            box-shadow: 0 0 10px var(--brand-cyan);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="max-w-md mx-auto h-[100dvh] flex flex-col relative transition-all duration-500">

        <main id="landing-page" class="flex flex-col items-center justify-between text-center text-brand-blue h-full p-8">
            
            <div class="w-full h-[15vh] flex flex-col items-center justify-start pt-2">
                <h1 id="landing-title" class="text-6xl font-extrabold tracking-tight" style="text-shadow: 0 4px 15px rgba(0,0,0,0.1);"><span id="logo-o" class="text-brand-orange-500 cursor-pointer"></span></h1>
                
            </div>
            
            <div class="w-full flex flex-col justify-start flex-grow"> 
                <p id="loading-status" class="text-gray-600 my-4 h-5">Adatb√°zis automatikus bet√∂lt√©se...</p>
                
                <label for="excel-file-input-manual" id="manual-file-select-label" class="main-button w-full text-sm block cursor-pointer my-4 !bg-brand-blue hover:!bg-cyan-700 hidden">
                    Manu√°lis J√°t√©kf√°jl Kiv√°laszt√°sa
                </label>
                <input type="file" id="excel-file-input-manual" class="hidden" accept=".xlsx,.txt,.db">
                <div id="game-order-setup" class="my-4 p-4 bg-gray-50 rounded-xl hidden"></div> 
                <div id="team-setup" class="mt-6 p-4 bg-gray-50 rounded-xl hidden"></div>
            </div>
            
            </main>
        
        <div id="content-wrapper" class="hidden absolute inset-0 transition-transform duration-500 translate-y-full">
            <div id="header" class="relative text-text-heading text-center pt-1 pb-16">
                 <div id="main-header">
   <div id="main-header-logo-row" class="flex justify-center items-center mb-2 px-4">
       
       <img id="left-asset" src="./MystiCat1.png" alt="Bal oldali ikon" class="side-header-asset-image"> 
       
       <img id="main-header-logo" src="./MystiGo_logo_cat.png" alt="MystiGo Log√≥" class="w-full max-w-xs mx-4">
       
       <img id="right-asset" src="./MystiCat2.png" alt="Jobb oldali ikon" class="side-header-asset-image">
       
   </div>
   <h1 id="page-title" class="text-sm font-bold tracking-wider">V√°lassz Kalandot</h1>
</div>
                 
                 <div id="game-header-logo-container" class="hidden">
                    <img id="game-header-logo" src="./MystiGo_logo_cat.png" alt="MystiGo Log√≥">
                 </div>
                 
                 <div id="center-header-content" class="hidden">
                     <div id="team-name-container" class="text-sm font-semibold text-brand-blue/80 block">
                        <span id="game-team-avatar-icon" class="avatar-icon"></span>
                        <span id="team-name-display"></span>
                     </div>
                     <span id="test-mode-indicator" class="text-xs font-bold text-brand-orange-500 hidden mt-1">TESZT M√ìD (NINCS GPS KORL√ÅTOZ√ÅS)</span>
                 </div>
                 
                 <div id="game-status-bar" class="hidden px-6">
                    <div class="bg-white/70 backdrop-blur-sm rounded-full flex justify-between items-center p-2 text-xs font-semibold shadow-sm">
                        <div class="px-3">Feladat: <span id="task-progress-display">1/10</span></div>
                        <div class="flex items-center gap-2">
                            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded-full text-brand-cyan-500">
                                <svg class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                <span id="timer-display">00:00</span>
                            </div>
                            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded-full text-green-600">
                                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                                <span id="geofence-timer-display">00:00</span>
                            </div>
                            <div class="flex items-center gap-1 bg-white px-2 py-0.5 rounded-full text-brand-orange-500">
                                <svg class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1-81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                <span id="score-display">0</span>
                            </div>
                        </div>
                    </div>
                 </div>
                 
                 <button id="exit-game-btn" onclick="showExitConfirmation()" class="absolute top-4 right-4 p-2 rounded-full bg-red-500 text-white shadow-lg hover:bg-red-600 transition hidden">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
                 
                 <svg class="absolute bottom-0 left-0 w-full" viewBox="0 0 1440 120" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1440 120H0V65.1721C0 65.1721 289.431 0 720 0C1150.57 0 1440 65.1721 1440 65.1721V120Z" fill="white"/></svg>
            </div>
            
            <div id="content-page-wrapper" class="absolute top-32 bottom-0 left-0 right-0 overflow-y-auto px-6 pb-6 bg-white">
                
                <section id="game-list-page" class="hidden">
                    <div id="game-list-controls" class="space-y-4 mb-6">
                        
                        
                        <div id="secret-switches-container" class="mt-4 p-4 bg-gray-50 rounded-xl hidden">
                            <h2 id="developer-tools-toggle" class="text-xs font-bold text-text-heading mb-3 cursor-pointer select-none flex justify-between items-center">
                                Fejleszt≈ëi Eszk√∂z√∂k
                                <span class="text-gray-50">‚ñº</span>
                            </h2>
                            <div id="developer-options" class="space-y-2 hidden">
                                <label for="excel-file-input" class="main-button w-full text-sm block cursor-pointer my-4 !bg-brand-blue hover:!bg-cyan-700">
                                     Manu√°lis J√°t√©kf√°jl Kiv√°laszt√°sa
                                </label>
                                <input type="file" id="excel-file-input" class="hidden" accept=".xlsx,.txt,.db">

                                <button onclick="window.open('MystiGo_game_creator.html', '_blank')" class="main-button w-full text-sm block !bg-blue-600 hover:!bg-blue-700 my-4">
                                     Game Creator (Megnyit√°s)
                                </button>
                                
                                <button onclick="loadLocalXlsx('games/games_full_kids.xlsx')" class="main-button w-full text-sm block !bg-red-600 hover:!bg-red-700 my-4">
                                     Teszt Adatb√°zis Bet√∂lt√©se (games_full_kids.xlsx)
                                </button>
                                
                                <fieldset id="game-mode-select-fieldset" class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                    <legend class="text-xs font-bold text-text-heading mb-2">J√°t√©k M√≥d V√°laszt√°sa:</legend>
                                    <div class="space-y-1">
                                        
                                        <label for="mode-normal" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-normal" name="game_mode_selection" value="normal" checked class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Norm√°l J√°t√©k (GPS sz√ºks√©ges)</span>
                                        </label>
                                        
                                        <label for="mode-test" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-test" name="game_mode_selection" value="test" class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Teszt M√≥d (Geo-fence kikapcsolva)</span>
                                        </label>
                                        
                                        <label for="mode-mock" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-mock" name="game_mode_selection" value="mock" class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Manu√°lis GPS (T√©rk√©pen kattint√°s)</span>
                                        </label></div>
                                </fieldset>
                                <div id="game-mode-settings" class="p-4 bg-gray-100 rounded-xl border border-gray-200 mt-4">
                                    <p class="text-sm font-semibold text-brand-blue mb-2">Feladatok √©s Sorrend</p>
                                    
                                    <select id="task-order-select" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm mb-3">
                                        <option value="sequential">Szekvenci√°lis (Sorban)</option>
                                        <option value="random">V√©letlenszer≈± (Random)</option>
					<option value="explore">Explore (√∂sszes pont l√°tszik)</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                        
                        <details id="game-type-explanation" class="story-details mb-4" style="background-color: #fefce8; border-color: #fde68a;">
    <summary style="font-weight: 800; color: var(--brand-blue); padding: 0.5rem; display: flex; align-items: center;">
        <span class="text-xl mr-2">‚ÑπÔ∏è</span> Hogyan m≈±k√∂dik a MystiGo?
        <span style="position: absolute; right: 0.75rem; top: 0.8rem; font-size: 1.5rem;"></span>
    </summary>
                            <div class="story-content" style="border-top: 1px solid #fde68a; margin-top: 0.5rem; padding-top: 0.5rem;">
                                
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p>üì± Telefon + GPS + internet sz√ºks√©ges</p>
                                   <p>üîã T√∂ltsd fel az akkut (vagy hozz powerbankot)</p>
                                   <p>üìç Menj a j√°t√©k kezd≈ëpontj√°ra ‚Äì ott indul el a j√°t√©k</p>
                                   <p>üó∫Ô∏è K√∂vesd a t√©rk√©pen a c√©lpontokat</p>
                                   <p>üß© A k√©rd√©s csak a helysz√≠nen jelenik meg</p>
 				   <p>‚≠ê Minden feladat 50 pontot √©r</p>
                                   <p>üí° K√©rhetsz 2 seg√≠ts√©get (‚àí10 / ‚àí20 pont) vagy megold√°st (0 pont)</p>
                                   <p>‚ùå Minden rossz v√°lasz: ‚àí1 pont</p>
                                   <p>‚è±Ô∏è K√©t id≈ëm√©r√©s:</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ K√©k = teljes j√°t√©kid≈ë</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ Z√∂ld = feladatra ford√≠tott id≈ë</p>
                                   <p>‚ö†Ô∏è Ha gond van az adott feladattal, haszn√°ld a ‚ÄûFeladat √°tugr√°sa‚Äù gombot</p>
                                </div>
                                
                                <h2 class="text-lg font-bold text-text-heading mt-4 mb-2">Kaland T√≠pusok Magyar√°zata</h2>
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p><strong>Normal üß≠:</strong> √Åltal√°nos kaland, feln≈ëtt/tin√©dzser (14+) j√°t√©kosoknak sz√°nt k√©rd√©sekkel √©s feladatokkal. A feladatok szekvenci√°lisan, sorban k√∂vetik egym√°st.</p>
                                    <p><strong>Kids üë∂:</strong> Kimondottan 6-10 √©ves gyerekeknek sz√≥l√≥, egyszer≈±bb k√©rd√©sek, a Mysti cica t√∂rt√©net√©vel f≈±szerezve. Szekvenci√°lis feladatok.</p>
                                    <p><strong>Team üßë‚Äçü§ù‚Äçüßë:</strong> Csapatj√°t√©kra optimaliz√°lt. A feladatok **v√°ltoz√≥ sorrendben** j√∂nnek egym√°s ut√°n, egyszerre tudnak indulni egy helyr≈ël a csapatok, √©s egy helyen v√©geznek a v√©g√©n.</p>
                                    <p><strong>Explore (Felfedez≈ë) üåç:</strong> A j√°t√©kos szabadon v√°laszt a t√©rk√©pen l√©v≈ë feladatok k√∂z√ºl. A c√©lpontok a j√°t√©k ind√≠t√°sa ut√°n egyszerre l√°that√≥k a t√©rk√©pen.</p>
                                </div>
                            </div>
                        </details>
                        <div id="team-setup" class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <h2 class="text-xl font-bold text-text-heading mb-3">N√©v Be√°ll√≠t√°s</p>
                            <input type="text" id="team-name-input" placeholder="N√©v" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm mb-2">
                            <select id="team-avatar-select" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm">
                                <option value="">V√°lassz Avatart (opcion√°lis)</option>
				    <option value="cat">Mysti üê±</option>
				    <option value="dog">Kutya üê∂</option>
				    <option value="panda">Panda üêº</option>
				    <option value="monkey">Majom üêµ</option>
				    <option value="detective">Nyomoz√≥ üïµÔ∏è</option>
				    <option value="explorer">Felfedez≈ë üß≠</option>
				    <option value="wizard">Var√°zsl√≥ üßô</option>
				    <option value="robot">Robot ü§ñ</option>
				    <option value="ghost">Szellem üëª</option>
				    <option value="lock">Lakat üîí</option>
				    <option value="magician">B≈±v√©sz üé©</option>
				    <option value="mask">√Ålarc üé≠</option>
				    <option value="fire">T≈±z üî•</option>
				    <option value="knight">Lovag ‚öîÔ∏è</option>
				    <option value="smile">Smile üòé</option>
				    <option value="zombie">Zombi üßü‚Äç‚ôÇÔ∏è</option>
				    <option value="ballerina">Belerina ü©∞</option>
				    <option value="police">Rend≈ër üöì</option>
				    <option value="firefighter">T≈±zolt√≥ üöí</option>
				    <option value="ambulance">Ment≈ë üöë</option>
				    <option value="star">Csillag ‚≠êÔ∏è</option>
				    <option value="floppy">Floppy üíæ</option>
			     </select>
         
               <button onclick="testGpsConnection()" class="w-full mt-3 py-2 bg-white border-2 border-gray-300 text-gray-600 hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
    GPS M≈±k√∂d√©s√©nek Tesztel√©se
</button>

			</div>
                        
                    </div>
                    
<div id="filter-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
    <h3 class="text-sm font-bold text-brand-blue mb-3 flex items-center">
        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
        Kaland Sz≈±r√©se
    </h3>
    <div class="grid grid-cols-2 gap-3">
        <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">Helysz√≠n</label>
            <select id="filter-location" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                <option value="all">√ñsszes Helysz√≠n</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">T√≠pus</label>
            <select id="filter-type" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                <option value="all">√ñsszes T√≠pus</option>
                <option value="normal">Normal üß≠</option>
                <option value="kids">Kids üë∂</option>
                <option value="team">Csapat üßë‚Äçü§ù‚Äçüßë</option>
                <option value="explore">Explore üåç</option>
            </select>
        </div>
    </div>
</div>


		<div id="game-list" class="space-y-6"></div>
                </section>
                
                <section id="game-page" class="hidden space-y-6">
                    <div class="content-card p-4">
                        <div id="map"></div>
                        
                        <div class="text-center mt-3 mb-2 flex justify-between items-center px-2">
                            <button id="google-maps-btn" class="text-xs text-brand-blue font-semibold hover:text-brand-cyan-500 transition flex items-center" onclick="startNavigation()">
                                <svg class="w-4 h-4 inline-block align-text-bottom mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-4.198 0-8 3.403-8 7.602 0 4.864 4.068 11.972 7.23 15.659.387.464.887.464 1.274 0 3.162-3.687 7.23-10.795 7.23-15.659 0-4.199-3.802-7.602-8-7-602zm0 10c-1.105 0-2-.896-2-2 0-1.105.895-2 2-2 1.104 0 2 .895 2 2 0 1.104-.896 2-2 2z"/></svg>
                                Navig√°l√°s
                            </button>
                            <p id="distance-info" class="text-center text-xs font-bold"></p>
                             <button id="report-error-btn" class="text-xs text-gray-500 font-semibold hover:text-red-500 transition" onclick="showReportModal()">
                                <svg class="w-4 h-4 inline-block align-text-bottom mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                Feladat √°tugr√°sa
                            </button>
                        </div>

	    <button id="back-to-map-btn" onclick="backToExploreMap()" class="hidden mb-4 text-xs font-bold text-gray-500 hover:text-brand-blue flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Vissza a t√©rk√©pre (K√©s≈ëbb oldom meg)
            </button>                        

                        <div id="start-task-button-container" class="mt-4 hidden">
                            <button id="start-game-btn" class="main-button w-full !text-lg !py-3 disabled:!bg-gray-400">
                                üöÄ Kaland Ind√≠t√°sa (Id≈ëm√©r√©s elindul)
                            </button>
                        </div>
                        <div id="explore-selection-container" class="mt-4 hidden text-center">
                            <h3 class="text-lg font-bold text-brand-blue mb-2">V√°lassz Feladatot a T√©rk√©pen!</h3>
                            <p class="text-sm text-gray-600 mb-4">Kattints egy k√©k markerre a k√∂vetkez≈ë c√©lpont kiv√°laszt√°s√°hoz.</p>
                        </div>
                        </div>
                    
                    <div id="task-interaction-area"> 
                        <div id="normal-task-content">
                            <div class="content-card p-5">
                                
				<details id="story-details" class="story-details mb-4" open>
                                    <summary>
                                        T√∂rt√©net Olvas√°sa
                                        <button id="speak-story-btn" onclick="speakStory(event)" class="p-1.5 rounded-full bg-red-500 text-white hover:bg-red-600 transition" title="Felolvas√°s ind√≠t√°sa">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 12c0 1.767-1.026 3.29-2.5 4v-8c1.474.71 2.5 2.233 2.5 4zM16 12c0 2.222-1.39 4.14-3.333 4.889l1.455 1.455c2.427-.99 4.344-3.13 4.344-6.344s-1.917-5.354-4.344-6.344l-1.455 1.455C14.61 7.86 16 9.778 16 12zM8 9H4v6h4l5 5V4l-5 5z"/></svg>
                                        </button>
                                    </summary>
                                    <div class="story-content">
                                        <p id="story" class="text-text-dark"></p>
                                    </div>
                                </details>
                                
                                 <p id="prompt" class="font-bold text-lg text-text-heading mb-4"></p>


                                 <div id="answer-input-container" class="flex items-center gap-2">
                                   <input type="text" id="answer-input" placeholder="√çrd be a megold√°st..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:bg-gray-100">
                                   <button id="submit-answer-btn" class="p-3 bg-cyan-500 text-white rounded-full shadow-lg hover:bg-cyan-600 transition flex-shrink-0"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button>
                                </div>
                                 <div id="hint-buttons-container" class="flex justify-center gap-2 mt-4 text-xs font-semibold">
                                    <button id="hint1-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full disabled:opacity-50">Seg√≠ts√©g 1 (Pont: -10)</button>
                                    <button id="hint2-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full disabled:opacity-50" disabled>Seg√≠ts√©g 2 (Pont: -20)</button>
                                    <button id="solution-btn" class="bg-red-100 text-red-700 px-3 py-1 rounded-full disabled:opacity-50" disabled>Megold√°s (Pont: 0)</button>
                                </div>
                                
                                <div style="height: 14rem;">¬†</div>
                            </div>
                        </div>

                        <div id="rescue-task-content" class="hidden"></div> 
                    </div>
                    </section>
                
                <section id="end-page" class="hidden space-y-6 text-center flex flex-col items-center pt-8">
                     <div id="pdf-content"> 
                        <div class="flex justify-center mb-6">
                             </div>
                        
                        <h2 class="text-4xl font-bold text-text-heading">Sz√©p munka!</h2>
                        <p class="text-lg text-text-dark mb-4">Teljes√≠tetted a kalandot.</p>
                        <p id="end-timestamp" class="text-sm text-gray-500 mb-6"></p> 
                        <div id="route-map" style="height: 300px; width: 100%; border-radius: 1rem; border: 3px solid #E0F7FA; margin: 20px 0;"></div> 
                        <p id="end-story" class="text-text-dark my-4 max-w-prose"></p>
<div class="relative my-10"> <div class="absolute inset-0 flex flex-col items-center justify-center text-brand-orange-500">
        <span class="text-5xl font-extrabold" id="final-score" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);"></span> <span class="text-base font-bold">PONT</span> </div>
</div>
<div class="mt-20 text-center space-y-4 p-6 w-full max-w-xs bg-gray-50 rounded-lg mx-auto shadow-md">
    <p class="text-lg font-bold text-text-heading mb-1">
        <span id="final-team-avatar-icon" class="avatar-icon"></span>
        N√©v: <span id="final-team-display"></span>
    </p> 
    <p class="block">Teljes Id≈ë: <strong id="final-time">00:00</strong></p> 
    <p class="block">Feladat Id≈ë: <strong id="final-geofence-time">00:00</strong></p>
</div>
                        <div class="flex justify-center mt-10">
                            </div>
                    </div> 

 <p class="text-xs text-gray-500 mb-2">K√ºldd el az eredm√©nyedet, ha szeretn√©l r√©sztvenni a j√°t√©kban  a <strong>mystigo.net@gmail.com</strong> c√≠mre!</p>
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                        <button onclick="sharePdfViaEmail()" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Eredm√©ny k√ºld√©se Emailben (PDF)">
    <svg class="w-8 h-8 text-brand-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
</button>
                    </div>

                    
                    <p class="text-sm text-gray-500 mb-4 mt-4 font-semibold">Oszd meg a teljes√≠t√©sed a k√∂z√∂ss√©gi m√©di√°n:</p>
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                        <button onclick="shareResult('facebook')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Facebookon">
                            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.35c0 .732.593 1.325 1.325 1.325h11.495v-9.294h-3.143v-3.626h3.143v-2.128c0-3.12 1.847-4.815 4.673-4.815 1.326 0 2.464.099 2.802.143v3.25l-1.921.001c-1.503 0-1.802.714-1.802 1.768v2.316h3.618l-.471 3.626h-3.147v9.294h6.115c.732 0 1.325-.593 1.325-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/></svg>
                        </button>
                        <button onclick="shareResult('system')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Instagramon/TikTokon/Egyebek">
                            <img src="social_share2.png" alt="√Åltal√°nos megoszt√°s" class="w-8 h-8">
                        </button>
                    </div>
<p></p>
<p></p>
                    <p class="text-sm text-gray-500 mb-4 mt-10">Amennyiben tetszett a j√°t√©k az al√°bbi lehet≈ës√©geken kereszt√ºl tudsz t√°mogatni minket:</p>

                    <div class="flex space-x-6 justify-center">
                            <a href="https://Revolut.Me/krisztwaeo" target="_blank" title="T√°mogat√°s Revoluton"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="./revolut.png" alt="Revolut Log√≥" class="w-8 h-8">
                            </a>
                            
                            <a href="https://paypal.me/mystigohu" target="_blank" title="T√°mogat√°s PayPalon"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="./paypal.png" alt="PayPal Log√≥" class="w-8 h-8">
                            </a>
                    </div>                    
                     <button onclick="downloadPDF()" class="main-button w-full max-w-xs !text-base mb-4 mt-6 hidden">Eredm√©ny let√∂lt√©se (PDF)</button>
                     
                     <a href="https://docs.google.com/forms/d/e/1FAIpQLScl1wQ2h7Gln_Pf9orPz2OnOz7Jridw7GWLALCTY9kkwDfflw/viewform?usp=dialog" 
    target="_blank" 
    class="main-button w-full max-w-xs !text-base hover:!bg-cyan-600 !text-white !font-extrabold mt-4 mb-4"
    style="background-color: var(--brand-cyan) !important;"
    title="√ârt√©keld a kalandot">
    K√©rlek, √âRT√âKELJ MINKET! ‚≠ê
</a>
                     <button id="download-story-pdf-btn" onclick="window.open('mese/Mysti_tortenete.pdf', '_blank')" class="main-button w-full !text-lg !py-3 !bg-brand-orange-500 hover:!bg-brand-orange mt-2">
    Mysti Cica Mese (PDF)
</button>
                     <button onclick="resetApp()" class="main-button w-full max-w-xs mt-auto !text-base">√öj Kaland</button>
                     
                     <div class="mt-4 p-2 text-center text-xs">
                        <a href="https://www.iubenda.com/privacy-policy/40995967" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Privacy Policy ">Adatv√©delmi Szab√°lyzat</a> | 
                        <a href="https://www.iubenda.com/privacy-policy/40995967/cookie-policy" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Cookie Policy ">Cookie Szab√°lyzat</a>
                    </div>
                    </section>
            </div>
        </div>
    </div>
    
    <div id="loading-overlay" class="modal-overlay fixed inset-0 bg-black/50 hidden items-center justify-center"><div class="w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin"></div></div>
    
    <div id="message-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 text-center max-w-sm w-full shadow-xl">
            <h2 id="message-title" class="text-xl font-bold text-text-heading mb-2"></h2>
            <p id="message-body" class="text-text-dark mb-6 whitespace-pre-wrap"></p>
            <div id="modal-button-container" class="flex gap-4">
                <button id="modal-ok-button" class="main-button flex-1 !text-base">Rendben</button>
                <button id="modal-cancel-button" class="main-button flex-1 !text-base !bg-gray-400 hover:!bg-gray-500 hidden">M√©gse</button>
            </div>
        </div>
    </div>

    <div id="report-error-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center p-4">
        <div id="report-error-modal-content" class="content-card p-5 bg-red-50 border-red-200 border">
            <h2 class="text-xl font-bold text-red-600 mb-2">Feladat √°tugr√°sa</h2>
            <p class="text-sm text-gray-700 mb-4">Amennyiben a helysz√≠n valami okb√≥l kifoly√≥lag nem el√©rhet≈ë, √°tugorhatod az adott feladatot. A feladat ebben az esetben *0 ponttal* teljes√≠tettnek min≈ës√ºl.</p>

            <div class="flex justify-between gap-4 mt-4">
                <button onclick="hideReportModal()" class="main-button flex-1 !text-sm !bg-gray-400 hover:!bg-gray-500">M√©gse</button>
                <button id="submit-error-report" onclick="handleSubmitError()" class="main-button flex-1 !text-sm !bg-red-600 hover:!bg-red-700">Igen szeretn√©m √°tugrani</button>
            </div>
        </div>
    </div>


<div id="report-error-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center p-4">
        <div id="report-error-modal-content" class="content-card p-5 bg-red-50 border-red-200 border">
             <div class="flex justify-between gap-4 mt-4">
                <button onclick="hideReportModal()" class="main-button flex-1 !text-sm !bg-gray-400 hover:!bg-gray-500">M√©gse</button>
                <button id="submit-error-report" onclick="handleSubmitError()" class="main-button flex-1 !text-sm !bg-red-600 hover:!bg-red-700">Igen szeretn√©m √°tugrani</button>
            </div>
        </div>
    </div>
    <div id="gps-help-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 9999;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-red-600 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    GPS Hiba / Be√°ll√≠t√°s
                </h2>
            </div>
            
            <p class="text-sm text-gray-700 mb-4 font-semibold">Nem siker√ºlt lek√©rni a pontos helyzeted. K√©rlek, ellen≈ërizd az al√°bbiakat:</p>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>üçé iPhone (iOS)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>Be√°ll√≠t√°sok > <strong>Adatv√©delem √©s biztons√°g</strong></li>
                    <li>Helymeghat√°roz√°s > <strong>Bekapcsolva</strong></li>
                    <li>Keresd meg a list√°ban a b√∂ng√©sz≈ët (Safari/Chrome)</li>
                    <li>V√°laszd: <strong>"Az alkalmaz√°s haszn√°lata k√∂zben"</strong></li>
                    <li>Kapcsold be: <strong>"Pontos helyzet"</strong></li>
                </ul>
            </div>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>ü§ñ Android (Samsung, Xiaomi, stb.)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>H√∫zd le az √©rtes√≠t√©si s√°vot √©s kapcsold be a <strong>Helyzet / GPS</strong> ikont.</li>
                    <li>Ha ez megvan: Chrome be√°ll√≠t√°sok > Webhelybe√°ll√≠t√°sok > Tart√≥zkod√°si hely. "A webhelyek lek√©rhetik az √ñn helyadatait" legyen bekapcsolva. A "Nincs enged√©lyezve" list√°ban ne legyen ott a https://mystigo.hu. Esetleg m√©g itt is ellen≈ërizd: Tartsd nyomva a Chrome ikont > App inf√≥ > Enged√©lyek > Hely > <strong>Enged√©lyez√©s</strong>.</li>
                </ul>
            </div>
    
            <button onclick="document.getElementById('gps-help-modal').classList.add('hidden')" class="main-button w-full !text-sm !py-3">√ârtem, megpr√≥b√°lom √∫jra</button>
        </div>
    </div>
       
<script>
        // --- GLOBAL STATE & CONSTANTS ---
        let games = {};
        // *** KONSTANSOK ***
        const GEOFENCE_DEFAULT_RADIUS = 20; 
        const DEFAULT_SCORE_PER_TASK = 50; 
        const HINT1_PENALTY = 10; 
        const HINT2_PENALTY = 20; 
        const WRONG_ANSWER_PENALTY = 1; 
        const RESCUE_TASK_CORRECT_ANSWER = '4'; 
        const RESCUE_TASK_SCORE = 0; 
        
        const LOCAL_STORAGE_PREFIX = 'MystiGoGameState_'; 
        const DEFAULT_GAME_FILE = 'games/games_free_kids.xlsx'; 

        const AVATAR_ICONS = {
            cat: 'üê±',dog: 'üê∂',panda: 'üêº',monkey: 'üêµ', detective: 'üïµÔ∏è', explorer: 'üß≠', wizard: 'üßô', robot: 'ü§ñ',
            ghost: 'üëª', lock: 'üîí', magician: 'üé©', mask: 'üé≠', fire: 'üî•', knight: '‚öîÔ∏è',smile: 'üòé',zombie: 'üßü‚Äç‚ôÇÔ∏è',ballerina: 'ü©∞',police: 'üöì',firefighter: 'üöí',ambulance: 'üöë',star: '‚≠êÔ∏è',floppy: 'üíæ',
        };

        let appState = {};
        let modalCloseCallback = null;
        let manualMarker = null; 
        let speechSynth = window.speechSynthesis; 

        function initializeState() {
            appState = { 
                currentPage: 'landing-page', 
                selectedGameId: null, 
                currentGame: null, 
                currentTaskIndex: 0, 
                score: 0, 
                timerInterval: null, 
                geofenceTimerInterval: null, 
                startTime: null, 
                map: null, 
                playerMarker: null, 
                taskMarker: null, 
                geofenceCircle: null, 
                userPosition: null, 
                geoWatchId: null, 
                isInZone: false, 
                isTestModeEnabled: false, 
                isManualMock: false, 
                teamName: null, 
                teamAvatar: null, 
                taskOrder: 'sequential', 
                totalTime: 0, 
                geofenceTime: 0, 
                isTimerRunning: false, 
                routeCoordinates: [],
                completedTasks: [], 
                availableTasks: [], 
                taskMarkers: {},
		        lastAutoZoomTime: 0
            };
        }

        // --- LOCAL STORAGE LOGIC ---
        function getStorageKey(gameId) {
            return LOCAL_STORAGE_PREFIX + gameId;
        }

        function saveGameState() {
            if (!appState.currentGame) return;

            const stateToSave = {
                gameId: appState.currentGame.id, 
                currentTaskIndex: appState.currentTaskIndex,
                score: appState.score,
                totalTime: appState.totalTime,
                geofenceTime: appState.geofenceTime,
                isTimerRunning: appState.isTimerRunning,
                teamName: appState.teamName,
                teamAvatar: appState.teamAvatar,
                isTestModeEnabled: appState.isTestModeEnabled,
                isManualMock: appState.isManualMock,
                routeCoordinates: appState.routeCoordinates,
                completedTasks: appState.completedTasks,
                availableTasks: appState.availableTasks,
                taskOrder: appState.taskOrder,
                tasks: appState.currentGame.tasks 
            };
            
            try {
                localStorage.setItem(getStorageKey(appState.currentGame.id), JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Hiba az √°llapot ment√©sekor:", e);
            }
        }

        function loadGameById(gameId) {
            try {
                const savedStateJson = localStorage.getItem(getStorageKey(gameId));
                if (!savedStateJson) return false;

                const state = JSON.parse(savedStateJson);
                if (!state.gameId || state.gameId !== gameId) return false;

                appState.currentGame = JSON.parse(JSON.stringify(games[gameId]));
                
                appState.currentTaskIndex = state.currentTaskIndex;
                appState.score = state.score;
                appState.totalTime = state.totalTime;
                appState.geofenceTime = state.geofenceTime;
                appState.isTimerRunning = state.isTimerRunning;
                appState.teamName = state.teamName;
                appState.teamAvatar = state.teamAvatar;
                appState.isTestModeEnabled = state.isTestModeEnabled;
                appState.isManualMock = state.isManualMock;
                appState.routeCoordinates = state.routeCoordinates || [];
                appState.completedTasks = state.completedTasks || [];
                appState.availableTasks = state.availableTasks || [];
                
                // TaskOrder helyre√°ll√≠t√°sa
                appState.taskOrder = state.taskOrder;
                if (appState.currentGame) {
                    appState.currentGame.taskOrder = state.taskOrder;
                }
                
                if (state.tasks) {
                    appState.currentGame.tasks = state.tasks;
                }

                showPage('game-page');
                
                setTimeout(() => {
                    initializeMap();
                    
                    if(appState.isManualMock) {
                        toggleMapClickMock(true);
                    } else {
                        if (manualMarker) { manualMarker.remove(); manualMarker = null; }
                        watchPosition(); 
                    }
                    
                    updateStatusDisplays();
                    
                    if (appState.isTimerRunning) {
                        appState.timerInterval = setInterval(updateTimer, 1000);
                        lastTimeUpdate = new Date().getTime(); 
                    }
                    
                    if (appState.currentGame.taskOrder === 'explore') {
                         if (appState.currentTaskIndex === 0 && appState.isTimerRunning) {
                             showTaskSelectionMap();
                             showMessage("Visszat√©r√©s", `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik a t√©rk√©pes v√°laszt√≥n√°l.`);
                             return true; 
                         }
                    } 
                    
                    loadTask(appState.currentTaskIndex); 
                    
                    let msg = `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik.`;
                    showMessage("Folytat√°s", msg, null);

                }, 100);

                return true;

            } catch (e) {
                console.error("Hiba az √°llapot bet√∂lt√©sekor:", e);
                return false;
            }
        }

        function deleteSavedGame(gameId) {
            localStorage.removeItem(getStorageKey(gameId));
            renderGameList(); 
        }
        
        async function loadLocalXlsx(filePath) {
            showLoading(true);
            document.getElementById('loading-status').textContent = `Adatb√°zis bet√∂lt√©se (${filePath})...`;
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`Hiba: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const wb = XLSX.read(data, {type:'array'}); 
                processExcelData(wb); 
            } catch (error) {
                document.getElementById('landing-page').classList.remove('hidden');
                document.getElementById('content-wrapper').classList.add('hidden'); 
                document.getElementById('loading-status').textContent = `Bet√∂lt√©s sikertelen. (${error.message})`;
                const manualInputLabel = document.getElementById('manual-file-select-label');
                if (manualInputLabel) manualInputLabel.classList.remove('hidden');
                showLoading(false);
            }
        }

        // --- I18N ---
        const I18N = { 
            hu: { 
                correct_title: 'Helyes!', 
                correct_body: `√úgyes vagy! (+${DEFAULT_SCORE_PER_TASK} pont)`, 
                wrong_title: 'Sajnos nem j√≥.', 
                wrong_body: `Pr√≥b√°ld √∫jra! Rossz v√°lasz: -${WRONG_ANSWER_PENALTY} pont.`, 
                far_title: 'M√©g messze vagy', 
                far_body: 'L√©pj be a z√≥n√°ba a megold√°s bek√ºld√©s√©hez, vagy a seg√≠ts√©g k√©r√©s√©hez!', 
                in_zone: 'A c√©lter√ºleten vagy!', 
                out_zone: (m) => `M√©g kb. ${m} m√©terre vagy a c√©lt√≥l.`, 
                hint1_body: (h) => `1. Seg√≠ts√©g (-${HINT1_PENALTY} pont): ${h} `, 
                hint2_body: (h) => `2. Seg√≠ts√©g (-${HINT2_PENALTY} pont): ${h} `, 
                rescue_correct: `Megker√ºl≈ë sikeres! (+${RESCUE_TASK_SCORE} pont)`, 
                rescue_wrong: 'Megker√ºl≈ë hib√°s. Pr√≥b√°ld √∫jra!', 
                gps_required: 'K√©rj√ºk, enged√©lyezd a GPS-t az eszk√∂z√∂d√∂n a kaland elind√≠t√°s√°hoz. Normal m√≥dban a j√°t√©k csak m≈±k√∂d≈ë GPS-szel indul el.' 
            } 
        };
        const t = (key, ...args) => I18N.hu[key] ? (typeof I18N.hu[key] === 'function' ? I18N.hu[key](...args) : I18N.hu[key]) : key;

 // --- PDF GENERATION (Avatarral kieg√©sz√≠tve) ---
        function downloadPDF() {
            const element = document.getElementById('pdf-content');
            if (!element) return;
            
            const originalStyle = element.style.cssText;
            element.style.padding = '20px'; 
            element.style.backgroundColor = '#ffffff';

            const now = new Date();
            // D√°tum √©s id≈ë komponensek
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0'); 

            // √ñsszef≈±z√©s: √â√â√â√â-HH-NN_√ì√ì-PP-MP form√°tumban
            const fileNameTimestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
            
            // Biztons√°gos csapatn√©v lek√©r√©s
            const safeTeamName = (appState && appState.teamName) ? appState.teamName : 'n√©v';
            
            // --- √öJ R√âSZ: Avatar lek√©r√©se ---
            // Ha van kiv√°lasztott avatar, azt haszn√°lja, ha nincs, akkor 'nincs-avatar'
            const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';

            // --- M√ìDOS√çTOTT F√ÅJLN√âV ---
            // Beillesztett√ºk a safeAvatar v√°ltoz√≥t a n√©vbe
            const fileName = `MystiGo_Eredm√©ny_${safeTeamName}_${safeAvatar}_${fileNameTimestamp}.pdf`;

            // 3 m√°sodperc v√°rakoz√°s a t√©rk√©p renderel√©sre, ut√°na ment√©s
            setTimeout(() => {
                html2pdf().from(element).set({
                    margin: 10, 
                    filename: fileName, 
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: false, useCORS: true, scrollY: 0, windowWidth: document.documentElement.offsetWidth },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save().then(() => {
                    element.style.cssText = originalStyle;
                }).catch(err => {
                    console.error("PDF gener√°l√°si hiba:", err);
                    element.style.cssText = originalStyle;
                });
            }, 3000); 
        }


async function sharePdfViaEmail() {
    // 1. Elemek √©s st√≠lusok el≈ëk√©sz√≠t√©se
    const element = document.getElementById('pdf-content');
    const originalStyle = element.style.cssText;
    element.style.padding = '20px';
    element.style.backgroundColor = '#ffffff';
    
    // --- F√ÅJLN√âV GENER√ÅL√ÅS KEZDETE ---
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const timeStr = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
    
    // Itt f≈±zz√ºk √∂ssze a d√°tumot √âS az id≈ët
    const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';
    const fileName = `Jatek_Eredmeny_${appState.teamName || 'Csapat'}_${safeAvatar}_${dateStr}_${timeStr}.pdf`;
    // --- F√ÅJLN√âV GENER√ÅL√ÅS V√âGE ---

    // Debug: Ki√≠rjuk a konzolra √©s egy alertben is, hogy l√°sd, t√©nyleg az √∫j k√≥d fut-e
    console.log("Tervezett f√°jln√©v:", fileName);
    // alert("F√°jln√©v teszt: " + fileName); // Ezt a sort kiveheted, ha m√°r m≈±k√∂dik

    showLoading(true); 

    try {
        // 2. PDF gener√°l√°sa Blob-k√©nt
        const pdfBlob = await html2pdf().from(element).set({
            margin: 10,
            filename: fileName, // Itt haszn√°ljuk a fenti v√°ltoz√≥t
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).output('blob');

        // 3. F√°jl objektum l√©trehoz√°sa
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

        // 4. St√≠lusok vissza√°ll√≠t√°sa
        element.style.cssText = originalStyle;
        showLoading(false);

        // 5. Megoszt√°s
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'J√°t√©k Eredm√©ny',
                    text: `Sziasztok! Itt van a J√°t√©kom eredm√©nye. Csapat: ${appState.teamName || 'N√©vtelen'}`
                });
            } catch (error) {
                if (error.name !== 'AbortError') console.error(error);
            }
        } else {
            // Fallback let√∂lt√©s
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            alert('A PDF let√∂lt√©sre ker√ºlt (megoszt√°s nem t√°mogatott).');
        }

    } catch (err) {
        console.error("Hiba:", err);
        element.style.cssText = originalStyle;
        showLoading(false);
    }
}




        // --- CORE APP & PAGE LOGIC ---
        function showPage(pageId) {
            // --- GA4 Virtual Pageview ---
    if (typeof gtag === 'function') {
        gtag('event', 'page_view', {
            'page_title': pageId,
            'page_location': window.location.href + '#' + pageId
        });
    }
	    const landingPage = document.getElementById('landing-page');
            const contentWrapper = document.getElementById('content-wrapper');
            
            if (pageId === 'landing-page') {
                landingPage.classList.remove('hidden');
                contentWrapper.classList.add('translate-y-full');
            } else {
                landingPage.classList.add('hidden');
                contentWrapper.classList.remove('hidden');
                setTimeout(() => contentWrapper.classList.remove('translate-y-full'), 10);
                showContentPage(pageId);
            }
        }

        function showContentPage(pageId) {
            document.querySelectorAll('#content-wrapper section').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            const contentWrapper = document.getElementById('content-page-wrapper');
            if (contentWrapper) contentWrapper.scrollTo({ top: 0, behavior: 'instant' });

            const mainHeader = document.getElementById('main-header');
            const statusBar = document.getElementById('game-status-bar');
            const exitButton = document.getElementById('exit-game-btn'); 
            const gameHeaderLogoContainer = document.getElementById('game-header-logo-container');
            const centerHeaderContent = document.getElementById('center-header-content');
            const teamNameContainer = document.getElementById('team-name-container');
            const teamNameDisplay = document.getElementById('team-name-display');
            const teamAvatarIcon = document.getElementById('game-team-avatar-icon'); 
            const testModeIndicator = document.getElementById('test-mode-indicator');
            const mainHeaderLogoRow = document.getElementById('main-header-logo-row'); 
            
            if (pageId === 'game-page') {
                mainHeader.classList.add('hidden');
                statusBar.classList.remove('hidden');
                exitButton.classList.remove('hidden'); 
                gameHeaderLogoContainer.classList.remove('hidden');
                centerHeaderContent.classList.remove('hidden');
                testModeIndicator.classList.toggle('hidden', !appState.isTestModeEnabled);
                
                if (appState.teamName) {
                    const avatarIcon = AVATAR_ICONS[appState.teamAvatar] || '';
                    teamAvatarIcon.textContent = avatarIcon; 
                    teamNameDisplay.textContent = appState.teamName; 
                    teamNameContainer.classList.remove('hidden');
                } else {
                    teamNameContainer.classList.add('hidden');
                }
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.add('hidden');
            } else {
                mainHeader.classList.remove('hidden');
                statusBar.classList.add('hidden');
                exitButton.classList.add('hidden'); 
                gameHeaderLogoContainer.classList.add('hidden');
                centerHeaderContent.classList.add('hidden');
                testModeIndicator.classList.add('hidden');
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.remove('hidden');
                
                const titles = { 'game-list-page': 'V√°lassz Kalandot', 'end-page': 'J√°t√©k V√©ge' };
                document.getElementById('page-title').textContent = titles[pageId] || 'MystiGo';
                
                if (pageId === 'game-list-page') {
                     if (Object.keys(games).length > 0) renderGameList();
                     if (Object.keys(games).length > 0) document.getElementById('team-setup').classList.remove('hidden');
                } else {
                     document.getElementById('secret-switches-container').classList.add('hidden');
                }
            }
            
            if (pageId === 'game-list-page') {
                const titleEl = document.getElementById('page-title');
                titleEl.textContent = 'V√°lassz Kalandot';
                const secretTrigger = document.createElement('span');
                secretTrigger.id = 'secret-trigger';
                secretTrigger.className = 'text-brand-orange-500 cursor-pointer ml-1 font-extrabold';
                secretTrigger.textContent = '!';
                if (titleEl) titleEl.appendChild(secretTrigger);
            }
        }

        function resetApp() {
            if (speechSynth.speaking) speechSynth.cancel();
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            if (appState.timerInterval) clearInterval(appState.timerInterval);
            if (appState.geofenceTimerInterval) clearInterval(appState.geofenceTimerInterval);
            
            if (appState.map) { 
                toggleMapClickMock(false); 
                appState.map.remove(); appState.map = null; 
            }
            if (manualMarker) { manualMarker.remove(); manualMarker = null; } 
            
            document.getElementById('developer-options').classList.add('hidden');
            document.getElementById('secret-switches-container').classList.add('hidden');

            initializeState();
            
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('content-wrapper').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.remove('translate-y-full');

            loadLocalXlsx(DEFAULT_GAME_FILE);
            showPage('game-list-page'); 
        }

        const showLoading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        
        function showMessage(title, body, onClose, showCancel = false) {
            // --- iPad / Mobil FIX KEZDIDE ---
    		        // 1. Ha nyitva a billenty≈±zet (mert a beviteli mez≈ën van a f√≥kusz), bez√°rjuk
 		           if (document.activeElement instanceof HTMLElement) {
 		               document.activeElement.blur();
     		       }
            
       			     // 2. Azonnal a tartalom tetej√©re g√∂rget√ºnk, hogy az ablak biztosan l√°that√≥ legyen
	              window.scrollTo(0, 0);
   				         const contentWrapper = document.getElementById('content-page-wrapper');
 				           if (contentWrapper) {
 			               contentWrapper.scrollTo({ top: 0, behavior: 'instant' });
    				        }
          				  // --- iPad / Mobil FIX V√âGE ---
	    document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').innerHTML = DOMPurify.sanitize(body, { ADD_ATTR: ['style'], ADD_TAGS: ['strong', 'em', 'p', 'br'] }); 
            const okButton = document.getElementById('modal-ok-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            okButton.textContent = 'Rendben';
            cancelButton.classList.add('hidden');

            if (showCancel) {
                okButton.textContent = 'Igen'; cancelButton.textContent = 'Nem'; cancelButton.classList.remove('hidden');
                okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
                cancelButton.onclick = hideMessage; 
            } else {
                 okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
            }
            modalCloseCallback = null; 
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function hideMessage() { 
            document.getElementById('message-modal').classList.add('hidden');
            if(typeof modalCloseCallback === 'function') { modalCloseCallback(); modalCloseCallback = null; }
            document.getElementById('modal-ok-button').onclick = hideMessage;
        }
        
        function showReportModal() {
            if (!appState.currentGame) return;
            checkGeofence();
            document.getElementById('report-error-modal').classList.remove('hidden');
            document.getElementById('error-description-input').value = '';
        }

        function hideReportModal() { document.getElementById('report-error-modal').classList.add('hidden'); }

        function handleSubmitError() {
    if (!appState.currentGame) return;
    const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex); 
    if (!currentTask) return;

    // --- M√ìDOS√çT√ÅS KEZDETE ---
    // Ha a 0. feladatot (Start pont) ugorjuk √°t, akkor el kell ind√≠tani a rendszert!
    if (currentTask.index === 0) {
        // Ez a f√ºggv√©ny elind√≠tja az id≈ët, a GPS r√∂gz√≠t√©st, √©s bet√∂lti a k√∂vetkez≈ë feladatot (Task 1)
        startTimersAndGPS();
        
        hideReportModal();
        
        // Jelz√ºnk a felhaszn√°l√≥nak, de NEM h√≠vjuk meg a handleCorrectAnswer-t,
        // mert a startTimersAndGPS() m√°r elv√©gezte a lapoz√°st.
        showMessage("J√°t√©k Elind√≠tva", "A kezd≈ëpontot √°tugrottad. A j√°t√©k √©s az id≈ëm√©r√©s elindult!", null);
        return; 
    }
    // --- M√ìDOS√çT√ÅS V√âGE ---

    // Ez marad a r√©gi a t√∂bbi feladathoz:
    currentTask.taskScore = 0; 
    updateStatusDisplays(); hideReportModal();
    showMessage("√Åtugorva", "A feladatot teljes√≠tettnek jel√∂lt√ºk (0 pont). A j√°t√©k folytat√≥dik.", () => { handleCorrectAnswer(); });
}
        
        function handleExitGame() { resetApp(); }

        function showExitConfirmation() {
            showMessage('Kil√©p√©s', 'Biztosan vissza l√©psz a f≈ëmen√ºbe? A j√°t√©k √°ll√°sa elment√©sre ker√ºl.', handleExitGame, true);
        }

        // --- DATA PROCESSING ---
        function assertCols(obj, req, ctx) {
            const missing = req.filter(k => !(k in obj) || obj[k] === null || String(obj[k]).trim() === '');
            if (missing.length > 0) throw new Error(`'${ctx}' munkalap hiba: A(z) ${missing.map(m => `"${m}"`).join(', ')} mez≈ë(k) hi√°nyzik/√ºres.`);
        }

        function processExcelData(workbook) {
            try {
                const gamesSheet = workbook.Sheets['games'], tasksSheet = workbook.Sheets['tasks'];
                if (!gamesSheet || !tasksSheet) throw new Error("A 'games' vagy 'tasks' munkalap hi√°nyzik.");
                const parsedGames = XLSX.utils.sheet_to_json(gamesSheet);
                const parsedTasks = XLSX.utils.sheet_to_json(tasksSheet);
                const combinedGames = {};
                parsedGames.forEach(game => {
                    assertCols(game, ['id', 'title', 'type', 'startLocationLat', 'startLocationLng'], 'games');
                    const lat = parseFloat(game.startLocationLat), lng = parseFloat(game.startLocationLng);
                    combinedGames[game.id] = { 
                        ...game, type: String(game.type || 'normal').trim().toLowerCase(), 
                        price: parseFloat(game.price || 0), description: DOMPurify.sanitize(game.description || ''), 
                        endStory: DOMPurify.sanitize(game.endStory || ''), startLocation: { lat, lng }, tasks: [] 
                    };
                });
                parsedTasks.forEach(task => {
                    if (!combinedGames[task.gameId]) return;
                    const lat = parseFloat(task.locationLat), lng = parseFloat(task.locationLng);
                    
                    let allSolutions = [];
                    if (task.solution) allSolutions.push(...String(task.solution).split(';').map(s => s.trim()));
                    if (task.accepted_answers) allSolutions.push(...String(task.accepted_answers).split(';').map(s => s.trim()));
                    if (task.synonyms) allSolutions.push(...String(task.synonyms).split(';').map(s => s.trim()));
                    const acceptedAnswers = Array.from(new Set(allSolutions.filter(Boolean).map(a => normalizeAnswer(a))));
                    
                    combinedGames[task.gameId].tasks.push({ 
                        ...task, index: parseInt(task.index, 10), isStartTask: false, 
                        story: DOMPurify.sanitize(task.story || ''), location: { lat, lng }, 
                        geofenceRadius: parseFloat(task.geofenceRadius || GEOFENCE_DEFAULT_RADIUS), 
                        hints: [task.hint1, task.hint2].filter(Boolean).map(h => DOMPurify.sanitize(h)), 
                        solution: String(task.solution || ''), acceptedAnswers: acceptedAnswers,
		disableSolution: (task.disableSolution == 1 || String(task.disableSolution).toLowerCase() === 'true'), 
                        hintsUsed: 0, timeSpent: 0, taskScore: 0, isTaskTimerActive: false 
                    }); 
                });

                const validatedGames = {};
                for (const gameId in combinedGames) {
                    const game = combinedGames[gameId];
                    if (!['normal', 'kids', 'team', 'explore'].includes(game.type)) continue;
                    if (game.tasks.length === 0) continue;
                    game.tasks.sort((a, b) => a.index - b.index);
                    validatedGames[gameId] = game;
                }
                games = validatedGames;
                renderGameList();
                showLoading(false);
                showPage('game-list-page');
            } catch (error) {
                showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                showLoading(false);
            }
        }
        
        // --- UI RENDERING ---
        function renderGameList(gamesToRender = null) {
            const listEl = document.getElementById('game-list');
            listEl.innerHTML = '';
            
            // Itt d√∂ntj√ºk el, hogy a sz≈±rt vagy az eredeti list√°t mutatjuk
            const sourceData = gamesToRender || games;

            // Ha nincs tal√°lat
            if (Object.keys(sourceData).length === 0) {
                 listEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-gray-500 font-semibold">Nincs a sz≈±r√©snek megfelel≈ë j√°t√©k.</p>
                    <button onclick="resetFilters()" class="text-brand-blue underline mt-2 text-sm">Sz≈±r≈ëk t√∂rl√©se</button>
                 </div>`; 
                 return;
            }
            
            // Ha ez az els≈ë bet√∂lt√©s (nincs sz≈±r≈ë megadva), t√∂lts√ºk fel a helysz√≠n list√°t
            if (!gamesToRender) {
                populateLocationFilter();
            }
            
            Object.values(sourceData).forEach(game => {
                const placeholderImage = `https://placehold.co/600x300/${game.type === 'kids' ? 'FFF8E1' : 'E0F7FA'}/${game.type === 'kids' ? 'F57C00' : '0A2B4C'}?text=${encodeURIComponent(game.title)}`;
                let gameTypeBadge = '';
                if (game.type === 'kids') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-0.5 text-xs font-medium text-yellow-800">Kids Edition üë∂</span>`;
                else if (game.type === 'team') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-indigo-100 px-3 py-0.5 text-xs font-medium text-indigo-800">Csapat Verseny üßë‚Äçü§ù‚Äçüßë</span>`;
                else if (game.type === 'explore') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-cyan-100 px-3 py-0.5 text-xs font-medium text-cyan-800">Explore (Felfedez≈ë) üåç</span>`;
                else gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-green-100 px-3 py-0.5 text-xs font-medium text-green-800">Normal üß≠</span>`;

                const priceText = game.price > 0 ? `${game.price.toLocaleString('hu-HU')} Ft` : 'Ingyenes';
                const gameTitleForMessage = game.title.replace(/'/g, "\\'");
                
                const hasSave = localStorage.getItem(getStorageKey(game.id)) !== null;
                
                let saveIndicator = "";
                let cardBorder = "";
                
                if (hasSave) {
                    saveIndicator = `<div class="bg-brand-orange text-white text-xs font-bold px-2 py-1 rounded absolute top-2 right-2 shadow-md">MENTVE</div>`;
                    cardBorder = "border-2 border-brand-orange";
                }

                let deleteButtonHtml = "";
                if (hasSave) {
                    deleteButtonHtml = `
                        <button onclick="event.stopPropagation(); deleteSavedGame('${game.id}');" class="absolute top-2 left-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 shadow-md z-10" title="√öjrakezd√©s (Ment√©s t√∂rl√©se)">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                }

                const locationBadge = game.location ? `<span class="text-xs text-gray-500 font-semibold flex items-center mt-1"><svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${game.location}</span>` : '';

                listEl.innerHTML += `
                    <div class="content-card overflow-hidden cursor-pointer hover:shadow-xl transition-shadow relative ${cardBorder}" 
                         onclick="handleGameSelect('${game.id}', '${gameTitleForMessage}', '${game.type}', '${priceText}', ${hasSave})">
                        ${saveIndicator}
                        ${deleteButtonHtml}
                        <img src="${game.imageUrl || placeholderImage}" alt="${game.title}" class="h-40 w-full object-cover" onerror="this.onerror=null;this.src='${placeholderImage}';">
                        <div class="p-5">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-text-heading">${game.title}</h3>
                                ${gameTypeBadge}
                            </div>
                            ${locationBadge}
                            <p class="text-text-dark mt-1 text-sm">${game.description || 'Nincs le√≠r√°s megadva.'}</p>
                            <p class="text-xs font-semibold mt-3 text-brand-orange-500">${priceText}</p>
                            ${hasSave ? '<p class="text-xs font-bold text-green-600 mt-2">Kattints a folytat√°shoz!</p>' : ''}
                        </div>
                    </div>`;
            });
        }
  
// --- √öJ SZ≈∞R≈ê F√úGGV√âNYEK ---
       function populateLocationFilter() {
            const locationSelect = document.getElementById('filter-location');
            if (!locationSelect) return;

            // Megjegyezz√ºk, mi volt kiv√°lasztva, hogy ne ugorjon vissza
            const currentValue = locationSelect.value;
            const locations = new Set();
            
            Object.values(games).forEach(game => {
                // Biztons√°gos sz√∂vegg√© alak√≠t√°s (hogy ne legyen .split hiba)
                const rawLocation = String(game.location || "");

                if (rawLocation && rawLocation !== 'Egy√©b' && rawLocation !== 'undefined') {
                    // ITT T√ñRT√âNIK A VAR√ÅZSLAT:
                    // 1. split(','): Sz√©tv√°gjuk a vessz≈ëkn√©l
                    // 2. forEach: Minden darabon v√©gigmegy√ºnk
                    const parts = rawLocation.split(','); 
                    
                    parts.forEach(part => {
                        // trim(): Lev√°gjuk a felesleges sz√≥k√∂z√∂ket az elej√©r≈ël/v√©g√©r≈ël
                        const cleanLoc = part.trim();
                        // Ha maradt sz√∂veg, hozz√°adjuk a list√°hoz
                        if (cleanLoc) locations.add(cleanLoc);
                    });
                }
            });

            // Opci√≥k √∫jra√©p√≠t√©se ABC sorrendben
            locationSelect.innerHTML = '<option value="all">√ñsszes Helysz√≠n</option>';
            Array.from(locations).sort().forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });

            // Vissza√°ll√≠tjuk a kiv√°laszt√°st, ha m√©g l√©tezik az opci√≥
            if (Array.from(locationSelect.options).some(option => option.value === currentValue)) {
                locationSelect.value = currentValue;
            } else {
                locationSelect.value = 'all';
            }
        }

      function applyFilters() {
            const typeFilter = document.getElementById('filter-type').value;
            const locationFilter = document.getElementById('filter-location').value;

            const filteredGames = {};

            Object.values(games).forEach(game => {
                // T√≠pus sz≈±r√©s (ez marad a r√©gi)
                const matchesType = (typeFilter === 'all') || (game.type === typeFilter);
                
                // Helysz√≠n sz≈±r√©s
                let matchesLocation = false;
                
                // Biztons√°gi √°talak√≠t√°s sz√∂vegg√©
                const rawLocation = String(game.location || "");

                if (locationFilter === 'all') {
                    matchesLocation = true;
                } else {
                    // 1. Sz√©tv√°gjuk a j√°t√©k helysz√≠neit list√°ra (pl. ["Budapest", "Margitsziget"])
                    const gameLocationsList = rawLocation.split(',').map(s => s.trim());

                    // 2. Megn√©zz√ºk, hogy a list√°ban szerepel-e a kiv√°lasztott sz≈±r≈ë
                    // (pl. ha "Budapest"-et keres√ºnk, megtal√°lja ebben a list√°ban)
                    matchesLocation = gameLocationsList.includes(locationFilter);
                }

                if (matchesType && matchesLocation) {
                    filteredGames[game.id] = game;
                }
            });

            renderGameList(filteredGames);
        }

        function resetFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-location').value = 'all';
            applyFilters();
        }

      
        function handleGameSelect(gameId, title, type, price, hasSave) {
            if (hasSave) {
                 loadGameById(gameId);
            } else {
                 showMessage('Kaland Ind√≠t√°sa', `Biztosan elind√≠tod a(z) <strong>${title}</strong> kalandot? J√°t√©k t√≠pusa: ${type}. √År: ${price}`, () => requestGpsAndStart(gameId), true);
            }
        }
        
        function formatTime(seconds) {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        function startTimersAndGPS() {
            if (appState.isTimerRunning) return; 

            appState.startTime = new Date();
            appState.isTimerRunning = true;
            clearInterval(appState.timerInterval);
            appState.timerInterval = setInterval(updateTimer, 1000);
            lastTimeUpdate = appState.startTime.getTime(); 
            
            if (appState.currentGame.taskOrder === 'explore') {
                if (appState.completedTasks.indexOf(0) === -1) appState.completedTasks.push(0);
                showTaskSelectionMap();
            } else {
                const nextTaskIndex = appState.currentGame.tasks[1].index; 
                appState.currentTaskIndex = nextTaskIndex; 
                loadTask(appState.currentTaskIndex); 
            }
            if (appState.map) checkGeofence();
            updateStatusDisplays(); 
            saveGameState(); 
        }

        let lastTimeUpdate = new Date().getTime();
        function updateTimer() {
            if (!appState.isTimerRunning) return; 
            const now = new Date().getTime();
            const elapsed = Math.floor((now - lastTimeUpdate) / 1000);
            const steps = elapsed; 
            appState.totalTime += steps;
            document.getElementById('timer-display').textContent = formatTime(appState.totalTime);
            
            const currentTask = appState.currentGame ? appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex) : null; 
            if (currentTask && currentTask.isTaskTimerActive) {
                appState.geofenceTime += steps;
            }
            document.getElementById('geofence-timer-display').textContent = formatTime(appState.geofenceTime);
            lastTimeUpdate = now;
            saveGameState(); 
        }
        
        function updateStatusDisplays() {
            if (!appState.currentGame) return;
            document.getElementById('score-display').textContent = appState.score;
            const totalTasks = appState.currentGame.tasks.length - 1; 
            let displayedTask;
            if (appState.currentGame.taskOrder === 'explore') {
                 displayedTask = appState.completedTasks.filter(index => index > 0).length; 
            } else {
                 const currentIndexInArray = appState.currentGame.tasks.findIndex(t => t.index === appState.currentTaskIndex);
                 displayedTask = (currentIndexInArray > 0) ? currentIndexInArray : 0; 
            }
            document.getElementById('task-progress-display').textContent = `${displayedTask} / ${totalTasks}`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame(gameId, modeOverride = null) {
// --- GOOGLE ANALYTICS M√âR√âS BEILLESZT√âSE ---
    if (typeof gtag === 'function') {
        gtag('event', 'game_start', {
            'game_id': gameId,
            'game_mode': modeOverride || 'normal',
            'team_name': document.getElementById('team-name-input').value || 'unknown'
        });
    }
            if (speechSynth.speaking) speechSynth.cancel();
            let gameMode;
            if (modeOverride) {
                gameMode = modeOverride;
            } else {
                const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
                gameMode = selectedMode ? selectedMode.value : 'normal'; 
            }
            
            appState.isTestModeEnabled = (gameMode === 'test' || gameMode === 'mock');
            appState.isManualMock = (gameMode === 'mock');
            
            if (!appState.isManualMock && manualMarker) {
                manualMarker.remove();
                manualMarker = null;
            }

            appState.currentGame = JSON.parse(JSON.stringify(games[gameId])); 
            appState.taskOrder = document.getElementById('task-order-select').value;
            
            if (appState.currentGame.type === 'team' && appState.taskOrder !== 'explore') appState.taskOrder = 'random';
            else if (appState.currentGame.type === 'explore') appState.taskOrder = 'explore';
            appState.currentGame.taskOrder = appState.taskOrder; 

            if (appState.taskOrder === 'explore') {
                 appState.completedTasks = [];
                 appState.availableTasks = appState.currentGame.tasks.filter(t => t.index > 0).map(t => t.index); 
                 appState.taskMarkers = {}; 
            }
            
            appState.currentTaskIndex = 0; appState.score = 0; appState.totalTime = 0; appState.geofenceTime = 0;
            appState.startTime = null; appState.isTimerRunning = false; appState.routeCoordinates = []; 
            
            appState.teamName = document.getElementById('team-name-input').value.trim() || null;
            appState.teamAvatar = document.getElementById('team-avatar-select').value || null;
            
            const startTaskTemplate = {
                index: 0, isStartTask: true, location: appState.currentGame.startLocation,
                geofenceRadius: GEOFENCE_DEFAULT_RADIUS,
                story: `**${appState.currentGame.title}**<br>${appState.currentGame.description}<br><br>Indulj el a megjel√∂lt Start Helysz√≠nre. Amikor el√©red a z√≥n√°t, nyomd meg a **Kaland Ind√≠t√°sa** gombot.`,
                prompt: '√ârd el a Start Helysz√≠nt az indul√°shoz!', hints: [], solution: '', acceptedAnswers: [],
                hintsUsed: 0, timeSpent: 0, taskScore: 0, isTaskTimerActive: false 
            };
            
            let realTasks = appState.currentGame.tasks.filter(t => t.index > 0); 
            
            if (appState.taskOrder === 'random' && realTasks.length >= 1) {
                const maxIndex = realTasks.reduce((max, task) => Math.max(max, task.index), 0);
                const finalTask = realTasks.find(t => t.index === maxIndex); 
                let tasksToShuffle = realTasks.filter(t => t.index !== maxIndex); 
                tasksToShuffle = shuffleArray(tasksToShuffle); 
                appState.currentGame.tasks = [ startTaskTemplate, ...tasksToShuffle, ...(finalTask ? [finalTask] : []) ];
            } else {
                appState.currentGame.tasks = [startTaskTemplate, ...realTasks];
            }
            
            appState.currentTaskIndex = startTaskTemplate.index; 
            
            document.getElementById('timer-display').textContent = '‚Äî:‚Äî';
            document.getElementById('geofence-timer-display').textContent = '‚Äî:‚Äî';
            document.getElementById('task-progress-display').textContent = `0 / ${appState.currentGame.tasks.length - 1}`; 
            
            clearInterval(appState.timerInterval);
            document.getElementById('test-mode-indicator').classList.toggle('hidden', !appState.isTestModeEnabled);
            showPage('game-page');
            
            setTimeout(() => {
                initializeMap();
                loadTask(appState.currentTaskIndex);
                watchPosition(); 
                updateStatusDisplays(); 
                saveGameState(); 
            }, 100);
        }

        function updateHintButtons(task) {
            const hint1Btn = document.getElementById('hint1-btn');
            const hint2Btn = document.getElementById('hint2-btn');
            const solutionBtn = document.getElementById('solution-btn');
            if (task.isStartTask) { hint1Btn.disabled = true; hint2Btn.disabled = true; solutionBtn.disabled = true; return; }
            const hasHint1 = task.hints && task.hints.length >= 1;
            const hasHint2 = task.hints && task.hints.length >= 2;
            const maxHints = task.hints.length;
            const applyHintState = (btn, index) => {
                 if (task.hintsUsed >= index) btn.classList.add('used');
                 else btn.classList.remove('used');
                 btn.disabled = (index > 1 && task.hintsUsed < index - 1);
                 return btn.disabled;
            }
            hint1Btn.disabled = !hasHint1 || applyHintState(hint1Btn, 1);
            hint2Btn.disabled = !hasHint2 || applyHintState(hint2Btn, 2);
            const isFinalTaskInExplore = appState.currentGame.taskOrder === 'explore' && appState.availableTasks.length === 1; 

	    if (task.disableSolution) {
        solutionBtn.style.display = 'none'; // Teljesen elt√ºnteti
    } else {
        solutionBtn.style.display = 'inline-block'; // Megjelen√≠ti
        // Csak akkor akt√≠v, ha elfogytak a seg√≠ts√©gek
        solutionBtn.disabled = (task.hintsUsed < maxHints || isFinalTaskInExplore);
    }            

            if (!appState.isTestModeEnabled && !task.isTaskTimerActive) { 
        hint1Btn.disabled = true;
        hint2Btn.disabled = true;
        solutionBtn.disabled = true;
            }
        }

        function loadTask(taskIndex) {
            if (speechSynth.speaking) speechSynth.cancel();
            document.getElementById('content-page-wrapper').scrollTo({ top: 0, behavior: 'instant' });
            const task = appState.currentGame.tasks.find(t => t.index === taskIndex); 
            if (!task) return;
            appState.currentTaskIndex = taskIndex; 
            const isStartTask = task.isStartTask; 
            if (typeof task.isTaskTimerActive === 'undefined') task.isTaskTimerActive = false;
            if (!isStartTask && task.taskScore !== DEFAULT_SCORE_PER_TASK && task.taskScore === 0 && task.hintsUsed === 0) task.taskScore = DEFAULT_SCORE_PER_TASK; 
            else if (isStartTask) task.taskScore = 0;

            document.getElementById('normal-task-content').classList.remove('hidden');
            document.getElementById('explore-selection-container').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            document.getElementById('google-maps-btn').classList.remove('hidden'); 
            document.getElementById('report-error-btn').classList.remove('hidden');

const backBtn = document.getElementById('back-to-map-btn');
    if (backBtn) {
        if (appState.currentGame.taskOrder === 'explore' && !isStartTask) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
    }            

            const speakBtn = document.getElementById('speak-story-btn');
            if (speakBtn && ('speechSynthesis' in window)) speakBtn.style.display = 'block'; 
            else if (speakBtn && speakBtn.parentElement) speakBtn.remove();
            
            if (isStartTask) task.startTime = 0;
            document.getElementById('story').innerHTML = task.story;
            document.getElementById('prompt').innerHTML = task.prompt;
            document.getElementById('answer-input').value = '';
            document.getElementById('story-details').open = true; 
            if(typeof task.hintsUsed === 'undefined') task.hintsUsed = 0;
            
            if (!isStartTask) {
                 document.getElementById('submit-answer-btn').disabled = true; 
                 document.getElementById('answer-input').disabled = true;
                 updateHintButtons(task);
                 document.getElementById('answer-input-container').classList.remove('hidden');
                 document.getElementById('hint-buttons-container').classList.remove('hidden');
                 document.getElementById('prompt').classList.remove('hidden'); 
            } else {
                 document.getElementById('submit-answer-btn').disabled = true;
                 document.getElementById('answer-input').disabled = true;
                 document.getElementById('hint1-btn').disabled = true;
                 document.getElementById('hint2-btn').disabled = true;
                 document.getElementById('solution-btn').disabled = true;
                 document.getElementById('answer-input-container').classList.add('hidden');
                 document.getElementById('hint-buttons-container').classList.add('hidden');
                 document.getElementById('prompt').classList.remove('hidden');
                 if (appState.currentGame.taskOrder === 'explore') {
                     document.getElementById('start-game-btn').disabled = false; 
                     document.getElementById('start-task-button-container').classList.remove('hidden');
                 }
            }
            if (appState.map) {
                updateTaskMarker(task.location);
                Object.values(appState.taskMarkers).forEach(m => m.remove());
                appState.taskMarkers = {};
            }
            checkGeofence(); 
            updateStatusDisplays();
        }

        function handleCorrectAnswer() {
// --- GOOGLE ANALYTICS M√âR√âS BEILLESZT√âSE ---
    if (typeof gtag === 'function') {
        gtag('event', 'level_up', {
            'level': appState.currentTaskIndex,
            'character': appState.teamAvatar || 'none',
            'score': appState.score
        });
    }            
	    if (speechSynth.speaking) speechSynth.cancel();
            const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex); 
            if (!currentTask) return;
            currentTask.timeSpent = appState.geofenceTime - (currentTask.startTime || 0);
            currentTask.isTaskTimerActive = false;
            if (currentTask.taskScore > 0 && !currentTask.isStartTask) appState.score += currentTask.taskScore; 
            
            if (appState.currentGame.taskOrder === 'explore') {
                if (currentTask && !currentTask.isStartTask) {
                    const indexToRemove = appState.availableTasks.indexOf(appState.currentTaskIndex);
                    if (indexToRemove > -1) appState.availableTasks.splice(indexToRemove, 1);
                    if (appState.completedTasks.indexOf(currentTask.index) === -1) appState.completedTasks.push(currentTask.index);
                }
                if (appState.availableTasks.length === 0) endGame();
                else {
                     appState.currentTaskIndex = 0; 
                     showTaskSelectionMap();
                }
            } else {
                const currentIndexInArray = appState.currentGame.tasks.findIndex(t => t.index === appState.currentTaskIndex);
                const nextIndexInArray = currentIndexInArray + 1;
                if (nextIndexInArray < appState.currentGame.tasks.length) {
                    const nextTaskIndex = appState.currentGame.tasks[nextIndexInArray].index;
                    loadTask(nextTaskIndex); 
                } else {
                    endGame();
                }
            }
            updateStatusDisplays();
	    saveGameState(); 
        }
        
// --- END GAME (JAV√çTOTT VERZI√ì) ---
        function endGame() {
   if (typeof gtag === 'function') {
        gtag('event', 'game_complete', {
            'game_id': appState.currentGame ? appState.currentGame.id : 'unknown',
            'score': appState.score,
            'total_time': appState.totalTime,
            'team_name': appState.teamName
        });
    }
	    if (speechSynth.speaking) speechSynth.cancel();
            
            // Jelenlegi id≈ë meghat√°roz√°sa
            const endTime = new Date();
            const formattedEndTime = `${endTime.getFullYear()}.${String(endTime.getMonth()+1).padStart(2,'0')}.${String(endTime.getDate()).padStart(2,'0')} ${String(endTime.getHours()).padStart(2,'0')}:${String(endTime.getMinutes()).padStart(2,'0')}`;
            
            // J√°t√©k k√∂zbeni id≈ëz√≠t≈ëk √©s figyel≈ëk le√°ll√≠t√°sa
            clearInterval(appState.timerInterval);
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            
            // J√°t√©k k√∂zbeni t√©rk√©p (nagy t√©rk√©p) t√∂rl√©se, ha l√©tezik
            if (appState.map) { appState.map.remove(); appState.map = null; }
            if (manualMarker) { manualMarker.remove(); manualMarker = null; }

            // Id≈ëk sz√°m√≠t√°sa
            const totalTaskTime = appState.currentGame.tasks.filter(t => !t.isStartTask).reduce((sum, task) => sum + (task.timeSpent || 0), 0);
            
            // HTML elemek kit√∂lt√©se az eredm√©nyekkel
            document.getElementById('end-story').innerHTML = appState.currentGame.endStory;
            document.getElementById('final-score').textContent = appState.score;
            document.getElementById('final-time').textContent = formatTime(appState.totalTime); 
            document.getElementById('final-team-display').textContent = appState.teamName || "N√©vtelen Csapat";
            document.getElementById('final-team-avatar-icon').textContent = AVATAR_ICONS[appState.teamAvatar] || '';
            document.getElementById('end-timestamp').textContent = `Befejez√©s: ${formattedEndTime}`;
            document.getElementById('final-geofence-time').textContent = formatTime(totalTaskTime);
            
            // Megjelen√≠tj√ºk a v√©gs≈ë oldalt
            showContentPage('end-page');
            
            // K√©zi let√∂lt√©s gomb l√°that√≥v√° t√©tele
            const manualPdfBtn = document.querySelector('button[onclick="downloadPDF()"]');
            if(manualPdfBtn) manualPdfBtn.classList.remove('hidden');
            
            // --- T√âRK√âP RAJZOL√ÅSA BIZTONS√ÅGOSAN ---
            const routeMapDiv = document.getElementById('route-map');
            
            // 1. L√âP√âS: T√©rk√©p kont√©ner takar√≠t√°sa (Kritikus jav√≠t√°s)
            // Ha m√°r volt rajta t√©rk√©p (el≈ëz≈ë j√°t√©kb√≥l), t√∂r√∂lj√ºk a Leaflet azonos√≠t√≥t √©s a tartalmat
            if (routeMapDiv) {
                if (routeMapDiv._leaflet_id) {
                    routeMapDiv._leaflet_id = null; // Leaflet hack: ID t√∂rl√©se
                }
                routeMapDiv.innerHTML = ""; // HTML tartalom t√∂rl√©se
            }

            try {
                if (appState.routeCoordinates.length > 0) {
                    const originalAny3d = L.Browser.any3d; const originalIelt9 = L.Browser.ielt9;
                    L.Browser.any3d = false; L.Browser.ielt9 = true; 
                    
                    // T√©rk√©p l√©trehoz√°sa
                    const endMap = L.map('route-map', { zoomControl: false, fadeAnimation: false, markerZoomAnimation: false, preferCanvas: true });
                    
                    L.Browser.any3d = originalAny3d; L.Browser.ielt9 = originalIelt9;
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap ¬© CARTO', crossOrigin: true }).addTo(endMap);
                    
                    const polyline = L.polyline(appState.routeCoordinates, { color: 'var(--brand-orange)', weight: 5, opacity: 0.8 }).addTo(endMap);
                    endMap.fitBounds(polyline.getBounds().pad(0.2));
                    
                    setTimeout(() => { 
                        try {
                            endMap.invalidateSize(); 
                            endMap.fitBounds(polyline.getBounds(), { padding: [20, 20], maxZoom: 16, animate: false }); 
                        } catch(e) { console.log("T√©rk√©p m√©retez√©si hiba (figyelmen k√≠v√ºl hagyhat√≥)"); }
                    }, 800);

                    // Start pont
                    const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location; 
                    L.marker([startLoc.lat, startLoc.lng], { title: 'Start' }).addTo(endMap).bindPopup('<b>Start Helysz√≠n</b>');

                    // Feladatok jel√∂l√©se
                    appState.currentGame.tasks.filter(t => !t.isStartTask).forEach(task => {
                        if (task.location) {
                            const isCompleted = appState.currentGame.taskOrder === 'explore' ? appState.completedTasks.includes(task.index) : true;
                            const taskMarkerIcon = L.divIcon({
                                className: 'task-selector-marker', html: isCompleted ? '‚úÖ' : task.index.toString(),
                                iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30],
                                style: isCompleted ? 'background-color: green;' : 'background-color: var(--brand-cyan);'
                            });
                            L.marker([task.location.lat, task.location.lng], { icon: taskMarkerIcon, title: `Feladat ${task.index}` }).addTo(endMap).bindPopup(`<b>Feladat ${task.index}</b>`);
                        }
                    });
                } else {
                     routeMapDiv.innerHTML = `<p class="p-4 text-gray-500">Nem siker√ºlt √∫tvonalat r√∂gz√≠teni (nincs GPS adat).</p>`;
                }
            } catch (err) {
                console.error("Hiba az eredm√©nyjelz≈ë t√©rk√©p rajzol√°sakor:", err);
                routeMapDiv.innerHTML = `<p class="p-4 text-red-500">T√©rk√©p bet√∂lt√©si hiba.</p>`;
                // Nem √°ll√≠tjuk meg a fut√°st, hogy a ment√©s t√∂rl√©se mindenk√©pp lefusson!
            }
            
            // --- FONTOS M≈∞VELETEK A T√âRK√âP UT√ÅN ---
            
            // 1. PDF Automatikus let√∂lt√©s
            setTimeout(() => {
                downloadPDF();
            }, 1000); 
            
            // 2. Ment√©s t√∂rl√©se (Hogy ne t√∂ltse vissza √∫jra)
            if(appState.currentGame) {
                console.log("Ment√©s t√∂rl√©se a j√°t√©k v√©g√©n:", appState.currentGame.id);
                deleteSavedGame(appState.currentGame.id);
            }
            
            // 3. J√°t√©k √°llapot kinull√°z√°sa
            appState.currentGame = null;
        }
        
        function toggleMapClickMock(enable) {
            if (!appState.map) return;
            if (appState.currentGame && appState.currentGame.taskOrder === 'explore' && appState.currentTaskIndex === 0 && appState.isTimerRunning) {
                if (appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
                return;
            }
            if (enable) {
                if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
                appState.geoWatchId = null;
                if (!appState.map.clickHandler) {
                     appState.map.clickHandler = (e) => {
                        const latLng = e.latlng;
                        const mockIcon = L.divIcon({ className: 'player-marker', iconSize: [20, 20], html: 'üìç', style: 'background-color: blue; border-color: white;' });
                        if (manualMarker) manualMarker.setLatLng(latLng); else manualMarker = L.marker(latLng, { icon: mockIcon }).addTo(appState.map);
                        appState.userPosition = { lat: latLng.lat, lng: latLng.lng };
                        if (appState.isTimerRunning) { appState.routeCoordinates.push([latLng.lat, latLng.lng]); saveGameState(); }
                        checkGeofence();
                        const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                        const bounds = L.latLngBounds(manualMarker.getLatLng(), L.latLng(currentTask.location.lat, currentTask.location.lng));
                        appState.map.fitBounds(bounds.pad(0.1)); 
                    };
                    appState.map.on('click', appState.map.clickHandler);
                }
            } else {
                if (appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
                if (manualMarker) { manualMarker.remove(); manualMarker = null; }
                if (appState.isManualMock) { appState.userPosition = null; watchPosition(); }
            }
        }
        
        function initializeMap() {
            if (appState.map) appState.map.remove();
            const startLoc = appState.currentGame.startLocation;
            appState.map = L.map('map', { zoomControl: false }).setView([startLoc.lat, startLoc.lng], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap ¬© CARTO' }).addTo(appState.map);
            toggleMapClickMock(appState.isManualMock); 
        }

        function updatePlayerMarker(lat, lng) {
            if (!appState.map) return;
            if (!appState.isTestModeEnabled && !appState.isManualMock) {
                appState.userPosition = { lat, lng };
                if (appState.playerMarker) appState.playerMarker.setLatLng([lat, lng]);
                else {
                    const playerIcon = L.divIcon({ className: 'player-marker', iconSize: [20, 20] });
                    appState.playerMarker = L.marker([lat, lng], { icon: playerIcon }).addTo(appState.map);
                }
                if (appState.isTimerRunning) appState.routeCoordinates.push([lat, lng]);
                if (appState.geofenceCircle && appState.playerMarker) { 
                    const bounds = L.latLngBounds(appState.playerMarker.getLatLng(), appState.geofenceCircle.getLatLng());
                    appState.map.fitBounds(bounds.pad(0.1)); 
                }
            }
            checkGeofence();
        }

        function updateTaskMarker(location) {
            if (!appState.map) return;
            const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
            if (!currentTask) return;
            const currentTaskLoc = L.latLng(location.lat, location.lng);
            const currentRadius = currentTask.geofenceRadius || GEOFENCE_DEFAULT_RADIUS;

            if (appState.geofenceCircle) {
                appState.geofenceCircle.setLatLng(currentTaskLoc); appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.addTo(appState.map);
            } else {
                appState.geofenceCircle = L.circle(currentTaskLoc, { radius: currentRadius, color: 'red', fillColor: 'red', fillOpacity: 0.1, weight: 2, className: 'geofence-circle' }).addTo(appState.map);
            }
            const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
            if (playerMarkerForBounds) {
                const bounds = L.latLngBounds(playerMarkerForBounds.getLatLng(), currentTaskLoc);
                appState.map.fitBounds(bounds.pad(0.1)); 
            } else {
                appState.map.setView(currentTaskLoc, 16); 
            }
        }

        function watchPosition() {
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            if (!appState.isTestModeEnabled && !appState.isManualMock && 'geolocation' in navigator) {
                appState.geoWatchId = navigator.geolocation.watchPosition(
                    (pos) => { updatePlayerMarker(pos.coords.latitude, pos.coords.longitude); }, 
                    (err) => {
                        console.warn(`GEO ERROR(${err.code}): ${err.message}`);
                        if (!appState.isTestModeEnabled) { showLoading(false); showMessage('GPS Hiba', t('gps_required'), () => { resetApp(); }); } 
                        else { showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d folytat√≥dik.'); checkGeofence(); }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000, frequency: 3000 }
                );
            } else if (appState.isTestModeEnabled && !appState.isManualMock) {
                 const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                 appState.userPosition = task ? { lat: task.location.lat, lng: task.location.lng } : { lat: appState.currentGame.startLocation.lat, lng: appState.currentGame.startLocation.lng };
                 checkGeofence();
            } else if (appState.isManualMock) {
                 appState.userPosition = (manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : null;
                 checkGeofence();
            }
        }
        
        function haversineDistance(c1, c2) {
            const R = 6371e3; const toRad = x => x*Math.PI/180;
            const p1=toRad(c1.lat), p2=toRad(c2.lat), dp=toRad(c2.lat-c1.lat), dl=toRad(c2.lng-c1.lng);
            const a = Math.sin(dp/2)*Math.sin(dp/2)+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)*Math.sin(dl/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function checkGeofence() {
            const taskInteractionArea = document.getElementById('task-interaction-area');
            const distEl = document.getElementById('distance-info');
            const startButtonContainer = document.getElementById('start-task-button-container'); 
            const exploreSelectionContainer = document.getElementById('explore-selection-container');
            const currentLocation = (appState.isManualMock && manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : appState.userPosition;
            const currentTask = appState.currentGame ? appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex) : null;
            if (!currentTask) return;

            const currentRadius = currentTask.geofenceRadius || GEOFENCE_DEFAULT_RADIUS;
            const isStartTask = currentTask.isStartTask; 
            
            if (appState.currentGame.taskOrder === 'explore' && isStartTask) {
                 startButtonContainer.classList.remove('hidden');
                 document.getElementById('start-game-btn').disabled = false;
                 taskInteractionArea.classList.remove('hidden'); 
                 document.getElementById('prompt').classList.add('hidden');
                 distEl.textContent = "Kaland ind√≠that√≥ b√°rhol!";
                 distEl.className = 'text-center text-xs font-bold mt-2 text-green-600';
                 if (appState.geofenceCircle) { appState.geofenceCircle.remove(); appState.geofenceCircle = null; }
                 if (appState.isTimerRunning) showTaskSelectionMap();
                 return; 
            }
            if (appState.currentGame.taskOrder === 'explore' && appState.isTimerRunning && appState.currentTaskIndex === 0) {
                 taskInteractionArea.classList.add('hidden');
                 exploreSelectionContainer.classList.remove('hidden');
                 renderTaskMarkers();
                 return; 
            }
            
            if (!document.getElementById('report-error-modal').classList.contains('hidden')) {
                 if (currentLocation) {
                    const distance = haversineDistance(currentLocation, currentTask.location);
                    appState.isInZone = distance <= currentRadius;
                    distEl.textContent = appState.isInZone ? t('in_zone') : t('out_zone', Math.round(distance));
                }
                return;
            }

            startButtonContainer.classList.add('hidden');
            exploreSelectionContainer.classList.add('hidden'); 
            
            if (appState.isTestModeEnabled && !appState.isManualMock) {
                appState.isInZone = true;
		        playArrivalNotification();                
                if (!currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
		            playArrivalNotification();
                    if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                if (isStartTask) { 
                    startButtonContainer.classList.remove('hidden');
                    taskInteractionArea.classList.remove('hidden'); 
                    document.getElementById('prompt').classList.add('hidden');
                } else {
                     document.getElementById('submit-answer-btn').disabled = false;
                     document.getElementById('answer-input').disabled = false;
                     taskInteractionArea.classList.remove('hidden'); 
                     document.getElementById('prompt').classList.remove('hidden');
                }
                distEl.textContent = "A Geo-fence inakt√≠v (TESZT M√ìD)";
                distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); }
                
            } else {
                if (!currentLocation) {
                    appState.isInZone = false;
                    document.getElementById('submit-answer-btn').disabled = true;
                    document.getElementById('answer-input').disabled = true;
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                    
                    if (appState.isManualMock) {
                        distEl.textContent = "Kattints a t√©rk√©pre a poz√≠ci√≥ be√°ll√≠t√°s√°hoz!";
                        distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    } else {
                        distEl.textContent = "Helyzet meghat√°roz√°sa...";
                        distEl.className='text-center text-xs font-bold mt-2 text-gray-500';
                    }
                    
                    if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); }
                    return; 
                }

                const distance = haversineDistance(currentLocation, currentTask.location);
                appState.isInZone = distance <= currentRadius; 
                
                if (appState.isInZone && !currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
                    playArrivalNotification();
			        if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                
                if (appState.isInZone) {
                    distEl.textContent = t('in_zone');
                    distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); 
                    document.getElementById('submit-answer-btn').disabled = false;
                    document.getElementById('answer-input').disabled = false;
                    taskInteractionArea.classList.remove('hidden'); 
                    if (isStartTask) {
                        startButtonContainer.classList.remove('hidden');
                        document.getElementById('submit-answer-btn').disabled = true; 
                        document.getElementById('answer-input').disabled = true;
                        taskInteractionArea.classList.remove('hidden'); 
                        document.getElementById('prompt').classList.add('hidden');
                    }
                } else {
                    distEl.textContent = t('out_zone', Math.round(distance));
                    distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); 
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                }
            }
            if (!currentTask.isStartTask) updateHintButtons(currentTask);
            if (currentTask && currentTask.isTaskTimerActive && !isStartTask) {
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('answer-input').disabled = false;
            }
            saveGameState(); 
        }

        function exploreSelectionMapMarkerSelectHandler(e) {
            if (!e.target || !e.target.options || e.target.options.taskIndex === undefined) return;
            loadTask(e.target.options.taskIndex);
            document.getElementById('explore-selection-container').classList.add('hidden');
            if (appState.isManualMock) toggleMapClickMock(true); 
        }
        
// --- √öJ F√úGGV√âNY: Visszal√©p√©s a t√©rk√©pre ---
function backToExploreMap() {
    // Csak Explore m√≥dban √©rtelmezett
    if (appState.currentGame.taskOrder !== 'explore') return;

    // Elrejtj√ºk a feladat interakci√≥s fel√ºletet
    document.getElementById('task-interaction-area').classList.add('hidden');
    
    // Megjelen√≠tj√ºk a v√°laszt√≥ fel√ºletet
    document.getElementById('explore-selection-container').classList.remove('hidden');

    // --- √öJ SOR: A vissza gomb elrejt√©se ---
    document.getElementById('back-to-map-btn').classList.add('hidden');
    // ---------------------------------------
    
    // T√©rk√©p vissza√°ll√≠t√°sa v√°laszt√≥ m√≥dba
    showTaskSelectionMap();
    
    // Az aktu√°lis task index√©t vissza√°ll√≠tjuk 0-ra (vagyis "v√°laszt√°s alatt" √°llapotra)
    appState.currentTaskIndex = 0;
    
    // T√©rk√©p friss√≠t√©se (hogy a mock click handler rendben legyen)
    if (appState.isManualMock) {
        toggleMapClickMock(true);
    }
}



        function renderTaskMarkers() {
            if (!appState.map || appState.currentGame.taskOrder !== 'explore') return;
            Object.values(appState.taskMarkers).forEach(m => m.remove());
            appState.taskMarkers = {};
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            
            const bounds = [];
            appState.availableTasks.forEach(taskIndex => {
                const task = appState.currentGame.tasks.find(t => t.index === taskIndex);
                if (!task) return;
                const taskIcon = L.divIcon({ className: 'task-selector-marker', html: task.index.toString(), iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] });
                const marker = L.marker([task.location.lat, task.location.lng], { icon: taskIcon, title: `Feladat ${task.index} - V√°lassz`, taskIndex: task.index }).addTo(appState.map).bindPopup(`<b>Feladat ${task.index}</b><br>Kattints a kiv√°laszt√°shoz!`);
                marker.on('click', exploreSelectionMapMarkerSelectHandler);
                appState.taskMarkers[task.index] = marker;
                bounds.push([task.location.lat, task.location.lng]);
            });
            const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
            if (playerMarkerForBounds) bounds.push(playerMarkerForBounds.getLatLng());
            else if (appState.userPosition) bounds.push([appState.userPosition.lat, appState.userPosition.lng]);
            
            if (bounds.length > 0 && appState.isTimerRunning) {
                 const now = Date.now();
                 if (now - appState.lastAutoZoomTime > 10000 || appState.lastAutoZoomTime === 0) {
                     appState.map.fitBounds(L.latLngBounds(bounds).pad(0.2));
                     appState.lastAutoZoomTime = now; 
                 }
            } else if (bounds.length > 0) {
                 const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location;
                 appState.map.setView([startLoc.lat, startLoc.lng], 16);
            }
            appState.map.invalidateSize(true);
        }

        function showTaskSelectionMap() {
            if (appState.currentGame.taskOrder !== 'explore' || !appState.map) return;
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            document.getElementById('task-interaction-area').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            const backBtn = document.getElementById('back-to-map-btn');
	      if (backBtn) backBtn.classList.add('hidden');
	    document.getElementById('explore-selection-container').classList.remove('hidden');
            renderTaskMarkers();
            if (appState.isManualMock && appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
            document.getElementById('distance-info').textContent = "V√°lassz feladatot a t√©rk√©pen!";
            document.getElementById('distance-info').className='text-center text-xs font-bold mt-2 text-brand-blue';
        }

        function startNavigation() {
            if (!appState.currentGame) return showMessage('Hiba', 'Nincs aktu√°lis kaland elind√≠tva.');
            let lat, lng;
            if (appState.currentTaskIndex === 0) {
                 const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location;
                 lat = startLoc.lat; lng = startLoc.lng;
                 showMessage('Navig√°l√°s a kezd≈ëponthoz', 'A Start Helysz√≠nre navig√°lunk.');
            } else {
                 const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                 if (!task) return showMessage('Hiba', 'Nincs aktu√°lis feladat a navig√°ci√≥hoz.');
                 lat = task.location.lat; lng = task.location.lng;
            }
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        function speakStory(event) {
            event.preventDefault(); 
            if (!('speechSynthesis' in window)) return showMessage('Felolvas√°si hiba', 'A b√∂ng√©sz≈ëje nem t√°mogatja a be√©p√≠tett hangfelolvas√°st (Web Speech API).');
            if (speechSynth.speaking) { speechSynth.cancel(); return; }
            const storyElement = document.getElementById('story');
            if (!storyElement) return;
            const storyText = storyElement.textContent.trim();
            if (storyText === "") return;
            const utterance = new SpeechSynthesisUtterance(storyText);
            const hungarianVoice = speechSynth.getVoices().find(voice => voice.lang.startsWith('hu-'));
            if (hungarianVoice) utterance.voice = hungarianVoice; else utterance.lang = 'hu-HU'; 
            speechSynth.speak(utterance);
        }
        
        function playArrivalNotification() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1); 
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.5); 
        }

        function shareResult(platform) {
            const finalScore = document.getElementById('final-score').textContent;
            const finalTime = document.getElementById('final-time').textContent;
            const teamName = appState.teamName || "N√©v";
            const gameTitle = appState.currentGame ? appState.currentGame.title : "Kaland";
            const text = `√âppen most fejeztem be a(z) ${gameTitle} kalandot a(z) ${teamName} csapattal! üèÜ Pontsz√°m: ${finalScore}, Teljes id≈ë: ${finalTime}. Pr√≥b√°ld ki te is! #MystiGo #V√°rosiKaland #KalandJ√°t√©k`;
            const url = 'https://www.mystigo.hu/'; 
            let shareUrl = '';
            switch (platform) {
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`; break;
                case 'system':
                    if (navigator.share) { navigator.share({ title: 'MystiGo Kaland Teljes√≠tve!', text: text, url: url }).catch(error => console.log('Megoszt√°s megszak√≠tva vagy hiba t√∂rt√©nt', error)); return; } 
                    shareUrl = `mailto:?subject=MystiGo Kaland&body=${encodeURIComponent(text + " " + url)}`; break;
                default: return;
            }
            if (shareUrl) window.open(shareUrl, '_blank');
        }
        
        function normalizeAnswer(str) { 
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '');
        }


function testGpsConnection() {
            showLoading(true);
            
            if (!navigator.geolocation) {
                showLoading(false);
                document.getElementById('gps-help-modal').classList.remove('hidden');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    showLoading(false);
                    // Sikeres GPS lek√©r√©s
                    const accuracy = Math.round(pos.coords.accuracy);
                    showMessage(
                        '‚úÖ GPS M≈±k√∂dik!', 
                        `Sikeresen meghat√°roztuk a helyzetedet!<br><br>Pontoss√°g: <strong>kb. ${accuracy} m√©ter</strong>.<br>K√©szen √°llsz a j√°t√©kra.`
                    );
                },
                (err) => {
                    showLoading(false);
                    console.warn("GPS Teszt Hiba:", err);
                    // Hiba eset√©n megnyitjuk a seg√≠t≈ë ablakot
                    document.getElementById('gps-help-modal').classList.remove('hidden');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }


function requestGpsAndStart(gameId) {
            const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
            const gameMode = selectedMode ? selectedMode.value : 'normal';

            if (gameMode === 'mock') { startGame(gameId, 'mock'); return; }
            
            if (!navigator.geolocation) { 
                // Ha a b√∂ng√©sz≈ë egy√°ltal√°n nem t√°mogatja, akkor is j√∂het a help ablak
                document.getElementById('gps-help-modal').classList.remove('hidden');
                return; 
            }
            
            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    showLoading(false);
                    updatePlayerMarker(pos.coords.latitude, pos.coords.longitude); 
                    startGame(gameId, 'normal');
                },
                (err) => { 
                    showLoading(false);
                    
                    if (gameMode === 'normal') {
                        // JAV√çT√ÅS: Itt most m√°r a sz√©p ablakot nyitjuk meg a showMessage helyett!
                        document.getElementById('gps-help-modal').classList.remove('hidden');
                    }
                    else { 
                        showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d miatt a j√°t√©k elindul.'); 
                        startGame(gameId, 'test'); 
                    }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000, frequency: 3000 } 
            );
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeState();
            loadLocalXlsx(DEFAULT_GAME_FILE);

            const logoO = document.getElementById('logo-o'); 
            const manualFileSelectLabel = document.getElementById('manual-file-select-label');
            const manualFileInput = document.getElementById('excel-file-input-manual'); 
            const devOptions = document.getElementById('developer-options');
            const devToggle = document.getElementById('developer-tools-toggle');

            document.getElementById('modal-ok-button').onclick = hideMessage;
            document.getElementById('modal-cancel-button').onclick = hideMessage;
            
            logoO.addEventListener('click', () => {
                 const switchesContainer = document.getElementById('secret-switches-container');
                 if (switchesContainer) {
                    if (!document.getElementById('game-list-page').classList.contains('hidden')) switchesContainer.classList.toggle('hidden');
                 }
            });
            
            const mainHeaderLogoContainer = document.querySelector('#main-header .flex.justify-center');
            if (mainHeaderLogoContainer) {
                mainHeaderLogoContainer.style.cursor = 'pointer'; 
                mainHeaderLogoContainer.addEventListener('click', () => { resetApp(); });
            }

            if (manualFileInput) {
                 manualFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0]; if (!file) return; 
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'}); 
                            processExcelData(wb);
                            if (manualFileSelectLabel) manualFileSelectLabel.classList.add('hidden');
                        } catch (error) {
                            showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                            showLoading(false);
                            if (manualFileSelectLabel) manualFileSelectLabel.classList.remove('hidden');
                        }
                    };
                    reader.onerror = () => { showMessage('Hiba', 'F√°jl olvas√°si hiba.'); showLoading(false); };
                    reader.readAsArrayBuffer(file);
                });
            }
            
            const excelFileInput = document.getElementById('excel-file-input');
            if (excelFileInput) {
                excelFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0]; if (!file) return; 
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'}); 
                            processExcelData(wb);
                        } catch (error) {
                            showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                            showLoading(false);
                        }
                    };
                    reader.onerror = () => { showMessage('Hiba', 'F√°jl olvas√°si hiba.'); showLoading(false); };
                    reader.readAsArrayBuffer(file);
                });
            }

            document.body.addEventListener('click', (e) => {
                 if (e.target && e.target.id === 'secret-trigger') {
                    const container = document.getElementById('secret-switches-container');
                    if (container) container.classList.toggle('hidden');
                 }
            });
            
            if (devToggle && devOptions) {
                devToggle.addEventListener('click', () => {
                    devOptions.classList.toggle('hidden');
                    devToggle.querySelector('span').textContent = devOptions.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
                });
            }

            document.getElementById('submit-answer-btn').addEventListener('click', () => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return;
                const userAnswer = document.getElementById('answer-input').value;
                const normalizedUserAnswer = normalizeAnswer(userAnswer);
                let isCorrect = false;
                if (task.acceptedAnswers && task.acceptedAnswers.includes(normalizedUserAnswer)) isCorrect = true;
                
                if (isCorrect) showMessage(t('correct_title'), `√úgyes vagy! (+${task.taskScore} pont)`, handleCorrectAnswer);
                else {
                    if (task.taskScore > 0) task.taskScore = Math.max(0, task.taskScore - WRONG_ANSWER_PENALTY);
                    showMessage(t('wrong_title'), t('wrong_body') + `<br><br>(Maradt pont: ${task.taskScore})`);
                }
                updateStatusDisplays();
            });

            document.getElementById('hint1-btn').addEventListener('click', (e) => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                if (task.hintsUsed < 1) { 
                    task.taskScore = Math.max(0, task.taskScore - HINT1_PENALTY); 
                    task.hintsUsed = 1;
                    if (typeof gtag === 'function') {
                        gtag('event', 'hint_used', {
                            'game_id': appState.currentGame.id,
                            'level_index': appState.currentTaskIndex,
                            'hint_type': 'hint_1',
                            'team_name': appState.teamName || 'unknown'
                        });
                    }
		    updateStatusDisplays(); saveGameState(); 
                }
                showMessage('1. Seg√≠ts√©g', t('hint1_body', task.hints[0]) + `<br><br>(Maradt pont: ${task.taskScore})`, () => { updateHintButtons(task); });
            });

            document.getElementById('hint2-btn').addEventListener('click', (e) => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                if (task.hintsUsed < 2) { 
                    task.taskScore = Math.max(0, task.taskScore - HINT2_PENALTY); 
                    task.hintsUsed = 2;
		if (typeof gtag === 'function') {
                        gtag('event', 'hint_used', {
                            'game_id': appState.currentGame.id,
                            'level_index': appState.currentTaskIndex,
                            'hint_type': 'hint_2',
                            'team_name': appState.teamName || 'unknown'
                        });
                    }                
    		updateStatusDisplays(); saveGameState(); 
                }
                showMessage('2. Seg√≠ts√©g', t('hint2_body', task.hints[1]) + `<br><br>(Maradt pont: ${task.taskScore})`, () => { updateHintButtons(task); });
            });
            
            document.getElementById('solution-btn').addEventListener('click', () => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                const scoreLost = task.taskScore; 
                task.taskScore = 0; 
                if (typeof gtag === 'function') {
                    gtag('event', 'hint_used', {
                        'game_id': appState.currentGame.id,
                        'level_index': appState.currentTaskIndex,
                        'hint_type': 'solution_reveal', // Itt m√°s t√≠pust adunk meg
                        'team_name': appState.teamName || 'unknown'
                    });
                }
		showMessage('Megold√°s', `A feladat megold√°sa: ${task.solution}. <br><br>(Maradt pont: 0)`, () => {
                    handleCorrectAnswer(); updateStatusDisplays();
                });
                saveGameState(); 
            });
            
            document.getElementById('start-game-btn').addEventListener('click', startTimersAndGPS);
            document.getElementById('exit-game-btn').addEventListener('click', showExitConfirmation);
            document.getElementById('report-error-btn').addEventListener('click', showReportModal); 
            document.getElementById('submit-error-report').addEventListener('click', handleSubmitError); 

            document.addEventListener('visibilitychange', () => {
                if (!appState.currentGame) return;
                if (document.hidden) { 
                    if (speechSynth.speaking) speechSynth.cancel();
                    if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId); appState.geoWatchId = null; 
                } 
                else if (!appState.geoWatchId) { watchPosition(); }
            });

            document.getElementById('answer-input').addEventListener('focus', (e) => {
                const inputElement = e.target;
                inputElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    const wrapper = document.getElementById('content-page-wrapper');
                    const inputTop = inputElement.offsetTop;
                    wrapper.scrollTo({ top: inputTop - 30, behavior: 'smooth' });
                }, 150); 
            });
        }); 
    </script>
</body>
</html>