<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0D2B45">
    <link rel="apple-touch-icon" href="icon-192_v3.png">

    <title>MystiGo - V√°rosi Kalandj√°t√©k Platform</title>
    
    <link rel="preload" href="games/games.xlsx" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="logo/MystiGo_logo.png" as="image">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        // 1. Defini√°ld az alap√©rtelmezett beleegyez√©si √°llapotot a CMP k√≥dja el≈ëtt!
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('consent', 'default', {
            'ad_storage': 'denied', // Hirdet√©s t√°rol√°s tiltva
            'analytics_storage': 'denied', // Analitika t√°rol√°s tiltva
            'wait_for_update': 500 // 500 ms v√°rakoz√°s a CMP-re
        });
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1SBQQGDGL7"></script>
    <script>
        gtag('js', new Date());
        gtag('config', 'G-1SBQQGDGL7');
    </script>
    <script type="text/javascript">
    var _iub = _iub || [];
    _iub.csConfiguration = {"lang":"hu","siteId":2549400,"cookiePolicyId":40995967, "consentOnContinuedBrowsing": false, "callback": { onConsentGiven: function() { gtag('consent', 'update', { 'analytics_storage': 'granted', 'ad_storage': 'granted' }); }, onConsentRejected: function() { gtag('consent', 'update', { 'analytics_storage': 'denied', 'ad_storage': 'denied' }); }}};
    </script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/tcf/stub.js"></script>
    <script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="utf-8"></script>
    <style>
        /* --- Arculat friss√≠tve a le√≠r√°s alapj√°n (t√ºrkiz, narancs, s√∂t√©tk√©k) --- */
        :root {
            --brand-cyan: #00CED1; /* T√ºrkiz */
            --brand-blue: #0D2B45; /* S√∂t√©tk√©k */
            --brand-orange: #FFA500; /* Narancs */
            --background-start: #E0F7FA;
            --background-end: #FFFFFF;
            --text-dark: #2D3748;
            --text-heading: var(--brand-blue);
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(180deg, var(--background-start) 0%, var(--background-end) 70%);
            overscroll-behavior-y: contain;
            touch-action: manipulation;
        }
        .main-button {
            background-color: var(--brand-orange);
            color: white;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .main-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .content-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.07);
        }
        #map { 
            height: 200px; 
            width: 100%;
            border-radius: 1rem; 
            border: 3px solid #E0F7FA; 
        }
        .hidden { display: none !important; }

        .player-marker {
            background-color: var(--brand-orange);
            border: 2px solid white;
            border-radius: 50%;
            width: 20px !important;
            height: 20px !important;
            box-shadow: 0 0 10px var(--brand-orange);
        }
        /* task-marker elt√°vol√≠tva, m√°r nem haszn√°ljuk */
        .modal-overlay { z-index: 2000; }
        .geofence-circle {
            animation: pulse 2s infinite;
        }
        
        /* Elt√°vol√≠tva a Leaflet alap√©rtelmezett sz√≠n fel√ºl√≠r√°sa a CSS-ben, hogy a JS vez√©relje azt */
        
        @keyframes pulse {
            0% { stroke-width: 2; opacity: 0.8; }
            70% { stroke-width: 4; opacity: 0.2; }
            100% { stroke-width: 2; opacity: 0.8; }
        }
        .text-brand-orange-500 { color: var(--brand-orange); } /* Seg√©doszt√°ly */
        .text-brand-cyan-500 { color: var(--brand-cyan); } /* Seg√©doszt√°ly */

        /* JAV√çT√ÅS: Fejl√©c √°llapotjelz≈ë m√©ret√©nek glob√°lis cs√∂kkent√©se (kisebb bet≈±/sz√°m a jobb elrendez√©s√©rt) */
        .game-status-bar {
            font-size: 0.75rem; /* text-xs - Kisebb bet≈±m√©ret */
        }
        
/* --- JAV√çT√ÅS: Ugr√°l√≥ sz√°mok ellen --- */
.tabular-nums {
    font-variant-numeric: tabular-nums; /* Egys√©ges sz√©less√©g≈± sz√°mok */
    font-feature-settings: "tnum";
    letter-spacing: 0.5px; /* Kicsi ritk√≠t√°s az olvashat√≥s√°g√©rt */
    display: inline-block;
    min-width: 40px; /* Hely fenntart√°sa a sz√°moknak */
    text-align: center;
}

	.game-status-bar .flex {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }
        .game-status-bar .flex-col {
            gap: 0.5rem; /* Kisebb t√°vols√°g az elemek k√∂z√∂tt */
        }

        /* Vizu√°lis visszajelz√©s a felhaszn√°lt, de √∫jra n√©zhet≈ë seg√≠ts√©gekre */
        button.used {
            background-color: #d1fae5; /* Z√∂ldes h√°tt√©r a megn√©zett seg√≠ts√©gre */
            color: #065f46; /* S√∂t√©tz√∂ld sz√∂veg */
            cursor: pointer;
            border: 1px solid #a7f3d0;
        }
        button.used:hover:not(:disabled) {
            background-color: #a7f3d0;
        }

        /* √ñsszecsukhat√≥ T√∂rt√©net doboz st√≠lusa */
        .story-details {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            background-color: #f7fafc;
            position: relative; /* Fontos a gomb abszol√∫t pozicion√°l√°s√°hoz */
        }
        .story-details summary {
            font-weight: 600;
            color: var(--brand-blue);
            cursor: pointer;
            outline: none;
            padding: 0.5rem 0;
            list-style: none; /* Elt√°vol√≠tja az alap√©rtelmezett nyilat */
            display: flex;
            align-items: center;
            position: relative; /* EZ BIZTOS√çTJA A GOMB FIX√ÅL√ÅS√ÅT A SUMMARY-N BEL√úL */
        }
        .story-details summary::-webkit-details-marker {
            display: none;
        }
        .story-details summary::before {
            content: '+';
            font-size: 1.25rem;
            margin-right: 0.5rem;
            transition: transform 0.2s;
            line-height: 0;
        }
        .story-details[open] summary::before {
            content: '-';
            transform: rotate(0deg);
        }
        .story-content {
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
            margin-top: 0.5rem;
        }
        /* Extra CSS a gomb garant√°lt megjelen√≠t√©s√©hez √©s poz√≠ci√≥j√°hoz (FELOLVAS√ì GOMB JAV√çT√ÅS) */
        #speak-story-btn {
            position: absolute;
            top: 50%; /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            transform: translateY(-50%); /* M√≥dos√≠tva: K√∂z√©pre igaz√≠t√°s */
            right: 0.5rem; /* Be√°ll√≠tja a gomb v√≠zszintes helyzet√©t (bel√ºl) */
            display: flex !important; /* Er≈ësen kik√©nyszer√≠ti a l√°that√≥s√°got */
            width: 32px; /* Kisebb m√©ret */
            height: 32px; /* Kisebb m√©ret */
            align-items: center;
            justify-content: center;
            padding: 0.35rem; /* Kisebb padding */
        }
        
        /* EMOJI JAV√çT√ÅS PDF-HEZ: K√©nyszer√≠tj√ºk a sz√≠nes emoji fontokat */
.avatar-icon {
    display: inline-block;
    margin-right: 0.25rem;
    font-size: 1.5rem; /* Kicsit nagyobbra vessz√ºk */
    line-height: 1;
    font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
}
        
        /* J√ÅT√âK K√ñZBENI FEJL√âC √âS STATUS BAR ST√çLUSAI */
        #game-header-logo-container {
            position: absolute;
            top: 5px !important;  /* Teljesen a tetej√©re h√∫zzuk */
            left: 10px !important;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        
/* --- √öJ SZAB√ÅLY: Fejl√©c magass√°g√°nak n√∂vel√©se --- */
        
        #game-header-logo {
            height: 60px !important; /* Kisebb m√©ret, hogy ne l√≥gjon bele semmibe */
            width: auto;
            object-fit: contain;
        }
        
        /* 2. K√ñZ√âPS≈ê R√âSZ (N√©v + Avatar + Teszt felirat) */
        #center-header-content {
    position: absolute;
    top: 10px !important; /* 0px helyett 10px, √≠gy lejjebb ker√ºl */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1005;
    width: auto;
    padding-top: 5px;
}
        
        #team-name-container {
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            background-color: rgba(255, 255, 255, 0.9); /* Feh√©r h√°tt√©r, hogy olvashat√≥ legyen */
            padding: 2px 10px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2px; /* Hely a teszt feliratnak */
        }
        
        /* Teszt m√≥d felirat st√≠lusa */
        #test-mode-indicator {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 0 4px;
            border-radius: 4px;
            font-size: 0.65rem !important; /* Kisebb bet≈±m√©ret, hogy elf√©rjen */
            line-height: 1.2;
        }
        
        /* 3. STATUS BAR (Pontsz√°m, Id≈ë - LEJJEBB TOLVA) */
        #game-status-bar {
             position: absolute;
             top: 67px !important; /* FONTOS: Ez tolja le a s√°vot, hogy ne fedje √°t a nevet! */
             left: 0;
             right: 0;
             z-index: 900;
             display: flex;
             justify-content: center;
        }
        
        /* 4. KIL√âP√âS GOMB (Jobb fels≈ë sarok) */
        #exit-game-btn {
            position: absolute;
            z-index: 1000;
            top: 5px !important; 
            right: 10px !important;
            /* Biztos√≠tjuk, hogy a gomb m√©rete fix legyen */
            width: 35px;
            height: 35px;
            padding: 6px;
        }

        /* Hiba bejelent√©s modal st√≠lusai */
        #report-error-modal {
            z-index: 9999; 
            background-color: rgba(0, 0, 0, 0.7);
        }
      


	 #report-error-modal-content {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 90%;
            width: 350px;
        }
        
        /* --- KALANDV√ÅLASZT√ì OLDAL FEJL√âC ST√çLUSAI (JAV√çTVA) --- */
        
                
        /* K√∂z√©ps≈ë log√≥ m√©ret√©nek kicsiny√≠t√©se a Kalandv√°laszt√≥ oldalon */
        #main-header-logo {
            max-width: 90px; /* Elegend≈ë helyet hagy az oldals√≥ k√©peknek √©s az alatta l√©v≈ë tartalomnak */
            height: auto;
        }
        
        /* --- LANDING PAGE (IND√çT√ì OLDAL) VISSZA√ÅLL√çTOTT ST√çLUSAI --- */
        #landing-page .w-full.h-\[20vh\] {
            height: 20vh; 
            padding-top: 2rem; 
        }
        
        /* Az SVG log√≥ eredeti m√©rete (a HTML-ben w-48) */
        #landing-page svg {
            width: 12rem; 
            height: auto;
        }
        /* Mivel a kor√°bbi k√≠s√©rletben beillesztett√ºk a #landing-logo-container-t, azt most elt√°vol√≠tjuk
           √©s vissza√°ll√≠tjuk az eredeti k√≥dot az ind√≠t√≥ oldalon. */
        
        /* √öJ CSS: T√©rk√©pes feladat v√°laszt√≥ marker EXPLORE m√≥dhoz */
        .task-selector-marker {
            background-color: var(--brand-cyan);
            border: 3px solid white;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            box-shadow: 0 0 10px var(--brand-cyan);
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="max-w-md mx-auto h-[100dvh] flex flex-col relative transition-all duration-500">

        <main id="landing-page" class="flex flex-col items-center justify-between text-center text-brand-blue h-full p-8">
            
            <div class="w-full h-[15vh] flex flex-col items-center justify-start pt-2">
                <h1 id="landing-title" class="text-6xl font-extrabold tracking-tight" style="text-shadow: 0 4px 15px rgba(0,0,0,0.1);"><span id="logo-o" class="text-brand-orange-500 cursor-pointer"></span></h1>
                
            </div>
            
            <div class="w-full flex flex-col justify-start flex-grow"> 
                <p id="loading-status" class="text-gray-600 my-4 h-5">Adatb√°zis automatikus bet√∂lt√©se...</p>
                
                <label for="excel-file-input-manual" id="manual-file-select-label" class="main-button w-full text-sm block cursor-pointer my-4 !bg-brand-blue hover:!bg-cyan-700 hidden">
                    Manu√°lis J√°t√©kf√°jl Kiv√°laszt√°sa
                </label>
                <input type="file" id="excel-file-input-manual" class="hidden" accept=".xlsx,.txt,.db">
                <div id="game-order-setup" class="my-4 p-4 bg-gray-50 rounded-xl hidden"></div> 
            </div>
            
            </main>
        
        <div id="content-wrapper" class="hidden absolute inset-0 transition-transform duration-500 translate-y-full">
            <div id="header" class="relative text-text-heading text-center pt-1 pb-10">
                 <div id="main-header">

<span class="absolute top-0 right-2 text-[9px] text-gray-500 font-mono tracking-widest opacity-50 pointer-events-none select-none">
       v1.0.12
   </span>

   <div id="main-header-logo-row" class="flex justify-center items-center mb-2 px-4">
       
        <img id="main-header-logo" src="logo/MystiGo_logo.png" alt="MystiGo Log√≥" class="w-full max-w-xs mx-4">
                 
   </div>
   <h1 id="page-title" class="text-sm font-bold tracking-wider mb-1">V√°lassz Kalandot</h1>
</div>
                 
                 <div id="game-header-logo-container" class="hidden">
                    <img id="game-header-logo" src="logo/MystiGo_logo.png" alt="MystiGo Log√≥">
                 </div>
                 
                 <div id="center-header-content" class="hidden">
                     <span id="test-mode-indicator" class="text-[10px] font-bold text-brand-orange-500 hidden mb-1 leading-tight">TESZT M√ìD</span>
		     <div id="team-name-container" class="text-sm font-semibold text-brand-blue/80 block">
                        <span id="game-team-avatar-icon" class="avatar-icon"></span>
                        <span id="team-name-display"></span>
                     </div>
                  </div>
                 
                 <div id="game-status-bar" class="hidden px-2 w-full flex justify-center">
    <div class="bg-white/90 backdrop-blur-sm rounded-full flex justify-between items-center px-3 py-2 text-xs font-semibold shadow-md w-full max-w-sm border border-gray-100">
        
        <div class="px-2 whitespace-nowrap text-brand-blue -ml-2">
    Feladat: <span id="task-progress-display">1/10</span>
</div>
        
        <div class="flex items-center gap-1.5">
            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-brand-blue min-w-[70px]">
                <svg class="w-3 h-3 text-brand-cyan-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span id="timer-display" class="tabular-nums">00:00</span>
            </div>

            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-green-700 min-w-[70px]">
                <svg class="w-3 h-3 text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                <span id="geofence-timer-display" class="tabular-nums">00:00</span>
            </div>

            <div class="flex items-center justify-center gap-1 bg-gray-50 border border-gray-200 px-2 py-1 rounded-full text-brand-orange-500 min-w-[50px]">
                <svg class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1-81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                <span id="score-display" class="tabular-nums">0</span>
            </div>
        </div>
    </div>
</div>
                 
                 <button id="exit-game-btn" onclick="showExitConfirmation()" 
    class="absolute top-4 right-4 p-2.5 rounded-full text-white 
           bg-gradient-to-br from-red-400 to-red-600 
           border-2 border-white 
           shadow-lg shadow-red-500/30 
           hover:scale-110 hover:from-red-500 hover:to-red-700 hover:shadow-red-500/50
           transition-all duration-200 ease-in-out hidden z-50">
    <svg class="w-5 h-5 drop-shadow-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
</button>
                 
                 <svg class="absolute bottom-0 left-0 w-full" viewBox="0 0 1440 120" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1440 120H0V65.1721C0 65.1721 289.431 0 720 0C1150.57 0 1440 65.1721 1440 65.1721V120Z" fill="white"/></svg>
            </div>
            
            <div id="content-page-wrapper" class="absolute top-40 bottom-0 left-0 right-0 overflow-y-auto px-6 pb-6 bg-white">
                
                <section id="game-list-page" class="hidden">
                    <div id="game-list-controls" class="space-y-4 mb-6">
                        
                        
                        <div id="secret-switches-container" class="mt-4 p-4 bg-gray-50 rounded-xl hidden">
                            <h2 id="developer-tools-toggle" class="text-xs font-bold text-text-heading mb-3 cursor-pointer select-none flex justify-between items-center">
                                Fejleszt≈ëi Eszk√∂z√∂k
                                <span class="text-gray-50">‚ñº</span>
                            </h2>
                            <div id="developer-options" class="space-y-2 hidden">
                                
				<button onclick="openStorageManager()" class="main-button w-full text-sm block !bg-gray-700 hover:!bg-gray-800 my-4 flex items-center justify-center gap-2">
				    üíæ LocalStorage Kezel≈ë (R√©szletes)
				</button>

				<button id="list-all-games-btn" class="main-button w-full text-sm block !bg-indigo-600 hover:!bg-indigo-700 my-4">
			         √ñsszes J√°t√©k List√°z√°sa (Rejtett is)
			        </button>
				<label for="excel-file-input" class="main-button w-full text-sm block cursor-pointer my-4 !bg-brand-blue hover:!bg-cyan-700">
                                     Manu√°lis J√°t√©kf√°jl Kiv√°laszt√°sa
                                </label>
                                <input type="file" id="excel-file-input" class="hidden" accept=".xlsx,.txt,.db">

                                <button onclick="window.open('MystiGo_game_creator.html', '_blank')" class="main-button w-full text-sm block !bg-blue-600 hover:!bg-blue-700 my-4">
                                     Game Creator (Megnyit√°s)
                                </button>
                                
                                <button onclick="loadLocalXlsx('games/games_full_kids.xlsx')" class="main-button w-full text-sm block !bg-red-600 hover:!bg-red-700 my-4">
                                     Teszt Adatb√°zis Bet√∂lt√©se (games_full_kids.xlsx)
                                </button>
                                
                                <fieldset id="game-mode-select-fieldset" class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                    <legend class="text-xs font-bold text-text-heading mb-2">J√°t√©k M√≥d V√°laszt√°sa:</legend>
                                    <div class="space-y-1">
                                        
                                        <label for="mode-normal" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-normal" name="game_mode_selection" value="normal" checked class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Norm√°l J√°t√©k (GPS sz√ºks√©ges)</span>
                                        </label>
                                        
                                        <label for="mode-test" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-test" name="game_mode_selection" value="test" class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Teszt M√≥d (Geo-fence kikapcsolva)</span>
                                        </label>
                                        
                                        <label for="mode-mock" class="flex items-center cursor-pointer text-gray-700">
                                            <input type="radio" id="mode-mock" name="game_mode_selection" value="mock" class="h-4 w-4 text-cyan-500 border-gray-300 focus:ring-cyan-500">
                                            <span class="ml-2 text-sm font-medium">Manu√°lis GPS (T√©rk√©pen kattint√°s)</span>
                                        </label></div>
                                </fieldset>
                                <div id="game-mode-settings" class="p-4 bg-gray-100 rounded-xl border border-gray-200 mt-4">
                                    <p class="text-sm font-semibold text-brand-blue mb-2">Feladatok √©s Sorrend</p>
                                    
                                    <select id="task-order-select" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm mb-3">
                                        <option value="sequential">Szekvenci√°lis (Sorban)</option>
                                        <option value="random">V√©letlenszer≈± (Random)</option>
					<option value="explore">Explore (√∂sszes pont l√°tszik)</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                        
                        <details id="game-type-explanation" class="story-details mb-4" style="background-color: #fefce8; border-color: #fde68a;">
    <summary style="font-weight: 800; color: var(--brand-blue); padding: 0.5rem; display: flex; align-items: center;">
        <span class="text-xl mr-2">‚ÑπÔ∏è</span> Hogyan m≈±k√∂dik a MystiGo?
        <span style="position: absolute; right: 0.75rem; top: 0.8rem; font-size: 1.5rem;"></span>
    </summary>
                            <div class="story-content" style="border-top: 1px solid #fde68a; margin-top: 0.5rem; padding-top: 0.5rem;">
                                
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p>üì± Telefon + GPS + internet sz√ºks√©ges</p>
                                   <p>üîã T√∂ltsd fel az akkut (vagy hozz powerbankot)</p>
                                   <p>üìç Menj a j√°t√©k kezd≈ëpontj√°ra ‚Äì ott indul el a j√°t√©k</p>
                                   <p>üó∫Ô∏è K√∂vesd a t√©rk√©pen a c√©lpontokat</p>
                                   <p>üß© A k√©rd√©s csak a helysz√≠nen jelenik meg</p>
                                   <p>‚≠ê Minden feladat 50 pontot √©r</p>
                                   <p>üí° K√©rhetsz 2 seg√≠ts√©get (‚àí10 / ‚àí20 pont) vagy megold√°st (0 pont)</p>
                                   <p>‚ùå Minden rossz v√°lasz: ‚àí1 pont</p>
                                   
                                   <div class="mt-3 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                       <p class="font-bold text-brand-blue mb-1">üèÜ Rangsorol√°s sorrendje:</p>
                                       <ol class="list-decimal list-inside space-y-1 ml-1">
                                           <li><strong>‚≠êSzerzett Pontok</strong> (Ez a legfontosabb!)</li>
                                           <li><strong>üß©Feladat id≈ë</strong> (Csak a k√©rd√©s megold√°sa alatt telik)</li>
                                           <li><strong>‚è±Ô∏èTeljes id≈ë</strong> (S√©ta + gondolkod√°s)</li>
                                       </ol>
                                       <div class="mt-2 flex items-start gap-2 text-xs text-blue-800 bg-white p-2 rounded border border-blue-100">
                                           <span class="text-lg">üí°</span>
                                           <span><strong>Tipp:</strong> Nem kell rohanni a helysz√≠nek k√∂z√∂tt! A teljes id≈ë sz√°m√≠t legkev√©sb√©. Team j√°t√©kn√°l nyugodtan s√©t√°ljatok, a pontoss√°g √©s a biztons√°g a legfontosabb!</span>
                                       </div>
                                   </div>

                                   <p>‚è±Ô∏è K√©t id≈ëm√©r√©s a k√©perny≈ën:</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ üîµ K√©k = Teljes id≈ë (kev√©sb√© sz√°m√≠t)</p>
                                   <p style="margin-left: 1.5rem">‚Ä¢ üü¢ Z√∂ld = Feladat id≈ë (fontosabb!)</p>
                                   <p class="mt-2">‚ö†Ô∏è Ha gond van az adott feladattal, haszn√°ld a <strong>‚ÄûFeladat √°tugr√°sa‚Äù</strong> gombot, de ilyenkor az adott feladat 0 pontot fog √©rni.</p>
                                </div>
                                
                                <h2 class="text-lg font-bold text-text-heading mt-4 mb-2">Kaland T√≠pusok Magyar√°zata</h2>
                                <div class="space-y-2 text-sm text-gray-700">
                                   <p><strong>Normal üß≠:</strong> √Åltal√°nos kaland, feln≈ëtt/tin√©dzser (14+) j√°t√©kosoknak sz√°nt k√©rd√©sekkel √©s feladatokkal. A feladatok sorrendben k√∂vetik egym√°st.</p>
                                    <p><strong>Kids üêà:</strong> Kimondottan 6-12 √©ves gyerekeknek sz√≥l√≥, egyszer≈±bb k√©rd√©sek, a Mysti cica t√∂rt√©net√©vel f≈±szerezve, sorban halad√≥ feladatokkal.</p>
                                    <p><strong>Team üßë‚Äçü§ù‚Äçüßë:</strong> Csapatj√°t√©kra optimaliz√°lt. A feladatok *v√°ltoz√≥ sorrendben* j√∂nnek egym√°s ut√°n, egyszerre tudnak indulni egy helyr≈ël a csapatok, √©s egy helyen v√©geznek a j√°t√©k v√©g√©n.</p>
                                    <p><strong>Explore üåç:</strong> A j√°t√©kos szabadon v√°laszt a t√©rk√©pen l√©v≈ë feladatok k√∂z√ºl. A c√©lpontok a j√°t√©k ind√≠t√°sa ut√°n egyszerre l√°that√≥k a t√©rk√©pen.</p>
                                </div>


<div class="mt-6 pt-4 border-t border-gray-200">
                                    <p class="text-xs font-bold text-gray-500 mb-1 text-center uppercase tracking-wide">Probl√©m√°d ad√≥dott?</p>
                                    
                                    <p class="text-[10px] text-gray-400 text-center mb-3 italic">
                                        (Minden oldal legalj√°n is megtal√°lod ezt a gombot)
                                    </p>

                                    <a href="https://forms.gle/Kzt5CvVrCxec2bby9" target="_blank" 
                                       class="block w-full py-2.5 rounded-lg border border-red-200 bg-white text-xs font-bold text-center text-red-600 hover:bg-red-50 hover:border-red-300 transition shadow-sm flex items-center justify-center gap-2">
                                        <span>üì¢</span> Visszajelz√©s / Hiba bejelent√©se
                                    </a>
                                </div>
                                </div> </details>

                        <div id="team-setup" class="p-4 bg-blue-50 rounded-xl border border-blue-200">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-bold text-text-heading">J√°t√©kos<span class="text-red-500">*</span></h2>
        
        <label class="flex items-center cursor-pointer gap-2 select-none bg-yellow-100 px-3 py-1 rounded-full border border-yellow-200 hover:bg-yellow-200 transition">
            <span class="text-xs font-bold text-yellow-800 uppercase tracking-wide">Kids M√≥d üêà</span>
            <input type="checkbox" id="kids-mode-checkbox" class="w-4 h-4 text-brand-orange border-gray-300 rounded focus:ring-brand-orange accent-orange-500">
        </label>
    </div>
    
    <input type="text" id="team-name-input" maxlength="25" placeholder="Pl. Vill√°m-Macsk√°k 2024" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-blue outline-none">
    
        
    <select id="team-avatar-select" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg text-sm">
        <option value="">V√°lassz Avatart</option>
        <option value="cat">Mysti üê±</option>
        <option value="dog">Kutya üê∂</option>
        <option value="panda">Panda üêº</option>
        <option value="zombie">Zombi üßü</option>
        <option value="shark">C√°pa ü¶à</option>
        <option value="parrot">Papag√°j ü¶ú</option>
        <option value="bear">Maci üêª</option>
        <option value="cow">Boci üêÆ</option>
        <option value="elephant">Elef√°nt üêò</option>
        <option value="detective">Nyomoz√≥ üïµÔ∏è</option>
        <option value="explorer">Felfedez≈ë üß≠</option>
        <option value="wizard">Var√°zsl√≥ üßô</option>
        <option value="robot">Robot ü§ñ</option>
        <option value="ghost">Szellem üëª</option>
        <option value="skull">Koponya ‚ò†Ô∏è</option>
        <option value="lock">Lakat üîí</option>
        <option value="magician">B≈±v√©sz üé©</option>
        <option value="mask">√Ålarc üé≠</option>
        <option value="fire">T≈±z üî•</option>
        <option value="knight">Lovag ‚öîÔ∏è</option>
        <option value="hamburger">Hamburger üçî</option>
        <option value="pizza">Pizza üçï</option>
        <option value="doughnut">F√°nk üç©</option>
        <option value="cupcake">Muffin üßÅ</option>
        <option value="lollipop">Nyal√≥ka üç≠</option>
        <option value="smile">Smile üòé</option>
        <option value="ballerina">Belerina ü©∞</option>
        <option value="police">Rend≈ër üöì</option>
        <option value="firefighter">T≈±zolt√≥ üöí</option>
        <option value="ambulance">Ment≈ë üöë</option>
        <option value="star">Csillag ‚≠êÔ∏è</option>
        <option value="heart">Sz√≠v ‚ù§Ô∏è</option>
        <option value="crown">Korona üëë</option>
        <option value="laptop">Laptop üíª</option>
        <option value="floppy">Floppy üíæ</option>
    </select>
<div class="flex justify-between items-start mt-1 mb-3">
        <p class="text-[10px] text-gray-500 italic">
            üí° Tipp: V√°lassz egyedi nevet √©s avatart, hogy k√∂nnyen megtal√°ld magad a ranglist√°n!
        </p>
    </div>



    <div id="auth-icons-container" class="my-6 text-center">
        
        <div id="login-buttons-wrapper" class="flex justify-center items-center gap-6">
            
            <button onclick="loginWithGoogle()" class="group relative flex items-center justify-center p-3 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-300 border border-gray-100" title="Bel√©p√©s Google fi√≥kkal">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition-transform">
                <span class="absolute -bottom-8 scale-0 transition-all rounded bg-gray-800 p-1 text-xs text-white group-hover:scale-100 w-max">Google bel√©p√©s</span>
            </button>

            <button onclick="openEmailModal()" class="group relative flex items-center justify-center p-3 bg-brand-blue rounded-full shadow-md hover:shadow-lg hover:bg-cyan-700 transition-all duration-300 border border-transparent" title="Bel√©p√©s Email c√≠mmel">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white group-hover:scale-110 transition-transform">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
    </svg>
    <span class="absolute -bottom-8 scale-0 transition-all rounded bg-gray-800 p-1 text-xs text-white group-hover:scale-100 w-max">Email bel√©p√©s</span>
</button>
        </div>

        <div id="user-profile-display" class="hidden max-w-[280px] mx-auto bg-white rounded-full p-1.5 pr-4 shadow-[0_4px_15px_rgba(0,0,0,0.05)] border border-gray-100 flex items-center justify-between transition-all hover:shadow-md">
    
    <div class="flex items-center gap-3 overflow-hidden">
        <div class="relative shrink-0">
            <img id="user-photo" src="" class="w-10 h-10 rounded-full object-cover border-2 border-brand-cyan">
            <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
        </div>
        
        <div class="flex flex-col justify-center text-left min-w-0">
            <span id="user-name" class="text-xs font-extrabold text-brand-blue truncate leading-tight block max-w-[140px]">
                </span>
        </div>
    </div>


    <button onclick="logout()" class="group flex items-center justify-center w-8 h-8 rounded-full bg-gray-50 hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors" title="Kil√©p√©s">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:scale-110 transition-transform">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
        </svg>
    </button>
</div>


    <button id="gps-test-btn" onclick="testGpsConnection()" class="w-full mt-3 py-2 bg-white border-2 border-gray-300 text-gray-600 hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
        üõ∞Ô∏è GPS M≈±k√∂d√©s√©nek Tesztel√©se
    </button>

    <button onclick="startSpecificTestGame()" class="w-full mt-2 py-2 bg-white border-2 border-gray-300 text-gray-600 hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
        üéÆ Teszt J√°t√©k Ind√≠t√°sa (GPS n√©lk√ºl)
    </button>

    <div id="gps-test-container" class="hidden mt-3 bg-white p-2 rounded-lg border border-gray-200 shadow-inner">
        <p id="gps-test-status" class="text-xs font-bold text-center text-brand-blue mb-2">üì° Jel keres√©se... (K√©rlek v√°rj)</p>
        <div id="gps-test-map" class="w-full h-40 rounded border border-gray-300 relative z-10"></div>
        <div id="gps-result-message" class="hidden mt-2 p-2 rounded text-xs font-bold text-center"></div>
        <div class="mt-2 text-[10px] text-gray-400 text-center">
            Pontoss√°g: <span id="gps-accuracy-value">-</span> m√©ter
        </div>
    </div>
</div>
          

          
<div id="filter-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 transition-all duration-300">
    <div onclick="toggleFilterSection()" class="cursor-pointer flex items-center justify-between select-none">
        <h3 class="text-sm font-bold text-brand-blue flex items-center">
            <span id="filter-toggle-icon" class="mr-2 text-lg font-extrabold text-brand-orange-500 leading-none" style="margin-top: -2px;">+</span>
            
            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            Kaland Keres√©se & Sz≈±r√©se
        </h3>
    </div>
    
    <div id="filter-content" class="hidden mt-3 pt-3 border-t border-gray-100">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">Helysz√≠n</label>
                <select id="filter-location" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                    <option value="all">√ñsszes Helysz√≠n</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 mb-1">T√≠pus</label>
                <select id="filter-type" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                    <option value="all">√ñsszes T√≠pus</option>
                    <option value="normal">Normal üß≠</option>
                    <option value="kids">Kids üêà</option>
                    <option value="team">Csapat üßë‚Äçü§ù‚Äçüßë</option>
                    <option value="explore">Explore üåç</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs font-semibold text-gray-500 mb-1">Keres√©s (N√©v, ID, V√°ros...)</label>
            <div class="relative">
                <input type="text" id="filter-search" oninput="applyFilters()" placeholder="√çrj be valamit..." class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 outline-none bg-gray-50">
                <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>
        
        <div class="mt-3 pt-3 border-t border-gray-100">
            <button onclick="sortGamesNearby()" id="btn-sort-nearby" class="w-full py-2 bg-white border-2 border-brand-blue text-brand-blue hover:bg-gray-100 hover:text-brand-blue font-bold rounded-lg text-xs transition flex items-center justify-center gap-2 shadow-sm">
                üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)
            </button>
            <p id="nearby-status" class="text-[10px] text-center text-gray-400 mt-1 hidden"></p>
        </div>
    </div>
</div>


		<div id="game-list" class="space-y-6"></div>
                </section>
                
                <section id="game-page" class="hidden space-y-6">
                    <div class="content-card p-4">
                        <div id="map"></div>
                        

                        <div class="mt-3 mb-2 flex justify-between items-center px-2 w-full">
       <button id="google-maps-btn" class="flex flex-col items-center justify-center text-xs text-brand-blue font-semibold hover:text-brand-cyan-500 transition" onclick="startNavigation()">
            <img src="logo/google_maps_icon.png" alt="Maps" class="w-5 h-5 mb-0.5 object-contain">
            <span>Navig√°l√°s</span>
        </button>
    
    <div class="flex-1 flex justify-center">
        <p id="distance-info" class="text-center text-xs font-bold whitespace-nowrap"></p>
    </div>
    

<button id="report-error-btn" class="flex flex-col items-center justify-center text-[10px] text-gray-500 font-semibold hover:text-red-500 transition leading-tight" onclick="showReportModal()">
     <span>‚ö†Ô∏è</span>
            <span>Feladat</span>
            <span>√°tugr√°sa</span>
        </button>

</div>


	    <button id="back-to-map-btn" onclick="backToExploreMap()" class="hidden mb-4 text-xs font-bold text-gray-500 hover:text-brand-blue flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Vissza a t√©rk√©pre (m√°sik feladatot v√°lasztok)
            </button>                        

                        <div id="start-task-button-container" class="mt-4 hidden">
                            <button id="start-game-btn" class="main-button w-full !text-lg !py-3 disabled:!bg-gray-400">
                                üöÄ Kaland Ind√≠t√°sa (Id≈ëm√©r√©s elindul)
                            </button>
                        </div>
                        <div id="explore-selection-container" class="mt-4 hidden text-center">
                            <h3 class="text-lg font-bold text-brand-blue mb-2">V√°lassz Feladatot a T√©rk√©pen!</h3>
                            <p class="text-sm text-gray-600 mb-4">A k√∂vetkez≈ë c√©lpont kiv√°laszt√°s√°hoz kattints egy k√©k jel√∂l≈ëre a t√©rk√©pen.</p>
                        </div>
                        </div>
                    
                    <div id="task-interaction-area"> 
                        <div id="normal-task-content">
                            <div class="content-card p-5">
                                
				<details id="story-details" class="story-details mb-4" open>
                                    <summary>
                                        T√∂rt√©net Olvas√°sa
                                        <button id="speak-story-btn" onclick="speakStory(event)" class="p-1.5 rounded-full bg-red-500 text-white hover:bg-red-600 transition" title="Felolvas√°s ind√≠t√°sa">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 12c0 1.767-1.026 3.29-2.5 4v-8c1.474.71 2.5 2.233 2.5 4zM16 12c0 2.222-1.39 4.14-3.333 4.889l1.455 1.455c2.427-.99 4.344-3.13 4.344-6.344s-1.917-5.354-4.344-6.344l-1.455 1.455C14.61 7.86 16 9.778 16 12zM8 9H4v6h4l5 5V4l-5 5z"/></svg>
                                        </button>
                                    </summary>
                                    <div class="story-content">
                                        <p id="story" class="text-text-dark"></p>
                                    </div>
                                </details>
                                
                                 <p id="prompt" class="font-bold text-lg text-text-heading mb-4"></p>


                                 <div id="answer-input-container" class="flex items-center gap-2">
                                   <input type="text" id="answer-input" placeholder="√çrd be a megold√°st..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-500 disabled:bg-gray-100">
                                   <button id="submit-answer-btn" class="p-3 bg-cyan-500 text-white rounded-full shadow-lg hover:bg-cyan-600 transition flex-shrink-0"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button>
                                </div>
                                 <div id="hint-buttons-container" class="flex justify-center gap-2 mt-4 text-xs font-semibold">
                                    <button id="hint1-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full disabled:opacity-50">Seg√≠ts√©g 1 (Pont: -10)</button>
                                    <button id="hint2-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full disabled:opacity-50" disabled>Seg√≠ts√©g 2 (Pont: -20)</button>
                                    <button id="solution-btn" class="bg-red-100 text-red-700 px-3 py-1 rounded-full disabled:opacity-50" disabled>Megold√°s (Pont: 0)</button>
                                </div>
                                
                                <div style="height: 14rem;">¬†</div>
                            </div>
                        </div>

                        <div id="rescue-task-content" class="hidden"></div> 
                    </div>
                    </section>
                
                <section id="end-page" class="hidden space-y-6 text-center flex flex-col items-center pt-8">
     <div id="pdf-content"> 
        
                        <h2 class="text-4xl font-bold text-text-heading">Sz√©p munka!</h2>
                        <p class="text-lg text-text-dark mb-4">Teljes√≠tetted a kalandot.</p>
                        <p id="end-timestamp" class="text-sm text-gray-500 mb-6"></p> 
                        <div id="route-map" style="height: 300px; width: 100%; border-radius: 1rem; border: 3px solid #E0F7FA; margin: 20px 0;"></div> 
                        <p id="end-story" class="text-text-dark my-4 max-w-prose"></p>
<div class="relative my-10"> <div class="absolute inset-0 flex flex-col items-center justify-center text-brand-orange-500">
        <span class="text-5xl font-extrabold" id="final-score" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);"></span> <span class="text-base font-bold">PONT</span> </div>
</div>
<div class="mt-20 text-center space-y-4 p-6 w-full max-w-xs bg-gray-50 rounded-lg mx-auto shadow-md">
    <p class="text-lg font-bold text-text-heading mb-1">
        <span id="final-team-avatar-icon" class="avatar-icon"></span>
        N√©v: <span id="final-team-display"></span>
    </p> 
    <p class="block">üß©Feladat Id≈ë: <strong id="final-geofence-time">00:00</strong></p>
    <p class="block">‚è±Ô∏èTeljes Id≈ë: <strong id="final-time">00:00</strong></p> 
    
</div>
                  
                    </div> 



<button onclick="openLeaderboardModal()" class="main-button w-full max-w-xs mx-auto mt-6 mb-2 !bg-brand-blue hover:!bg-cyan-700 shadow-xl flex items-center justify-center gap-2">
    <span>üèÜ</span> Ranglista Megtekint√©se
</button>

 
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                       
    
                    </div>

                    
                    <p class="text-sm text-gray-500 mb-4 mt-4 font-semibold">Oszd meg a teljes√≠t√©sed a k√∂z√∂ss√©gi m√©di√°n:</p>
                    <div id="social-share-buttons" class="flex space-x-6 justify-center">
                        <button onclick="shareResult('facebook')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Facebookon">
                            <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.35c0 .732.593 1.325 1.325 1.325h11.495v-9.294h-3.143v-3.626h3.143v-2.128c0-3.12 1.847-4.815 4.673-4.815 1.326 0 2.464.099 2.802.143v3.25l-1.921.001c-1.503 0-1.802.714-1.802 1.768v2.316h3.618l-.471 3.626h-3.147v9.294h6.115c.732 0 1.325-.593 1.325-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/></svg>
                        </button>
                        <button onclick="shareResult('system')" class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200" title="Megoszt√°s Instagramon/TikTokon/Egyebek">
                            <img src="logo/share.png" alt="√Åltal√°nos megoszt√°s" class="w-8 h-8">
                        </button>
                    </div>
<p></p>
<p></p>
                    <p class="text-sm text-gray-500 mb-4 mt-10">Amennyiben tetszett a j√°t√©k az al√°bbi lehet≈ës√©geken kereszt√ºl tudsz t√°mogatni minket:</p>

                    <div class="flex space-x-6 justify-center">
                            <a href="https://Revolut.Me/krisztwaeo" target="_blank" title="T√°mogat√°s Revoluton"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="logo/revolut.png" alt="Revolut Log√≥" class="w-8 h-8">
                            </a>
                            
                            <a href="https://paypal.me/mystigohu" target="_blank" title="T√°mogat√°s PayPalon"
                            class="p-2 rounded-full bg-white hover:bg-gray-100 transition shadow-lg flex items-center justify-center border border-gray-200">
                                <img src="logo/paypal.png" alt="PayPal Log√≥" class="w-8 h-8">
                            </a>
                    </div>                    
                                          
                     <a id="game-review-btn" 
   href="#" 
   target="_blank" 
   class="hidden main-button w-full max-w-xs !text-base hover:!bg-cyan-600 !text-white !font-extrabold mt-4 mb-4"
   style="background-color: var(--brand-cyan) !important;"
   title="√ârt√©keld a kalandot">
   K√©rlek, √âRT√âKELJ MINKET! ‚≠ê
</a>
                     
                     <button onclick="resetApp()" class="main-button w-full max-w-xs mt-auto !text-base">√öj Kaland</button>
                     
                     <div class="mt-4 p-2 text-center text-xs">
                        <a href="https://www.iubenda.com/privacy-policy/40995967" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Privacy Policy ">Adatv√©delmi Szab√°lyzat</a> | 
                        <a href="https://www.iubenda.com/privacy-policy/40995967/cookie-policy" class="iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe text-brand-blue/80 hover:text-brand-cyan-500 transition" title="Cookie Policy ">Cookie Szab√°lyzat</a>
                    </div>
                    </section>

<div class="w-full mt-auto pt-6 pb-6 px-4">
                    <a href="https://forms.gle/Kzt5CvVrCxec2bby9" target="_blank" 
                       class="block w-full py-2 rounded-xl border border-gray-200 bg-gray-50 text-[10px] uppercase tracking-widest font-bold text-center text-gray-400 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-all cursor-pointer no-underline shadow-sm">
                        üì¢ Visszajelz√©s / Hiba bejelent√©s
                    </a>
                </div>
                </div> </div>
    </div>


            </div>
        </div>
    </div>
    
    <div id="loading-overlay" class="modal-overlay fixed inset-0 bg-black/50 hidden items-center justify-center"><div class="w-16 h-16 border-4 border-white/20 border-t-white rounded-full animate-spin"></div></div>
    
    <div id="message-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 text-center max-w-sm w-full shadow-xl">
            <h2 id="message-title" class="text-xl font-bold text-text-heading mb-2"></h2>
            <p id="message-body" class="text-text-dark mb-6 whitespace-pre-wrap"></p>
            <div id="modal-button-container" class="flex gap-4">
                <button id="modal-ok-button" class="main-button flex-1 !text-base">Rendben</button>
                <button id="modal-cancel-button" class="main-button flex-1 !text-base !bg-gray-400 hover:!bg-gray-500 hidden">M√©gse</button>
            </div>
        </div>
    </div>

    <div id="report-error-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center p-4">
        <div id="report-error-modal-content" class="content-card p-5 bg-red-50 border-red-200 border">
            <h2 class="text-xl font-bold text-red-600 mb-2">Feladat √°tugr√°sa</h2>
            <p class="text-sm text-gray-700 mb-4">Amennyiben a helysz√≠n valami okb√≥l kifoly√≥lag nem el√©rhet≈ë, √°tugorhatod az adott feladatot. A feladat ebben az esetben *0 ponttal* teljes√≠tettnek min≈ës√ºl.</p>

            <div class="flex justify-between gap-4 mt-4">
                <button onclick="hideReportModal()" class="main-button flex-1 !text-sm !bg-gray-400 hover:!bg-gray-500">M√©gse</button>
                <button id="submit-error-report" onclick="handleSubmitError()" class="main-button flex-1 !text-sm !bg-red-600 hover:!bg-red-700">Igen szeretn√©m √°tugrani</button>
            </div>
        </div>
    </div>


    <div id="gps-help-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 9999;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-red-600 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    GPS Hiba / Be√°ll√≠t√°s
                </h2>
            </div>
            
            <p class="text-sm text-gray-700 mb-4 font-semibold">Nem siker√ºlt lek√©rni a pontos helyzeted. K√©rlek, ellen≈ërizd az al√°bbiakat:</p>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>üçé iPhone (iOS)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>Be√°ll√≠t√°sok > <strong>Adatv√©delem √©s biztons√°g</strong></li>
                    <li>Helymeghat√°roz√°s > <strong>Bekapcsolva</strong></li>
                    <li>Keresd meg a list√°ban a b√∂ng√©sz≈ët (Safari/Chrome)</li>
                    <li>V√°laszd: <strong>"Az alkalmaz√°s haszn√°lata k√∂zben"</strong></li>
                    <li>Kapcsold be: <strong>"Pontos helyzet"</strong></li>
                </ul>
            </div>
    
            <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-brand-blue mb-2 flex items-center text-sm">
                    <span>ü§ñ Android (Samsung, Xiaomi, stb.)</span>
                </h3>
                <ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">
                    <li>H√∫zd le az √©rtes√≠t√©si s√°vot √©s kapcsold be a <strong>Helyzet / GPS</strong> ikont.</li>
                    <li>Ha ez megvan: Chrome be√°ll√≠t√°sok > Webhelybe√°ll√≠t√°sok > Tart√≥zkod√°si hely. "A webhelyek lek√©rhetik az √ñn helyadatait" legyen bekapcsolva. A "Nincs enged√©lyezve" list√°ban ne legyen ott a https://mystigo.hu. Esetleg m√©g itt is ellen≈ërizd: Tartsd nyomva a Chrome ikont > App inf√≥ > Enged√©lyek > Hely > <strong>Enged√©lyez√©s</strong>.</li>
                </ul>
            </div>
    
            <button onclick="document.getElementById('gps-help-modal').classList.add('hidden')" class="main-button w-full !text-sm !py-3">√ârtem, megpr√≥b√°lom √∫jra</button>
        </div>
    </div>


<div id="leaderboard-modal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center p-4" style="z-index: 3000;">
    <div class="bg-white rounded-2xl p-0 w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
        
        <div id="leaderboard-header" class="bg-white p-4 flex justify-between items-center shrink-0 border-b border-gray-200">
            <h3 class="text-xl font-bold text-brand-blue flex items-center gap-2">
                <span>üèÜ</span> Ranglista
            </h3>
            <button onclick="document.getElementById('leaderboard-modal').classList.add('hidden')" class="text-gray-400 hover:text-brand-blue transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="overflow-y-auto p-4 flex-grow bg-gray-50">
            <table class="min-w-full text-xs">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="px-2 py-2 text-left text-gray-500">#</th>
                        <th class="px-2 py-2 text-left text-gray-500">Csapat</th>
                        <th class="px-2 py-2 text-center text-gray-500">Pont</th>
                        <th class="px-2 py-2 text-right text-gray-500">Id≈ë</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-modal-body" class="divide-y divide-gray-200 bg-white"></tbody>
            </table>
        </div>
        <div class="p-4 border-t border-gray-100 shrink-0 bg-white flex gap-3">
    <button onclick="downloadLeaderboardPDF()" class="main-button flex-1 !text-sm !py-2 !bg-green-600 hover:!bg-green-700 flex items-center justify-center gap-2">
        <span>üíæ</span> Ment√©s
    </button>
    
    <button onclick="document.getElementById('leaderboard-modal').classList.add('hidden')" class="main-button flex-1 !text-sm !py-2 !bg-gray-500 hover:!bg-gray-600">
        Bez√°r√°s
    </button>
</div>
    </div>
</div>


<div id="storage-manager-modal" class="modal-overlay fixed inset-0 bg-black/80 hidden items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[85vh]">
        <div class="bg-gray-800 p-4 rounded-t-2xl flex justify-between items-center shrink-0">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                üíæ Mem√≥ria Kezel≈ë
            </h3>
            <button onclick="document.getElementById('storage-manager-modal').classList.add('hidden')" class="text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="overflow-y-auto p-2 flex-grow bg-gray-50" id="storage-list-container">
            </div>

        <div class="p-4 border-t border-gray-200 bg-white rounded-b-2xl shrink-0 flex justify-between items-center gap-3">
            <span id="storage-count-display" class="text-xs text-gray-500 font-bold"></span>
            <div class="flex gap-2">
                <button onclick="nukeAllStorage()" class="px-3 py-2 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 transition">
                    üî• MINDENT T√ñR√ñL
                </button>
                <button onclick="document.getElementById('storage-manager-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 text-xs font-bold rounded hover:bg-gray-300 transition">
                    Bez√°r√°s
                </button>
            </div>
        </div>
    </div>
</div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, runTransaction, push, query, orderByChild, limitToLast, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider, 
    signOut, 
    onAuthStateChanged, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword,
    sendEmailVerification,
    sendPasswordResetEmail // <-- EZT ADD HOZZ√Å
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


  // --- !!! M√ÅSOLD VISSZA A SAJ√ÅT KULCSAIDAT A F√ÅJLB√ìL !!! ---
  const firebaseConfig = {
    apiKey: "AIzaSyCA7V1WXFCVhmw2BygHkrwhrSy1Taoohyw",
    authDomain: "mystigo-7b149.firebaseapp.com",
    databaseURL: "https://mystigo-7b149-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mystigo-7b149",
    storageBucket: "mystigo-7b149.firebasestorage.app",
    messagingSenderId: "616896082200",
    appId: "1:616896082200:web:b13c243df8eaac6d542e6d",
    measurementId: "G-PFDMYCJ9J1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
let currentUser = null; // Ebben t√°roljuk majd a bel√©pett felhaszn√°l√≥t


// --- EMAIL REGISZTR√ÅCI√ì (Meger≈ës√≠t≈ë email k√ºld√©ssel) ---
window.registerWithEmail = function() {
    const email = document.getElementById('email-input-field').value;
    const password = document.getElementById('password-input-field').value;

    if (!email || !password) { alert("K√©rlek add meg az email c√≠met √©s a jelsz√≥t!"); return; }
    if (password.length < 6) { alert("A jelsz√≥nak legal√°bb 6 karakternek kell lennie!"); return; }

    createUserWithEmailAndPassword(auth, email, password)
   .then((userCredential) => {
    const user = userCredential.user;
    
    // B≈ëv√≠tett hibakeres≈ë k√ºld√©s:
    sendEmailVerification(user)
        .then(() => {
            console.log("‚úÖ SIKER: Ellen≈ërz≈ë email elk√ºldve ide:", user.email);
            alert("Sikeres regisztr√°ci√≥!\n\nEgy meger≈ës√≠t≈ë linket k√ºldt√ºnk a(z) " + user.email + " c√≠mre.");
        })
        .catch((emailError) => {
            console.error("‚ùå HIBA az email k√ºld√©sekor:", emailError);
            alert("A fi√≥k l√©trej√∂tt, de az emailt nem tudtuk elk√ºldeni: " + emailError.message);
        });

    updateUserUI(true, user);
})
        .catch((error) => {
            console.error("Regisztr√°ci√≥s hiba:", error);
            let msg = "Hiba t√∂rt√©nt: " + error.message;
            if (error.code === 'auth/email-already-in-use') msg = "Ez az email c√≠m m√°r regisztr√°lva van. Pr√≥b√°lj meg ink√°bb bel√©pni!";
            if (error.code === 'auth/invalid-email') msg = "Hib√°s email c√≠m form√°tum.";
            if (error.code === 'auth/weak-password') msg = "T√∫l gyenge jelsz√≥ (min. 6 karakter).";
            alert(msg);
        });
};

  // --- EMAIL BEL√âP√âS ---
  window.loginWithEmail = function() {
      const email = document.getElementById('email-input-field').value;
      const password = document.getElementById('password-input-field').value;

      if (!email || !password) { alert("K√©rlek add meg az email c√≠met √©s a jelsz√≥t!"); return; }

      signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
    const user = userCredential.user;
    
    if (!user.emailVerified) {
        // Csak sz√≥lunk neki, de engedj√ºk j√°tszani
        alert("Figyelem! M√©g nem er≈ës√≠tetted meg az email c√≠medet.\nN√©zd meg a postafi√≥kodat (a Spam mapp√°t is)!");
    }
    
    console.log("Sikeres bel√©p√©s:", user.email);
})
          .catch((error) => {
              console.error(error);
              let msg = "Sikertelen bel√©p√©s.";
              if (error.code === 'auth/invalid-credential') msg = "Hib√°s email c√≠m vagy jelsz√≥.";
              if (error.code === 'auth/user-not-found') msg = "Nincs ilyen felhaszn√°l√≥. Regisztr√°lj el≈ëbb!";
              if (error.code === 'auth/wrong-password') msg = "Hib√°s jelsz√≥.";
              alert(msg);
          });
  };


// --- JELSZ√ì VISSZA√ÅLL√çT√ÅS K√âR√âSE ---
import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

window.requestPasswordReset = function(event) {
    event.preventDefault(); // Megakad√°lyozza az oldal √∫jrat√∂lt√©s√©t
    
    const emailInput = document.getElementById('email-input-field');
    const email = emailInput.value.trim();
    
    if (!email) {
        alert("K√©rlek, √≠rd be az email c√≠medet a fenti mez≈ëbe a vissza√°ll√≠t√°shoz!");
        emailInput.focus();
        return;
    }
    
    // Elk√ºldj√ºk a vissza√°ll√≠t√≥ emailt a Firebase-nek
    sendPasswordResetEmail(auth, email)
        .then(() => {
            // Bez√°rjuk a modalt, √©s √ºzen√ºnk a felhaszn√°l√≥nak
            window.closeEmailModal();
            showMessage(
                'Jelsz√≥ Vissza√°ll√≠t√°s', 
                `Egy linket k√ºldt√ºnk a(z) <strong>${email}</strong> c√≠mre. K√©rlek, n√©zd meg a be√©rkez≈ë leveleidet (√©s a Spam mapp√°t is!).`
            );
        })
        .catch((error) => {
            console.error("Jelsz√≥ vissza√°ll√≠t√°si hiba:", error);
            // Nem adjuk ki a pontos hib√°t biztons√°gi okokb√≥l (pl. user-not-found)
            window.closeEmailModal();
            showMessage(
                'Hiba t√∂rt√©nt', 
                `Sikertelen k√©r√©s. K√©rlek, ellen≈ërizd, hogy a <strong>${email}</strong> c√≠met haszn√°lod-e a bel√©p√©shez, vagy pr√≥b√°lj meg regisztr√°lni.`
            );
        });
};



// --- MODAL KEZEL√âS (EZ HI√ÅNYZOTT!) ---
window.openEmailModal = function() {
    const modal = document.getElementById('email-modal');
    const modalContent = document.getElementById('email-modal-content');
    if (modal && modalContent) {
        modal.classList.remove('hidden');
        // Kis anim√°ci√≥ a megjelen√©shez
        setTimeout(() => {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
    } else {
        console.error("Hiba: Nem tal√°lom az 'email-modal' elemet a HTML-ben!");
    }
};

window.closeEmailModal = function() {
    const modal = document.getElementById('email-modal');
    const modalContent = document.getElementById('email-modal-content');
    
    if (modal && modalContent) {
        // Kis anim√°ci√≥ az elt≈±n√©shez
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            // Mez≈ëk t√∂rl√©se bez√°r√°skor
            const emailInput = document.getElementById('email-input-field');
            const passInput = document.getElementById('password-input-field');
            if(emailInput) emailInput.value = '';
            if(passInput) passInput.value = '';
        }, 200); 
    }
};

// Bez√°r√°s, ha a s√∂t√©t h√°tt√©rre kattintanak (ez csak akkor fut le, ha l√©tezik az elem)
const emailModalEl = document.getElementById('email-modal');
if (emailModalEl) {
    emailModalEl.addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeEmailModal();
        }
    });
}


window.loginWithGoogle = function() {
      signInWithPopup(auth, provider)
          .then((result) => {
              const user = result.user;
              console.log("Bel√©pve:", user.displayName);
              document.getElementById('team-name-input').value = user.displayName;
              // Opcion√°lis: Ha van avatar v√°laszt√≥ logika, itt kezelheted
          }).catch((error) => {
              console.error("Hiba a bel√©p√©skor:", error);
              alert("Sikertelen bejelentkez√©s: " + error.message);
          });
  };

  window.logout = function() {
      signOut(auth).then(() => {
          console.log("Kil√©pve");
      });
  };

  onAuthStateChanged(auth, (user) => {
      if (user) {
          currentUser = user;
          updateUserUI(true, user); // Ez a f√ºggv√©ny a 3. l√©p√©sn√©l lesz defini√°lva
      } else {
          currentUser = null;
          updateUserUI(false);
      }
  });



  // 1. LIMIT (Marad)
  window.checkGameLimitAndIncrement = async function(gameId, maxPlayers) {
      if(!gameId) return true;
      const gameRef = ref(db, 'games/' + gameId + '/count');
      try {
          const result = await runTransaction(gameRef, (currentCount) => {
              const count = (currentCount || 0);
              return count < maxPlayers ? count + 1 : undefined;
          });
          return result.committed;
      } catch (error) { console.error(error); return true; }
  };


// --- PROFIL MENT√âSE (N√©v + Avatar) ---
window.saveUserProfileToFirebase = function() {
    // Csak akkor ment√ºnk, ha van bel√©pett felhaszn√°l√≥
    if (currentUser) {
        const uid = currentUser.uid;
        const name = document.getElementById('team-name-input').value;
        const avatar = document.getElementById('team-avatar-select').value;

        // Ment√©s a 'users/UID/profile' √∫tvonalra
        set(ref(db, 'users/' + uid + '/profile'), {
            teamName: name,
            teamAvatar: avatar,
            lastUpdated: Date.now()
        }).then(() => {
            console.log("Profil adatok szinkroniz√°lva a felh≈ëbe.");
        }).catch((error) => {
            console.error("Hiba a profil ment√©sekor:", error);
        });
    }
};



 // 2. MENT√âS (Eredeti + Google ment√©s egyes√≠tve)
  window.saveScoreToFirebase = function(data) {
      if (!data.gameId) return;

      // --- A. R√âSZ: EREDETI RANGLISTA MENT√âS (EZ KELL A K√ñZ√ñS LIST√ÅHOZ!) ---
      
      // D√°tum form√°z√°sa
      const now = new Date();
      const readableDate = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

      // Ment√©s a k√∂z√∂s 'leaderboard'-ba
      const leaderboardRef = ref(db, 'leaderboard/' + data.gameId);
      push(leaderboardRef, {
          teamName: data.teamName || "N√©vtelen",
          teamAvatar: data.teamAvatar || "no avatar",
          score: data.score,
          totalTime: data.totalTime,
          geofenceTime: data.geofenceTime,
          timestamp: Date.now(),
          dateString: readableDate 
      });

      // --- B. R√âSZ: √öJ GOOGLE PROFIL MENT√âS (EZ AZ √öJ R√âSZ) ---
      
      // Csak akkor fut le, ha a felhaszn√°l√≥ be van jelentkezve
      if (currentUser) {
          const uid = currentUser.uid;
          const userHistoryRef = ref(db, 'users/' + uid + '/history');
          const userTotalRef = ref(db, 'users/' + uid + '/totalScore');

          // 1. Elmentj√ºk a j√°t√©kot a j√°t√©kos saj√°t el≈ëzm√©nyeibe
          push(userHistoryRef, {
              gameId: data.gameId,
              score: data.score,
              date: Date.now(),
              dateString: readableDate, 
              teamName: data.teamName
          });

          // 2. Friss√≠tj√ºk az √∂sszpontsz√°m√°t
          runTransaction(userTotalRef, (currentScore) => {
              return (currentScore || 0) + data.score;
          });
          
          console.log("Pontsz√°m mentve a felhaszn√°l√≥i profilhoz is.");
      }
  };



   

 // --- √öJ FEJLETT RANGLISTA LOGIKA

// Glob√°lis v√°ltoz√≥ az adatok t√°rol√°s√°ra
  window.currentLeaderboardData = [];

  // 1. MODAL MEGNYIT√ÅSA √âS UI EL≈êK√âSZ√çT√âSE (JAV√çTVA: M√©g sz≈±kebb oszlopok √©s paddingok)
  window.openLeaderboardModal = async function(specificGameId = null) {
      const gameId = specificGameId || window.currentGameId;

      if (!gameId) {
        alert("Nincs akt√≠v j√°t√©k azonos√≠t√≥. El≈ëbb v√°lassz egy j√°t√©kot!");
        return;
    }

      const modal = document.getElementById('leaderboard-modal');
      const listBody = document.getElementById('leaderboard-modal-body');
      
      const modalHeader = document.getElementById('leaderboard-header'); 
      let filterContainer = document.getElementById('leaderboard-filters');
      
      if (!filterContainer && modalHeader) {
          filterContainer = document.createElement('div');
          filterContainer.id = 'leaderboard-filters';
          filterContainer.className = "bg-white border-b border-gray-200 p-3 space-y-3";
          filterContainer.innerHTML = `
            <div class="flex rounded-lg bg-gray-100 p-1">
                <button onclick="filterLeaderboard('today')" id="btn-filter-today" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm">
                    üìÖ Mai nap
                </button>
                <button onclick="filterLeaderboard('all')" id="btn-filter-all" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue">
                    üèÜ √ñsszes
                </button>
            </div>
            <div class="relative">
                <input type="text" id="leaderboard-search" onkeyup="filterLeaderboard()" placeholder="üîç Csapatn√©v keres√©se..." class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs focus:ring-2 focus:ring-brand-blue outline-none">
                <svg class="w-4 h-4 text-gray-400 absolute left-2.5 top-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
          `;
          modalHeader.insertAdjacentElement('afterend', filterContainer);
      }

// --- RANGLISTA PDF MENT√âSE ---
  window.downloadLeaderboardPDF = function() {
      // 1. Az elemek kiv√°laszt√°sa
      const listBody = document.getElementById('leaderboard-modal-body');
      if (!listBody || listBody.rows.length === 0) {
          alert("Nincs mit menteni, a lista √ºres.");
          return;
      }

      // Visszajelz√©s a gombon (opcion√°lis UX)
      const btn = event.currentTarget;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Gener√°l√°s...';
      btn.disabled = true;

      // 2. Ideiglenes kont√©ner l√©trehoz√°sa a PDF gener√°l√°shoz
      // Ez az√©rt kell, hogy "kivegy√ºk" a t√°bl√°zatot a g√∂rgethet≈ë (scroll) ablakb√≥l,
      // √≠gy a PDF-ben a teljes lista l√°tszani fog, nem csak ami √©pp a k√©perny≈ën van.
      const wrapper = document.createElement('div');
      wrapper.style.padding = '20px';
      wrapper.style.fontFamily = 'sans-serif';
      wrapper.style.background = 'white';
      wrapper.style.color = '#0D2B45';

      // C√≠m √©s d√°tum
      const dateStr = new Date().toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' });
      const activeGameId = window.currentGameId || "Ismeretlen";
      
      wrapper.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 24px; color: #0D2B45;">üèÜ MystiGo Ranglista</h1>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Kaland: <strong>${activeGameId}</strong> | D√°tum: ${dateStr}</p>
        </div>
      `;

      // T√°bl√°zat kl√≥noz√°sa
      const originalTable = document.querySelector('#leaderboard-modal table');
      const clonedTable = originalTable.cloneNode(true);
      
      // St√≠lus igaz√≠t√°s a PDF-hez (hogy biztosan sz√©p legyen feh√©r h√°tt√©rrel)
      clonedTable.style.width = '100%';
      clonedTable.style.borderCollapse = 'collapse';
      clonedTable.style.fontSize = '12px';
      
      // Fejl√©c sz√≠nez√©se a kl√≥nban
      const thead = clonedTable.querySelector('thead');
      if(thead) thead.style.backgroundColor = '#f3f4f6';
      
      wrapper.appendChild(clonedTable);

      // 3. PDF Gener√°l√°s
      const opt = {
          margin:       10,
          filename:     `MystiGo_Ranglista_${activeGameId}_${new Date().toISOString().slice(0,10)}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().from(wrapper).set(opt).save().then(() => {
          // Vissza√°ll√≠t√°s
          btn.innerHTML = originalText;
          btn.disabled = false;
      }).catch(err => {
          console.error(err);
          alert("Hiba t√∂rt√©nt a ment√©s k√∂zben.");
          btn.innerHTML = originalText;
          btn.disabled = false;
      });
  };


      // --- T√ÅBL√ÅZAT FEJL√âC SZ≈∞K√çT√âSE ---
      const tableHead = modal.querySelector('thead');
      if (tableHead) {
          tableHead.innerHTML = `
            <tr>
                <th class="px-1 py-2 text-center text-gray-500 w-6">#</th>
                
                <th class="px-1 py-2 text-left text-gray-500">Csapat</th>
                
                <th class="pl-1 pr-0 py-2 text-right text-gray-500 w-10">Pont</th> 
                
                <th class="pl-1 pr-1 py-2 text-right text-gray-500 w-24">Id≈ë</th> 
            </tr>
          `;
      }

      modal.classList.remove('hidden');
      
      listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8"><div class="animate-spin h-6 w-6 border-2 border-brand-blue border-t-transparent rounded-full mx-auto mb-2"></div>Bet√∂lt√©s...</td></tr>';

      try {
          const q = query(ref(db, 'leaderboard/' + gameId));
          const snapshot = await get(q);

          if (!snapshot.exists()) {
              listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">M√©g nincs eredm√©ny ehhez a j√°t√©khoz.</td></tr>';
              window.currentLeaderboardData = [];
              return;
          }

          let results = [];
          snapshot.forEach((child) => {
              const val = child.val();
              if (val.score === undefined || val.score === null) {
                  val.score = 0; 
                  val.teamName = (val.teamName || "Hib√°s adat") + " (Nincs pont)";
              }
              results.push(val);
          });

          window.currentLeaderboardData = results;
          
          setTimeout(() => {
              // 1. Kirajzoljuk a list√°t
              filterLeaderboard('today'); 
              
              // 2. √öJ: Odag√∂rget√ºnk a saj√°t sorhoz (kis k√©sleltet√©ssel, hogy biztosan ott legyen m√°r a DOM-ban)
              setTimeout(() => {
                  const myRow = document.getElementById('my-leaderboard-row');
                  if (myRow) {
                      myRow.scrollIntoView({ behavior: "smooth", block: "center" });
                  }
              }, 100);
              
          }, 50);

   } catch (error) {
          console.error("Hiba:", error);
          listBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Hiba t√∂rt√©nt: ${error.message}</td></tr>`;
      }
  };


  // 2. SZ≈∞R≈ê LOGIKA (JAV√çTOTT SORREND: Sz≈±r√©s -> Rendez√©s -> Rangsorol√°s -> Keres√©s)
  window.filterLeaderboard = function(modeParam) {
      let mode = modeParam;
      const btnToday = document.getElementById('btn-filter-today');
      const btnAll = document.getElementById('btn-filter-all');
      
      // Ha nincs param√©ter, megn√©zz√ºk melyik gomb akt√≠v
      if (!mode) {
          if(!btnToday) return; 
          mode = btnToday.classList.contains('bg-white') ? 'today' : 'all';
      }

      // Gombok st√≠lus√°nak friss√≠t√©se
      if (mode === 'today') {
          btnToday.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm";
          btnAll.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue hover:bg-gray-200";
      } else {
          btnAll.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition-all bg-white text-brand-blue shadow-sm";
          btnToday.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-gray-500 hover:text-brand-blue hover:bg-gray-200";
      }

      const searchInput = document.getElementById('leaderboard-search');
      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : "";
      
      // Mindig az eredeti, teljes list√°b√≥l indulunk ki
      let data = [...window.currentLeaderboardData];

      // L√âP√âS 1: Id≈ëszak sz≈±r√©se (Ki tartozik a "mez≈ënybe"?)
      if (mode === 'today') {
          const startOfToday = new Date();
          startOfToday.setHours(0, 0, 0, 0);
          data = data.filter(r => r.timestamp >= startOfToday.getTime());
      }

      // L√âP√âS 2: Rendez√©s (Pont -> Feladat Id≈ë -> Teljes Id≈ë)
      // Fontos: Ezt M√âG A KERES√âS EL≈êTT megcsin√°ljuk!
      data.sort((a, b) => {
          const scoreDiff = b.score - a.score;
          if (scoreDiff !== 0) return scoreDiff;
          const taskTimeDiff = (a.geofenceTime || 0) - (b.geofenceTime || 0);
          if (taskTimeDiff !== 0) return taskTimeDiff;
          return (a.totalTime || 0) - (b.totalTime || 0);
      });

      // L√âP√âS 3: Val√≥di helyez√©s r√∂gz√≠t√©se
      // Hozz√°adunk egy 'actualRank' tulajdons√°got, ami megmondja, h√°nyadik a teljes mez≈ënyben
      data = data.map((item, index) => {
          return { ...item, actualRank: index + 1 };
      });

      // L√âP√âS 4: N√©v keres√©s
      // Most m√°r sz≈±rhet√ºnk n√©vre, mert a helyez√©s√ºket megjegyezt√ºk az el≈ëz≈ë l√©p√©sben
      if (searchTerm) {
          data = data.filter(r => r.teamName.toLowerCase().includes(searchTerm));
      }

      renderLeaderboardTable(data);
  };



// 3. T√ÅBL√ÅZAT MEGJELEN√çT√âSE (JAV√çTVA: N√©v mez≈ë 100px, Paddingok minimaliz√°lva)
  window.renderLeaderboardTable = function(results) {
      const listBody = document.getElementById('leaderboard-modal-body');
      
      if (results.length === 0) {
          listBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 italic">Nincs a sz≈±r√©snek megfelel≈ë tal√°lat.</td></tr>';
          return;
      }

      const avatars = {
             cat: 'üê±', dog: 'üê∂', panda: 'üêº', shark: 'ü¶à', parrot: 'ü¶ú', bear: 'üêª', cow: 'üêÆ', elephant: 'üêò', detective: 'üïµÔ∏è', explorer: 'üß≠', wizard: 'üßô', robot: 'ü§ñ',
             ghost: 'üëª', skull: '‚ò†Ô∏è', lock: 'üîí', magician: 'üé©', mask: 'üé≠', fire: 'üî•', knight: '‚öîÔ∏è', hamburger: 'üçî', pizza: 'üçï', doughnut: 'üç©', cupcake: 'üßÅ', lollipop: 'üç≠', smile: 'üòé', zombie: 'üßü',ballerina: 'ü©∞',police: 'üöì',firefighter: 'üöí',ambulance: 'üöë',star: '‚≠êÔ∏è', heart: '‚ù§Ô∏è', crown: 'üëë', laptop: 'üíª', floppy: 'üíæ', monkey: 'üêµ'
      };
      
      const fmt = (s) => {
         const m = Math.floor(s / 60).toString().padStart(2,'0');
         const sec = (s % 60).toString().padStart(2,'0');
         return `${m}:${sec}`;
      };
      
      const fmtDate = (ms) => { 
          const d = new Date(ms);
          const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
          return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}. ${timeStr}`; 
      };

      let html = "";
      
      results.slice(0, 100).forEach((r) => {
          const icon = avatars[r.teamAvatar] || 'üë§';
          const isMyTeam = (Math.abs(r.timestamp - Date.now()) < 120000 && r.score == window.currentScoreForHighlight);
          const rank = r.actualRank;

          let rankDisplay = `${rank}.`;
          let rowBg = ""; // Alapb√≥l feh√©r (√ºres)
          
          if (rank === 1) { rankDisplay = "ü•á"; }
          else if (rank === 2) { rankDisplay = "ü•à"; }
          else if (rank === 3) { rankDisplay = "ü•â"; }
          
          // 2. SAJ√ÅT CSAPAT KIEMEL√âSE (Ez fel√ºl√≠r mindent)
          if (isMyTeam) {
              rowBg = "bg-blue-200 border-l-4 border-l-red-400";
          }

          // √öJ: ID hozz√°ad√°sa, ha ez a saj√°t sorom, hogy k√©s≈ëbb odatudjunk g√∂rgetni
          const rowId = isMyTeam ? 'id="my-leaderboard-row"' : '';

          html += `
            <tr ${rowId} class="transition border-b border-gray-100 last:border-0 ${rowBg}">
                
                <td class="px-1 py-3 font-bold text-gray-500 text-center text-sm w-6 align-middle">${rankDisplay}</td>
                
                <td class="px-1 py-3 align-middle">
                    <div class="font-bold text-brand-blue flex items-center gap-1.5">
                        <span class="text-xl bg-white border border-gray-100 shadow-sm rounded-full w-8 h-8 flex items-center justify-center min-w-[32px] shrink-0">${icon}</span> 
                        
                        <span class="text-sm leading-tight break-words whitespace-normal min-w-0 w-[100px]" title="${r.teamName}">
                            ${r.teamName}
                        </span>
                    </div>
                    <div class="text-[10px] text-gray-400 ml-10 flex items-center gap-1 mt-1">
                        ‚è±Ô∏è ${fmtDate(r.timestamp)}
                    </div>
                </td>
                
                <td class="pl-1 pr-0 py-3 text-right font-extrabold text-brand-orange-500 text-base w-10 align-middle">
                    ${r.score}
                </td>
                
                <td class="pl-1 pr-1 py-3 text-right text-xs text-gray-600 leading-tight w-24 align-middle">
                    <div class="flex flex-col items-end gap-1">
                        <div title="Feladat id≈ë" class="font-semibold text-green-700 bg-green-50 px-1.5 py-0.5 rounded w-fit whitespace-nowrap">
                            üß© ${fmt(r.geofenceTime || 0)}
                        </div>
                        <div title="Teljes id≈ë" class="font-semibold text-brand-blue bg-blue-50 px-1.5 py-0.5 rounded w-fit whitespace-nowrap">
                            ‚è±Ô∏è ${fmt(r.totalTime || 0)}
                        </div>
                    </div>
                </td>
            </tr>
          `;
      });
      listBody.innerHTML = html;
  };



  // --- RANGLISTA K√ìD V√âGE ---

// --- √öJ R√âSZ: Befejezett j√°t√©kok sz√°mol√°sa ---
  window.incrementGameCompletion = async function(gameId) {
      if(!gameId) return;
      // A 'completed' csom√≥pontot n√∂velj√ºk az adott j√°t√©kon bel√ºl
      const gameRef = ref(db, 'games/' + gameId + '/completed');
      try {
          await runTransaction(gameRef, (currentCount) => {
              return (currentCount || 0) + 1;
          });
          console.log("Sikeres befejez√©s r√∂gz√≠tve.");
      } catch (error) {
          console.error("Hiba a befejez√©s r√∂gz√≠t√©sekor:", error);
      }
  };



// UI Friss√≠t√©se be/kil√©p√©skor (Moderniz√°lt verzi√≥)
// UI Friss√≠t√©se be/kil√©p√©skor (JAV√çTVA: Pontsz√°m duplik√°ci√≥)
function updateUserUI(isLoggedIn, user = null) {
    const loginButtonsWrapper = document.getElementById('login-buttons-wrapper');
    const profileDiv = document.getElementById('user-profile-display');
    const userNameEl = document.getElementById('user-name');
    
    window.closeEmailModal();

    if (isLoggedIn && user) {
        if(loginButtonsWrapper) loginButtonsWrapper.classList.add('hidden');
        profileDiv.classList.remove('hidden');
        
        // --- 1. Alapadatok be√°ll√≠t√°sa ---
        const displayName = user.displayName || user.email.split('@')[0];
        // Avatar alapbe√°ll√≠t√°s
        const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${displayName}&background=0D8ABC&color=fff&size=128`;
        document.getElementById('user-photo').src = photoURL;

        // --- ADATOK BET√ñLT√âSE A FELH≈êB≈êL ---
        const uid = user.uid;
        
        // 1. Profil (N√©v √©s Avatar) bet√∂lt√©se
        get(ref(db, 'users/' + uid + '/profile')).then((snapshot) => {
            let actualName = displayName;
            if (snapshot.exists() && snapshot.val().teamName) {
                actualName = snapshot.val().teamName;
                document.getElementById('team-name-input').value = actualName;
            }
            
            // ITT T√ñRL√úNK MINDENT √âS CSAK A NEVET √çRJUK BE ELS≈êK√âNT
            userNameEl.innerHTML = actualName; 
            
            // 2. √ñsszpontsz√°m bet√∂lt√©se √©s a N√âV AL√Å ragaszt√°sa
            return get(ref(db, 'users/' + uid + '/totalScore'));
            
        }).then((snapshot) => {
            const score = snapshot.exists() ? snapshot.val() : 0;
            
            // ITT ADJUK HOZZ√Å A PONTOT A N√âV AL√Å (CSAK EGYSZER!)
            if(userNameEl) {
                // A <br> seg√≠ts√©g√©vel a pontsz√°m a n√©v al√° ker√ºl
                userNameEl.innerHTML += `<br><span class="text-[10px] font-bold text-brand-orange-500 tracking-wide flex items-center gap-1 mt-0.5">‚≠ê ${score} pont</span>`;
            }
        
        }).catch((err) => console.error("Profil/Pontsz√°m bet√∂lt√©si hiba:", err));

        // Automatikus n√©vkit√∂lt√©s
        const nameInput = document.getElementById('team-name-input');
        if(nameInput && !nameInput.value) nameInput.value = displayName;

    } else {
        if(loginButtonsWrapper) loginButtonsWrapper.classList.remove('hidden');
        profileDiv.classList.add('hidden');
        
        // Mez≈ëk √ºr√≠t√©se kil√©p√©skor
        document.getElementById('team-name-input').value = '';
        document.getElementById('team-avatar-select').value = '';
    }
}



</script>



       
<script>
        // --- GLOBAL STATE & CONSTANTS ---
        let games = {};
	let badWordsList = [
            "bazd", "basz", "geci", "picsa", "szar", "kurva", "fos", "buzi",
            "fasz", "pina", "ribanc", "k√∂cs√∂g", "any√°d", "segg", "szop",
            "p√∂cs", "kurafi", "bunk√≥", "cig√°ny", "nigger", "zsid√≥", "buzer√°ns",
            "szuka", "perverz", "pedofil", "n√°ci", "hitler", "sperma", "orgia",
            "porn√≥", "szex", "kibasz", "megbasz", "faszfej", "balfasz",
            "balfaszok", "balfaszokat", "balfaszt", "barmok", "barmokat", "barmot",
            "barom", "baszik", "bazmeg", "buksza", "buksz√°k", "buksz√°kat", "buksz√°t",
            "b√∫r", "b√∫rok", "cs√∂cs", "cs√∂cs√∂k", "cs√∂cs√∂ket", "cs√∂cs√∂t", "faszfejek",
            "faszfejeket", "faszfejet", "faszok", "faszokat", "faszt", "fing",
            "fingok", "fingokat", "fingot", "franc", "francok", "francokat",
            "francot", "gecibb", "gecik", "geciket", "gecit", "kibaszott",
            "kibaszottabb", "k√∫r", "kurafik", "kurafikat", "kurafit", "kurv√°k",
            "kurv√°kat", "kurv√°t", "leggecibb", "legkibaszottabb", "legszarabb",
            "marha", "marh√°k", "marh√°kat", "marh√°t", "megd√∂glik", "pele", "pel√©k",
            "pics√°kat", "pics√°t", "pin√°k", "pin√°kat", "pin√°t", "pofa", "pof√°kat",
            "pof√°t", "p√∂cs√∂k", "p√∂cs√∂ket", "p√∂cs√∂t", "punci", "puncik", "seggek",
            "seggeket", "segget", "seggfej", "seggfejek", "seggfejeket", "seggfejet",
            "szajha", "szajh√°k", "szajh√°kat", "szajh√°t", "szarabb", "szarik",
            "szarok", "szarokat", "szart", "2g1c", "2 girls 1 cup", "acrotomophilia",
            "alabama hot pocket", "alaskan pipeline", "anal", "anilingus", "anus",
            "apeshit", "arsehole", "ass", "asshole", "assmunch", "auto erotic",
            "autoerotic", "babeland", "baby batter", "baby juice", "ball gag",
            "ball gravy", "ball kicking", "ball licking", "ball sack", "ball sucking",
            "bangbros", "bangbus", "bareback", "barely legal", "barenaked", "bastard",
            "bastardo", "bastinado", "bbw", "bdsm", "beaner", "beaners",
            "beaver cleaver", "beaver lips", "beastiality", "bestiality", "big black",
            "big breasts", "big knockers", "big tits", "bimbos", "birdlock", "bitch",
            "bitches", "black cock", "blonde action", "blonde on blonde action",
            "blowjob", "blow job", "blow your load", "blue waffle", "blumpkin",
            "bollocks", "bondage", "boner", "boob", "boobs", "booty call",
            "brown showers", "brunette action", "bukkake", "bulldyke", "bullet vibe",
            "bullshit", "bung hole", "bunghole", "busty", "butt", "buttcheeks",
            "butthole", "camel toe", "camgirl", "camslut", "camwhore", "carpet muncher",
            "carpetmuncher", "chocolate rosebuds", "cialis", "circlejerk",
            "cleveland steamer", "clit", "clitoris", "clover clamps", "clusterfuck",
            "cock", "cocks", "coprolagnia", "coprophilia", "cornhole", "coon",
            "coons", "creampie", "cum", "cumming", "cumshot", "cumshots",
            "cunnilingus", "cunt", "darkie", "date rape", "daterape", "deep throat",
            "deepthroat", "dendrophilia", "dick", "dildo", "dingleberry",
            "dingleberries", "dirty pillows", "dirty sanchez", "doggie style",
            "doggiestyle", "doggy style", "doggystyle", "dog style", "dolcett",
            "domination", "dominatrix", "dommes", "donkey punch", "double dong",
            "double penetration", "dp action", "dry hump", "dvda", "eat my ass",
            "ecchi", "ejaculation", "erotic", "erotism", "escort", "eunuch", "fag",
            "faggot", "fecal", "felch", "fellatio", "feltch", "female squirting",
            "femdom", "figging", "fingerbang", "fingering", "fisting", "foot fetish",
            "footjob", "frotting", "fuck", "fuck buttons", "fuckin", "fucking",
            "fucktards", "fudge packer", "fudgepacker", "futanari", "gangbang",
            "gang bang", "gay sex", "genitals", "giant cock", "girl on",
            "girl on top", "girls gone wild", "goatcx", "goatse", "god damn",
            "gokkun", "golden shower", "goodpoop", "goo girl", "goregasm", "grope",
            "group sex", "g-spot", "guro", "hand job", "handjob", "hard core",
            "hardcore", "hentai", "homoerotic", "honkey", "hooker", "horny",
            "hot carl", "hot chick", "how to kill", "how to murder", "huge fat",
            "humping", "incest", "intercourse", "jack off", "jail bait", "jailbait",
            "jelly donut", "jerk off", "jigaboo", "jiggaboo", "jiggerboo", "jizz",
            "juggs", "kike", "kinbaku", "kinkster", "kinky", "knobbing",
            "leather restraint", "leather straight jacket", "lemon party", "livesex",
            "lolita", "lovemaking", "make me come", "male squirting", "masturbate",
            "masturbating", "masturbation", "menage a trois", "milf",
            "missionary position", "mong", "motherfucker", "mound of venus",
            "mr hands", "muff diver", "muffdiving", "nambla", "nawashi", "negro",
            "neonazi", "nigga", "nig nog", "nimphomania", "nipple", "nipples",
            "nsfw", "nsfw images", "nude", "nudity", "nutten", "nympho",
            "nymphomania", "octopussy", "omorashi", "one cup two girls",
            "one guy one jar", "orgasm", "orgy", "paedophile", "paki", "panties",
            "panty", "pedobear", "pegging", "penis", "phone sex", "piece of shit",
            "pikey", "pissing", "piss pig", "pisspig", "playboy", "pleasure chest",
            "pole smoker", "ponyplay", "poof", "poon", "poontang", "punany",
            "poop chute", "poopchute", "porn", "porno", "pornography",
            "prince albert piercing", "pthc", "pubes", "pussy", "queaf", "queef",
            "quim", "raghead", "raging boner", "rape", "raping", "rapist", "rectum",
            "reverse cowgirl", "rimjob", "rimming", "rosy palm",
            "rosy palm and her 5 sisters", "rusty trombone", "sadism", "santorum",
            "scat", "schlong", "scissoring", "semen", "sexcam", "sexo", "sexy",
            "sexual", "sexually", "sexuality", "shaved beaver", "shaved pussy",
            "shemale", "shibari", "shit", "shitblimp", "shitty", "shota",
            "shrimping", "skeet", "slanteye", "slut", "s&m", "smut", "snatch",
            "snowballing", "sodomize", "sodomy", "spastic", "spic", "splooge",
            "splooge moose", "spooge", "spread legs", "spunk", "strap on",
            "strapon", "strappado", "strip club", "style doggy", "suck", "sucks",
            "suicide girls", "sultry women", "swastika", "swinger", "tainted love",
            "taste my", "tea bagging", "threesome", "throating", "thumbzilla",
            "tied up", "tight white", "tit", "tits", "titties", "titty",
            "tongue in a", "topless", "tosser", "towelhead", "tranny", "tribadism",
            "tub girl", "tubgirl", "tushy", "twat", "twink", "twinkie",
            "two girls one cup", "undressing", "upskirt", "urethra play",
            "urophilia", "vagina", "venus mound", "viagra", "vibrator",
            "violet wand", "vorarephilia", "voyeur", "voyeurweb", "voyuer", "vulva",
            "wank", "wetback", "wet dream", "white power", "whore", "worldsex",
            "wrapping men", "wrinkled starfish", "xx", "xxx", "yaoi",
            "yellow showers", "yiffy", "zoophilia"
        ];
	window.showHiddenGames = false;        
	// *** KONSTANSOK ***
        const GEOFENCE_DEFAULT_RADIUS = 20; 
        const DEFAULT_SCORE_PER_TASK = 50; 
        const HINT1_PENALTY = 10; 
        const HINT2_PENALTY = 20; 
        const WRONG_ANSWER_PENALTY = 1; 
        const RESCUE_TASK_CORRECT_ANSWER = '4'; 
        const RESCUE_TASK_SCORE = 0; 
        
        const LOCAL_STORAGE_PREFIX = 'MystiGoGameState_'; 
        const DEFAULT_GAME_FILE = 'games/games.xlsx'; 

        const AVATAR_ICONS = {
            cat: 'üê±', dog: 'üê∂', panda: 'üêº', monkey: 'üêµ', shark: 'ü¶à', parrot: 'ü¶ú', bear: 'üêª', cow: 'üêÆ', elephant: 'üêò', detective: 'üïµÔ∏è', explorer: 'üß≠', wizard: 'üßô', robot: 'ü§ñ',
             ghost: 'üëª', skull: '‚ò†Ô∏è', lock: 'üîí', magician: 'üé©', mask: 'üé≠', fire: 'üî•', knight: '‚öîÔ∏è', hamburger: 'üçî', pizza: 'üçï', doughnut: 'üç©', cupcake: 'üßÅ', lollipop: 'üç≠', smile: 'üòé', zombie: 'üßü',ballerina: 'ü©∞',police: 'üöì',firefighter: 'üöí',ambulance: 'üöë',star: '‚≠êÔ∏è', heart: '‚ù§Ô∏è', crown: 'üëë', laptop: 'üíª', floppy: 'üíæ'
        };

        let appState = {};
        let modalCloseCallback = null;
        let manualMarker = null; 
        let speechSynth = window.speechSynthesis; 

        function initializeState() {
            appState = { 
                currentPage: 'landing-page', 
                selectedGameId: null, 
                currentGame: null, 
                currentTaskIndex: 0, 
                score: 0, 
                timerInterval: null, 
                geofenceTimerInterval: null, 
                startTime: null, 
                map: null, 
                playerMarker: null, 
                taskMarker: null, 
                geofenceCircle: null, 
                userPosition: null, 
                geoWatchId: null, 
                isInZone: false, 
                isTestModeEnabled: false, 
                isManualMock: false, 
                teamName: null, 
                teamAvatar: null, 
                taskOrder: 'sequential', 
                totalTime: 0, 
                geofenceTime: 0, 
                isTimerRunning: false, 
                routeCoordinates: [],
                completedTasks: [], 
                availableTasks: [], 
                taskMarkers: {},
		lastAutoZoomTime: 0,
	        visibleGamesLimit: 5,
		currentFilteredGames: null
            };
        }

        // --- LOCAL STORAGE LOGIC ---
        function getStorageKey(gameId) {
            return LOCAL_STORAGE_PREFIX + gameId;
        }

        function saveGameState() {
            if (!appState.currentGame) return;

            const stateToSave = {
                gameId: appState.currentGame.id, 
                currentTaskIndex: appState.currentTaskIndex,
                score: appState.score,
                totalTime: appState.totalTime,
                geofenceTime: appState.geofenceTime,
                isTimerRunning: appState.isTimerRunning,
                teamName: appState.teamName,
                teamAvatar: appState.teamAvatar,
                isTestModeEnabled: appState.isTestModeEnabled,
                isManualMock: appState.isManualMock,
                routeCoordinates: appState.routeCoordinates,
                completedTasks: appState.completedTasks,
                availableTasks: appState.availableTasks,
                taskOrder: appState.taskOrder,
                tasks: appState.currentGame.tasks 
            };
            
            try {
                localStorage.setItem(getStorageKey(appState.currentGame.id), JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Hiba az √°llapot ment√©sekor:", e);
            }
        }

        function loadGameById(gameId) {
            try {
                const savedStateJson = localStorage.getItem(getStorageKey(gameId));
                if (!savedStateJson) return false;

                const state = JSON.parse(savedStateJson);
                if (!state.gameId || state.gameId !== gameId) return false;

                appState.currentGame = JSON.parse(JSON.stringify(games[gameId]));

// --- √öJ K√ìD: J√°t√©k fejl√©c log√≥ be√°ll√≠t√°sa (Ment√©sn√©l is!) ---
                const gameLogo = document.getElementById('game-header-logo');
                if (gameLogo) {
                     gameLogo.src = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
                }
                // ----

		window.currentGameId = gameId;                

                appState.currentTaskIndex = state.currentTaskIndex;
                appState.score = state.score;
                appState.totalTime = state.totalTime;
                appState.geofenceTime = state.geofenceTime;
                appState.isTimerRunning = state.isTimerRunning;
                appState.teamName = state.teamName;
                appState.teamAvatar = state.teamAvatar;
                appState.isTestModeEnabled = state.isTestModeEnabled;
                appState.isManualMock = state.isManualMock;
                appState.routeCoordinates = state.routeCoordinates || [];
                appState.completedTasks = state.completedTasks || [];
                appState.availableTasks = state.availableTasks || [];
                
                // TaskOrder helyre√°ll√≠t√°sa
                appState.taskOrder = state.taskOrder;
                if (appState.currentGame) {
                    appState.currentGame.taskOrder = state.taskOrder;
                }
                
                if (state.tasks) {
                    appState.currentGame.tasks = state.tasks;
                }

                showPage('game-page');
                
                setTimeout(() => {
                    initializeMap();
                    
                    if(appState.isManualMock) {
                        toggleMapClickMock(true);
                    } else {
                        if (manualMarker) { manualMarker.remove(); manualMarker = null; }
                        watchPosition(); 
                    }
                    
                    updateStatusDisplays();
                    
                    if (appState.isTimerRunning) {
                        appState.timerInterval = setInterval(updateTimer, 1000);
                        lastTimeUpdate = new Date().getTime(); 
                    }
                    
                    if (appState.currentGame.taskOrder === 'explore') {
                         if (appState.currentTaskIndex === 0 && appState.isTimerRunning) {
                             showTaskSelectionMap();
                             showMessage("Visszat√©r√©s", `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik a t√©rk√©pes v√°laszt√≥n√°l.`);
                             return true; 
                         }
                    } 
                    
                    loadTask(appState.currentTaskIndex); 
                    
                    let msg = `√údv √∫jra, ${appState.teamName || ''}! A j√°t√©k folytat√≥dik.`;
                    showMessage("Folytat√°s", msg, null);

                }, 100);

                return true;

            } catch (e) {
                console.error("Hiba az √°llapot bet√∂lt√©sekor:", e);
                return false;
            }
        }

        function deleteSavedGame(gameId) {
            localStorage.removeItem(getStorageKey(gameId));
            
            // --- JAV√çT√ÅS: Ellen≈ërizz√ºk, hogy van-e akt√≠v URL sz≈±r√©s ---
            const urlParams = new URLSearchParams(window.location.search);
            const pGameId = urlParams.get('game') || urlParams.get('id');
            const pLoc = urlParams.get('location') || urlParams.get('helyszin');
            const pType = urlParams.get('type') || urlParams.get('tipus');

            // Ha b√°rmilyen sz≈±r≈ë param√©ter van az URL-ben, akkor az URL sz≈±r≈ët futtatjuk √∫jra
            if (pGameId || pLoc || pType) {
                console.log("Ment√©s t√∂r√∂lve, URL sz≈±r√©s friss√≠t√©se...");
                handleInitialUrlFiltering();
            } else {
                // Ha nincs URL param√©ter, akkor a leg√∂rd√ºl≈ë men√ºk (dropdown) alapj√°n friss√≠t√ºnk
                console.log("Ment√©s t√∂r√∂lve, Dropdown sz≈±r√©s friss√≠t√©se...");
                applyFilters(); 
            }
        }
        
        async function loadLocalXlsx(filePath) {
            showLoading(true);
            document.getElementById('loading-status').textContent = `Adatb√°zis bet√∂lt√©se (${filePath})...`;
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) throw new Error(`Hiba: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const wb = XLSX.read(data, {type:'array'}); 
                processExcelData(wb); 
            } catch (error) {
                document.getElementById('landing-page').classList.remove('hidden');
                document.getElementById('content-wrapper').classList.add('hidden'); 
                document.getElementById('loading-status').textContent = `Bet√∂lt√©s sikertelen.`;
                const manualInputLabel = document.getElementById('manual-file-select-label');
                if (manualInputLabel) manualInputLabel.classList.remove('hidden');
                showLoading(false);
            }
        }

        // --- I18N ---
        const I18N = { 
            hu: { 
                correct_title: 'Helyes!', 
                correct_body: `√úgyes vagy! (+${DEFAULT_SCORE_PER_TASK} pont)`, 
                wrong_title: 'Sajnos nem j√≥.', 
                wrong_body: `Pr√≥b√°ld √∫jra! Rossz v√°lasz: -${WRONG_ANSWER_PENALTY} pont.`, 
                far_title: 'M√©g messze vagy', 
                far_body: 'L√©pj be a z√≥n√°ba a megold√°s bek√ºld√©s√©hez, vagy a seg√≠ts√©g k√©r√©s√©hez!', 
                in_zone: 'A c√©lter√ºleten vagy!', 
                out_zone: (m) => `M√©g kb. ${m} m√©terre vagy a c√©lt√≥l.`, 
                hint1_body: (h) => `1. Seg√≠ts√©g (-${HINT1_PENALTY} pont): ${h} `, 
                hint2_body: (h) => `2. Seg√≠ts√©g (-${HINT2_PENALTY} pont): ${h} `, 
                rescue_correct: `Megker√ºl≈ë sikeres! (+${RESCUE_TASK_SCORE} pont)`, 
                rescue_wrong: 'Megker√ºl≈ë hib√°s. Pr√≥b√°ld √∫jra!', 
                gps_required: 'K√©rj√ºk, enged√©lyezd a GPS-t az eszk√∂z√∂d√∂n a kaland elind√≠t√°s√°hoz. Normal m√≥dban a j√°t√©k csak m≈±k√∂d≈ë GPS-szel indul el.' 
            } 
        };
        const t = (key, ...args) => I18N.hu[key] ? (typeof I18N.hu[key] === 'function' ? I18N.hu[key](...args) : I18N.hu[key]) : key;

 // --- PDF GENERATION (Avatarral kieg√©sz√≠tve) ---
        function downloadPDF() {
            const element = document.getElementById('pdf-content');
            if (!element) return;
            
            const originalStyle = element.style.cssText;
            
            // --- AVATAR JAV√çT√ÅS: K√©nyszer√≠tj√ºk a bet≈±t√≠pust a gener√°l√°s idej√©re ---
            element.style.padding = '20px'; 
            element.style.backgroundColor = '#ffffff';
            element.style.fontFamily = '"Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "Poppins", sans-serif';
            // -----------------------------------------------------------------------

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0'); 

            const fileNameTimestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;
            
            const safeTeamName = (appState && appState.teamName) ? appState.teamName : 'n√©v';
            const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';

            // ID meg≈ërz√©se
            const gameId = window.currentGameId || 'Eredm√©ny'; 

            const fileName = `MystiGo_${gameId}_${safeTeamName}_${safeAvatar}_${fileNameTimestamp}.pdf`;

            setTimeout(() => {
                html2pdf().from(element).set({
                    margin: 10, 
                    filename: fileName, 
                    image: { type: 'jpeg', quality: 0.98 },
                    // useCORS fontos a k√©pekhez, letterRendering a bet≈±kh√∂z
                    html2canvas: { scale: 2, logging: false, useCORS: true, letterRendering: true, scrollY: 0, windowWidth: document.documentElement.offsetWidth },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save().then(() => {
                    element.style.cssText = originalStyle;
                }).catch(err => {
                    console.error("PDF gener√°l√°si hiba:", err);
                    element.style.cssText = originalStyle;
                });
            }, 2000); 
        }


async function sharePdfViaEmail() {
    // 1. Elemek √©s st√≠lusok el≈ëk√©sz√≠t√©se
    const element = document.getElementById('pdf-content');
    if (!element) return;

    const originalStyle = element.style.cssText;
    element.style.padding = '20px';
    element.style.backgroundColor = '#ffffff';
    element.style.fontFamily = '"Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "Poppins", sans-serif';
    // --- F√ÅJLN√âV GENER√ÅL√ÅS (Ugyanaz, mint a downloadPDF-ben) ---
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0'); 
    
    const fileNameTimestamp = `${year}-${month}-${day}_${hour}-${minute}-${second}`;

    // Biztons√°gos adatok lek√©r√©se
    const safeTeamName = (appState && appState.teamName) ? appState.teamName : 'n√©v';
    const safeAvatar = (appState && appState.teamAvatar) ? appState.teamAvatar : 'nincs-avatar';
    
    // FONTOS: Itt is a window.currentGameId-t haszn√°ljuk!
    const gameId = window.currentGameId || 'Eredm√©ny';

    // Egys√©ges f√°jln√©v strukt√∫ra
    const fileName = `MystiGo_${gameId}_${safeTeamName}_${safeAvatar}_${fileNameTimestamp}.pdf`;
    // -----------------------------------------------------------

    console.log("Megosztand√≥ f√°jl neve:", fileName);
    showLoading(true); 

    try {
        // 2. PDF gener√°l√°sa Blob-k√©nt
        const pdfBlob = await html2pdf().from(element).set({
            margin: 10,
            filename: fileName, 
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).output('blob');

        // 3. F√°jl objektum l√©trehoz√°sa
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

        // 4. St√≠lusok vissza√°ll√≠t√°sa
        element.style.cssText = originalStyle;
        showLoading(false);

        // 5. Megoszt√°s
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'J√°t√©k Eredm√©ny',
                    text: `Sziasztok! Itt van a J√°t√©kom eredm√©nye. Kaland: ${gameId}, Csapat: ${safeTeamName}`
                });
            } catch (error) {
                if (error.name !== 'AbortError') console.error(error);
            }
        } else {
            // Fallback let√∂lt√©s (ha a megoszt√°s nem t√°mogatott)
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            alert('A PDF let√∂lt√©sre ker√ºlt (a megoszt√°s ezen az eszk√∂z√∂n nem t√°mogatott).');
        }

    } catch (err) {
        console.error("Hiba:", err);
        element.style.cssText = originalStyle;
        showLoading(false);
    }
}




        // --- CORE APP & PAGE LOGIC ---
        function showPage(pageId) {
            // --- GA4 Virtual Pageview ---
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    'page_title': pageId,
                    'page_location': window.location.href + '#' + pageId
                });
            }

            // --- POZ√çCI√ìK BE√ÅLL√çT√ÅSA (JAV√çTOTT - 330px) ---
            const contentWrapperEl = document.getElementById('content-page-wrapper');
            const headerEl = document.getElementById('header'); 

            // 1. T√∂r√∂lj√ºk a kor√°bbi oszt√°lyokat √©s st√≠lusokat
            contentWrapperEl.classList.remove('top-40', 'top-52', 'top-32');
            contentWrapperEl.style.top = ''; 
            headerEl.style.paddingBottom = ''; 

            if (pageId === 'game-page') {
                // --- J√ÅT√âK N√âZET ---
                headerEl.style.paddingBottom = '60px'; 
                contentWrapperEl.style.top = '115px'; 
                
            } else if (pageId === 'end-page') {
                // --- J√ÅT√âK V√âGE (DRASZTIKUS KORREKCI√ì) ---
                // 330 pixelre toljuk le a feh√©r dobozt. 
                // Ez elegend≈ë helyet ad a magas log√≥nak √©s a feliratnak is.
                contentWrapperEl.style.setProperty('top', '330px', 'important');

            } else {
                // --- MEN√ú √âS EGY√âB OLDALAK ---
                contentWrapperEl.style.top = '160px'; 
            }
            // ---------------------------------------------------------

            const landingPage = document.getElementById('landing-page');
            const contentWrapper = document.getElementById('content-wrapper');
            
            if (pageId === 'landing-page') {
                landingPage.classList.remove('hidden');
                contentWrapper.classList.add('translate-y-full');
            } else {
                landingPage.classList.add('hidden');
                contentWrapper.classList.remove('hidden');
                setTimeout(() => contentWrapper.classList.remove('translate-y-full'), 10);
                showContentPage(pageId);
            }
        }

        function showContentPage(pageId) {
            document.querySelectorAll('#content-wrapper section').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            const contentWrapper = document.getElementById('content-page-wrapper');
            if (contentWrapper) contentWrapper.scrollTo({ top: 0, behavior: 'instant' });

            const mainHeader = document.getElementById('main-header');
            const statusBar = document.getElementById('game-status-bar');
            const exitButton = document.getElementById('exit-game-btn'); 
            const gameHeaderLogoContainer = document.getElementById('game-header-logo-container');
            const centerHeaderContent = document.getElementById('center-header-content');
            const teamNameContainer = document.getElementById('team-name-container');
            const teamNameDisplay = document.getElementById('team-name-display');
            const teamAvatarIcon = document.getElementById('game-team-avatar-icon'); 
            const testModeIndicator = document.getElementById('test-mode-indicator');
            const mainHeaderLogoRow = document.getElementById('main-header-logo-row'); 
            const titleEl = document.getElementById('page-title'); // <--- ITT DEFINI√ÅLJUK
            
            if (pageId === 'game-page') {
                mainHeader.classList.add('hidden');
                statusBar.classList.remove('hidden');
                exitButton.classList.remove('hidden'); 
                gameHeaderLogoContainer.classList.remove('hidden');
                centerHeaderContent.classList.remove('hidden');
                testModeIndicator.classList.toggle('hidden', !appState.isTestModeEnabled);
                
                if (appState.teamName) {
                    const avatarIcon = AVATAR_ICONS[appState.teamAvatar] || '';
                    teamAvatarIcon.textContent = avatarIcon; 
                    teamNameDisplay.textContent = appState.teamName; 
                    teamNameContainer.classList.remove('hidden');
                } else {
                    teamNameContainer.classList.add('hidden');
                }
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.add('hidden');
            } else {
                mainHeader.classList.remove('hidden');
                statusBar.classList.add('hidden');
                exitButton.classList.add('hidden'); 
                gameHeaderLogoContainer.classList.add('hidden');
                centerHeaderContent.classList.add('hidden');
                testModeIndicator.classList.add('hidden');
                if(mainHeaderLogoRow) mainHeaderLogoRow.classList.remove('hidden');
                
                // --- M√ìDOS√çT√ÅS: C√çM KEZEL√âSE ---
                if (pageId === 'end-page') {
                    // Ha a j√°t√©k v√©g√©n vagyunk, ELREJTJ√úK a c√≠met, csak a log√≥ marad
                    if (titleEl) titleEl.classList.add('hidden');
                } else {
                    // Minden m√°s oldalon (pl. Kalandv√°laszt√≥) MEGJELEN√çTJ√úK
                    if (titleEl) {
                        titleEl.classList.remove('hidden');
                        const titles = { 'game-list-page': 'V√°lassz Kalandot' };
                        titleEl.textContent = titles[pageId] || 'MystiGo';
                    }
                }
                // -------------------------------
                
                if (pageId === 'game-list-page') {
                    // Log√≥ vissza√°ll√≠t√°sa a f≈ëmen√ºben
                    const mainHeaderLogo = document.getElementById('main-header-logo');
                    if (mainHeaderLogo) {
                        // Megn√©zz√ºk, hogy be van-e kapcsolva a Kids m√≥d
                        const isKidsMode = localStorage.getItem('mystigo_pref_kidsMode') === 'true';
                        
                        // Ennek megfelel≈ëen √°ll√≠tjuk be a k√©pet
                        mainHeaderLogo.src = isKidsMode ? "logo/MystiGo_logo_cat.png" : "logo/MystiGo_logo.png";
                    }

                    if (Object.keys(games).length > 0) applyFilters();
                    if (Object.keys(games).length > 0) document.getElementById('team-setup').classList.remove('hidden');
                    
                    // Titkos kapcsol√≥ vissza√°ll√≠t√°sa a c√≠m mell√© (csak ha van c√≠m elem √©s l√°that√≥)
                    if (titleEl && !titleEl.classList.contains('hidden')) {
                        const secretTrigger = document.createElement('span');
                        secretTrigger.id = 'secret-trigger';
                        secretTrigger.className = 'text-brand-orange-500 cursor-pointer ml-1 font-extrabold';
                        secretTrigger.textContent = '!';
                        titleEl.appendChild(secretTrigger);
                    }

                } else {
                    document.getElementById('secret-switches-container').classList.add('hidden');
                }
            }
        }
            

        function resetApp() {
            if (speechSynth.speaking) speechSynth.cancel();
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            if (appState.timerInterval) clearInterval(appState.timerInterval);
            if (appState.geofenceTimerInterval) clearInterval(appState.geofenceTimerInterval);
            
            // J√°t√©k t√©rk√©p takar√≠t√°sa
            if (appState.map) { 
                toggleMapClickMock(false); 
                appState.map.remove(); appState.map = null; 
            }
            if (manualMarker) { manualMarker.remove(); manualMarker = null; } 
            
            // --- JAV√çT√ÅS KEZDTE: GPS Teszt takar√≠t√°sa ---
            const gpsContainer = document.getElementById('gps-test-container');
            if (gpsContainer) gpsContainer.classList.add('hidden'); // Elrejtj√ºk a dobozt

            // Le√°ll√≠tjuk a teszt figyel√©s√©t, ha futna
            if (typeof finishGpsTest === 'function') {
                finishGpsTest(); 
            }

            // T√∂r√∂lj√ºk a teszt t√©rk√©pet a mem√≥ri√°b√≥l, hogy legk√∂zelebb tiszt√°n induljon
            if (gpsTestMap) { 
                gpsTestMap.remove(); 
                gpsTestMap = null; 
            }
            gpsTestMarker = null;
            gpsTestCircle = null;
            // --- JAV√çT√ÅS V√âGE ---

            document.getElementById('developer-options').classList.add('hidden');
            document.getElementById('secret-switches-container').classList.add('hidden');

            initializeState();
            
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('content-wrapper').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.remove('translate-y-full');

            loadLocalXlsx(DEFAULT_GAME_FILE);
            showPage('game-list-page'); 
	    if (currentUser) updateUserUI(true, currentUser);

        }

        const showLoading = (show) => document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        
        function showMessage(title, body, onClose, showCancel = false) {
            // --- iPad / Mobil FIX KEZDIDE ---
    		        // 1. Ha nyitva a billenty≈±zet (mert a beviteli mez≈ën van a f√≥kusz), bez√°rjuk
 		           if (document.activeElement instanceof HTMLElement) {
 		               document.activeElement.blur();
     		       }
            
       			     // 2. Azonnal a tartalom tetej√©re g√∂rget√ºnk, hogy az ablak biztosan l√°that√≥ legyen
	              window.scrollTo(0, 0);
   				         const contentWrapper = document.getElementById('content-page-wrapper');
 				           if (contentWrapper) {
 			               contentWrapper.scrollTo({ top: 0, behavior: 'instant' });
    				        }
          				  // --- iPad / Mobil FIX V√âGE ---
	    document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').innerHTML = DOMPurify.sanitize(body, { ADD_ATTR: ['style'], ADD_TAGS: ['strong', 'em', 'p', 'br'] }); 
            const okButton = document.getElementById('modal-ok-button');
            const cancelButton = document.getElementById('modal-cancel-button');
            okButton.textContent = 'Rendben';
            cancelButton.classList.add('hidden');

            if (showCancel) {
                okButton.textContent = 'Igen'; cancelButton.textContent = 'Nem'; cancelButton.classList.remove('hidden');
                okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
                cancelButton.onclick = hideMessage; 
            } else {
                 okButton.onclick = () => { hideMessage(); if(typeof onClose === 'function') onClose(); };
            }
            modalCloseCallback = null; 
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function hideMessage() { 
            document.getElementById('message-modal').classList.add('hidden');
            if(typeof modalCloseCallback === 'function') { modalCloseCallback(); modalCloseCallback = null; }
            document.getElementById('modal-ok-button').onclick = hideMessage;
        }
        
        function showReportModal() {
            if (!appState.currentGame) return;
            checkGeofence();
            document.getElementById('report-error-modal').classList.remove('hidden');
            document.getElementById('error-description-input').value = '';
        }

        function hideReportModal() { document.getElementById('report-error-modal').classList.add('hidden'); }

        function handleSubmitError() {
    if (!appState.currentGame) return;
    const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex); 
    if (!currentTask) return;

    // --- M√ìDOS√çT√ÅS KEZDETE ---
    // Ha a 0. feladatot (Start pont) ugorjuk √°t, akkor el kell ind√≠tani a rendszert!
    if (currentTask.index === 0) {
        // Ez a f√ºggv√©ny elind√≠tja az id≈ët, a GPS r√∂gz√≠t√©st, √©s bet√∂lti a k√∂vetkez≈ë feladatot (Task 1)
        startTimersAndGPS();
        
        hideReportModal();
        
        // Jelz√ºnk a felhaszn√°l√≥nak, de NEM h√≠vjuk meg a handleCorrectAnswer-t,
        // mert a startTimersAndGPS() m√°r elv√©gezte a lapoz√°st.
        showMessage("J√°t√©k Elind√≠tva", "A kezd≈ëpontot √°tugrottad. A j√°t√©k √©s az id≈ëm√©r√©s elindult!", null);
        return; 
    }
    // --- M√ìDOS√çT√ÅS V√âGE ---

    // Ez marad a r√©gi a t√∂bbi feladathoz:
    currentTask.taskScore = 0;
    currentTask.skipped = true; 
    updateStatusDisplays(); hideReportModal();
    showMessage("√Åtugorva", "A feladatot teljes√≠tettnek jel√∂lt√ºk (0 pont). A j√°t√©k folytat√≥dik.", () => { handleCorrectAnswer(); });
}
        
        function handleExitGame() { resetApp(); }

        function showExitConfirmation() {
            showMessage('Kil√©p√©s', 'Biztosan vissza l√©psz a f≈ëmen√ºbe? A j√°t√©k √°ll√°sa elment√©sre ker√ºl.', handleExitGame, true);
        }

        // --- DATA PROCESSING ---
        function assertCols(obj, req, ctx) {
            const missing = req.filter(k => !(k in obj) || obj[k] === null || String(obj[k]).trim() === '');
            if (missing.length > 0) throw new Error(`'${ctx}' munkalap hiba: A(z) ${missing.map(m => `"${m}"`).join(', ')} mez≈ë(k) hi√°nyzik/√ºres.`);
        }



        function processExcelData(workbook) {
            try {
                const gamesSheet = workbook.Sheets['games'], tasksSheet = workbook.Sheets['tasks'];
                if (!gamesSheet || !tasksSheet) throw new Error("A 'games' vagy 'tasks' munkalap hi√°nyzik.");
                const parsedGames = XLSX.utils.sheet_to_json(gamesSheet);
                const parsedTasks = XLSX.utils.sheet_to_json(tasksSheet);
                const combinedGames = {};
                
                parsedGames.forEach(game => {
                    
                    // Rejtett j√°t√©k flag sz√°m√≠t√°sa
                    const isHiddenGame = (game.isHidden == 1 || String(game.isHidden).trim().toLowerCase() === 'true');

                    assertCols(game, ['id', 'title', 'type', 'startLocationLat', 'startLocationLng'], 'games');
                    const lat = parseFloat(game.startLocationLat), lng = parseFloat(game.startLocationLng);
                    const cleanId = String(game.id).trim(); 

                    // --- √öJ LOGIKA: 0 = Letiltva, √úres = Korl√°tlan, Sz√°m = Limit ---
                    const oneTimeKey = Object.keys(game).find(key => key.toLowerCase().trim() === 'maxplaycount');
                    let rawVal = (oneTimeKey) ? game[oneTimeKey] : '';
                    let maxPlayVal = 0; // Alap√©rtelmezett: 0 = Korl√°tlan (ha √ºres a cella)

                    // Csak akkor v√°ltunk, ha VAN valami √≠rva a cell√°ba
                    if (rawVal !== undefined && rawVal !== null && String(rawVal).trim() !== '') {
                        const parsed = parseInt(rawVal);
                        if (!isNaN(parsed)) {
                            if (parsed === 0) {
                                maxPlayVal = -1; // K√ìD: -1 jelenti, hogy "Letiltva / Nem el√©rhet≈ë"
                            } else {
                                maxPlayVal = parsed; // Egy√©b sz√°m: A limit √©rt√©ke
                            }
                        }
                    }
                    // ----

                    combinedGames[cleanId] = { 
                        ...game, 
                        id: cleanId,
                        isHidden: isHiddenGame, 
                        type: String(game.type || 'normal').trim().toLowerCase(),
                        startLocation: { lat, lng }, 
                        price: parseInt(game.price || 0),
                        headerLogo: game.headerLogo ? String(game.headerLogo).trim() : null,
                        reviewUrl: game.reviewUrl ? String(game.reviewUrl).trim() : null,
                        
                        // --- JAV√çT√ÅS 2: Itt m√°r csak a k√©sz √©rt√©ket haszn√°ljuk ---
                        maxPlayCount: maxPlayVal, 
                        
                        tasks: [] 
                    };
                });


                parsedTasks.forEach(task => {
                    if (!combinedGames[task.gameId]) return;
                    const lat = parseFloat(task.locationLat), lng = parseFloat(task.locationLng);
                    
                    let allSolutions = [];
                    if (task.solution) allSolutions.push(...String(task.solution).split(';').map(s => s.trim()));
                    if (task.accepted_answers) allSolutions.push(...String(task.accepted_answers).split(';').map(s => s.trim()));
                    if (task.synonyms) allSolutions.push(...String(task.synonyms).split(';').map(s => s.trim()));
                    const acceptedAnswers = Array.from(new Set(allSolutions.filter(Boolean).map(a => normalizeAnswer(a))));
                    
                    combinedGames[task.gameId].tasks.push({ 
                        ...task, index: parseInt(task.index, 10), isStartTask: false, 
                        story: DOMPurify.sanitize(task.story || ''), location: { lat, lng }, 
                        geofenceRadius: parseFloat(task.geofenceRadius || GEOFENCE_DEFAULT_RADIUS), 
                        hints: [task.hint1, task.hint2].filter(Boolean).map(h => DOMPurify.sanitize(h)), 
                        solution: String(task.solution || ''), acceptedAnswers: acceptedAnswers,
		disableSolution: (task.disableSolution == 1 || String(task.disableSolution).toLowerCase() === 'true'), 
                        hintsUsed: 0, timeSpent: 0, taskScore: 0, isTaskTimerActive: false 
                    }); 
                });

                const validatedGames = {};
                // HIBAKERES√âS: Sz√°moljuk, h√°ny j√°t√©kot dobunk el
                let droppedCount = 0;
                
                for (const gameId in combinedGames) {
                    const game = combinedGames[gameId];
                    // Ellen≈ërizz√ºk, hogy √©rv√©nyes-e a t√≠pusa
                    if (!['normal', 'kids', 'team', 'explore'].includes(game.type)) {
                        console.warn(`J√°t√©k kihagyva (${gameId}): √ârv√©nytelen t√≠pus ("${game.type}")`);
                        droppedCount++;
                        continue;
                    }
                    if (game.tasks.length === 0) {
                        console.warn(`J√°t√©k kihagyva (${gameId}): Nincsenek feladatok`);
                        droppedCount++;
                        continue;
                    }
                    game.tasks.sort((a, b) => a.index - b.index);
                    validatedGames[gameId] = game;
                }
                games = validatedGames;

                // --- DIAGNOSZTIKAI ABLAK (Ez megmondja az igazat!) ---
                const loadedIds = Object.keys(games);
                if (loadedIds.length === 0) {
                    alert("HIBA: Egyetlen j√°t√©kot sem siker√ºlt bet√∂lteni! Ellen≈ërizd az Excel f√°jlt.");
                } else {
                    // Megn√©zz√ºk, benne van-e a keresett ID a URL-ben
                    const urlParams = new URLSearchParams(window.location.search);
                    const searchedId = urlParams.get('game') || urlParams.get('id');
                    
                    if (searchedId && !games[searchedId.trim()]) {
                        alert(`HIBAKERES√âS:\nA rendszer bet√∂lt√∂tt ${loadedIds.length} db j√°t√©kot, de a keresett "${searchedId}" NINCS k√∂zt√ºk.\n\nBet√∂lt√∂tt ID-k:\n` + loadedIds.join("\n"));
                    }
                }
                // -----------------------------------------------------


// --- SZ≈∞R≈ê DOBOZ LENYIT√ÅSA / BECSUK√ÅSA ---
        window.toggleFilterSection = function() {
            const content = document.getElementById('filter-content');
            const icon = document.getElementById('filter-toggle-icon');
            
            if (!content || !icon) return;

            if (content.classList.contains('hidden')) {
                // Kinyit√°s
                content.classList.remove('hidden');
                icon.textContent = '‚Äì'; // M√≠nusz jel
                icon.classList.remove('text-brand-orange-500'); // Opcion√°lis sz√≠nv√°lt√°s
                icon.classList.add('text-brand-blue');
            } else {
                // Bez√°r√°s
                content.classList.add('hidden');
                icon.textContent = '+'; // Plusz jel
                icon.classList.add('text-brand-orange-500');
                icon.classList.remove('text-brand-blue');
            }
        };


                populateLocationFilter(); 
                
                // Most h√≠vjuk meg a sz≈±r≈ët - biztosan van m√°r adat!
                if (window.checkUrlParametersAndFilter) {
                    checkUrlParametersAndFilter();
                }
                
                showLoading(false);
                showPage('game-list-page');
		handleInitialUrlFiltering();
		autoSortGamesByDistance();

            } catch (error) {
                showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                showLoading(false);
            }
        }
        
        // --- UI RENDERING ---
        function renderGameList(gamesToRender = null) {
            const listEl = document.getElementById('game-list');
            listEl.innerHTML = '';
            
            // 1. Nyers adatok
            const sourceData = gamesToRender || games;
            let rawArray = Object.values(sourceData);

            // 2. RENDEZ√âS T√ÅVOLS√ÅG SZERINT (Ha van kisz√°molt t√°vols√°g)
            // Ez az √∫j r√©sz: ha a gomb megnyom√°sa ut√°n vagyunk, sorba rendezi ≈ëket
            if (rawArray.length > 0 && typeof rawArray[0]._calculatedDistance !== 'undefined') {
                rawArray.sort((a, b) => a._calculatedDistance - b._calculatedDistance);
            }

            // 3. Sz≈±r√©s (Rejtett √©s NEM AKT√çV j√°t√©kok kisz≈±r√©se)
            const displayableGames = rawArray.filter(game => {
                // Ha konkr√©t sz≈±r√©s van (pl. keres√©s), akkor mindent mutatunk ami egyezik
                if (gamesToRender) return true;
                
                // Fejleszt≈ëi m√≥dban mindent mutatunk
                if (window.showHiddenGames) return true;
                
                // 1. Rejtett (hidden) flag ellen≈ërz√©se
                if (game.isHidden) return false;

                // 2. Limit √©s Tilt√°s ellen≈ërz√©se (hogy csak az akt√≠vak l√°tsz√≥djanak)
                let playCount = parseInt(localStorage.getItem('MystiGo_Perm_Count_' + game.id) || 0);
                const oldBooleanSave = localStorage.getItem('MystiGo_Perm_Completed_' + game.id);
                if (playCount === 0 && oldBooleanSave === 'true') playCount = 1;

                const isManuallyDisabled = (game.maxPlayCount === -1);
                const isLimitReached = (game.maxPlayCount > 0 && playCount >= game.maxPlayCount);

                // Ha le van tiltva, vagy el√©rte a limitet, NE jelenjen meg a list√°ban
                if (isManuallyDisabled || isLimitReached) return false;

                return true;
            });

            // √úres lista kezel√©se
            if (displayableGames.length === 0) {
                 listEl.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-gray-500 font-semibold">Nincs a sz≈±r√©snek megfelel≈ë j√°t√©k.</p>
                    <button onclick="applyFilters()" class="text-brand-blue underline mt-2 text-sm">Sz≈±r≈ëk friss√≠t√©se</button>
                 </div>`; 
                 return;
            }
            
            if (!gamesToRender) {
                populateLocationFilter();
            }

            // Limit√°l√°s
            const currentLimit = appState.visibleGamesLimit;
            const visibleGames = displayableGames.slice(0, currentLimit);

            // K√°rty√°k gener√°l√°sa
            visibleGames.forEach(game => {
                const hasSave = localStorage.getItem(getStorageKey(game.id)) !== null;
                const placeholderImage = `https://placehold.co/600x300/${game.type === 'kids' ? 'FFF8E1' : 'E0F7FA'}/${game.type === 'kids' ? 'F57C00' : '0A2B4C'}?text=${encodeURIComponent(game.title)}`;
                
                let gameTypeBadge = '';
                if (game.type === 'kids') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-yellow-100 px-3 py-0.5 text-xs font-medium text-yellow-800">Kids üêà</span>`;
                else if (game.type === 'team') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-indigo-100 px-3 py-0.5 text-xs font-medium text-indigo-800">Team üßë‚Äçü§ù‚Äçüßë</span>`;
                else if (game.type === 'explore') gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-cyan-100 px-3 py-0.5 text-xs font-medium text-cyan-800">Explore üåç</span>`;
                else gameTypeBadge = `<span class="inline-flex items-center rounded-full bg-green-100 px-3 py-0.5 text-xs font-medium text-green-800">Normal üß≠</span>`;

                const priceText = game.price > 0 ? `${game.price.toLocaleString('hu-HU')} Ft` : 'Ingyenes';
                const gameTitleForMessage = game.title.replace(/'/g, "\\'");
                const locationBadge = game.location ? `<span class="text-xs text-gray-500 font-semibold flex items-center mt-1"><svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${game.location}</span>` : '';

                let playCount = parseInt(localStorage.getItem('MystiGo_Perm_Count_' + game.id) || 0);
                const oldBooleanSave = localStorage.getItem('MystiGo_Perm_Completed_' + game.id);
                if (playCount === 0 && oldBooleanSave === 'true') playCount = 1;
                
                const isManuallyDisabled = (game.maxPlayCount === -1);
                const isLimitReached = (game.maxPlayCount > 0 && playCount >= game.maxPlayCount);
                
                let contentOpacityClass = ""; 
                let completedBadge = "";

                if (!window.showHiddenGames && (isLimitReached || isManuallyDisabled)) {
                    contentOpacityClass = "opacity-40 grayscale"; 
                    if (isManuallyDisabled) {
                        completedBadge = `<div class="bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded absolute top-2 right-2 shadow-md z-20">üîí JELENLEG NEM EL√âRHET≈ê</div>`;
                    } else {
                        completedBadge = `<div class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded absolute top-2 right-2 shadow-md z-20">TELJES√çTVE (${playCount}/${game.maxPlayCount}) ‚úÖ</div>`;
                    }
                }

                let saveIndicator = "";
                let cardBorder = "";
                if (hasSave) {
                    saveIndicator = `<div class="bg-brand-orange text-white text-xs font-bold px-2 py-1 rounded absolute top-2 left-2 shadow-md z-20">MENTVE</div>`;
                    cardBorder = "border-2 border-brand-orange";
                }

                // --- √öJ R√âSZ: T√°vols√°g jelz≈ë k√©k c√≠mke ---
                let distanceBadge = "";
                if (game._calculatedDistance !== undefined) {
                    const distText = game._calculatedDistance > 100 
                        ? Math.round(game._calculatedDistance) + " km" 
                        : game._calculatedDistance.toFixed(1) + " km";
                    
                    distanceBadge = `<div class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded absolute bottom-2 left-2 shadow-md z-20 flex items-center gap-1">üìç ${distText}</div>`;
                }
                // ------------------------------------------

                let deleteButtonHtml = "";
                if (hasSave) {
                    deleteButtonHtml = `
                        <button onclick="event.stopPropagation(); deleteSavedGame('${game.id}');" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 shadow-md z-30" title="√öjrakezd√©s (Ment√©s t√∂rl√©se)">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                }

                const leaderboardBtnHtml = `
                    <button onclick="event.stopPropagation(); openLeaderboardModal('${game.id}');" 
                            class="absolute bottom-4 right-4 bg-white text-brand-blue border border-gray-200 p-2 rounded-full shadow-lg hover:bg-brand-orange hover:text-white hover:scale-110 transition-all z-30"
                            title="Ranglista megtekint√©se">
                        üèÜ
                    </button>
                `;

                listEl.innerHTML += `
                    <div class="content-card overflow-hidden cursor-pointer hover:shadow-xl transition-shadow relative ${cardBorder}" 
                         onclick="handleGameSelect('${game.id}', '${gameTitleForMessage}', '${game.type}', '${priceText}', ${hasSave})">
                        ${saveIndicator}
                        ${completedBadge}
                        ${deleteButtonHtml}
                        ${leaderboardBtnHtml}
                        
                        <div class="relative">
                            <img src="${game.imageUrl || placeholderImage}" alt="${game.title}" class="h-40 w-full object-cover ${contentOpacityClass}" onerror="this.onerror=null;this.src='${placeholderImage}';">
                            ${distanceBadge}
                        </div>

                        <div class="p-5 ${contentOpacityClass}">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-text-heading">${game.title}</h3>
                                ${gameTypeBadge}
                            </div>
                            ${locationBadge}
                            <p class="text-text-dark mt-1 text-sm">${game.description || 'Nincs le√≠r√°s megadva.'}</p>
                            <p class="text-xs font-semibold mt-3 text-brand-orange-500 pr-10">${priceText}</p>
                            ${hasSave ? '<p class="text-xs font-bold text-green-600 mt-2">Kattints a folytat√°shoz!</p>' : ''}
                        </div>
                    </div>`;
            });
            
            if (displayableGames.length > currentLimit) {
                const remaining = displayableGames.length - currentLimit;
                listEl.innerHTML += `
                    <div class="text-center pt-4 pb-2">
                        <button onclick="loadMoreGames()" class="bg-white border-2 border-gray-200 text-gray-500 hover:text-brand-blue hover:border-brand-blue font-bold py-3 px-6 rounded-full shadow-sm transition w-full">
                            Tov√°bbi kalandok bet√∂lt√©se (${remaining} db) ‚ñº
                        </button>
                    </div>
                `;
            }
        }
  



// --- √öJ SZ≈∞R≈ê F√úGGV√âNYEK ---
       function populateLocationFilter() {
    const locationSelect = document.getElementById('filter-location');
    if (!locationSelect) return;

    // Megjegyezz√ºk, mi volt kiv√°lasztva
    const currentValue = locationSelect.value;
    const locations = new Set();
    
    Object.values(games).forEach(game => {
        // --- M√ìDOS√çT√ÅS: Ha nem vagyunk fejleszt≈ëi m√≥dban, rejtj√ºk a rejtetteket ---
        if (!window.showHiddenGames && game.isHidden) return; 
        // ------------------------------------------------------------------------

        const rawLocation = String(game.location || "");

        if (rawLocation && rawLocation !== 'Egy√©b' && rawLocation !== 'undefined') {
            const parts = rawLocation.split(','); 
            parts.forEach(part => {
                const cleanLoc = part.trim();
                if (cleanLoc) locations.add(cleanLoc);
            });
        }
    });

    // Opci√≥k √∫jra√©p√≠t√©se
    locationSelect.innerHTML = '<option value="all">√ñsszes Helysz√≠n</option>';
    Array.from(locations).sort((a, b) => a.localeCompare(b, 'hu')).forEach(loc => {
        const option = document.createElement('option');
        option.value = loc;
        option.textContent = loc;
        locationSelect.appendChild(option);
    });

    // Vissza√°ll√≠tjuk a kiv√°laszt√°st
    if (Array.from(locationSelect.options).some(option => option.value === currentValue)) {
        locationSelect.value = currentValue;
    } else {
        locationSelect.value = 'all';
    }
}

// --- EZ HI√ÅNYZOTT: Sz≈±r√©s v√©grehajt√°sa ---
function applyFilters() {
            const locSelect = document.getElementById('filter-location');
            const typeSelect = document.getElementById('filter-type');
            const searchInput = document.getElementById('filter-search'); // √öJ MEZ≈ê
            
            if (!locSelect || !typeSelect) return;

            const location = locSelect.value;
            const type = typeSelect.value;
            // Keres√©si sz√∂veg kisbet≈±s√≠tve √©s sz√≥k√∂z√∂k n√©lk√ºl
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : ''; 

            // MINDIG vissza√°ll√≠tjuk a limitet 5-re √∫j sz≈±r√©skor
            appState.visibleGamesLimit = 5;

            // HA MINDEN ALAP√âRTELMEZETT (Nincs sz≈±r√©s √©s nincs keres√©s sem)
            if (location === 'all' && type === 'all' && searchTerm === '') {
                appState.currentFilteredGames = null; 
                renderGameList(null); // Alap lista (5 db + load more)
                return;
            }

            const filteredGames = {};

            Object.values(games).forEach(game => {
                if (!window.showHiddenGames && game.isHidden) return; 

                // 1. Helysz√≠n sz≈±r√©s
                let locMatch = (location === 'all');
                if (!locMatch) {
                    const gameLocs = game.location ? String(game.location).split(',').map(s => s.trim()) : [];
                    locMatch = gameLocs.includes(location);
                }

                // 2. T√≠pus sz≈±r√©s
                const typeMatch = (type === 'all' || game.type === type);

                // 3. √öJ: Sz√∂veges keres√©s (ID, C√≠m, Helysz√≠n, T√≠pus)
                let searchMatch = true;
                if (searchTerm !== '') {
                    // √ñsszef≈±zz√ºk a kereshet≈ë mez≈ëket egy hossz√∫ stringg√©
                    const searchableText = `${game.id} ${game.title} ${game.location} ${game.type}`.toLowerCase();
                    // Megn√©zz√ºk, benne van-e a keresett sz√≥
                    searchMatch = searchableText.includes(searchTerm);
                }

                // Csak akkor adjuk hozz√°, ha MINDEN felt√©tel igaz
                if (locMatch && typeMatch && searchMatch) {
                    filteredGames[game.id] = game;
                }
            });

            // Elmentj√ºk √©s kirajzoljuk a tal√°latokat
            appState.currentFilteredGames = filteredGames;
            renderGameList(filteredGames);
        }

// --- √öJ AUTOMATIKUS RENDEZ≈ê F√úGGV√âNY ---
        window.autoSortGamesByDistance = function() {
            if (!navigator.geolocation) return; // Ha nincs GPS t√°mogat√°s, marad az alap sorrend

            // Csendben lek√©rj√ºk a poz√≠ci√≥t
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    console.log("Automatikus GPS rendez√©s folyamatban...");

                    Object.values(games).forEach(game => {
                        if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                            const dist = haversineDistance(
                                { lat: userLat, lng: userLng }, 
                                { lat: game.startLocation.lat, lng: game.startLocation.lng }
                            );
                            game._calculatedDistance = dist / 1000; // km
                        } else {
                            game._calculatedDistance = 99999; 
                        }
                    });

                    // Miut√°n megvannak a t√°vols√°gok, √∫jrarajzoljuk a list√°t.
                    // A renderGameList elej√©n l√©v≈ë logika automatikusan rendezni fog, 
                    // ha l√°tja a _calculatedDistance mez≈ëket.
                    renderGameList();
                },
                (error) => {
                    console.log("Automatikus GPS rendez√©s nem siker√ºlt (nem kritikus):", error);
                },
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 } // Laz√°bb be√°ll√≠t√°sok a gyorsas√°ghoz
            );
        };

// --- √öJ F√úGGV√âNY: T√°vols√°g alap√∫ rendez√©s (JAV√çTVA: L√°that√≥s√°g sz≈±r√©ssel) ---
        window.sortGamesNearby = function() {
            const btn = document.getElementById('btn-sort-nearby');
            const status = document.getElementById('nearby-status');
            
            if (!navigator.geolocation) {
                alert("A b√∂ng√©sz≈ëd nem t√°mogatja a helymeghat√°roz√°st.");
                return;
            }

            // UI visszajelz√©s
            btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-brand-blue border-t-transparent rounded-full"></div> Helyzet lek√©r√©se...`;
            btn.disabled = true;
            status.textContent = "GPS jel keres√©se...";
            status.classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    status.textContent = "T√°vols√°gok sz√°m√≠t√°sa √©s sz≈±r√©s...";

                    const gamesArray = [];
                    const sortedGames = {};

                    // J√°t√©kok feldolgoz√°sa
                    Object.values(games).forEach(game => {
                        
                        // --- JAV√çT√ÅS ITT: Sz≈±r√©s a l√°that√≥s√°g alapj√°n ---
                        // Ha NEM vagyunk fejleszt≈ëi m√≥dban (showHiddenGames hamis), akkor sz≈±r√ºnk:
                        if (!window.showHiddenGames) {
                            // 1. Rejtett j√°t√©kok kisz≈±r√©se
                            if (game.isHidden) return;
                            
                            // 2. Nem j√°tszhat√≥ (Letiltott) j√°t√©kok kisz≈±r√©se
                            if (game.maxPlayCount === -1) return;
                        }
                        // ------------------------------------------------

                        if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                            const dist = haversineDistance(
                                { lat: userLat, lng: userLng }, 
                                { lat: game.startLocation.lat, lng: game.startLocation.lng }
                            );
                            game._calculatedDistance = dist / 1000; // km
                        } else {
                            game._calculatedDistance = 99999; 
                        }
                        gamesArray.push(game);
                    });

                    // Rendez√©s (legkisebb el≈ël)
                    gamesArray.sort((a, b) => a._calculatedDistance - b._calculatedDistance);

                    // Visszaalak√≠t√°s objektumm√°
                    gamesArray.forEach(game => {
                        sortedGames[game.id] = game;
                    });

                    // Be√°ll√≠tjuk, hogy ez a "sz≈±rt" lista
                    appState.currentFilteredGames = sortedGames;
                    appState.visibleGamesLimit = 5;

                    // √öjrarajzol√°s (Most m√°r csak a sz≈±rt elemeket tartalmazza a sortedGames)
                    renderGameList(sortedGames);

                    // UI vissza√°ll√≠t√°s
                    btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (Friss√≠tve)`;
                    btn.classList.add('bg-green-50', 'border-green-500', 'text-green-700');
                    btn.disabled = false;
                    status.textContent = `Sikeres rendez√©s a poz√≠ci√≥d alapj√°n.`;
                    
                    setTimeout(() => {
                        btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)`;
                        btn.classList.remove('bg-green-50', 'border-green-500', 'text-green-700');
                        status.classList.add('hidden');
                    }, 5000);

                },
                (error) => {
                    console.error("GPS Hiba:", error);
                    alert("Nem siker√ºlt lek√©rni a helyzeted. K√©rlek, enged√©lyezd a GPS-t!");
                    
                    btn.innerHTML = `üìç J√°t√©kok a k√∂zelemben (T√°vols√°g szerint)`;
                    btn.disabled = false;
                    status.classList.add('hidden');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        };




  // --- √öJ, BIZTOSABB URL SZ≈∞R≈ê LOGIKA (Adat-vez√©relt) ---
        function handleInitialUrlFiltering() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Param√©terek kiolvas√°sa
            const pGameId = urlParams.get('game') || urlParams.get('id');
            const pLoc = urlParams.get('location') || urlParams.get('helyszin');
            const pType = urlParams.get('type') || urlParams.get('tipus');

            // Ha nincs semmilyen param√©ter, nem csin√°lunk semmit (minden l√°tszik)
            if (!pGameId && !pLoc && !pType) return;

            console.log("üîç URL Sz≈±r√©s akt√≠v:", { pGameId, pLoc, pType });

            let filteredGames = {};
            let matchFound = false;

// --- √öJ BLOKK KEZDETE (Rejtett j√°t√©kok list√°z√°sa) ---
    if (pType === 'hidden' || pType === 'rejtett') {
        Object.values(games).forEach(game => {
            if (game.isHidden) {
                filteredGames[game.id] = game;
                matchFound = true;
            }
        });
        
        if (matchFound) {
            console.log("Rejtett j√°t√©kok list√°z√°sa...");
            renderGameList(filteredGames);
            updateFilterUI(null, 'hidden', null);
            return; // Itt kil√©p√ºnk, hogy ne fusson le a t√∂bbi sz≈±r√©s
        } else {
             alert("Nincsenek rejtett j√°t√©kok az adatb√°zisban.");
             return;
        }
    }

            // 1. ESET: Konkr√©t j√°t√©k ID keres√©se
            if (pGameId) {
                const searchKey = pGameId.trim().toLowerCase();
                // Megkeress√ºk a val√≥di ID-t (kisbet≈±/nagybet≈± nem sz√°m√≠t)
                const realId = Object.keys(games).find(id => id.trim().toLowerCase() === searchKey);

                if (realId) {
                    filteredGames[realId] = games[realId];
                    matchFound = true;
                    console.log("‚úÖ J√°t√©k megtal√°lva:", realId);

                    // --- √öJ R√âSZ: Egyedi log√≥ be√°ll√≠t√°sa, ha van ---
                    if (games[realId].headerLogo) {
                        const mainHeaderLogo = document.getElementById('main-header-logo');
                        if (mainHeaderLogo) {
                            mainHeaderLogo.src = games[realId].headerLogo;
                            // Opcion√°lis: Ha az √∫j log√≥ ar√°nyai m√°sok, levehetj√ºk a m√©retkorl√°toz√°st, vagy igaz√≠thatunk rajta
                            // mainHeaderLogo.style.maxWidth = '100%'; 
                        }
                    }
                    // ----------------------------------------------

                } else {
                    console.warn("‚ùå A keresett j√°t√©k ID nem tal√°lhat√≥:", pGameId);
                    alert(`A k√©rt j√°t√©k (${pGameId}) nem tal√°lhat√≥.`);
                    return; // Hagyjuk az √∂sszeset, vagy mutassunk √ºreset
                }
            } 
            // 2. ESET: Helysz√≠n √©s/vagy T√≠pus sz≈±r√©s
            else {
                Object.values(games).forEach(game => {
                    let locMatch = true;
                    let typeMatch = true;

                    // Helysz√≠n ellen≈ërz√©s (ha van param√©ter)
                    if (pLoc) {
                        // A j√°t√©k helysz√≠neit t√∂mbb√© alak√≠tjuk √©s kisbet≈±s√≠tj√ºk
                        const gameLocs = (game.location || "").toLowerCase().split(',').map(s => s.trim());
                        // Megn√©zz√ºk, hogy a keresett sz√≥ benne van-e valamelyikben
                        const searchLoc = pLoc.toLowerCase().trim();
                        // "Fuzzy" keres√©s: ha a keresett sz√≥ r√©szlete a helysz√≠nnek (pl. "buda" -> "Budapest")
                        locMatch = gameLocs.some(l => l.includes(searchLoc));
                    }

                    // T√≠pus ellen≈ërz√©s (ha van param√©ter)
                    if (pType) {
                        if (game.type !== pType.toLowerCase()) {
                            typeMatch = false;
                        }
                    }

                    if (locMatch && typeMatch) {
                        filteredGames[game.id] = game;
                        matchFound = true;
                    }
                });
            }

            // 3. EREDM√âNY KIRAJZOL√ÅSA
            if (matchFound) {
                renderGameList(filteredGames);
                
                // 4. UI VIZU√ÅLIS FRISS√çT√âSE (Hogy a felhaszn√°l√≥ l√°ssa, mi t√∂rt√©nt)
                updateFilterUI(pLoc, pType, pGameId);
            } else {
                // Ha sz≈±rt√ºnk, de √ºres lett az eredm√©ny
                document.getElementById('game-list').innerHTML = `
                    <div class="text-center p-8 bg-red-50 rounded-xl border border-red-200">
                        <p class="text-red-600 font-bold">Nincs tal√°lat a megadott felt√©telekre.</p>
                        <button onclick="window.location.href=window.location.pathname" class="text-brand-blue underline mt-2 text-sm">√ñsszes j√°t√©k mutat√°sa</button>
                    </div>`;
            }
        }

        // Seg√©df√ºggv√©ny a Dropdown-ok be√°ll√≠t√°s√°hoz (Csak vizu√°lis!)
        function updateFilterUI(locParam, typeParam, gameIdParam) {
            const filterContainer = document.getElementById('filter-container');
            const locSelect = document.getElementById('filter-location');
            const typeSelect = document.getElementById('filter-type');

            // --- M√ìDOS√çT√ÅS: Ha b√°rmilyen URL param√©ter van, ELREJTJ√úK a dobozt ---
            if (gameIdParam || locParam || typeParam) {
                if (filterContainer) {
                    filterContainer.classList.add('hidden'); // Teljesen elt√ºnteti a sz≈±r≈ë dobozt
                }
                // Mivel elrejtett√ºk, nem kell tov√°bb √°ll√≠tgatni a select-eket
                return;
            }
            
            // Ha NINCS param√©ter, biztos√≠tjuk, hogy l√°that√≥ legyen
            if (filterContainer) {
                filterContainer.classList.remove('hidden');
            }

            // --- INNENT≈êL A R√âGI LOGIKA (Csak akkor fut le, ha nincs URL sz≈±r√©s) ---
            
            // Helysz√≠n be√°ll√≠t√°sa (ha manu√°lisan h√≠vn√°nk meg k√©s≈ëbb)
            if (locParam && locSelect) {
                const option = Array.from(locSelect.options).find(opt => 
                    opt.value.toLowerCase().includes(locParam.toLowerCase())
                );
                if (option) {
                    locSelect.value = option.value;
                }
            }

            // T√≠pus be√°ll√≠t√°sa
            if (typeParam && typeSelect) {
                typeSelect.value = typeParam.toLowerCase();
            }
        }

      
        async function handleGameSelect(gameId, title, type, price, hasSave) {

            // --- 1. MENT√âS KEZEL√âSE (Els≈ëdleges priorit√°s) ---
            // Ha van ment√©s, azonnal bet√∂ltj√ºk. 
            // √çgy NEM fut le a limit ellen≈ërz√©s √©s NEM n√∂vekszik a sz√°ml√°l√≥.
            if (hasSave) {
                 loadGameById(gameId);
                 return; // Kil√©p√ºnk, nem fut tov√°bb a k√≥d
            }

            // --- 2. √öJ J√ÅT√âK IND√çT√ÅSI LOGIKA (Csak ha nincs ment√©s) ---
            
            const gameConfig = games[gameId];
            
            // A. J√°t√©k korl√°t √©s tilt√°s ellen≈ërz√©se
            // Ha 0 volt az Excelben (teh√°t -1 a k√≥dban), akkor TILOS ind√≠tani
            if (!window.showHiddenGames && gameConfig && gameConfig.maxPlayCount === -1) {
                showMessage(
                    'Nem el√©rhet≈ë üîí', 
                    `Ez a kaland (${title}) jelenleg nem el√©rhet≈ë vagy fejleszt√©s alatt √°ll.`
                );
                return;
            }

            // Sz√°ml√°l√≥ lek√©r√©se
            let playCount = parseInt(localStorage.getItem('MystiGo_Perm_Count_' + gameId) || 0);
            const oldBooleanSave = localStorage.getItem('MystiGo_Perm_Completed_' + gameId);
            if (playCount === 0 && oldBooleanSave === 'true') {
                playCount = 1;
            }

            // B. Limit el√©r√©s√©nek ellen≈ërz√©se
            // Csak akkor dob hib√°t, ha √öJ j√°t√©kot akarunk kezdeni, de m√°r el√©rt√ºk a limitet.
            if (!window.showHiddenGames && gameConfig && gameConfig.maxPlayCount > 0 && playCount >= gameConfig.maxPlayCount) {
                showMessage(
                    'Limit El√©rve! üèÜ', 
                    `Ezt a kalandot (${title}) √∂sszesen ${gameConfig.maxPlayCount} alkalommal lehet v√©gigj√°tszani, √©s te m√°r ${playCount}-szer teljes√≠tetted.`
                );
                return;
            }
            // -------------------------------------------

            // C. Adatok valid√°l√°sa (N√©v, Avatar, Tr√°g√°rs√°g)
            const nameInput = document.getElementById('team-name-input');
            const avatarSelect = document.getElementById('team-avatar-select');
            const lowerName = nameInput.value.toLowerCase(); 

            // √úres n√©v
            if (!nameInput.value.trim()) {
                showMessage('Hi√°nyz√≥ Adat', 'K√©rlek, adj meg egy <strong>Nevet</strong> a j√°t√©k ind√≠t√°s√°hoz!');
                nameInput.scrollIntoView({behavior: "smooth", block: "center"});
                nameInput.focus();
                return; 
            }

            // Tr√°g√°r sz≈±r√©s
            const containsBadWord = badWordsList.some(word => {
                if (word.length <= 3) {
                    const regex = new RegExp(`\\b${word}\\b`, 'i');
                    return regex.test(lowerName);
                }
                return lowerName.includes(word);
            });

            if (containsBadWord) {
                showMessage('Nem megfelel≈ë n√©v', 'A v√°lasztott n√©v nem enged√©lyezett kifejez√©st tartalmaz.<br>K√©rlek, v√°lassz m√°sikat!');
                nameInput.scrollIntoView({behavior: "smooth", block: "center"});
                nameInput.focus();
                nameInput.classList.add('border-red-500', 'ring-2', 'ring-red-500');
                setTimeout(() => nameInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500'), 3000);
                return; 
            }

            // Avatar
            if (!avatarSelect.value) {
                showMessage('Hi√°nyz√≥ Adat', 'K√©rlek, v√°lassz egy <strong>Avatart</strong> a j√°t√©k ind√≠t√°s√°hoz!');
                avatarSelect.scrollIntoView({behavior: "smooth", block: "center"});
                avatarSelect.focus();
                return; 
            }
            
            // D. FIREBASE LIMIT ELLEN≈êRZ√âS (Csak √∫j j√°t√©kn√°l fut le)
            const MAX_PLAYERS = 100000; 

            if (window.checkGameLimitAndIncrement) {
                showLoading(true);
                document.getElementById('loading-status').textContent = "Szabad helyek ellen≈ërz√©se...";
                
                // Itt n√∂veli a glob√°lis sz√°ml√°l√≥t, ha van m√©g hely
                const allowed = await window.checkGameLimitAndIncrement(gameId, MAX_PLAYERS);
                
                showLoading(false);
                document.getElementById('loading-status').textContent = "";

                if (!allowed) {
                    showMessage('Betelt a j√°t√©k!', `Sajn√°ljuk, a(z) <strong>${title}</strong> kaland el√©rte a maxim√°lis l√©tsz√°mot (${MAX_PLAYERS} f≈ë).\nPr√≥b√°lj meg egy m√°sik kalandot v√°lasztani.`);
                    return; 
                }
            }

            // E. V√©gs≈ë meger≈ës√≠t√©s √©s Ind√≠t√°s
            showMessage('Kaland Ind√≠t√°sa', `Biztosan elind√≠tod a(z) <strong>${title}</strong> kalandot? J√°t√©k t√≠pusa: ${type}. √År: ${price}`, () => requestGpsAndStart(gameId), true);
        }
        
        function formatTime(seconds) {
            const minutes = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        function startTimersAndGPS() {

if (window.AudioContext || window.webkitAudioContext) {
                try {
                    const AudioCtxt = window.AudioContext || window.webkitAudioContext;
                    const ctx = new AudioCtxt();
                    ctx.resume().then(() => {
                        // N√©ma hang lej√°tsz√°sa az enged√©ly megszerz√©s√©hez
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        gain.gain.value = 0.001; // Szinte n√©ma
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(0);
                        osc.stop(0.1);
                    });
                } catch (e) { console.log("Audio unlock hiba (nem kritikus):", e); }
            }

            if (appState.isTimerRunning) return; 

            appState.startTime = new Date();
            appState.isTimerRunning = true;
            clearInterval(appState.timerInterval);
            appState.timerInterval = setInterval(updateTimer, 1000);
            lastTimeUpdate = appState.startTime.getTime(); 
            
            if (appState.currentGame.taskOrder === 'explore') {
                if (appState.completedTasks.indexOf(0) === -1) appState.completedTasks.push(0);
                showTaskSelectionMap();
            } else {
                const nextTaskIndex = appState.currentGame.tasks[1].index; 
                appState.currentTaskIndex = nextTaskIndex; 
                loadTask(appState.currentTaskIndex); 
            }
            if (appState.map) checkGeofence();
            updateStatusDisplays(); 
            saveGameState(); 
        }

        let lastTimeUpdate = new Date().getTime();
        function updateTimer() {
            if (!appState.isTimerRunning) return; 
            
            const now = new Date().getTime();
            const diffInMs = now - lastTimeUpdate; // Eltelt id≈ë ezredm√°sodpercben

            // Csak akkor l√©p√ºnk, ha eltelt legal√°bb 1 m√°sodperc (1000ms)
            if (diffInMs >= 1000) {
                // Kisz√°moljuk, pontosan h√°ny m√°sodperc telt el (lehet, hogy 2, ha belassult a b√∂ng√©sz≈ë)
                const secondsPassed = Math.floor(diffInMs / 1000);
                
                appState.totalTime += secondsPassed;
                
                // UI friss√≠t√©se
                document.getElementById('timer-display').textContent = formatTime(appState.totalTime);

                // Geofence id≈ëz√≠t≈ë kezel√©se
                const currentTask = appState.currentGame ? appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex) : null; 
                if (currentTask && currentTask.isTaskTimerActive) {
                    appState.geofenceTime += secondsPassed;
                }
                document.getElementById('geofence-timer-display').textContent = formatTime(appState.geofenceTime);

                // FONTOS JAV√çT√ÅS:
                // Nem a 'now'-ra √°ll√≠tjuk, hanem pontosan annyival n√∂velj√ºk, amennyit elsz√°moltunk.
                // √çgy a marad√©k (pl. 50ms) megmarad a k√∂vetkez≈ë k√∂rre, √©s a sz√°ml√°l√≥ pontos marad.
                lastTimeUpdate += (secondsPassed * 1000);
                
                saveGameState(); 
            }
        }
        
        function updateStatusDisplays() {
            if (!appState.currentGame) return;
            document.getElementById('score-display').textContent = appState.score;
            const totalTasks = appState.currentGame.tasks.length - 1; 
            let displayedTask;
            if (appState.currentGame.taskOrder === 'explore') {
                 displayedTask = appState.completedTasks.filter(index => index > 0).length; 
            } else {
                 const currentIndexInArray = appState.currentGame.tasks.findIndex(t => t.index === appState.currentTaskIndex);
                 displayedTask = (currentIndexInArray > 0) ? currentIndexInArray : 0; 
            }
            document.getElementById('task-progress-display').textContent = `${displayedTask} / ${totalTasks}`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame(gameId, modeOverride = null) {
// --- GOOGLE ANALYTICS M√âR√âS BEILLESZT√âSE ---
    if (typeof gtag === 'function') {
        gtag('event', 'game_start', {
            'game_id': gameId,
            'game_mode': modeOverride || 'normal',
            'team_name': document.getElementById('team-name-input').value || 'unknown'
        });
    }
           	window.currentGameId = gameId;
		if (speechSynth.speaking) speechSynth.cancel();
            let gameMode;
            if (modeOverride) {
                gameMode = modeOverride;
            } else {
                const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
                gameMode = selectedMode ? selectedMode.value : 'normal'; 
            }
            
            appState.isTestModeEnabled = (gameMode === 'test' || gameMode === 'mock');
            appState.isManualMock = (gameMode === 'mock');
            
            if (!appState.isManualMock && manualMarker) {
                manualMarker.remove();
                manualMarker = null;
            }

            appState.currentGame = JSON.parse(JSON.stringify(games[gameId])); 
            
// --- √öJ K√ìD: J√°t√©k fejl√©c log√≥ be√°ll√≠t√°sa ---
            const gameLogo = document.getElementById('game-header-logo');
            if (gameLogo) {
                // Ha van egyedi logo, azt haszn√°ljuk, ha nincs, vissza√°llunk a cic√°sra
                gameLogo.src = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
            }
            // --------------------------------------------

	    appState.taskOrder = document.getElementById('task-order-select').value;
            
            if (appState.currentGame.type === 'team' && appState.taskOrder !== 'explore') appState.taskOrder = 'random';
            else if (appState.currentGame.type === 'explore') appState.taskOrder = 'explore';
            appState.currentGame.taskOrder = appState.taskOrder; 

            if (appState.taskOrder === 'explore') {
                 appState.completedTasks = [];
                 appState.availableTasks = appState.currentGame.tasks.filter(t => t.index > 0).map(t => t.index); 
                 appState.taskMarkers = {}; 
            }
            
            appState.currentTaskIndex = 0; appState.score = 0; appState.totalTime = 0; appState.geofenceTime = 0;
            appState.startTime = null; appState.isTimerRunning = false; appState.routeCoordinates = []; 
            
            appState.teamName = document.getElementById('team-name-input').value.trim() || null;
            appState.teamAvatar = document.getElementById('team-avatar-select').value || null;
            
            const startTaskTemplate = {
                index: 0, isStartTask: true, location: appState.currentGame.startLocation,
                geofenceRadius: GEOFENCE_DEFAULT_RADIUS,
                story: `**${appState.currentGame.title}**<br>${appState.currentGame.description}<br><br>Indulj el a megjel√∂lt Start Helysz√≠nre. Amikor el√©red a z√≥n√°t, nyomd meg a **Kaland Ind√≠t√°sa** gombot.`,
                prompt: '√ârd el a Start Helysz√≠nt az indul√°shoz!', hints: [], solution: '', acceptedAnswers: [],
                hintsUsed: 0, timeSpent: 0, taskScore: 0, isTaskTimerActive: false 
            };
            
            let realTasks = appState.currentGame.tasks.filter(t => t.index > 0); 
            
            if (appState.taskOrder === 'random' && realTasks.length >= 1) {
                const maxIndex = realTasks.reduce((max, task) => Math.max(max, task.index), 0);
                const finalTask = realTasks.find(t => t.index === maxIndex); 
                let tasksToShuffle = realTasks.filter(t => t.index !== maxIndex); 
                tasksToShuffle = shuffleArray(tasksToShuffle); 
                appState.currentGame.tasks = [ startTaskTemplate, ...tasksToShuffle, ...(finalTask ? [finalTask] : []) ];
            } else {
                appState.currentGame.tasks = [startTaskTemplate, ...realTasks];
            }
            
            appState.currentTaskIndex = startTaskTemplate.index; 
            
            document.getElementById('timer-display').textContent = '‚Äî:‚Äî';
            document.getElementById('geofence-timer-display').textContent = '‚Äî:‚Äî';
            document.getElementById('task-progress-display').textContent = `0 / ${appState.currentGame.tasks.length - 1}`; 
            
            clearInterval(appState.timerInterval);
            document.getElementById('test-mode-indicator').classList.toggle('hidden', !appState.isTestModeEnabled);
            showPage('game-page');
            
            setTimeout(() => {
                initializeMap();
                loadTask(appState.currentTaskIndex);
                watchPosition(); 
                updateStatusDisplays(); 
                saveGameState(); 
            }, 100);
        }

        function updateHintButtons(task) {
            const hint1Btn = document.getElementById('hint1-btn');
            const hint2Btn = document.getElementById('hint2-btn');
            const solutionBtn = document.getElementById('solution-btn');
            if (task.isStartTask) { hint1Btn.disabled = true; hint2Btn.disabled = true; solutionBtn.disabled = true; return; }
            const hasHint1 = task.hints && task.hints.length >= 1;
            const hasHint2 = task.hints && task.hints.length >= 2;
            const maxHints = task.hints.length;
            const applyHintState = (btn, index) => {
                 if (task.hintsUsed >= index) btn.classList.add('used');
                 else btn.classList.remove('used');
                 btn.disabled = (index > 1 && task.hintsUsed < index - 1);
                 return btn.disabled;
            }
            hint1Btn.disabled = !hasHint1 || applyHintState(hint1Btn, 1);
            hint2Btn.disabled = !hasHint2 || applyHintState(hint2Btn, 2);
            const isFinalTaskInExplore = appState.currentGame.taskOrder === 'explore' && appState.availableTasks.length === 1; 

	    if (task.disableSolution) {
        solutionBtn.style.display = 'none'; // Teljesen elt√ºnteti
    } else {
        solutionBtn.style.display = 'inline-block'; // Megjelen√≠ti
        // Csak akkor akt√≠v, ha elfogytak a seg√≠ts√©gek
        solutionBtn.disabled = (task.hintsUsed < maxHints || isFinalTaskInExplore);
    }            

            if (!appState.isTestModeEnabled && !task.isTaskTimerActive) { 
        hint1Btn.disabled = true;
        hint2Btn.disabled = true;
        solutionBtn.disabled = true;
            }
        }

        function loadTask(taskIndex) {
            if (speechSynth.speaking) speechSynth.cancel();
            document.getElementById('content-page-wrapper').scrollTo({ top: 0, behavior: 'instant' });
            const task = appState.currentGame.tasks.find(t => t.index === taskIndex); 
            if (!task) return;
            appState.currentTaskIndex = taskIndex; 
            const isStartTask = task.isStartTask; 
            if (typeof task.isTaskTimerActive === 'undefined') task.isTaskTimerActive = false;
            if (!isStartTask && task.taskScore !== DEFAULT_SCORE_PER_TASK && task.taskScore === 0 && task.hintsUsed === 0) task.taskScore = DEFAULT_SCORE_PER_TASK; 
            else if (isStartTask) task.taskScore = 0;

            document.getElementById('normal-task-content').classList.remove('hidden');
            document.getElementById('explore-selection-container').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            document.getElementById('google-maps-btn').classList.remove('hidden'); 
            document.getElementById('report-error-btn').classList.remove('hidden');

const backBtn = document.getElementById('back-to-map-btn');
    if (backBtn) {
        if (appState.currentGame.taskOrder === 'explore' && !isStartTask) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden');
        }
    }            

            const speakBtn = document.getElementById('speak-story-btn');
            if (speakBtn && ('speechSynthesis' in window)) speakBtn.style.display = 'block'; 
            else if (speakBtn && speakBtn.parentElement) speakBtn.remove();
            
            if (isStartTask) task.startTime = 0;
            document.getElementById('story').innerHTML = task.story;
            document.getElementById('prompt').innerHTML = task.prompt;
            document.getElementById('answer-input').value = '';
            document.getElementById('story-details').open = true; 
            if(typeof task.hintsUsed === 'undefined') task.hintsUsed = 0;
            
            if (!isStartTask) {
                 document.getElementById('submit-answer-btn').disabled = true; 
                 document.getElementById('answer-input').disabled = true;
                 updateHintButtons(task);
                 document.getElementById('answer-input-container').classList.remove('hidden');
                 document.getElementById('hint-buttons-container').classList.remove('hidden');
                 document.getElementById('prompt').classList.remove('hidden'); 
            } else {
                 document.getElementById('submit-answer-btn').disabled = true;
                 document.getElementById('answer-input').disabled = true;
                 document.getElementById('hint1-btn').disabled = true;
                 document.getElementById('hint2-btn').disabled = true;
                 document.getElementById('solution-btn').disabled = true;
                 document.getElementById('answer-input-container').classList.add('hidden');
                 document.getElementById('hint-buttons-container').classList.add('hidden');
                 document.getElementById('prompt').classList.remove('hidden');
                 if (appState.currentGame.taskOrder === 'explore') {
                     document.getElementById('start-game-btn').disabled = false; 
                     document.getElementById('start-task-button-container').classList.remove('hidden');
                 }
            }
            if (appState.map) {
                updateTaskMarker(task.location);
                Object.values(appState.taskMarkers).forEach(m => m.remove());
                appState.taskMarkers = {};
            }
            checkGeofence(); 
            updateStatusDisplays();
        }

        function handleCorrectAnswer() {
// --- GOOGLE ANALYTICS M√âR√âS BEILLESZT√âSE ---
    if (typeof gtag === 'function') {
        gtag('event', 'level_up', {
            'level': appState.currentTaskIndex,
            'character': appState.teamAvatar || 'none',
            'score': appState.score
        });
    }            
	    if (speechSynth.speaking) speechSynth.cancel();
            const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex); 
            if (!currentTask) return;
            currentTask.timeSpent = appState.geofenceTime - (currentTask.startTime || 0);
            currentTask.isTaskTimerActive = false;
            if (currentTask.taskScore > 0 && !currentTask.isStartTask) appState.score += currentTask.taskScore; 
            
            if (appState.currentGame.taskOrder === 'explore') {
                if (currentTask && !currentTask.isStartTask) {
                    const indexToRemove = appState.availableTasks.indexOf(appState.currentTaskIndex);
                    if (indexToRemove > -1) appState.availableTasks.splice(indexToRemove, 1);
                    if (appState.completedTasks.indexOf(currentTask.index) === -1) appState.completedTasks.push(currentTask.index);
                }
                if (appState.availableTasks.length === 0) endGame();
                else {
                     appState.currentTaskIndex = 0; 
                     showTaskSelectionMap();
                }
            } else {
                const currentIndexInArray = appState.currentGame.tasks.findIndex(t => t.index === appState.currentTaskIndex);
                const nextIndexInArray = currentIndexInArray + 1;
                if (nextIndexInArray < appState.currentGame.tasks.length) {
                    const nextTaskIndex = appState.currentGame.tasks[nextIndexInArray].index;
                    loadTask(nextTaskIndex); 
                } else {
                    endGame();
                }
            }
            updateStatusDisplays();
	    saveGameState(); 
        }
        
// --- END GAME (JAV√çTOTT VERZI√ì) ---
        function endGame() {
    // --- GOOGLE ANALYTICS M√âR√âS ---
    if (typeof gtag === 'function') {
        gtag('event', 'game_complete', {
            'game_id': appState.currentGame ? appState.currentGame.id : 'unknown',
            'score': appState.score,
            'total_time': appState.totalTime,
            'team_name': appState.teamName
        });
    }
    
    // --- FONTOS: Elmentj√ºk az ID-t √©s a pontot a modalnak ---
    window.currentGameId = appState.currentGame ? appState.currentGame.id : null;
    window.currentScoreForHighlight = appState.score;
    // --------------------------------------------------------

// --- √öJ R√âSZ: Tart√≥s teljes√≠t√©s sz√°ml√°l√≥ n√∂vel√©se ---
    if (appState.currentGame) {
        const countKey = 'MystiGo_Perm_Count_' + appState.currentGame.id;
        
        // Jelenlegi √©rt√©k lek√©r√©se
        let currentCount = parseInt(localStorage.getItem(countKey) || 0);
        
        // Visszakompatibilit√°s ellen≈ërz√©se n√∂vel√©s el≈ëtt
        if (currentCount === 0 && localStorage.getItem('MystiGo_Perm_Completed_' + appState.currentGame.id) === 'true') {
            currentCount = 1;
        }

        // N√∂velj√ºk √©s mentj√ºk
        localStorage.setItem(countKey, currentCount + 1);
        
        // Biztons√°g kedv√©√©rt a r√©gi boolean kulcsot is be√°ll√≠tjuk "true"-ra
        localStorage.setItem('MystiGo_Perm_Completed_' + appState.currentGame.id, 'true');
    }

    if (speechSynth.speaking) speechSynth.cancel();

    // --- Ment√©s a Firebase Ranglist√°ra ---
    if (appState.currentGame && window.saveScoreToFirebase) {
        const totalTaskTime = appState.currentGame.tasks.filter(t => !t.isStartTask).reduce((sum, task) => sum + (task.timeSpent || 0), 0);

        window.saveScoreToFirebase({
            gameId: appState.currentGame.id,
            teamName: appState.teamName,
            teamAvatar: appState.teamAvatar,
            score: appState.score,
            totalTime: appState.totalTime,
            geofenceTime: totalTaskTime
        });
        
        if (window.incrementGameCompletion) {
                window.incrementGameCompletion(appState.currentGame.id);
            }
        }

            // Jelenlegi id≈ë meghat√°roz√°sa
            const endTime = new Date();
            const formattedEndTime = `${endTime.getFullYear()}.${String(endTime.getMonth()+1).padStart(2,'0')}.${String(endTime.getDate()).padStart(2,'0')} ${String(endTime.getHours()).padStart(2,'0')}:${String(endTime.getMinutes()).padStart(2,'0')}`;
            
            // J√°t√©k k√∂zbeni id≈ëz√≠t≈ëk √©s figyel≈ëk le√°ll√≠t√°sa
            clearInterval(appState.timerInterval);
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            
            // J√°t√©k k√∂zbeni t√©rk√©p (nagy t√©rk√©p) t√∂rl√©se, ha l√©tezik
            if (appState.map) { appState.map.remove(); appState.map = null; }
            if (manualMarker) { manualMarker.remove(); manualMarker = null; }

            // Id≈ëk sz√°m√≠t√°sa
            const totalTaskTime = appState.currentGame.tasks.filter(t => !t.isStartTask).reduce((sum, task) => sum + (task.timeSpent || 0), 0);
            
            // --- JAV√çTOTT LOG√ì CSERE K√ìD ---
            // 1. A k√°rty√°n bel√ºli log√≥ cser√©je
            const endPageLogo = document.getElementById('end-page-logo');
            if (endPageLogo) {
                endPageLogo.src = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
            }

            // 2. A fels≈ë fejl√©c log√≥ cser√©je
            const mainHeaderLogo = document.getElementById('main-header-logo');
            if (mainHeaderLogo) {
                mainHeaderLogo.src = appState.currentGame.headerLogo || "logo/MystiGo_logo.png";
            }
            // ------------------------------------------

	    // HTML elemek kit√∂lt√©se az eredm√©nyekkel
            document.getElementById('end-story').innerHTML = appState.currentGame.endStory;
            document.getElementById('final-score').textContent = appState.score;
            document.getElementById('final-time').textContent = formatTime(appState.totalTime); 
            document.getElementById('final-team-display').textContent = appState.teamName || "N√©vtelen Csapat";
            document.getElementById('final-team-avatar-icon').textContent = AVATAR_ICONS[appState.teamAvatar] || '';
            document.getElementById('end-timestamp').textContent = `Befejez√©s: ${formattedEndTime}`;
            document.getElementById('final-geofence-time').textContent = formatTime(totalTaskTime);
            
            // Megjelen√≠tj√ºk a v√©gs≈ë oldalt
            showContentPage('end-page');
            
// --- √öJ R√âSZ KEZDETE: √ârt√©kel≈ë gomb kezel√©se ---
const reviewBtn = document.getElementById('game-review-btn');
if (reviewBtn) {
    // Ha az adatb√°zisban van megadva reviewUrl ehhez a j√°t√©khoz
    if (appState.currentGame && appState.currentGame.reviewUrl) {
        reviewBtn.href = appState.currentGame.reviewUrl; // Link be√°ll√≠t√°sa
        reviewBtn.classList.remove('hidden'); // Gomb megjelen√≠t√©se
        reviewBtn.classList.add('block');     // Biztos√≠tjuk, hogy blokk elem legyen
    } else {
        // Ha nincs link, elrejtj√ºk a gombot
        reviewBtn.classList.add('hidden');
        reviewBtn.classList.remove('block');
    }
}
// --- √öJ R√âSZ V√âGE ---

            // K√©zi let√∂lt√©s gomb l√°that√≥v√° t√©tele
            const manualPdfBtn = document.querySelector('button[onclick="downloadPDF()"]');
            if(manualPdfBtn) manualPdfBtn.classList.remove('hidden');
            
            // --- T√âRK√âP RAJZOL√ÅSA BIZTONS√ÅGOSAN ---
            const oldMapDiv = document.getElementById('route-map');
            if (oldMapDiv) {
                const parent = oldMapDiv.parentNode;
                const newMapDiv = document.createElement('div');
                newMapDiv.id = 'route-map';
                // Ugyanaz a st√≠lus, ami a HTML-ben volt
                newMapDiv.style.cssText = "height: 300px; width: 100%; border-radius: 1rem; border: 3px solid #E0F7FA; margin: 20px 0;";
                
                // Beillesztj√ºk a r√©gi hely√©re (az id="end-timestamp" ut√°n)
                const refNode = document.getElementById('end-timestamp');
                if (refNode && refNode.nextSibling) {
                    parent.insertBefore(newMapDiv, refNode.nextSibling);
                } else {
                    parent.appendChild(newMapDiv); // Fallback
                }
                oldMapDiv.remove();
            }

            try {
                if (appState.routeCoordinates.length > 0) {
                    const originalAny3d = L.Browser.any3d; const originalIelt9 = L.Browser.ielt9;
                    L.Browser.any3d = false; L.Browser.ielt9 = true; 
                    
                    // T√©rk√©p l√©trehoz√°sa
                    const endMap = L.map('route-map', { zoomControl: false, fadeAnimation: false, markerZoomAnimation: false, preferCanvas: true });
                    
                    L.Browser.any3d = originalAny3d; L.Browser.ielt9 = originalIelt9;
                    

                    L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=6zyg285SLPbgmb1LZStQ', {
                        attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                        crossOrigin: true,
                        tileSize: 512,
                        zoomOffset: -1,
                        maxZoom: 20
                    }).addTo(endMap);

                    
                    const polyline = L.polyline(appState.routeCoordinates, { color: 'var(--brand-orange)', weight: 5, opacity: 0.8 }).addTo(endMap);
                    endMap.fitBounds(polyline.getBounds().pad(0.2));
                    
                    setTimeout(() => { 
                        try {
                            endMap.invalidateSize(); 
                            endMap.fitBounds(polyline.getBounds(), { padding: [20, 20], maxZoom: 18, animate: false }); 
                        } catch(e) { console.log("T√©rk√©p m√©retez√©si hiba (figyelmen k√≠v√ºl hagyhat√≥)"); }
                    }, 800);

                    // Start pont
                    const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location; 
                    L.marker([startLoc.lat, startLoc.lng], { title: 'Start' }).addTo(endMap).bindPopup('<b>Start Helysz√≠n</b>');

                    // Feladatok jel√∂l√©se
                    appState.currentGame.tasks.filter(t => !t.isStartTask).forEach(task => {
                        if (task.location) {
                            const isCompleted = appState.currentGame.taskOrder === 'explore' ? appState.completedTasks.includes(task.index) : true;
                            
                            // --- √öJ LOGIKA: Piros X √©s h√°tt√©r ha √°tugrottuk ---
                            // Megn√©zz√ºk, hogy van-e skipped jel√∂l√©s, VAGY 0 pontot √©rt-e (biztons√°gi tartal√©k)
                            const isSkipped = (task.skipped === true || task.taskScore === 0);

                            // Alap ikon √©s h√°tt√©rsz√≠n (Z√∂ld pipa vagy sz√°m)
                            let iconContent = isCompleted ? '‚úÖ' : task.index.toString();
                            // Fontos: a !bg-green-500 a Tailwind miatt kell, hogy fel√ºl√≠rja a k√©ket
                            let bgClass = isCompleted ? '!bg-green-500' : ''; 

                            // HA √ÅTUGROTTUK: Piros X √©s piros h√°tt√©r
                            if (isSkipped) {
                                iconContent = '‚ùå';
                                bgClass = '!bg-red-500 !border-white'; 
                            }

                            const taskMarkerIcon = L.divIcon({
                                // Hozz√°adjuk a bgClass-t a megl√©v≈ë oszt√°lyhoz
                                className: `task-selector-marker ${bgClass}`, 
                                html: iconContent,
                                iconSize: [30, 30], 
                                iconAnchor: [15, 30], 
                                popupAnchor: [0, -30]
                            });
                            // --------------------------------------------------

                            L.marker([task.location.lat, task.location.lng], { icon: taskMarkerIcon, title: `Feladat ${task.index}` }).addTo(endMap).bindPopup(`<b>Feladat ${task.index}</b>`);
                        }
                    });
                } else {
                     routeMapDiv.innerHTML = `<p class="p-4 text-gray-500">Nem siker√ºlt √∫tvonalat r√∂gz√≠teni (nincs GPS adat).</p>`;
                }
            } catch (err) {
                console.error("Hiba az eredm√©nyjelz≈ë t√©rk√©p rajzol√°sakor:", err);
                routeMapDiv.innerHTML = `<p class="p-4 text-red-500">T√©rk√©p bet√∂lt√©si hiba.</p>`;
                // Nem √°ll√≠tjuk meg a fut√°st, hogy a ment√©s t√∂rl√©se mindenk√©pp lefusson!
            }
            
            // --- FONTOS M≈∞VELETEK A T√âRK√âP UT√ÅN ---
            
            // 1. PDF Automatikus let√∂lt√©s
            setTimeout(() => {
                downloadPDF();
            }, 1000); 
            
            // 2. Ment√©s t√∂rl√©se (Hogy ne t√∂ltse vissza √∫jra)
            if(appState.currentGame) {
                console.log("Ment√©s t√∂rl√©se a j√°t√©k v√©g√©n:", appState.currentGame.id);
                deleteSavedGame(appState.currentGame.id);
            }
            

        }
        
        function toggleMapClickMock(enable) {
            if (!appState.map) return;
            if (appState.currentGame && appState.currentGame.taskOrder === 'explore' && appState.currentTaskIndex === 0 && appState.isTimerRunning) {
                if (appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
                return;
            }
            if (enable) {
                if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
                appState.geoWatchId = null;
                if (!appState.map.clickHandler) {
                     appState.map.clickHandler = (e) => {
                        const latLng = e.latlng;
                        const mockIcon = L.divIcon({ className: 'player-marker', iconSize: [20, 20], html: 'üìç', style: 'background-color: blue; border-color: white;' });
                        if (manualMarker) manualMarker.setLatLng(latLng); else manualMarker = L.marker(latLng, { icon: mockIcon }).addTo(appState.map);
                        appState.userPosition = { lat: latLng.lat, lng: latLng.lng };
                        if (appState.isTimerRunning) { appState.routeCoordinates.push([latLng.lat, latLng.lng]); saveGameState(); }
                        checkGeofence();
                        const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                        const bounds = L.latLngBounds(manualMarker.getLatLng(), L.latLng(currentTask.location.lat, currentTask.location.lng));
                        appState.map.fitBounds(bounds.pad(0.2)); 
                    };
                    appState.map.on('click', appState.map.clickHandler);
                }
            } else {
                if (appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
                if (manualMarker) { manualMarker.remove(); manualMarker = null; }
                if (appState.isManualMock) { appState.userPosition = null; watchPosition(); }
            }
        }
        
        function initializeMap() {
            if (appState.map) appState.map.remove();
            const startLoc = appState.currentGame.startLocation;
            appState.map = L.map('map', { zoomControl: false }).setView([startLoc.lat, startLoc.lng], 16);

            L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=6zyg285SLPbgmb1LZStQ', {
                attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                crossOrigin: true,
                tileSize: 512,
                zoomOffset: -1,
                maxZoom: 18.5
            }).addTo(appState.map);


            toggleMapClickMock(appState.isManualMock); 
        }




        function updatePlayerMarker(lat, lng) {
            if (!appState.map) return;

            // 1. Poz√≠ci√≥ ment√©se
            appState.userPosition = { lat: lat, lng: lng };

            // √ötvonal r√∂gz√≠t√©se
            if (appState.isTimerRunning) {
                appState.routeCoordinates.push([lat, lng]);
            }

            if (!appState.isTestModeEnabled && !appState.isManualMock) {
                const latLng = new L.LatLng(lat, lng);

                // 2. Marker (k√©k/s√°rga p√∂tty) kezel√©se
                if (appState.playerMarker) {
                    appState.playerMarker.setLatLng(latLng);
                } else {
                    const playerIcon = L.divIcon({
                        className: 'player-marker',
                        html: '', // <--- EZ A SOR BIZTOS√çTJA, HOGY NE LEGYEN BENNE T≈∞/EMOJI
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                        popupAnchor: [0, -10]
                    });
                    
                    appState.playerMarker = L.marker(latLng, { 
                        icon: playerIcon,
                        zIndexOffset: 1000 
                    }).addTo(appState.map);
                }
                
                // 3. T√©rk√©p igaz√≠t√°sa (Zoom logika)
                if (appState.geofenceCircle && appState.playerMarker) { 
                    const targetLatLng = appState.geofenceCircle.getLatLng();
                    const distance = latLng.distanceTo(targetLatLng);
                    const radius = appState.geofenceCircle.getRadius();

                    // Ha k√∂zel vagyunk (< sug√°r + 20m), agressz√≠v zoom (19)
                    if (distance <= radius + 20) {
                        appState.map.setView(latLng, 19, { animate: true });
                    } else {
                        // Ha t√°volabb, mindent mutatunk (maxZoom 18)
                        const bounds = L.latLngBounds(latLng, targetLatLng);
                        appState.map.fitBounds(bounds.pad(0.1), { maxZoom: 18, animate: true }); 
                    }
                } else {
                    appState.map.setView(latLng, 17);
                }
            }
            
            checkGeofence();
        }




        function updateTaskMarker(location) {
            if (!appState.map) return;
            const currentTask = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
            if (!currentTask) return;
            const currentTaskLoc = L.latLng(location.lat, location.lng);
            const currentRadius = currentTask.geofenceRadius || GEOFENCE_DEFAULT_RADIUS;

            if (appState.geofenceCircle) {
                appState.geofenceCircle.setLatLng(currentTaskLoc); appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.addTo(appState.map);
            } else {
                appState.geofenceCircle = L.circle(currentTaskLoc, { radius: currentRadius, color: 'red', fillColor: 'red', fillOpacity: 0.1, weight: 2, className: 'geofence-circle' }).addTo(appState.map);
            }
            const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
            if (playerMarkerForBounds) {
		    const bounds = L.latLngBounds(playerMarkerForBounds.getLatLng(), currentTaskLoc);
		    // Itt is add hozz√° a maxZoom-ot:
		    appState.map.fitBounds(bounds.pad(0.2), { maxZoom: 18, animate: true }); 
		} else {
		    // Ez az alap zoom, ha m√©g nincs GPS jel (pl. 16):
		    appState.map.setView(currentTaskLoc, 16); 
	              }
        }

        function watchPosition() {
            if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId);
            if (!appState.isTestModeEnabled && !appState.isManualMock && 'geolocation' in navigator) {
                appState.geoWatchId = navigator.geolocation.watchPosition(
                    (pos) => { updatePlayerMarker(pos.coords.latitude, pos.coords.longitude); }, 
                    (err) => {
                        console.warn(`GEO ERROR(${err.code}): ${err.message}`);
                        if (!appState.isTestModeEnabled) { showLoading(false); showMessage('GPS Hiba', t('gps_required'), () => { resetApp(); }); } 
                        else { showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d folytat√≥dik.'); checkGeofence(); }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000, frequency: 3000 }
                );
            } else if (appState.isTestModeEnabled && !appState.isManualMock) {
                 const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                 appState.userPosition = task ? { lat: task.location.lat, lng: task.location.lng } : { lat: appState.currentGame.startLocation.lat, lng: appState.currentGame.startLocation.lng };
                 checkGeofence();
            } else if (appState.isManualMock) {
                 appState.userPosition = (manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : null;
                 checkGeofence();
            }
        }
        
        function haversineDistance(c1, c2) {
            const R = 6371e3; const toRad = x => x*Math.PI/180;
            const p1=toRad(c1.lat), p2=toRad(c2.lat), dp=toRad(c2.lat-c1.lat), dl=toRad(c2.lng-c1.lng);
            const a = Math.sin(dp/2)*Math.sin(dp/2)+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)*Math.sin(dl/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function checkGeofence() {
            const taskInteractionArea = document.getElementById('task-interaction-area');
            const distEl = document.getElementById('distance-info');
            const startButtonContainer = document.getElementById('start-task-button-container'); 
            const exploreSelectionContainer = document.getElementById('explore-selection-container');
            const currentLocation = (appState.isManualMock && manualMarker) ? { lat: manualMarker.getLatLng().lat, lng: manualMarker.getLatLng().lng } : appState.userPosition;
            const currentTask = appState.currentGame ? appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex) : null;
            if (!currentTask) return;

            const currentRadius = currentTask.geofenceRadius || GEOFENCE_DEFAULT_RADIUS;
            const isStartTask = currentTask.isStartTask; 
            
            if (appState.currentGame.taskOrder === 'explore' && isStartTask) {
                 startButtonContainer.classList.remove('hidden');
                 document.getElementById('start-game-btn').disabled = false;
                 taskInteractionArea.classList.remove('hidden'); 
                 document.getElementById('prompt').classList.add('hidden');
                 distEl.textContent = "Kaland ind√≠that√≥ b√°rhol!";
                 distEl.className = 'text-center text-xs font-bold mt-2 text-green-600';
                 if (appState.geofenceCircle) { appState.geofenceCircle.remove(); appState.geofenceCircle = null; }
                 if (appState.isTimerRunning) showTaskSelectionMap();
                 return; 
            }
            if (appState.currentGame.taskOrder === 'explore' && appState.isTimerRunning && appState.currentTaskIndex === 0) {
                 taskInteractionArea.classList.add('hidden');
                 exploreSelectionContainer.classList.remove('hidden');
                 renderTaskMarkers();
                 return; 
            }
            
            if (!document.getElementById('report-error-modal').classList.contains('hidden')) {
                 if (currentLocation) {
                    const distance = haversineDistance(currentLocation, currentTask.location);
                    appState.isInZone = distance <= currentRadius;
                    distEl.textContent = appState.isInZone ? t('in_zone') : t('out_zone', Math.round(distance));
                }
                return;
            }

            startButtonContainer.classList.add('hidden');
            exploreSelectionContainer.classList.add('hidden'); 
            
            if (appState.isTestModeEnabled && !appState.isManualMock) {
                appState.isInZone = true;
		        playArrivalNotification();                
                if (!currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
		            playArrivalNotification();
                    if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                if (isStartTask) { 
                    startButtonContainer.classList.remove('hidden');
                    taskInteractionArea.classList.remove('hidden'); 
                    document.getElementById('prompt').classList.add('hidden');
                } else {
                     document.getElementById('submit-answer-btn').disabled = false;
                     document.getElementById('answer-input').disabled = false;
                     taskInteractionArea.classList.remove('hidden'); 
                     document.getElementById('prompt').classList.remove('hidden');
                }
                distEl.textContent = "A Geo-fence inakt√≠v (TESZT M√ìD)";
                distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); }
                
            } else {
                if (!currentLocation) {
                    appState.isInZone = false;
                    document.getElementById('submit-answer-btn').disabled = true;
                    document.getElementById('answer-input').disabled = true;
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                    
                    if (appState.isManualMock) {
                        distEl.textContent = "Kattints a t√©rk√©pre a poz√≠ci√≥ be√°ll√≠t√°s√°hoz!";
                        distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    } else {
                        distEl.textContent = "Helyzet meghat√°roz√°sa...";
                        distEl.className='text-center text-xs font-bold mt-2 text-gray-500';
                    }
                    
                    if (appState.geofenceCircle) { appState.geofenceCircle.setRadius(currentRadius); appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); }
                    return; 
                }

                const distance = haversineDistance(currentLocation, currentTask.location);
                appState.isInZone = distance <= currentRadius; 
                
                if (appState.isInZone && !currentTask.isTaskTimerActive) {
                    currentTask.isTaskTimerActive = true;
                    playArrivalNotification();
			        if (appState.isTimerRunning && !isStartTask) currentTask.startTime = appState.geofenceTime;
                }
                
                if (appState.isInZone) {
                    distEl.textContent = t('in_zone');
                    distEl.className='text-center text-xs font-bold mt-2 text-green-600';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: '#04b36c', fillColor: '#04b36c', fillOpacity: 0.1 }); 
                    document.getElementById('submit-answer-btn').disabled = false;
                    document.getElementById('answer-input').disabled = false;
                    taskInteractionArea.classList.remove('hidden'); 
                    if (isStartTask) {
                        startButtonContainer.classList.remove('hidden');
                        document.getElementById('submit-answer-btn').disabled = true; 
                        document.getElementById('answer-input').disabled = true;
                        taskInteractionArea.classList.remove('hidden'); 
                        document.getElementById('prompt').classList.add('hidden');
                    }
                } else {
                    distEl.textContent = t('out_zone', Math.round(distance));
                    distEl.className='text-center text-xs font-bold mt-2 text-brand-orange-500';
                    appState.geofenceCircle.setRadius(currentRadius);
                    appState.geofenceCircle.setStyle({ color: 'red', fillColor: 'red', fillOpacity: 0.1 }); 
                    if (!isStartTask && !currentTask.isTaskTimerActive) taskInteractionArea.classList.add('hidden');
                    else { taskInteractionArea.classList.remove('hidden'); document.getElementById('prompt').classList.remove('hidden'); }
                }
            }
            if (!currentTask.isStartTask) updateHintButtons(currentTask);
            if (currentTask && currentTask.isTaskTimerActive && !isStartTask) {
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('answer-input').disabled = false;
            }
            saveGameState(); 
        }

        function exploreSelectionMapMarkerSelectHandler(e) {
            if (!e.target || !e.target.options || e.target.options.taskIndex === undefined) return;
            loadTask(e.target.options.taskIndex);
            document.getElementById('explore-selection-container').classList.add('hidden');
            if (appState.isManualMock) toggleMapClickMock(true); 
        }
        
// --- √öJ F√úGGV√âNY: Visszal√©p√©s a t√©rk√©pre ---
function backToExploreMap() {
    // Csak Explore m√≥dban √©rtelmezett
    if (appState.currentGame.taskOrder !== 'explore') return;

    // Elrejtj√ºk a feladat interakci√≥s fel√ºletet
    document.getElementById('task-interaction-area').classList.add('hidden');
    
    // Megjelen√≠tj√ºk a v√°laszt√≥ fel√ºletet
    document.getElementById('explore-selection-container').classList.remove('hidden');

    // --- √öJ SOR: A vissza gomb elrejt√©se ---
    document.getElementById('back-to-map-btn').classList.add('hidden');
    // ---------------------------------------
    
    // T√©rk√©p vissza√°ll√≠t√°sa v√°laszt√≥ m√≥dba
    showTaskSelectionMap();
    
    // Az aktu√°lis task index√©t vissza√°ll√≠tjuk 0-ra (vagyis "v√°laszt√°s alatt" √°llapotra)
    appState.currentTaskIndex = 0;
    
    // T√©rk√©p friss√≠t√©se (hogy a mock click handler rendben legyen)
    if (appState.isManualMock) {
        toggleMapClickMock(true);
    }
}



        function renderTaskMarkers() {
            if (!appState.map || appState.currentGame.taskOrder !== 'explore') return;
            Object.values(appState.taskMarkers).forEach(m => m.remove());
            appState.taskMarkers = {};
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            
            const bounds = [];
            appState.availableTasks.forEach(taskIndex => {
                const task = appState.currentGame.tasks.find(t => t.index === taskIndex);
                if (!task) return;
                const taskIcon = L.divIcon({ className: 'task-selector-marker', html: task.index.toString(), iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] });
                const marker = L.marker([task.location.lat, task.location.lng], { icon: taskIcon, title: `Feladat ${task.index} - V√°lassz`, taskIndex: task.index }).addTo(appState.map).bindPopup(`<b>Feladat ${task.index}</b><br>Kattints a kiv√°laszt√°shoz!`);
                marker.on('click', exploreSelectionMapMarkerSelectHandler);
                appState.taskMarkers[task.index] = marker;
                bounds.push([task.location.lat, task.location.lng]);
            });
            const playerMarkerForBounds = appState.isManualMock ? manualMarker : appState.playerMarker;
            if (playerMarkerForBounds) bounds.push(playerMarkerForBounds.getLatLng());
            else if (appState.userPosition) bounds.push([appState.userPosition.lat, appState.userPosition.lng]);
            
            if (bounds.length > 0 && appState.isTimerRunning) {
                 const now = Date.now();
                 if (now - appState.lastAutoZoomTime > 10000 || appState.lastAutoZoomTime === 0) {
                     appState.map.fitBounds(L.latLngBounds(bounds).pad(0.2));
                     appState.lastAutoZoomTime = now; 
                 }
            } else if (bounds.length > 0) {
                 const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location;
                 appState.map.setView([startLoc.lat, startLoc.lng], 16);
            }
            appState.map.invalidateSize(true);
        }

        function showTaskSelectionMap() {
            if (appState.currentGame.taskOrder !== 'explore' || !appState.map) return;
            if (appState.geofenceCircle) appState.geofenceCircle.remove();
            document.getElementById('task-interaction-area').classList.add('hidden');
            document.getElementById('start-task-button-container').classList.add('hidden');
            const backBtn = document.getElementById('back-to-map-btn');
	      if (backBtn) backBtn.classList.add('hidden');
	    document.getElementById('explore-selection-container').classList.remove('hidden');
            renderTaskMarkers();
            if (appState.isManualMock && appState.map.clickHandler) { appState.map.off('click', appState.map.clickHandler); appState.map.clickHandler = null; }
            document.getElementById('distance-info').textContent = "V√°lassz feladatot a t√©rk√©pen!";
            document.getElementById('distance-info').className='text-center text-xs font-bold mt-2 text-brand-blue';
        }

        function startNavigation() {
            if (!appState.currentGame) return showMessage('Hiba', 'Nincs aktu√°lis kaland elind√≠tva.');
            let lat, lng;
            if (appState.currentTaskIndex === 0) {
                 const startLoc = appState.currentGame.tasks.find(t => t.index === 0).location;
                 lat = startLoc.lat; lng = startLoc.lng;
                 showMessage('Navig√°l√°s a kezd≈ëponthoz', 'A Start Helysz√≠nre navig√°lunk.');
            } else {
                 const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                 if (!task) return showMessage('Hiba', 'Nincs aktu√°lis feladat a navig√°ci√≥hoz.');
                 lat = task.location.lat; lng = task.location.lng;
            }
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        function speakStory(event) {
            event.preventDefault(); 
            if (!('speechSynthesis' in window)) return showMessage('Felolvas√°si hiba', 'A b√∂ng√©sz≈ëje nem t√°mogatja a be√©p√≠tett hangfelolvas√°st (Web Speech API).');
            if (speechSynth.speaking) { speechSynth.cancel(); return; }
            const storyElement = document.getElementById('story');
            if (!storyElement) return;
            const storyText = storyElement.textContent.trim();
            if (storyText === "") return;
            const utterance = new SpeechSynthesisUtterance(storyText);
            const hungarianVoice = speechSynth.getVoices().find(voice => voice.lang.startsWith('hu-'));
            if (hungarianVoice) utterance.voice = hungarianVoice; else utterance.lang = 'hu-HU'; 
            speechSynth.speak(utterance);
        }
        
        function playArrivalNotification() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(500, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1); 
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.5); 
        }

        function shareResult(platform) {
            const finalScore = document.getElementById('final-score').textContent;
            const finalTime = document.getElementById('final-time').textContent;
            const teamName = appState.teamName || "N√©v";
            const gameTitle = appState.currentGame ? appState.currentGame.title : "Kaland";
            const text = `√âppen most fejeztem be a(z) ${gameTitle} kalandot a(z) ${teamName} csapattal! üèÜ Pontsz√°m: ${finalScore}, Teljes id≈ë: ${finalTime}. Pr√≥b√°ld ki te is! #MystiGo #V√°rosiKaland #KalandJ√°t√©k`;
            const url = 'https://www.mystigo.hu/'; 
            let shareUrl = '';
            switch (platform) {
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`; break;
                case 'system':
                    if (navigator.share) { navigator.share({ title: 'MystiGo Kaland Teljes√≠tve!', text: text, url: url }).catch(error => console.log('Megoszt√°s megszak√≠tva vagy hiba t√∂rt√©nt', error)); return; } 
                    shareUrl = `mailto:?subject=MystiGo Kaland&body=${encodeURIComponent(text + " " + url)}`; break;
                default: return;
            }
            if (shareUrl) window.open(shareUrl, '_blank');
        }
        
        function normalizeAnswer(str) { 
            if (typeof str !== 'string') return '';
            return str.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '');
        }


// --- GPS TESZT GLOB√ÅLIS V√ÅLTOZ√ìK ---
let gpsTestMap = null;
let gpsTestMarker = null;
let gpsTestCircle = null;
let gpsTestWatchId = null;
let gpsTestInterval = null;
let bestAccuracy = 99999;
let lastTestLat = null;
let lastTestLng = null; 

// --- √öJ GPS TESZT F√úGGV√âNY ---
window.testGpsConnection = function() {
    // UI elemek el≈ëk√©sz√≠t√©se
    const container = document.getElementById('gps-test-container');
    const statusText = document.getElementById('gps-test-status');
    const resultMsg = document.getElementById('gps-result-message');
    const accValue = document.getElementById('gps-accuracy-value');
    const testBtn = document.getElementById('gps-test-btn');

    // Resetel√©s
    container.classList.remove('hidden');
    resultMsg.classList.add('hidden');
    statusText.innerHTML = `üì° Jel keres√©se... <span id="gps-countdown">15</span>mp`;
    accValue.textContent = "-";
    bestAccuracy = 99999;
    lastTestLat = null; // T√∂r√∂lj√ºk az el≈ëz≈ët
    lastTestLng = null;
    testBtn.disabled = true;

    // 1. T√©rk√©p inicializ√°l√°sa
    if (!gpsTestMap) {
        gpsTestMap = L.map('gps-test-map', { 
            zoomControl: false, 
            attributionControl: false 
        }).setView([47.4979, 19.0402], 13);

        L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=6zyg285SLPbgmb1LZStQ', {
            maxZoom: 20
        }).addTo(gpsTestMap);
    }
    
    setTimeout(() => { gpsTestMap.invalidateSize(); }, 200);

    if (!navigator.geolocation) {
        finishGpsTest(false, "A b√∂ng√©sz≈ë nem t√°mogatja a GPS-t.");
        return;
    }

    // 2. Visszasz√°ml√°l√≥ (15 mp)
    let timeLeft = 15;
    if (gpsTestInterval) clearInterval(gpsTestInterval);

    gpsTestInterval = setInterval(() => {
        timeLeft--;
        const counterEl = document.getElementById('gps-countdown');
        if(counterEl) counterEl.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            finishGpsTest(); // Id≈ë lej√°rt
        }
    }, 1000);

    // 3. Poz√≠ci√≥ figyel√©se
    gpsTestWatchId = navigator.geolocation.watchPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = Math.round(pos.coords.accuracy);

            // √öJ: Ments√ºk el a poz√≠ci√≥t, hogy a v√©g√©n tudjunk vele sz√°molni
            lastTestLat = lat;
            lastTestLng = lng;

            // Legjobb pontoss√°g ment√©se
            if (accuracy < bestAccuracy) bestAccuracy = accuracy;
            accValue.textContent = accuracy;

            // T√©rk√©pelem friss√≠t√©se
            updateTestMapMarker(lat, lng, accuracy);

            // --- JAV√çTOTT GYORS LE√ÅLL√çT√ÅS ---
            // A legjobb √©rt√©ket n√©zz√ºk, √©s ha az j√≥, azonnal meg√°llunk!
            if (bestAccuracy <= 10) {
                console.log("J√≥ jel tal√°lva:", bestAccuracy); // Debug info
                finishGpsTest(); 
            }
        },
        (err) => {
            console.warn("GPS Teszt hiba:", err);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
};

// Seg√©df√ºggv√©ny a t√©rk√©prajzol√°shoz
function updateTestMapMarker(lat, lng, accuracy) {
    if (!gpsTestMap) return;
    try {
        const latLng = [lat, lng];
        
        if (!gpsTestMarker) {
            const icon = L.divIcon({ className: 'player-marker', iconSize: [15, 15] });
            gpsTestMarker = L.marker(latLng, { icon: icon }).addTo(gpsTestMap);
            gpsTestCircle = L.circle(latLng, { radius: accuracy, color: 'blue', weight: 1, fillOpacity: 0.1 }).addTo(gpsTestMap);
            gpsTestMap.setView(latLng, 16);
        } else {
            gpsTestMarker.setLatLng(latLng);
            if (gpsTestCircle) {
                gpsTestCircle.setLatLng(latLng);
                gpsTestCircle.setRadius(accuracy);
            }
            if (!gpsTestMap.getBounds().contains(latLng)) {
                gpsTestMap.panTo(latLng);
            }
        }
    } catch (e) {
        console.error("T√©rk√©p hiba:", e);
    }
}

// --- GPS TESZT LEZ√ÅR√ÅSA (SORBARENDEZ√âSSEL) ---
function finishGpsTest(forceError = false, errorMsg = "") {
    // Minden figyel√©s azonnali le√°ll√≠t√°sa
    if (gpsTestWatchId) {
        navigator.geolocation.clearWatch(gpsTestWatchId);
        gpsTestWatchId = null;
    }
    if (gpsTestInterval) {
        clearInterval(gpsTestInterval);
        gpsTestInterval = null;
    }

    const statusText = document.getElementById('gps-test-status');
    const resultMsg = document.getElementById('gps-result-message');
    const testBtn = document.getElementById('gps-test-btn');
    
    if(testBtn) testBtn.disabled = false;

    if (forceError) {
        statusText.textContent = "Hiba t√∂rt√©nt!";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-red-100 text-red-700 block";
        resultMsg.innerHTML = `‚ö†Ô∏è ${errorMsg}`;
        return;
    }

    // EREDM√âNY KI√çR√ÅSA
    if (bestAccuracy <= 50) {
        statusText.textContent = "Teszt k√©sz."; 
        
        let successText = "";
        let colorClass = "";
        
        if (bestAccuracy <= 10) {
             colorClass = "bg-green-100 text-green-700";
             successText = `üöÄ Szuper jel!<br>Pontoss√°g: ${bestAccuracy}m`;
             if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'green', fillColor: 'green' });
        } else {
             colorClass = "bg-green-100 text-green-700";
             successText = `‚úÖ GPS M≈±k√∂dik!<br>Pontoss√°g: ${bestAccuracy}m`;
             if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'green', fillColor: 'green' });
        }

        // --- √öJ R√âSZ: SORBARENDEZ√âS AUTOMATIKUSAN ---
        if (lastTestLat !== null && lastTestLng !== null) {
            console.log("Sikeres teszt -> Lista rendez√©se...");
            
            // 1. T√°vols√°gok √∫jrasz√°mol√°sa a teszt koordin√°t√°ival
            Object.values(games).forEach(game => {
                if (game.startLocation && game.startLocation.lat && game.startLocation.lng) {
                    const dist = haversineDistance(
                        { lat: lastTestLat, lng: lastTestLng }, 
                        { lat: game.startLocation.lat, lng: game.startLocation.lng }
                    );
                    game._calculatedDistance = dist / 1000; // km
                } else {
                    game._calculatedDistance = 99999; 
                }
            });

            // 2. Lista √∫jrarajzol√°sa (ez automatikusan sorba rendezi a _calculatedDistance alapj√°n)
            renderGameList();

            // 3. Visszajelz√©s
            successText += `<br><span class="text-[10px] uppercase font-bold mt-1 block">üìç J√°t√©klista friss√≠tve!</span>`;
        }
        // ---------------------------------------------

        resultMsg.className = `mt-2 p-2 rounded text-xs font-bold text-center block ${colorClass}`;
        resultMsg.innerHTML = successText;
        
    } else if (bestAccuracy < 99999) {
        // Gyenge jel (s√°rga)
        statusText.textContent = "Teszt k√©sz.";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-yellow-100 text-yellow-800 block";
        resultMsg.innerHTML = `‚ö†Ô∏è Gyenge jel (${bestAccuracy}m).<br>Menj ny√≠lt terepre!`;
        if (gpsTestCircle) gpsTestCircle.setStyle({ color: 'orange', fillColor: 'orange' });
    
    } else {
        // Nincs jel (piros)
        statusText.textContent = "Nincs jel.";
        resultMsg.className = "mt-2 p-2 rounded text-xs font-bold text-center bg-red-100 text-red-700 block";
        resultMsg.innerHTML = `‚ùå Nem siker√ºlt poz√≠ci√≥t tal√°lni.<br>Ellen≈ërizd a be√°ll√≠t√°sokat!`;
    }
    
    resultMsg.classList.remove('hidden');
}


// --- √öJ TESZT IND√çT√ì F√úGGV√âNY ---
window.startSpecificTestGame = function() {
    // -----------------------------------------------------------
    // IDE √çRD BE A FIX J√ÅT√âK AZONOS√çT√ìT (amit az Excel 'id' oszlop√°ba √≠rt√°l)
    const FIX_GAME_ID = "teszt-game"; 
    // -----------------------------------------------------------

    // 1. Ellen≈ërizz√ºk, hogy bet√∂lt≈ëd√∂tt-e az adatb√°zis √©s l√©tezik-e a j√°t√©k
    if (!games || !games[FIX_GAME_ID]) {
        alert(`HIBA: A k√≥dba √≠rt j√°t√©k azonos√≠t√≥ ("${FIX_GAME_ID}") nem tal√°lhat√≥ a bet√∂lt√∂tt adatb√°zisban!\n\nEl√©rhet≈ë ID-k: ${Object.keys(games).join(", ")}`);
        return;
    }

    // 2. Automatikus kit√∂lt√©s (hogy ne kelljen be√≠rni a nevet/avatart)
    const nameInput = document.getElementById('team-name-input');
    const avatarSelect = document.getElementById('team-avatar-select');

    // Csak akkor √≠rjuk fel√ºl, ha √ºres
    if (!nameInput.value) nameInput.value = "Fejleszt≈ë";
    if (!avatarSelect.value) avatarSelect.value = "robot"; // Robot avatar alap√©rtelmezetten

    // 3. UI friss√≠t√©se, mintha a felhaszn√°l√≥ √≠rta volna be (hogy a ment√©s is m≈±k√∂dj√∂n)
    localStorage.setItem('mystigo_pref_teamName', nameInput.value);
    localStorage.setItem('mystigo_pref_teamAvatar', avatarSelect.value);

    // 4. J√°t√©k ind√≠t√°sa 'mock' (manu√°lis GPS) m√≥dban
    console.log(`Teszt j√°t√©k ind√≠t√°sa: ${FIX_GAME_ID} (Mock Mode)`);
    startGame(FIX_GAME_ID, 'mock');
};



function requestGpsAndStart(gameId) {
            const selectedMode = document.querySelector('input[name="game_mode_selection"]:checked');
            const gameMode = selectedMode ? selectedMode.value : 'normal';

            if (gameMode === 'mock') { startGame(gameId, 'mock'); return; }
            
            if (!navigator.geolocation) { 
                // Ha a b√∂ng√©sz≈ë egy√°ltal√°n nem t√°mogatja, akkor is j√∂het a help ablak
                document.getElementById('gps-help-modal').classList.remove('hidden');
                return; 
            }
            
            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    showLoading(false);
                    updatePlayerMarker(pos.coords.latitude, pos.coords.longitude); 
                    startGame(gameId, 'normal');
                },
                (err) => { 
                    showLoading(false);
                    
                    if (gameMode === 'normal') {
                        // JAV√çT√ÅS: Itt most m√°r a sz√©p ablakot nyitjuk meg a showMessage helyett!
                        document.getElementById('gps-help-modal').classList.remove('hidden');
                    }
                    else { 
                        showMessage('GPS Hiba', 'Nem siker√ºlt lek√©rni a helyzeted. Teszt M√≥d miatt a j√°t√©k elindul.'); 
                        startGame(gameId, 'test'); 
                    }
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000, frequency: 3000 } 
            );
        }
      
// --- STORAGE MANAGER LOGIKA ---

window.openStorageManager = function() {
    renderStorageList();
    document.getElementById('storage-manager-modal').classList.remove('hidden');
};

window.renderStorageList = function() {
    const container = document.getElementById('storage-list-container');
    container.innerHTML = '';
    
    const keys = Object.keys(localStorage);
    document.getElementById('storage-count-display').textContent = `${keys.length} bejegyz√©s`;

    if (keys.length === 0) {
        container.innerHTML = `<div class="text-center p-8 text-gray-400 italic">A LocalStorage √ºres.</div>`;
        return;
    }

    // Rendez√©s, hogy a hasonl√≥ak egym√°s mell√© ker√ºljenek
    keys.sort();

    keys.forEach(key => {
        let displayTitle = key;
        let icon = 'üìÑ';
        let bgColor = 'bg-white';
        let borderColor = 'border-gray-200';
        let textColor = 'text-gray-600';

        // Kateg√≥ri√°k felismer√©se a szebb megjelen√≠t√©s√©rt
        if (key.startsWith('MystiGoGameState_')) {
            icon = 'üéÆ';
            displayTitle = key.replace('MystiGoGameState_', 'MENT√âS: ');
            bgColor = 'bg-orange-50';
            borderColor = 'border-orange-200';
            textColor = 'text-orange-800';
        } else if (key.startsWith('MystiGo_Perm_Completed_')) {
            icon = 'üèÜ';
            displayTitle = key.replace('MystiGo_Perm_Completed_', 'K√âSZ: ');
            bgColor = 'bg-green-50';
            borderColor = 'border-green-200';
            textColor = 'text-green-800';
        
	} else if (key.startsWith('MystiGo_Perm_Count_')) {
            icon = 'üî¢';
            displayTitle = key.replace('MystiGo_Perm_Count_', 'J√ÅT√âK SZ√ÅML√ÅL√ì: ');
            bgColor = 'bg-purple-50';
            borderColor = 'border-purple-200';
            textColor = 'text-purple-800';

	} else if (key.startsWith('mystigo_pref_')) {
            icon = '‚öôÔ∏è';
            displayTitle = key.replace('mystigo_pref_', 'BE√ÅLL√çT√ÅS: ');
            bgColor = 'bg-blue-50';
            borderColor = 'border-blue-200';
            textColor = 'text-blue-800';
        }

        // Egy sor HTML k√≥dja
        const itemHtml = `
            <div class="flex items-center justify-between p-3 mb-2 rounded-lg border ${bgColor} ${borderColor} shadow-sm transition hover:shadow-md group">
                <div class="overflow-hidden mr-3">
                    <div class="text-xs font-bold ${textColor} truncate flex items-center gap-1.5" title="${key}">
                        <span>${icon}</span> ${displayTitle}
                    </div>
                    <div class="text-[10px] text-gray-400 truncate font-mono mt-0.5">
                        ${key}
                    </div>
                </div>
                <button onclick="deleteStorageItem('${key}')" 
                        class="shrink-0 bg-white border border-gray-200 text-red-500 hover:bg-red-500 hover:text-white p-1.5 rounded-md transition shadow-sm"
                        title="T√∂rl√©s">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `;
        container.innerHTML += itemHtml;
    });
};

window.deleteStorageItem = function(key) {
    if (confirm(`Biztosan t√∂rl√∂d ezt a kulcsot?\n${key}`)) {
        localStorage.removeItem(key);
        renderStorageList(); // Lista friss√≠t√©se t√∂rl√©s ut√°n
        
        // Ha √©pp a fut√≥ j√°t√©kot t√∂r√∂lt√ºk, jelezz√ºk
        if (window.currentGameId && key.includes(window.currentGameId)) {
            alert("Figyelem: A jelenleg fut√≥ vagy kiv√°lasztott j√°t√©k adatait t√∂r√∂lted. √ârdemes √∫jrat√∂lteni az oldalt.");
        }
    }
};

window.nukeAllStorage = function() {
    if (confirm("‚ö†Ô∏è FIGYELEM!\n\nEz t√∂rli az √ñSSZES ment√©st, be√°ll√≠t√°st √©s teljes√≠t√©st.\nBiztosan folytatod?")) {
        localStorage.clear();
        renderStorageList();
        alert("A mem√≥ria teljesen t√∂r√∂lve lett. Az oldal √∫jrat√∂lt≈ëdik.");
        location.reload();
    }
};

  
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- √öJ R√âSZ KEZDETE: N√©v √©s Avatar automatikus ment√©se/bet√∂lt√©se ---
            	const teamNameInput = document.getElementById('team-name-input');
		const avatarSelect = document.getElementById('team-avatar-select');

if (teamNameInput) {
    // A 'change' esem√©ny figyel, ha a mez≈ë √©rt√©ke megv√°ltozik
    teamNameInput.addEventListener('change', window.saveUserProfileToFirebase);
    // A 'blur' esem√©ny akkor fut le, ha a felhaszn√°l√≥ kikattint a mez≈ëb≈ël
    teamNameInput.addEventListener('blur', window.saveUserProfileToFirebase);
}
if (avatarSelect) {
    avatarSelect.addEventListener('change', window.saveUserProfileToFirebase);
}

// --- √öJ GOMB ESEM√âNYKEZEL≈êJE (√ñsszes j√°t√©k list√°z√°sa) ---
    // --- EZ A FRISS√çTETT VERZI√ì (CSER√âLD LE A R√âGIT ERRE) ---
    const listAllGamesBtn = document.getElementById('list-all-games-btn');
    if (listAllGamesBtn) {
        listAllGamesBtn.addEventListener('click', () => {
            // 1. Bekapcsoljuk a glob√°lis v√°ltoz√≥t, hogy l√°ssuk a rejtetteket
            window.showHiddenGames = true;

            // 2. √öjragener√°ljuk a helysz√≠n list√°t (most m√°r a rejtett v√°rosok is benne lesznek)
            populateLocationFilter();

            // 3. Kirajzoljuk a j√°t√©kokat
            renderGameList(games);
            
            // 4. Fejleszt≈ëi men√º bez√°r√°sa (hogy l√°ssuk az eredm√©nyt)
            const devOptions = document.getElementById('developer-options');
            if (devOptions) devOptions.classList.add('hidden');
            const devToggle = document.getElementById('developer-tools-toggle');
            if(devToggle) devToggle.querySelector('span').textContent = '‚ñº';

        });
    }
    // --------------------------------------------------------

            // 1. Bet√∂lt√©s: Megn√©zz√ºk, van-e elmentve adat
            const savedName = localStorage.getItem('mystigo_pref_teamName');
            const savedAvatar = localStorage.getItem('mystigo_pref_teamAvatar');

            if (savedName) {
                nameInputEl.value = savedName;
            }
            if (savedAvatar) {
                avatarSelectEl.value = savedAvatar;
            }

            // 2. Ment√©s: Figyelj√ºk a v√°ltoz√°st √©s azonnal ment√ºnk
            if (nameInputEl) {
    nameInputEl.addEventListener('input', (e) => {
        // Ez a r√©gi (b√∂ng√©sz≈ëbe ment√©s) marad:
        localStorage.setItem('mystigo_pref_teamName', e.target.value);
        
        // EZT ADD HOZZ√Å (Felh≈ëbe ment√©s):
        if (typeof window.saveUserProfileToFirebase === 'function') {
            // Kis k√©sleltet√©s (debounce), hogy ne minden bet≈±n√©l k√ºldj√ºnk adatot
            clearTimeout(window.saveProfileTimeout);
            window.saveProfileTimeout = setTimeout(window.saveUserProfileToFirebase, 1000);
        }
    });
}

if (avatarSelectEl) {
    avatarSelectEl.addEventListener('change', (e) => {
        localStorage.setItem('mystigo_pref_teamAvatar', e.target.value);
        
        // EZT ADD HOZZ√Å:
        if (typeof window.saveUserProfileToFirebase === 'function') {
            window.saveUserProfileToFirebase();
        }
    });
}

// --- √öJ KIDS M√ìD LOGIKA ---
            const kidsCheckbox = document.getElementById('kids-mode-checkbox');
            const mainLogo = document.getElementById('main-header-logo');
            const filterTypeSelect = document.getElementById('filter-type');

            function toggleKidsMode(isKidsActive) {
                // 1. Logo csere
                if (mainLogo) {
                    mainLogo.src = isKidsActive ? "logo/MystiGo_logo_cat.png" : "logo/MystiGo_logo.png";
                }
                // 2. Sz≈±r≈ë be√°ll√≠t√°sa √©s lista friss√≠t√©se
                if (filterTypeSelect) {
                    filterTypeSelect.value = isKidsActive ? 'kids' : 'all';
                    if (typeof applyFilters === 'function') {
                        applyFilters();
                    }
                }
            }

            // Bet√∂lt√©skor
            const savedKidsMode = localStorage.getItem('mystigo_pref_kidsMode') === 'true';
            if (kidsCheckbox) {
                kidsCheckbox.checked = savedKidsMode;
                if (savedKidsMode) toggleKidsMode(true);

                // V√°ltoz√°skor
                kidsCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    localStorage.setItem('mystigo_pref_kidsMode', isChecked);
                    toggleKidsMode(isChecked);
                });
            }
            // -----


            if (avatarSelectEl) {
                avatarSelectEl.addEventListener('change', (e) => {
                    localStorage.setItem('mystigo_pref_teamAvatar', e.target.value);
                });
            }
            // --- √öJ R√âSZ V√âGE ---

	    initializeState();
            loadLocalXlsx(DEFAULT_GAME_FILE);

            const logoO = document.getElementById('logo-o'); 
            const manualFileSelectLabel = document.getElementById('manual-file-select-label');
            const manualFileInput = document.getElementById('excel-file-input-manual'); 
            const devOptions = document.getElementById('developer-options');
            const devToggle = document.getElementById('developer-tools-toggle');

            document.getElementById('modal-ok-button').onclick = hideMessage;
            document.getElementById('modal-cancel-button').onclick = hideMessage;
            
            logoO.addEventListener('click', () => {
                 const switchesContainer = document.getElementById('secret-switches-container');
                 if (switchesContainer) {
                    if (!document.getElementById('game-list-page').classList.contains('hidden')) switchesContainer.classList.toggle('hidden');
                 }
            });
            
            const mainHeaderLogoContainer = document.querySelector('#main-header .flex.justify-center');
            if (mainHeaderLogoContainer) {
                mainHeaderLogoContainer.style.cursor = 'pointer'; 
                mainHeaderLogoContainer.addEventListener('click', () => { resetApp(); });
            }

            if (manualFileInput) {
                 manualFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0]; if (!file) return; 
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'}); 
                            processExcelData(wb);
                            if (manualFileSelectLabel) manualFileSelectLabel.classList.add('hidden');
                        } catch (error) {
                            showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                            showLoading(false);
                            if (manualFileSelectLabel) manualFileSelectLabel.classList.remove('hidden');
                        }
                    };
                    reader.onerror = () => { showMessage('Hiba', 'F√°jl olvas√°si hiba.'); showLoading(false); };
                    reader.readAsArrayBuffer(file);
                });
            }
            
            const excelFileInput = document.getElementById('excel-file-input');
            if (excelFileInput) {
                excelFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0]; if (!file) return; 
                    showLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result),{type:'array'}); 
                            processExcelData(wb);
                        } catch (error) {
                            showMessage('Feldolgoz√°si Hiba', `Hiba: ${error.message}`);
                            showLoading(false);
                        }
                    };
                    reader.onerror = () => { showMessage('Hiba', 'F√°jl olvas√°si hiba.'); showLoading(false); };
                    reader.readAsArrayBuffer(file);
                });
            }

            document.body.addEventListener('click', (e) => {
                 if (e.target && e.target.id === 'secret-trigger') {
                    const container = document.getElementById('secret-switches-container');
                    if (container) container.classList.toggle('hidden');
                 }
            });
            
            if (devToggle && devOptions) {
                devToggle.addEventListener('click', () => {
                    devOptions.classList.toggle('hidden');
                    devToggle.querySelector('span').textContent = devOptions.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
                });
            }

            document.getElementById('submit-answer-btn').addEventListener('click', () => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return;
                const userAnswer = document.getElementById('answer-input').value;
                const normalizedUserAnswer = normalizeAnswer(userAnswer);
                let isCorrect = false;
                if (task.acceptedAnswers && task.acceptedAnswers.includes(normalizedUserAnswer)) isCorrect = true;
                
                if (isCorrect) showMessage(t('correct_title'), `√úgyes vagy! (+${task.taskScore} pont)`, handleCorrectAnswer);
                else {
                    if (task.taskScore > 0) task.taskScore = Math.max(0, task.taskScore - WRONG_ANSWER_PENALTY);
                    showMessage(t('wrong_title'), t('wrong_body') + `<br><br>(Maradt pont: ${task.taskScore})`);
                }
                updateStatusDisplays();
            });

            document.getElementById('hint1-btn').addEventListener('click', (e) => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                if (task.hintsUsed < 1) { 
                    task.taskScore = Math.max(0, task.taskScore - HINT1_PENALTY); 
                    task.hintsUsed = 1;
                    if (typeof gtag === 'function') {
                        gtag('event', 'hint_used', {
                            'game_id': appState.currentGame.id,
                            'level_index': appState.currentTaskIndex,
                            'hint_type': 'hint_1',
                            'team_name': appState.teamName || 'unknown'
                        });
                    }
		    updateStatusDisplays(); saveGameState(); 
                }
                showMessage('1. Seg√≠ts√©g', t('hint1_body', task.hints[0]) + `<br><br>(Maradt pont: ${task.taskScore})`, () => { updateHintButtons(task); });
            });

            document.getElementById('hint2-btn').addEventListener('click', (e) => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                if (task.hintsUsed < 2) { 
                    task.taskScore = Math.max(0, task.taskScore - HINT2_PENALTY); 
                    task.hintsUsed = 2;
		if (typeof gtag === 'function') {
                        gtag('event', 'hint_used', {
                            'game_id': appState.currentGame.id,
                            'level_index': appState.currentTaskIndex,
                            'hint_type': 'hint_2',
                            'team_name': appState.teamName || 'unknown'
                        });
                    }                
    		updateStatusDisplays(); saveGameState(); 
                }
                showMessage('2. Seg√≠ts√©g', t('hint2_body', task.hints[1]) + `<br><br>(Maradt pont: ${task.taskScore})`, () => { updateHintButtons(task); });
            });
            
            document.getElementById('solution-btn').addEventListener('click', () => {
                const task = appState.currentGame.tasks.find(t => t.index === appState.currentTaskIndex);
                if (!task) return;
                if (!task.isTaskTimerActive) return showMessage(t('far_title'), t('far_body')); 
                if (task.isStartTask) return; 
                if (speechSynth.speaking) speechSynth.cancel();
                const scoreLost = task.taskScore; 
                task.taskScore = 0; 
                if (typeof gtag === 'function') {
                    gtag('event', 'hint_used', {
                        'game_id': appState.currentGame.id,
                        'level_index': appState.currentTaskIndex,
                        'hint_type': 'solution_reveal', // Itt m√°s t√≠pust adunk meg
                        'team_name': appState.teamName || 'unknown'
                    });
                }
		showMessage('Megold√°s', `A feladat megold√°sa: ${task.solution}. <br><br>(Maradt pont: 0)`, () => {
                    handleCorrectAnswer(); updateStatusDisplays();
                });
                saveGameState(); 
            });
            
            document.getElementById('start-game-btn').addEventListener('click', startTimersAndGPS);
            document.getElementById('exit-game-btn').addEventListener('click', showExitConfirmation);
            document.getElementById('report-error-btn').addEventListener('click', showReportModal); 
            document.getElementById('submit-error-report').addEventListener('click', handleSubmitError); 

            document.addEventListener('visibilitychange', () => {
                if (!appState.currentGame) return;
                if (document.hidden) { 
                    if (speechSynth.speaking) speechSynth.cancel();
                    if (appState.geoWatchId) navigator.geolocation.clearWatch(appState.geoWatchId); appState.geoWatchId = null; 
                } 
                else if (!appState.geoWatchId) { watchPosition(); }
            });

            document.getElementById('answer-input').addEventListener('focus', (e) => {
                const inputElement = e.target;
                inputElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    const wrapper = document.getElementById('content-page-wrapper');
                    const inputTop = inputElement.offsetTop;
                    wrapper.scrollTo({ top: inputTop - 30, behavior: 'smooth' });
                }, 150); 
            });
        }); 


window.loadMoreGames = function() {
            // N√∂velj√ºk a limitet
            appState.visibleGamesLimit += 5;
            
            // √öJ: Azt a list√°t rajzoljuk √∫jra, ami √©ppen akt√≠v (sz≈±rt vagy eredeti)
            renderGameList(appState.currentFilteredGames);
        };

    </script>


<div id="email-modal" class="fixed inset-0 bg-black/60 hidden z-[9999] flex items-center justify-center backdrop-blur-sm transition-opacity p-4">
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto overflow-hidden transform transition-all scale-95" id="email-modal-content">
        
        <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-gray-50">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-brand-blue"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A7.501 7.501 0 0 1 4.501 20.118Z" /></svg>
                Fi√≥k kezel√©se
            </h3>
            <button onclick="closeEmailModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-full p-1 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600 mb-4 text-center">Add meg az adataidat a bel√©p√©shez vagy √∫j fi√≥k l√©trehoz√°s√°hoz.</p>
            
            <div class="space-y-1">
                <label for="email-input-field" class="text-xs font-bold text-gray-700 uppercase ml-1">Email c√≠m</label>
                <input type="email" id="email-input-field" placeholder="pelda@email.hu" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition">
            </div>
            
            <div class="space-y-1">
                 <label for="password-input-field" class="text-xs font-bold text-gray-700 uppercase ml-1">Jelsz√≥</label>
                <input type="password" id="password-input-field" placeholder="Minimum 6 karakter" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition">
            </div>

<div class="space-y-1">
                 <label for="password-input-field" class="text-xs font-bold text-gray-700 uppercase ml-1">Jelsz√≥</label>
                <input type="password" id="password-input-field" placeholder="Minimum 6 karakter" class="w-full px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-brand-blue focus:border-brand-blue outline-none transition">
                
                <a href="#" onclick="requestPasswordReset(event)" class="block text-right text-xs font-semibold text-gray-500 hover:text-red-500 underline mt-1">
                    Elfelejtettem a jelszavam
                </a>
            </div>


            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                <button onclick="loginWithEmail()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-blue-700 transition shadow-md active:scale-95">
   	 	Bel√©p√©s
	</button>
                <button onclick="registerWithEmail()" class="flex-1 bg-white border-2 border-brand-blue text-brand-blue py-3 rounded-xl text-sm font-bold hover:bg-blue-50 transition shadow-sm active:scale-95">
                    Regisztr√°ci√≥
                </button>
            </div>
        </div>
    </div>
</div>
</body> ```

### 3. L√âP√âS: JavaScript m√≥dos√≠t√°sa (Modal kezel√©s √©s UI friss√≠t√©s)

Menj a `<script type="module">` r√©szbe.

**A. √öj f√ºggv√©nyek a modal nyit√°s√°ra/z√°r√°s√°ra:**
M√°sold be ezeket valahova a t√∂bbi `window.` kezdet≈± f√ºggv√©ny mell√© (pl. a `loginWithEmail` f√∂l√©):

```javascript
// --- MODAL KEZEL√âS (Felugr√≥ ablak) ---
window.openEmailModal = function() {
    const modal = document.getElementById('email-modal');
    const modalContent = document.getElementById('email-modal-content');
    modal.classList.remove('hidden');
    // Kis anim√°ci√≥ a megjelen√©shez
    setTimeout(() => {
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
    }, 10);
};

window.closeEmailModal = function() {
    const modal = document.getElementById('email-modal');
    const modalContent = document.getElementById('email-modal-content');
    // Kis anim√°ci√≥ az elt≈±n√©shez
    modalContent.classList.remove('scale-100');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        // Mez≈ëk t√∂rl√©se bez√°r√°skor (opcion√°lis, de hasznos)
        document.getElementById('email-input-field').value = '';
        document.getElementById('password-input-field').value = '';
    }, 200); // V√°rjuk meg az anim√°ci√≥t
};

// Bez√°r√°s, ha a s√∂t√©t h√°tt√©rre kattintanak
document.getElementById('email-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeEmailModal();
        }
    });
</script> </body>
</html>