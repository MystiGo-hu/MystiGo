<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MystiGo - Kupon Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0D2B45; color: #e2e8f0; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-mystigo { background: linear-gradient(135deg, #20e3b2 0%, #009ad7 100%); transition: all 0.2s; }
        .btn-mystigo:active { scale: 0.98; }
        input, select { background: #0f172a !important; border: 1px solid #334155 !important; color: white !important; }
        input:focus, select:focus { border-color: #20e3b2 !important; box-shadow: 0 0 0 2px rgba(32, 227, 178, 0.1); outline: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-blue-500">
                Kupon Adminisztráció
            </h1>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition-colors">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>

        <div id="login-section" class="glass rounded-3xl p-8 text-center">
            <h2 class="text-xl mb-6">Bejelentkezés szükséges</h2>
            <button id="login-btn" class="btn-mystigo px-8 py-3 rounded-xl font-bold text-white shadow-lg">
                Bejelentkezés Google-lal
            </button>
        </div>

        <div id="admin-content" class="hidden space-y-6">
            
            <div class="glass rounded-3xl p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle text-teal-400"></i>
                    Kezelés
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">Cél mappa</label>
                        <div class="flex gap-2">
                            <select id="cp-folder" class="flex-1 p-3 rounded-xl cursor-pointer">
                                </select>
                            <button id="new-folder-btn" class="bg-slate-700 px-4 rounded-xl hover:bg-slate-600 transition-all" title="Új mappa">
                                <i class="fa-solid fa-folder-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">Kupon kód</label>
                        <input type="text" id="cp-code" class="w-full p-3 rounded-xl uppercase font-mono tracking-widest" placeholder="Kód vagy üresen generál">
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3">
                    <button id="add-single-btn" class="flex-1 btn-mystigo py-3 rounded-xl font-bold text-white shadow-md">
                        Kupon Mentése
                    </button>
                    <label class="flex-1 cursor-pointer bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-bold text-white text-center transition-all">
                        <span><i class="fa-solid fa-file-excel mr-2"></i>Excel feltöltés</span>
                        <input type="file" id="xls-upload" class="hidden" accept=".xlsx, .xls">
                    </label>
                </div>
            </div>

            <div class="glass rounded-3xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold flex items-center gap-2">
                        <i class="fa-solid fa-database text-blue-400"></i> 
                        Aktív kuponok 
                        <span id="current-folder-label" class="text-xs font-normal text-gray-400 ml-2"></span>
                    </h2>
                    <span id="count" class="bg-white/10 px-3 py-1 rounded-full text-xs font-mono">0 db</span>
                </div>
                
                <div id="list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA7V1WXFCVhmw2BygHkrwhrSy1Taoohyw",
            authDomain: "mystigo-7b149.firebaseapp.com",
            databaseURL: "https://mystigo-7b149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mystigo-7b149",
            storageBucket: "mystigo-7b149.appspot.com",
            messagingSenderId: "367383637666",
            appId: "1:367383637666:web:156184517316377e641775"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const folderSelect = document.getElementById('cp-folder');
        const listDiv = document.getElementById('list');
        const countSpan = document.getElementById('count');

        // Auth figyelés
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'krisztian.topler@gmail.com') {
                loginSection.classList.add('hidden');
                adminContent.classList.remove('hidden');
                initFolderListener(); // Mappák betöltése
            } else {
                loginSection.classList.remove('hidden');
                adminContent.classList.add('hidden');
                if (user) signOut(auth);
            }
        });

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // --- Mappa és Lista kezelés ---

        function initFolderListener() {
            // Figyeljük a teljes 'coupons' csomópontot a mappák kinyeréséhez
            onValue(ref(db, 'coupons'), (snapshot) => {
                const data = snapshot.val();
                const currentSelection = folderSelect.value;
                folderSelect.innerHTML = '';
                
                if (data) {
                    const folders = Object.keys(data);
                    folders.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.textContent = f;
                        folderSelect.appendChild(opt);
                    });
                    
                    if (currentSelection && folders.includes(currentSelection)) {
                        folderSelect.value = currentSelection;
                    }
                } else {
                    // Ha teljesen üres a DB
                    const opt = document.createElement('option');
                    opt.value = 'common';
                    opt.textContent = 'common';
                    folderSelect.appendChild(opt);
                }
                loadCoupons(); // Lista frissítése a választott mappából
            });
        }

        // Új mappa gomb
        document.getElementById('new-folder-btn').onclick = () => {
            const name = prompt("Új mappa neve (pl. mozi, etterem):");
            if (name) {
                const cleanName = name.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
                const opt = document.createElement('option');
                opt.value = cleanName;
                opt.textContent = cleanName;
                folderSelect.appendChild(opt);
                folderSelect.value = cleanName;
                loadCoupons();
            }
        };

        // Mappa váltáskor lista frissítés
        folderSelect.onchange = () => loadCoupons();

        function loadCoupons() {
            const folder = folderSelect.value;
            if (!folder) return;

            document.getElementById('current-folder-label').textContent = `> ${folder}`;

            onValue(ref(db, `coupons/${folder}`), (snapshot) => {
                listDiv.innerHTML = '';
                const data = snapshot.val();
                
                if (!data) {
                    countSpan.innerText = '0 db';
                    listDiv.innerHTML = '<p class="text-gray-500 text-sm italic col-span-full text-center py-4">Nincsenek kuponok ebben a mappában.</p>';
                    return;
                }

                const codes = Object.keys(data);
                countSpan.innerText = codes.length + ' db';
                
                codes.sort().forEach(code => {
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/10 hover:border-teal-500/30 transition-all";
                    item.innerHTML = `
                        <span class="font-mono font-bold text-sm text-teal-400">${code}</span>
                        <button class="del-btn text-gray-500 hover:text-red-500 p-2 transition-colors">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>`;
                    
                    item.querySelector('.del-btn').onclick = () => {
                        if(confirm(`Törlöd a(z) ${code} kupont a(z) ${folder} mappából?`)) {
                            remove(ref(db, `coupons/${folder}/${code}`));
                        }
                    };
                    listDiv.appendChild(item);
                });
            });
        }

        // --- Hozzáadás Logika ---

        function generateCode() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        document.getElementById('add-single-btn').onclick = async () => {
            const input = document.getElementById('cp-code');
            const folder = folderSelect.value;
            let code = input.value.trim().toUpperCase() || generateCode();
            
            if (!folder) return alert("Válassz vagy hozz létre egy mappát!");

            try {
                await set(ref(db, `coupons/${folder}/${code}`), true);
                input.value = '';
            } catch (err) {
                alert("Hiba: " + err.message);
            }
        };

        // Excel feltöltés
        document.getElementById('xls-upload').onchange = (e) => {
            const file = e.target.files[0];
            const folder = folderSelect.value;
            if (!file || !folder) return;

            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const data = evt.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    const updates = {};
                    let count = 0;

                    for (let i = 1; i < rows.length; i++) {
                        const code = rows[i][0]; 
                        if (code) {
                            const cleanCode = String(code).trim().toUpperCase();
                            updates[`coupons/${folder}/${cleanCode}`] = true;
                            count++;
                        }
                    }

                    if (count > 0) {
                        await update(ref(db), updates);
                        alert(`${count} db kupon feltöltve a(z) "${folder}" mappába!`);
                    }
                    e.target.value = '';
                } catch (err) {
                    alert("Hiba a feldolgozás során!");
                    console.error(err);
                }
            };
            reader.readAsBinaryString(file);
        };
    </script>
</body>
</html>